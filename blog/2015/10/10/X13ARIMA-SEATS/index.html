      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Seasonal adjusment on the fly with X-13ARIMA-SEATS, seasonal and ggplot2</title>
      	
         
         
            <meta name ="description" content ="I show how to seasonally adjust published electronic card transactions spend in New Zealand using the US Census Bureau's excellent X-13ARIMA-SEATS software, the Spanish SEATS algorithm and Christoph Sax's seasonal R package; and how to build a new "stat" for ggplot2 to make it easy to do seasonal adjustment on the fly for a graphic of a time series split by various grouping dimensions.">
            <meta property="og:description" content ="I show how to seasonally adjust published electronic card transactions spend in New Zealand using the US Census Bureau's excellent X-13ARIMA-SEATS software, the Spanish SEATS algorithm and Christoph Sax's seasonal R package; and how to build a new "stat" for ggplot2 to make it easy to do seasonal adjustment on the fly for a graphic of a time series split by various grouping dimensions.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Seasonal adjusment on the fly with X-13ARIMA-SEATS, seasonal and ggplot2" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0014-faceted.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2015/10/10/X13ARIMA-SEATS/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">       
     <link rel="stylesheet" href="/css/Pygments/autumn.css">      
     <link rel="stylesheet" href="/css/Pygments/custom.css">      
            
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
         <script src="/js/bootstrap.min.js"></script>
         
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2015/12/12/exports-gdp>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Seasonal adjusment on the fly with X-13ARIMA-SEATS, seasonal and ggplot2</h1>
         <p class="meta">10 Oct 2015</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   I show how to seasonally adjust published electronic card transactions spend in New Zealand using the US Census Bureau's excellent X-13ARIMA-SEATS software, the Spanish SEATS algorithm and Christoph Sax's seasonal R package; and how to build a new "stat" for ggplot2 to make it easy to do seasonal adjustment on the fly for a graphic of a time series split by various grouping dimensions.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="calling-seasonal-adjustment-software-from-r">Calling seasonal adjustment software from R</h2>
<p>I recently explored for the first time (having languished on the “check this out later” list) <a href="http://www.christophsax.com/">Christoph Sax</a>’s excellent <a href="https://cran.r-project.org/web/packages/seasonal/index.html">{seasonal} R package</a>.  It makes it super easy for R users to engage with X-13ARIMA-SEATS, the latest industry standard software for time series analysis and in particular seasonal adjustment of official statistics series.  It’s a huge step forward in ease of use from the {x12} package which was a good interface to X-12ARIMA but never felt to me as R-native as {seasonal} does; I was always conscious of X-12ARIMA in the background.  For example, to control for Chinese New Year (important at my work), you had to save a text file with the relevant dates encoded in it, rather than pass it directly to the function in an R-native way.</p>

<p>{seasonal} calls on the latest US Census Bureau software X-13ARIMA-SEATS which has an <a href="https://www.census.gov/srd/www/x13as/">excellently informative website</a> and free downloads.  See the definitive <a href="https://www.census.gov/ts/x13as/docX13ASHTML.pdf">reference manual</a>.</p>

<p>To avoid confusion, some terminology:</p>

<ul>
  <li>ARIMA stands for “autoregressive integrated moving average” and is one of a class of models for time series</li>
  <li>X11, originally the name of software by the US Census Bureau and taken up by Statistics Canada, now usually refers to the X11 <em>method</em> for seasonal adjustment (or other inference) via ARIMA modelling first developed in the 1960s (Shiskin, Young and Musgrave in 1967)</li>
  <li>SEATS is Signal Extraction in ARIMA Time Series and is an alternative <em>method</em> for seasonal adjustment (or other inference) via ARIMA modelling, developed by Gomez and Maravall at Bank of Spain (various 1990s references)</li>
  <li>X13-ARIMA-SEATS is the US Census Bureau’s latest program that implements both the X11 and SEATS methods plus some additional diagnostic and model strategy tools</li>
  <li>{seasonal} is an R package that acts as a front end to X13-ARIMA-SEATS and gives all the needed functionality including both the X11 and SEATS methods without leaving the R environment</li>
</ul>

<h2 id="electronic-card-transactions-in-new-zealand">Electronic card transactions in New Zealand</h2>
<p>I’ll demonstrate this functionality generously made available by the US Census Bureau and Sax with <a href="http://www.stats.govt.nz/browse_for_stats/businesses/business_characteristics/electronic-card-transactions-info-releases.aspx">electronic card transactions spend in New Zealand, published by Statistics New Zealand</a>.  The data are published on a monthly basis from October 2002 to (at the time of writing) August 2015.</p>

<p>To get started I look at a single subset of the data, spend in millions of New Zealand dollars on apparel.  Here’s the basic data, its autocorrelation function, partial autocorrelation function, and  spectrum.</p>

<p><img src="/img/0014-apparel-ts-basics.svg" alt="basics" /></p>

<p>Key characteristics include:</p>

<ul>
  <li>there’s an obvious and unsurprising trend upwards - it’s not a stationary time series</li>
  <li>the variance increases as the series increases, so some form of transformation (probably logarithm, which I checked and works well) needed if we want methods where the variance doesn’t vary with the trend</li>
  <li>there’s a strong partial autocorrelation at 1.0 (ie annual, showing spend in a particular month is correlated with spend in the same month a year before) and at 1/12 (showing spend in a particular month is also correlated with spend in the immediately previous month).</li>
</ul>

<p>Here’s the code for downloading this data from where I’ve stashed a clean version (available for you all) and producing those basics:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="kn">library</span><span class="p">(</span>seasonal<span class="p">)</span>
<a name="True-2"></a><span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<a name="True-3"></a><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<a name="True-4"></a><span class="kn">library</span><span class="p">(</span>showtext<span class="p">)</span>
<a name="True-5"></a><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<a name="True-6"></a><span class="kn">library</span><span class="p">(</span>scales<span class="p">)</span>
<a name="True-7"></a>
<a name="True-8"></a><span class="c1"># set up fonts etc</span>
<a name="True-9"></a>font.add.google<span class="p">(</span><span class="s">&quot;Poppins&quot;</span><span class="p">,</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-10"></a>showtext.auto<span class="p">()</span>
<a name="True-11"></a>theme_set<span class="p">(</span>theme_light<span class="p">(</span>base_family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">))</span>
<a name="True-12"></a>
<a name="True-13"></a><span class="c1"># set path to X13-SEATS and check it&#39;s working</span>
<a name="True-14"></a><span class="kp">Sys.setenv</span><span class="p">(</span>X13_PATH <span class="o">=</span> <span class="s">&quot;c:/winx13/x13as&quot;</span><span class="p">)</span>
<a name="True-15"></a>checkX13<span class="p">()</span>
<a name="True-16"></a>
<a name="True-17"></a><span class="c1"># download file with data ultimately from Statistics New Zealand&#39;s Infoshare, prepared </span>
<a name="True-18"></a><span class="c1"># earlier: &quot;Values - Electronic card transactions A/S/T by industry group (Monthly)&quot;</span>
<a name="True-19"></a><span class="c1">#</span>
<a name="True-20"></a>download.file<span class="p">(</span><span class="s">&quot;https://github.com/ellisp/ellisp.github.io/blob/master/data/Electronic card transactions by industry group Monthly.rda?raw=true&quot;</span><span class="p">,</span>
<a name="True-21"></a>              mode <span class="o">=</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="c1"># ie binary</span>
<a name="True-22"></a>              destfile <span class="o">=</span> <span class="s">&quot;tmp.rda&quot;</span><span class="p">)</span>
<a name="True-23"></a><span class="kp">load</span><span class="p">(</span><span class="s">&quot;tmp.rda&quot;</span><span class="p">)</span>
<a name="True-24"></a><span class="kp">head</span><span class="p">(</span>ect<span class="p">)</span>
<a name="True-25"></a>
<a name="True-26"></a>apparel <span class="o">&lt;-</span> ect <span class="o">%&gt;%</span>
<a name="True-27"></a>   filter<span class="p">(</span>group <span class="o">==</span> <span class="s">&quot;Apparel&quot;</span><span class="p">)</span>
<a name="True-28"></a>
<a name="True-29"></a>apparel_ts <span class="o">&lt;-</span> ts<span class="p">(</span>apparel<span class="o">$</span>Value<span class="p">,</span> start <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">2002</span><span class="p">,</span> <span class="m">10</span><span class="p">),</span> frequency <span class="o">=</span> <span class="m">12</span><span class="p">)</span>
<a name="True-30"></a>
<a name="True-31"></a>par<span class="p">(</span>mfrow <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span> family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-32"></a>plot<span class="p">(</span>apparel_ts<span class="p">,</span> xlab <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<a name="True-33"></a>acf<span class="p">(</span>apparel_ts<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<a name="True-34"></a>pacf<span class="p">(</span>apparel_ts<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<a name="True-35"></a>spectrum<span class="p">(</span>apparel_ts<span class="p">,</span> main <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span></code></pre></div>

<p>Here’s the classic decomposition into trend, seasonal and random components that can be multiplied together to form the original series.  I use multiplicative decomposition because of the way the variance increases as the mean increases.
<img src="/img/0014-apparel-decompose.svg" alt="decomposition" /></p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>plot<span class="p">(</span>decompose<span class="p">(</span>apparel_ts<span class="p">,</span> type <span class="o">=</span> <span class="s">&quot;multiplicative&quot;</span><span class="p">))</span></code></pre></div>

<p>A simple form of seasonal adjustment can be performed by multiplying that trend value in the plot above by the random value which can be seen to hover around 1.0 (or, equivalently, dividing the original value by the seasonal values).  This is a bit simplistic however; most notably it means the multiplier for a month stays the same over time, which is unlikely to be true over longer periods (although it might be a reasonable approximation for this relatively short series).</p>

<h2 id="seats-seasonal-adjustment">SEATS seasonal adjustment</h2>
<p>To perform a more sophisticated seasonal adjustment it’s best to go to the best in breed software, which is the US Census’ X-13ARIMA-SEATS.  Sax’s seasonal package makes it super-easy to fit a model and extract the seasonally adjusted values and residuals for diagnostic purposes.  In fact it’s a one liner  - a call to seas(), which gives us very sensible defaults using the SEATS method:</p>

<ul>
  <li>automatically fits a seasonal ARIMA model based on the frequency defined in the ts object it is fed</li>
  <li>detects outliers and in effect leaves them out of the calculation of the seasonal effects (turns out not to be important in this dataset)</li>
  <li>detects any impact of number of trading days per month and Easter, and creates external regressors for them if necessary</li>
  <li>detects if a transformation is necessary and chooses a good one if necessary (in this case it opts for logarithmic as we’d guessed)</li>
</ul>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>mod <span class="o">&lt;-</span> seas<span class="p">(</span>apparel_ts<span class="p">)</span>
<a name="True-2"></a>
<a name="True-3"></a>plot<span class="p">(</span>mod<span class="p">)</span>
<a name="True-4"></a>plot<span class="p">(</span>resid<span class="p">(</span>mod<span class="p">),</span> main <span class="o">=</span> <span class="s">&quot;Residuals&quot;</span><span class="p">)</span>
<a name="True-5"></a>qqnorm<span class="p">(</span>resid<span class="p">(</span>mod<span class="p">),</span> main <span class="o">=</span> <span class="s">&quot;Residuals compared to Normal&quot;</span><span class="p">)</span>
<a name="True-6"></a>pacf<span class="p">(</span>resid<span class="p">(</span>mod<span class="p">),</span> <span class="s">&quot;Partial ACF of residuals&quot;</span><span class="p">)</span></code></pre></div>

<p><img src="/img/0014-apparel-ts-seats.svg" alt="SEATS" /></p>

<p>Super simple.</p>

<p>The main reasons we’re doing this from R rather than hand coding a X-13 .spc file are:</p>

<ul>
  <li>its data management ease and flexibility,</li>
  <li>access to a wide class of analytical functions (as used in my initial explorations), and</li>
  <li>graphics.</li>
</ul>

<p>So the basic workflow will be to take the results from our SEATS model and manipulate them in R for re-use, whether performing diagnostic statistical tests or just visuals to understand the data.  For example, the connected scatter plot below lets us see how the original values get adjusted down (those in the right bottom triangle of the plot) or up (those in the left upper triangle) in the seasonal adjustment process.</p>

<p><img src="/img/0014-apparel-compare.svg" alt="compare" /></p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>apparel_sa <span class="o">&lt;-</span> <span class="kt">data_frame</span><span class="p">(</span>
<a name="True-2"></a>   Time <span class="o">=</span> time<span class="p">(</span>apparel_ts<span class="p">),</span>
<a name="True-3"></a>   Original <span class="o">=</span> apparel_ts<span class="p">,</span>
<a name="True-4"></a>   SA <span class="o">=</span> final<span class="p">(</span>mod<span class="p">))</span>
<a name="True-5"></a>
<a name="True-6"></a>ggplot<span class="p">(</span>apparel_sa<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> Original<span class="p">,</span> y <span class="o">=</span> SA<span class="p">,</span> colour <span class="o">=</span> Time<span class="p">))</span> <span class="o">+</span>
<a name="True-7"></a>   geom_abline<span class="p">(</span>intercept <span class="o">=</span> <span class="m">0</span><span class="p">,</span> slope <span class="o">=</span> <span class="m">1</span><span class="p">,</span> colour <span class="o">=</span> <span class="s">&quot;grey50&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-8"></a>   geom_path<span class="p">()</span> <span class="o">+</span>
<a name="True-9"></a>   geom_point<span class="p">()</span> <span class="o">+</span>
<a name="True-10"></a>   coord_equal<span class="p">()</span> <span class="o">+</span>
<a name="True-11"></a>   scale_x_continuous<span class="p">(</span><span class="s">&quot;Original ($m)&quot;</span><span class="p">,</span> label <span class="o">=</span> dollar<span class="p">)</span> <span class="o">+</span>
<a name="True-12"></a>   scale_y_continuous<span class="p">(</span><span class="s">&quot;Seasonally adjusted ($m)&quot;</span><span class="p">,</span> label <span class="o">=</span> dollar<span class="p">)</span> <span class="o">+</span>
<a name="True-13"></a>   ggtitle<span class="p">(</span><span class="s">&quot;Comparison of original and seasonally adjusted\n electronic card transactions on apparel in New Zealand&quot;</span><span class="p">)</span></code></pre></div>

<p>In fact, Sax provides a super-useful inspect() function that spins up a Shiny app that lets you interact with all the key settings and diagnostics.  I can’t show that here though as I don’t have access to a server with X-13ARIMA-SEATS and Shiny Server on it (couldn’t run it on shinyapps.io at this point for example, because of the requirement for the X-13ARIMA-SEATS software).</p>

<p>For those interested in the actual results, the standard summary is shown below.  Months with more Fridays and Saturdays in them get increased spend on apparel (something I hadn’t expected, but I guess I hadn’t thought about it very much); months with Easter in them get less spending; and the randomness can be modelled adequately with integration of order 1 and a moving average for both the month to month change, and the year-on-year month comparison:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="o">&gt;</span> <span class="kp">summary</span><span class="p">(</span>mod<span class="p">)</span>
<a name="True-2"></a>
<a name="True-3"></a>Call<span class="o">:</span>
<a name="True-4"></a>seas<span class="p">(</span>x <span class="o">=</span> apparel_ts<span class="p">)</span>
<a name="True-5"></a>
<a name="True-6"></a>Coefficients<span class="o">:</span>
<a name="True-7"></a>                    Estimate Std. Error z value Pr<span class="p">(</span><span class="o">&gt;|</span>z<span class="o">|</span><span class="p">)</span>    
<a name="True-8"></a>Mon               <span class="m">-0.0042437</span>  <span class="m">0.0042013</span>  <span class="m">-1.010</span> <span class="m">0.312446</span>    
<a name="True-9"></a>Tue               <span class="m">-0.0005243</span>  <span class="m">0.0041054</span>  <span class="m">-0.128</span> <span class="m">0.898375</span>    
<a name="True-10"></a>Wed               <span class="m">-0.0049353</span>  <span class="m">0.0040414</span>  <span class="m">-1.221</span> <span class="m">0.222013</span>    
<a name="True-11"></a>Thu               <span class="m">-0.0037071</span>  <span class="m">0.0041312</span>  <span class="m">-0.897</span> <span class="m">0.369540</span>    
<a name="True-12"></a>Fri                <span class="m">0.0150563</span>  <span class="m">0.0040701</span>   <span class="m">3.699</span> <span class="m">0.000216</span> <span class="o">***</span>
<a name="True-13"></a>Sat                <span class="m">0.0153981</span>  <span class="m">0.0041104</span>   <span class="m">3.746</span> <span class="m">0.000180</span> <span class="o">***</span>
<a name="True-14"></a>Easter<span class="p">[</span><span class="m">1</span><span class="p">]</span>         <span class="m">-0.0407969</span>  <span class="m">0.0085273</span>  <span class="m">-4.784</span> <span class="m">1.72e-06</span> <span class="o">***</span>
<a name="True-15"></a>MA<span class="o">-</span>Nonseasonal<span class="m">-01</span>  <span class="m">0.6739188</span>  <span class="m">0.0611324</span>  <span class="m">11.024</span>  <span class="o">&lt;</span> <span class="m">2e-16</span> <span class="o">***</span>
<a name="True-16"></a>MA<span class="o">-</span>Seasonal<span class="m">-12</span>     <span class="m">0.6326280</span>  <span class="m">0.0671190</span>   <span class="m">9.425</span>  <span class="o">&lt;</span> <span class="m">2e-16</span> <span class="o">***</span>
<a name="True-17"></a><span class="o">---</span>
<a name="True-18"></a>Signif. codes<span class="o">:</span>  <span class="m">0</span> ‘<span class="o">***</span>’ <span class="m">0.001</span> ‘<span class="o">**</span>’ <span class="m">0.01</span> ‘<span class="o">*</span>’ <span class="m">0.05</span> ‘<span class="m">.</span>’ <span class="m">0.1</span> ‘ ’ <span class="m">1</span>
<a name="True-19"></a>
<a name="True-20"></a>SEATS adj.  ARIMA<span class="o">:</span> <span class="p">(</span><span class="m">0</span> <span class="m">1</span> <span class="m">1</span><span class="p">)(</span><span class="m">0</span> <span class="m">1</span> <span class="m">1</span><span class="p">)</span>  Obs.<span class="o">:</span> <span class="m">155</span>  Transform<span class="o">:</span> <span class="kp">log</span>
<a name="True-21"></a>AICc<span class="o">:</span> <span class="m">949.3</span><span class="p">,</span> BIC<span class="o">:</span> <span class="m">977.1</span>  QS <span class="p">(</span>no seasonality <span class="kr">in</span> final<span class="p">)</span><span class="o">:</span>    <span class="m">0</span>  
<a name="True-22"></a>Box<span class="o">-</span>Ljung <span class="p">(</span>no autocorr.<span class="p">)</span><span class="o">:</span>  <span class="m">23.7</span>   Shapiro <span class="p">(</span>normality<span class="p">)</span><span class="o">:</span> <span class="m">0.9963</span></code></pre></div>

<p>Here’s how I turn the output into a ggplot2 graphic:
<img src="/img/0014-apparel-adjusted-ggplot.svg" alt="compare" /></p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>apparel_sa <span class="o">%&gt;%</span>
<a name="True-2"></a>   gather<span class="p">(</span><span class="s">&quot;variable&quot;</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="p">,</span> <span class="o">-</span>Time<span class="p">)</span> <span class="o">%&gt;%</span> 
<a name="True-3"></a>   mutate<span class="p">(</span>variable <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;SA&quot;</span><span class="p">,</span> <span class="s">&quot;Seasonally adjusted by SEATS&quot;</span><span class="p">,</span> variable<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-4"></a>   ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> Time<span class="p">,</span> y <span class="o">=</span> value<span class="p">,</span> colour <span class="o">=</span> variable<span class="p">))</span> <span class="o">+</span>
<a name="True-5"></a>   geom_line<span class="p">()</span> <span class="o">+</span>
<a name="True-6"></a>   labs<span class="p">(</span>colour <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> x <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-7"></a>   scale_y_continuous<span class="p">(</span><span class="s">&quot;Value of transactions ($m)&quot;</span><span class="p">,</span> label <span class="o">=</span> dollar<span class="p">)</span> <span class="o">+</span>
<a name="True-8"></a>   ggtitle<span class="p">(</span><span class="s">&quot;Electronic card transactions on apparel in New Zealand&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-9"></a>   theme<span class="p">(</span>legend.position <span class="o">=</span> <span class="s">&quot;bottom&quot;</span><span class="p">)</span></code></pre></div>

<h2 id="create-a-new-ggplot2-stat">Create a new ggplot2 stat</h2>
<p>So that’s nice, but to make this feel super useful and integrate into my graphics-based data exploration workflow, I’m going to want to seasonally adjust on the fly a dataset that is sliced and diced by different dimensions.  I want something that works like geom_smooth().  Luckily, Hadley Wickham’s amazing ggplot2 package is designed to allow exactly this sort of extension.  We just need to create a new statistical transformation, with the help of the proto package which lets us briefly treat R as though it were an object-oriented programming language.</p>

<p>In the code below, StatSeas is an object that creates functions, and stat_seas(…) is a function that works just like stat_smooth(), except instead of fitting a scatter plot smoother it performs a call to X-13ARIMA-SEATS with whatever arguments the user has passed through with the ….  The user has to specify the frequency and the starting point of the time series, and the approach isn’t robust to missing values (ie all the time series after slicing into groups need to begin at the same date).</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="kn">library</span><span class="p">(</span>proto<span class="p">)</span>
<a name="True-2"></a>
<a name="True-3"></a>StatSeas <span class="o">&lt;-</span> proto<span class="p">(</span>ggplot2<span class="o">:::</span>Stat<span class="p">,</span> <span class="p">{</span>    
<a name="True-4"></a>   required_aes <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">)</span>
<a name="True-5"></a>   default_geom <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="m">.</span><span class="p">)</span> GeomLine
<a name="True-6"></a>   objname <span class="o">&lt;-</span> <span class="s">&quot;seasadj&quot;</span>
<a name="True-7"></a>   calculate_groups <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="m">.</span><span class="p">,</span> data<span class="p">,</span> scales<span class="p">,</span> <span class="kc">...</span><span class="p">){</span>
<a name="True-8"></a>      <span class="m">.</span>super<span class="o">$</span>calculate_groups<span class="p">(</span><span class="m">.</span><span class="p">,</span> data<span class="p">,</span> scales<span class="p">,</span> <span class="kc">...</span><span class="p">)</span>
<a name="True-9"></a>   <span class="p">}</span>
<a name="True-10"></a>   calculate <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="m">.</span><span class="p">,</span> data<span class="p">,</span> scales<span class="p">,</span> frequency<span class="p">,</span> start<span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
<a name="True-11"></a>      y_ts <span class="o">&lt;-</span> ts<span class="p">(</span>data<span class="o">$</span>y<span class="p">,</span> frequency <span class="o">=</span> frequency<span class="p">,</span> start <span class="o">=</span> start<span class="p">)</span>
<a name="True-12"></a>      y_sa <span class="o">&lt;-</span> seasonal<span class="o">::</span>final<span class="p">(</span>seasonal<span class="o">::</span>seas<span class="p">(</span>y_ts<span class="p">,</span> <span class="kc">...</span><span class="p">))</span>
<a name="True-13"></a>      result <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> data<span class="o">$</span>x<span class="p">,</span> y <span class="o">=</span> <span class="kp">as.numeric</span><span class="p">(</span>y_sa<span class="p">))</span>
<a name="True-14"></a>      <span class="kr">return</span><span class="p">(</span>result<span class="p">)</span>
<a name="True-15"></a>   <span class="p">}</span>
<a name="True-16"></a><span class="p">})</span> 
<a name="True-17"></a>stat_seas <span class="o">&lt;-</span> StatSeas<span class="o">$</span>new</code></pre></div>

<p>Here’s the new function in action:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>ggplot<span class="p">(</span>apparel<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> TimePeriod<span class="p">,</span> y <span class="o">=</span> Value<span class="p">))</span> <span class="o">+</span>
<a name="True-2"></a>   <span class="c1"># original:</span>
<a name="True-3"></a>   geom_line<span class="p">(</span>colour <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-4"></a>   <span class="c1"># seasonally adjusted:</span>
<a name="True-5"></a>   stat_seas<span class="p">(</span>frequency <span class="o">=</span> <span class="m">12</span><span class="p">,</span> start <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">2002</span><span class="p">,</span> <span class="m">10</span><span class="p">))</span></code></pre></div>

<p><img src="/img/0014-apparel-ts-new-stat.svg" alt="compare" /></p>

<p>Nice and easy!</p>

<p>But the real beauty is that we can use this on data that is grouped by aesthetics like colour or linetype, or facets.  I demo this by going back to the full set of data of which spend on apparel was just one element.  The eight lines of code below take the original data, fit SEATS models and seasonally adjust for every spend category, and produce a nicely polished plot.  Not bad!</p>

<p>Thanks Hadley Wickham for {ggplot2}, Christoph Sax for {seasonal}, the US Census Bureau for X-13ARIMA-SEATS, and the Bank of Spain for the SEATS method.
<img src="/img/0014-faceted.svg" alt="faceted" /></p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>ect <span class="o">%&gt;%</span>
<a name="True-2"></a>   ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> TimePeriod<span class="p">,</span> y <span class="o">=</span> Value<span class="p">,</span> colour <span class="o">=</span> group<span class="p">))</span> <span class="o">+</span>
<a name="True-3"></a>   geom_line<span class="p">(</span>alpha <span class="o">=</span> <span class="m">0.3</span><span class="p">)</span> <span class="o">+</span>
<a name="True-4"></a>   stat_seas<span class="p">(</span>frequency <span class="o">=</span> <span class="m">12</span><span class="p">,</span> start <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1978</span><span class="p">,</span> <span class="m">4</span><span class="p">))</span> <span class="o">+</span>
<a name="True-5"></a>   facet_wrap<span class="p">(</span> <span class="o">~</span> group<span class="p">,</span> scales <span class="o">=</span> <span class="s">&quot;free_y&quot;</span><span class="p">,</span> ncol <span class="o">=</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span>
<a name="True-6"></a>   labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&quot;SEATS-seasonally adjusted monthly transaction value ($m)&quot;</span><span class="p">,</span>
<a name="True-7"></a>        title <span class="o">=</span> <span class="s">&quot;Electronic card transactions in New Zealand&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-8"></a>   theme<span class="p">(</span>legend.position <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">)</span></code></pre></div>

<p>Note - Statistics New Zealand publish an official seasonally adjusted series from this data, making the exercise above redundant other than as a demonstration.  Where their results differ from mine (which is only in tiny details - I checked but decided too boring to include in here), use their’s not mine.</p>


</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2015/10/04/recruiting">
        <p>&larr; Older</p>
        <p>Recruiting Analysts for dynamic cutting edge public sector team</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2015/10/25/silver">
        <p>Newer &rarr;</p>
        <p>Silver flows in the seventeenth and eighteenth centuries</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
            <p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
	
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="/" property="cc:attributionName" rel="cc:attributionURL">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.


			</footer>
    </div>



  
</body>
</html>
   




         
