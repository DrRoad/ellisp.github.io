      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Network charts of commuting in New Zealand with R and D3</title>
      	
         
         
            <meta name ="description" content ="Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.">
            <meta property="og:description" content ="Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Network charts of commuting in New Zealand with R and D3" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0025-commuting.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2015/12/26/commuting-network/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">       
     <link rel="stylesheet" href="/css/Pygments/autumn.css">      
     <link rel="stylesheet" href="/css/Pygments/custom.css">      
            
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
         <script src="/js/bootstrap.min.js"></script>
         
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/04/04/nzelect2>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Network charts of commuting in New Zealand with R and D3</h1>
         <p class="meta">26 Dec 2015</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   Commuting patterns between districts and cities in New Zealand are used to illustrate static (for printing) and interactive (for the web) network charts with R and D3.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="commuting-between-districts-and-cities-in-new-zealand">Commuting between districts and cities in New Zealand</h2>
<iframe src="/img/0025-networkD3.html" style="overflow-y: hidden;" width="100%" height="430px"></iframe>

<p>At this year’s New Zealand Statisticians Association conference I gave a talk on <a href="http://www.mbie.govt.nz/info-services/sectors-industries/regions-cities/research/modelled-territorial-authority-gross-domestic-product">Modelled Territorial Authority Gross Domestic Product</a>.  One thing I’d talked about was the impact on the estimates of people residing in one Territorial Authority (district or city) but working in another one.  This was important because data on earnings  by place of residence formed a crucial step in those particular estimates of modelled GDP, which needs to be based on place of production.  I had a slide to visualise the “commuting patterns”, which I’d prepared for that talk but isn’t used elsewhere, and thought I’d share it and a web version here on this blog.</p>

<p>The web version is the one in the frame above this text.  It’s designed to be interacted with - try hovering over circles, or picking them up and dragging them around.</p>

<h2 id="data">Data</h2>
<p>The source data for this come from 2013 Census and are <a href="http://www.stats.govt.nz/Census/2013-census/profile-and-summary-reports/commuter-view-visualisation.aspx">published by Statistics New Zealand</a>, who have their own <a href="http://www.stats.govt.nz/datavisualisation/commuterview/index.html">rather nifty map-based visualisation</a>.  The data are published on the visualisation’s information page and it’s easy to grab the CSV and tidy it up in R:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<a name="True-2"></a><span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<a name="True-3"></a><span class="kn">library</span><span class="p">(</span>showtext<span class="p">)</span>
<a name="True-4"></a><span class="kn">library</span><span class="p">(</span>igraph<span class="p">)</span>
<a name="True-5"></a><span class="kn">library</span><span class="p">(</span>networkD3<span class="p">)</span>
<a name="True-6"></a>
<a name="True-7"></a><span class="c1"># import fonts</span>
<a name="True-8"></a>font.add.google<span class="p">(</span><span class="s">&quot;Poppins&quot;</span><span class="p">,</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-9"></a>showtext.auto<span class="p">()</span>
<a name="True-10"></a>
<a name="True-11"></a><span class="c1"># download data from Statistics New Zealand</span>
<a name="True-12"></a>X <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;http://www.stats.govt.nz/~/media/Statistics/Census/2013%20Census/profile-and-summary-reports/commuter-view-interactive/2013-usual-residence-by-workplace-address-territorial-authority.csv&quot;</span><span class="p">,</span>
<a name="True-13"></a>              na.strings       <span class="o">=</span> <span class="s">&quot;..C&quot;</span><span class="p">,</span>
<a name="True-14"></a>              sep              <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">,</span>
<a name="True-15"></a>              stringsAsFactors <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
<a name="True-16"></a>              check.names      <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
<a name="True-17"></a>              header           <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<a name="True-18"></a>
<a name="True-19"></a><span class="c1"># Tidy into long form, remove clutter, make names consistent, </span>
<a name="True-20"></a><span class="c1"># drop uninteresting data:</span>
<a name="True-21"></a>TravelAll <span class="o">&lt;-</span> X<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">67</span><span class="p">,</span> <span class="p">]</span> <span class="o">%&gt;%</span> 
<a name="True-22"></a>  rename<span class="p">(</span>from <span class="o">=</span> Usual.residence<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-23"></a>  gather<span class="p">(</span>to<span class="p">,</span> value<span class="p">,</span> <span class="o">-</span>from<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-24"></a>  mutate<span class="p">(</span>from <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; District&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> from<span class="p">),</span>
<a name="True-25"></a>         from <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; City&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> from<span class="p">),</span>
<a name="True-26"></a>         from <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; Territory&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> from<span class="p">),</span>
<a name="True-27"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> to<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
<a name="True-28"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; Territory&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> to<span class="p">),</span>
<a name="True-29"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; District&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> to<span class="p">),</span>
<a name="True-30"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; City&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> to<span class="p">),</span>
<a name="True-31"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Hawke s&quot;</span><span class="p">,</span> <span class="s">&quot;Hawke&#39;s&quot;</span><span class="p">,</span> to<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
<a name="True-32"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Matamata Piako&quot;</span><span class="p">,</span> <span class="s">&quot;Matamata-Piako&quot;</span><span class="p">,</span> to<span class="p">),</span>
<a name="True-33"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Queenstown Lakes&quot;</span><span class="p">,</span> <span class="s">&quot;Queenstown-Lakes&quot;</span><span class="p">,</span> to<span class="p">),</span>
<a name="True-34"></a>         to <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Thames Coromandel&quot;</span><span class="p">,</span> <span class="s">&quot;Thames-Coromandel&quot;</span><span class="p">,</span> to<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-35"></a>  filter<span class="p">(</span>from <span class="o">!=</span> to <span class="o">&amp;</span>
<a name="True-36"></a>           to <span class="o">!=</span> <span class="s">&quot;Total workplace address&quot;</span> <span class="o">&amp;</span>
<a name="True-37"></a>           to <span class="o">!=</span> <span class="s">&quot;No Fixed Workplace Address&quot;</span> <span class="o">&amp;</span>
<a name="True-38"></a>           to <span class="o">!=</span> <span class="s">&quot;Area Outside Territorial Authority&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-39"></a>  filter<span class="p">(</span><span class="o">!</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;Not Further Defined&quot;</span><span class="p">,</span> to<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-40"></a>  mutate<span class="p">(</span>value <span class="o">=</span> <span class="kp">as.numeric</span><span class="p">(</span>value<span class="p">),</span>
<a name="True-41"></a>         value <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span><span class="kp">is.na</span><span class="p">(</span>value<span class="p">),</span> <span class="m">0</span><span class="p">,</span> value<span class="p">))</span> 
<a name="True-42"></a>
<a name="True-43"></a><span class="c1"># subset dropping the small values:  </span>
<a name="True-44"></a>Travel <span class="o">&lt;-</span> TravelAll <span class="o">%&gt;%</span> 
<a name="True-45"></a>  filter<span class="p">(</span>value <span class="o">&gt;</span> <span class="m">100</span><span class="p">)</span></code></pre></div>

<h2 id="drawing-a-static-plot">Drawing a static plot</h2>
<p><img src="/img/0025-commuting.svg" alt="static" />
The static plot I used in my presentation is made with the excellent <a href="https://cran.r-project.org/web/packages/igraph/index.html">{igraph} package</a> by Gabor Csadi.  There are lots of options for layouts; not being an expert in network graphs I used trial and error until I got something sufficiently visually striking.  Note that the locations of districts and cities are chosen to maximise use of white space given the various connections between them - they don’t represent physical locations (which is possible, but less impact for my purpose).</p>

<p>The eventual code is simple enough.  The “Travel” object I created in the previous chunk of code is in the right shape, with its “from” and “to” columns enough to define both the nodes and edges (ie links connecting nodes), and the “value” column is used to define the width of each edge.  There was a bit of finesse required with size and font settings to get it looking useful.  As it sits, it’s still difficult to tell which way the arrows are pointing (most relationships are both ways of course, and all the arrows merge together into blobs for significant “target” authorities like Auckland), but it gets the job down of picturing which districts and cities are linked to which.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>draw_plot <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>seed <span class="o">=</span> <span class="m">125</span><span class="p">){</span>
<a name="True-2"></a>   <span class="kp">set.seed</span><span class="p">(</span>seed<span class="p">)</span> <span class="c1"># there&#39;s some randomness in the graphing layout</span>
<a name="True-3"></a>   g <span class="o">&lt;-</span> Travel  <span class="o">%&gt;%</span>
<a name="True-4"></a>      graph.data.frame<span class="p">(</span>directed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>       
<a name="True-5"></a>   par<span class="p">(</span>family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">,</span> mai <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">.2</span><span class="p">,</span> <span class="m">.2</span><span class="p">,</span> <span class="m">.2</span><span class="p">,</span> <span class="m">.2</span><span class="p">))</span>  
<a name="True-6"></a>   plot<span class="p">(</span>g<span class="p">,</span> edge.arrow.size <span class="o">=</span> <span class="m">.4</span><span class="p">,</span> layout <span class="o">=</span> layout.davidson.harel<span class="p">,</span>
<a name="True-7"></a>        edge.width <span class="o">=</span> <span class="kp">sqrt</span><span class="p">(</span>Travel<span class="o">$</span>value<span class="p">)</span> <span class="o">/</span> <span class="m">20</span><span class="p">,</span>
<a name="True-8"></a>        vertex.size <span class="o">=</span> <span class="m">0</span><span class="p">,</span> edge.curved <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
<a name="True-9"></a>        vertex.label.family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">,</span>
<a name="True-10"></a>        vertex.label.cex <span class="o">=</span> <span class="m">.8</span><span class="p">,</span>
<a name="True-11"></a>        main <span class="o">=</span> <span class="s">&quot;Commuting patterns 2013 (&gt;100 people commuting)&quot;</span>
<a name="True-12"></a>   <span class="p">)</span>          
<a name="True-13"></a><span class="p">}</span></code></pre></div>

<h2 id="drawing-an-interactive-plot">Drawing an interactive plot</h2>
<iframe src="/img/0025-networkD3.html" style="overflow-y: hidden;" width="100%" height="430px"></iframe>

<p>The interactive plot is a bit fiddlier, but still a fairly straightforward task with the help of the <a href="https://cran.r-project.org/web/packages/networkD3/index.html">{networkD3} package</a> by Christopher Gandrud et al.  This package uses the <a href="http://www.htmlwidgets.org/">htmlwidgets paradigm</a> to make JavaScript D3 network graph visualisations easy to create.  This gives us access to the data management and analysis capabilities of R as well as the web visualisations of JavaScript.</p>

<p>There’s a bit of extra work to be done here and it’s not quite such an R-native feel as using {igraph}.  Most significantly, JavaScript (like most computer languages I know other than R) indexes its arrays starting at zero, not one, and the data frame that holds the “from” and “to” information for the edges needs to refer to nodes by number from zero to (n - 1).  There are many ways to do this but I find the easiest is to use Wickham’s dplyr pipeline - as in the code that creates the “Links” data frame below.  Note that I’m also classifying the territorial authorities by island.</p>

<p>One of the strengths of an interactive plot is we can impart extra information by hover-over tooltips that would be way too cluttered in a static chart.  In this case, I’ve done a slightly ugly summary of an authority’s total “to” and “from” movements from residence to place of work.  The code below creating “froms”, “tos”, “both” and “TAs” data frames is for this purpose, so the “label” column can be used in the visualisation for the actual tooltips.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="c1"># vector of south island districts so we can colour nodes by island:</span>
<a name="True-2"></a>southisland <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;Dunedin&quot;</span><span class="p">,</span> <span class="s">&quot;Tasman&quot;</span><span class="p">,</span> <span class="s">&quot;Nelson&quot;</span><span class="p">,</span> <span class="s">&quot;Marlborough&quot;</span><span class="p">,</span> <span class="s">&quot;Christchurch&quot;</span><span class="p">,</span> 
<a name="True-3"></a>                 <span class="s">&quot;Queenstown-Lakes&quot;</span><span class="p">,</span> <span class="s">&quot;Invercargill&quot;</span><span class="p">,</span> <span class="s">&quot;Grey&quot;</span><span class="p">,</span>
<a name="True-4"></a>                 <span class="s">&quot;Westland&quot;</span><span class="p">,</span> <span class="s">&quot;Waimakariri&quot;</span><span class="p">,</span> <span class="s">&quot;Hurunui&quot;</span><span class="p">,</span> <span class="s">&quot;Selwyn&quot;</span><span class="p">,</span>
<a name="True-5"></a>                 <span class="s">&quot;Ashburton&quot;</span><span class="p">,</span> <span class="s">&quot;Timaru&quot;</span><span class="p">,</span> <span class="s">&quot;Mackenzie&quot;</span><span class="p">,</span> <span class="s">&quot;Waimate&quot;</span><span class="p">,</span> <span class="s">&quot;Central Otago&quot;</span><span class="p">,</span>
<a name="True-6"></a>                 <span class="s">&quot;Waitaki&quot;</span><span class="p">,</span> <span class="s">&quot;Clutha&quot;</span><span class="p">,</span> <span class="s">&quot;Gore&quot;</span><span class="p">,</span> <span class="s">&quot;Southland&quot;</span><span class="p">,</span> <span class="s">&quot;Buller&quot;</span><span class="p">)</span>
<a name="True-7"></a>
<a name="True-8"></a><span class="c1"># create a look up table of TA names and ID 0:(n-1)</span>
<a name="True-9"></a>TAs <span class="o">&lt;-</span> <span class="kt">data_frame</span><span class="p">(</span>TA <span class="o">=</span> <span class="kp">unique</span><span class="p">(</span><span class="kt">c</span><span class="p">(</span>Travel<span class="o">$</span>from<span class="p">,</span> Travel<span class="o">$</span>to<span class="p">)))</span> 
<a name="True-10"></a>TAs <span class="o">&lt;-</span> TAs <span class="o">%&gt;%</span>
<a name="True-11"></a>   mutate<span class="p">(</span>ID <span class="o">=</span> <span class="m">0</span><span class="o">:</span><span class="p">(</span><span class="kp">nrow</span><span class="p">(</span>TAs<span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">),</span>
<a name="True-12"></a>          size <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
<a name="True-13"></a>          island <span class="o">=</span> <span class="kp">ifelse</span><span class="p">(</span>TA <span class="o">%in%</span> southisland<span class="p">,</span> <span class="s">&quot;South Island&quot;</span><span class="p">,</span> <span class="s">&quot;North Island&quot;</span><span class="p">))</span>
<a name="True-14"></a>
<a name="True-15"></a><span class="c1"># create a data frame with numbers 0 : n-1 instead of names of TAS          </span>
<a name="True-16"></a>Links <span class="o">&lt;-</span> Travel <span class="o">%&gt;%</span>
<a name="True-17"></a>   left_join<span class="p">(</span>TAs<span class="p">,</span> by <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;from&quot;</span> <span class="o">=</span> <span class="s">&quot;TA&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-18"></a>   select<span class="p">(</span><span class="o">-</span>from<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-19"></a>   rename<span class="p">(</span>from <span class="o">=</span> ID<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-20"></a>   left_join<span class="p">(</span>TAs<span class="p">,</span> by <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;to&quot;</span> <span class="o">=</span> <span class="s">&quot;TA&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-21"></a>   select<span class="p">(</span><span class="o">-</span>to<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-22"></a>   rename<span class="p">(</span>to <span class="o">=</span> ID<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-23"></a>   mutate<span class="p">(</span>value <span class="o">=</span> value <span class="o">/</span> <span class="m">200</span><span class="p">)</span>
<a name="True-24"></a>   
<a name="True-25"></a><span class="c1"># create some totals for more informative tooltips:</span>
<a name="True-26"></a>froms <span class="o">&lt;-</span> TravelAll <span class="o">%&gt;%</span>
<a name="True-27"></a>   group_by<span class="p">(</span>from<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-28"></a>   summarise<span class="p">(</span>From <span class="o">=</span> <span class="kp">sum</span><span class="p">(</span>value<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-29"></a>   ungroup<span class="p">()</span> <span class="o">%&gt;%</span>
<a name="True-30"></a>   rename<span class="p">(</span>TA <span class="o">=</span> from<span class="p">)</span>
<a name="True-31"></a>
<a name="True-32"></a>tos <span class="o">&lt;-</span> TravelAll <span class="o">%&gt;%</span>
<a name="True-33"></a>   group_by<span class="p">(</span>to<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-34"></a>   summarise<span class="p">(</span>To <span class="o">=</span> <span class="kp">sum</span><span class="p">(</span>value<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-35"></a>   ungroup<span class="p">()</span> <span class="o">%&gt;%</span>
<a name="True-36"></a>   rename<span class="p">(</span>TA <span class="o">=</span> to<span class="p">)</span>
<a name="True-37"></a>
<a name="True-38"></a>both <span class="o">&lt;-</span> full_join<span class="p">(</span>froms<span class="p">,</span> tos<span class="p">,</span> by <span class="o">=</span> <span class="s">&quot;TA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-39"></a>   mutate<span class="p">(</span>label <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span>TA<span class="p">,</span> <span class="s">&quot;. From: &quot;</span><span class="p">,</span> From<span class="p">,</span> <span class="s">&quot;; To: &quot;</span><span class="p">,</span> To<span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">))</span> 
<a name="True-40"></a>
<a name="True-41"></a>TAs <span class="o">&lt;-</span> TAs <span class="o">%&gt;%</span>
<a name="True-42"></a>   left_join<span class="p">(</span>both<span class="p">,</span> by <span class="o">=</span> <span class="s">&quot;TA&quot;</span><span class="p">)</span></code></pre></div>

<p>Drawing a good looking network chart is easy enough, and just a matter of getting the data in the right shape and telling the forceNetwork() R function which columns to use as Source and Target for each edge / link, and which columns of a second data frame to use for Group (which controls colour), Nodesize, and NodeID (which controls the mouse hover tooltips).  Controlling colours requires us to create a D3 scale as a palette which needs a bit of basic JavaScript, which gets passed to forceNetwork via the colourScale = JS(…) snippet below.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>pal <span class="o">&lt;-</span> <span class="s">&#39;d3.scale.ordinal()</span>
<a name="True-2"></a><span class="s">         .domain([&quot;South Island&quot;, &quot;North Island&quot;])</span>
<a name="True-3"></a><span class="s">         .range([&quot;#FF6900&quot;, &quot;#694489&quot;]);&#39;</span>
<a name="True-4"></a>
<a name="True-5"></a>net <span class="o">&lt;-</span> forceNetwork<span class="p">(</span>Links<span class="p">,</span> Source <span class="o">=</span> <span class="s">&quot;from&quot;</span><span class="p">,</span> Target <span class="o">=</span> <span class="s">&quot;to&quot;</span><span class="p">,</span> Value <span class="o">=</span> <span class="s">&quot;value&quot;</span><span class="p">,</span> 
<a name="True-6"></a>             Nodes <span class="o">=</span> TAs<span class="p">,</span> NodeID <span class="o">=</span> <span class="s">&quot;label&quot;</span><span class="p">,</span> Nodesize <span class="o">=</span> <span class="s">&quot;size&quot;</span><span class="p">,</span> Group <span class="o">=</span> <span class="s">&quot;island&quot;</span><span class="p">,</span>
<a name="True-7"></a>             fontFamily <span class="o">=</span> <span class="s">&quot;Poppins&quot;</span><span class="p">,</span> height <span class="o">=</span> <span class="m">350</span><span class="p">,</span> width <span class="o">=</span> <span class="m">650</span><span class="p">,</span> bounded <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
<a name="True-8"></a>             colourScale <span class="o">=</span> JS<span class="p">(</span>pal<span class="p">))</span>
<a name="True-9"></a>
<a name="True-10"></a>saveNetwork<span class="p">(</span>net<span class="p">,</span> <span class="s">&quot;../img/0025-networkD3.html&quot;</span><span class="p">,</span> selfcontained <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span></code></pre></div>

<p>In the code above I’ve saved the resulting HTML to a file (and folders containing the various other assets eg JavaScript).  This file is basically ready to go, but as a final touch I want to insert a line into the header, just above the &lt;/head&gt; tag, calling in the Cascading Style Sheets used in my blog, including the “Poppins” font from Google Fonts.  You’ll have seen in the code above that I told the D3 network chart to use Poppins font, but unless it knows where to find it it can’t do anything with this.  I also wanted to insert a heading into the body; my intended use for this HTML page was to be placed in an iframe in this blog post, and for visual coherence it needs a heading inside the iframe.</p>

<p>So I read the HTML back into R, insert the lines I want by find and replace with the gsub() function, and write it back to file, and I’ve managed to avoid editing any HTML by hand (useful if there are going to be lots of iterations during development).</p>

<p>These last few snippets of code would need to be adapted to your particular folder structure, fonts and CSS if you want to copy them.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>tmp <span class="o">&lt;-</span> <span class="kp">readLines</span><span class="p">(</span><span class="s">&quot;../img/0025-networkD3.html&quot;</span><span class="p">)</span>
<a name="True-2"></a>
<a name="True-3"></a>tmp <span class="o">&lt;-</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&#39;&lt;/head&gt;&#39;</span><span class="p">,</span> 
<a name="True-4"></a>            <span class="s">&#39;&lt;link href=&quot;/css/bootstrap-theme.min.css&quot; rel =&quot;stylesheet&quot;&gt;&lt;/head&gt;&#39;</span><span class="p">,</span> 
<a name="True-5"></a>            tmp<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<a name="True-6"></a>
<a name="True-7"></a>tmp <span class="o">&lt;-</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&#39;&lt;div id=&quot;htmlwidget_container&quot;&gt;&#39;</span><span class="p">,</span>
<a name="True-8"></a>            <span class="s">&#39;&lt;h3&gt;Residents in one area, working in another&lt;/h3&gt;</span>
<a name="True-9"></a><span class="s">            &lt;div id=&quot;htmlwidget_container&quot;&gt;&#39;</span><span class="p">,</span>
<a name="True-10"></a>            tmp<span class="p">,</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<a name="True-11"></a>            
<a name="True-12"></a><span class="kp">writeLines</span><span class="p">(</span>tmp<span class="p">,</span> <span class="s">&quot;../img/0025-networkD3.html&quot;</span><span class="p">)</span></code></pre></div>

<p>If anyone’s wondering why Wellington has so many inbound commuters compared to Auckland, which is much larger, it’s just an artefact of boundaries.  Wellington Region is divided into a number of smaller cities and regions which show up in this sort of data, whereas the Auckland region is a single territorial authority.</p>

<p>C’est tout.</p>

<h3 id="edits">Edits</h3>
<p>Edited 27/12/2015 so the numbers in the tooltip labels include the sums of commuters even when less than 100 - incorrectly omitted in the first version.  I now use the pre-filtered “TravelAll” object for creating the labels.  This doesn’t make any visual difference, but the numbers were understated before.</p>


</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2015/12/21/m3-and-x13">
        <p>&larr; Older</p>
        <p>X13-SEATS-ARIMA as an automated forecasting tool</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2015/12/29/Rrobot-born">
        <p>Newer &rarr;</p>
        <p>A (not too talkative) twitterbot is born</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
            <p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
	
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="/" property="cc:attributionName" rel="cc:attributionURL">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.


			</footer>
    </div>



  
</body>
</html>
   




         
