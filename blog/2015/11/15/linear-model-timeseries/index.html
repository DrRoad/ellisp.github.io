      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Linear model with time series random component</title>
      	
         
         
            <meta name ="description" content ="Creating an animation to show why you can't ignore the time series element of data even when it's been created by a simple linear model">
            <meta property="og:description" content ="Creating an animation to show why you can't ignore the time series element of data even when it's been created by a simple linear model">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Linear model with time series random component" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0017-original.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2015/11/15/linear-model-timeseries/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">       
     <link rel="stylesheet" href="/css/Pygments/autumn.css">      
     <link rel="stylesheet" href="/css/Pygments/custom.css">      
            
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
         <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
         <script src="/js/bootstrap.min.js"></script>
         
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/05/22/robust-regression>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Linear model with time series random component</h1>
         <p class="meta">15 Nov 2015</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   Creating an animation to show why you can't ignore the time series element of data even when it's been created by a simple linear model
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="what-do-auto-correlated-residuals-do-to-your-linear-model">What do auto-correlated residuals do to your linear model?</h2>
<p>For training purposes I wanted to illustrate the dangers of ignoring time series characteristics of the random part of a classical linear regression, and I came up with this animation to do it:</p>

<p><img src="/img/0017-timeseries.gif" alt="animated-regression" /></p>

<p>I like this, because it shows how easy it is to fit something that looks to be a good fit but actually misses important parts of reality.  The red lines show where the fitted model is, based on a small window of the data - from 5 to 200 points.  The black line shows the true data generating process.  From very early on the model fit to the simple cross-sectional has converged to pretty close to the black line. However, the model fit to the data with time series errors spends a long time greatly overestimating the value of one of the parameters in the model, and not until there are 120 observations has it converged to anywhere near the true process.</p>

<p>At the very least, it shows that you need many more - four times as many in this case, but unfortunately that’s not a magic number that will always work - observations from a time series to reliably estimate the structural part of a model.  Even if we’d explicitly modelled the time series part of the data on the right of the animation, we’d still have that problem.</p>

<p>By including the residual plots below the scatter plots we get a nice picture of a warning sign in this basic (and should be fundamental and universal) diagnostic plot.  In this particular case the pattern is obvious; when working with real data you should check with partial autocorrelation function plots too.</p>

<h2 id="simulating-data">Simulating data</h2>

<p>The animation illustrates the results of simulating and contrasting two fairly extreme cases:</p>

<ul>
  <li>cross section data, generated exactly from a model of <code>y = a + b.x + e, e ~ N(0, 1)</code>.  This is the textbook case introduced in any basic statistics course;</li>
  <li>time series data, generated with exactly the same model except the error term, in addition to be normally distributed with mean of zero and standard deviation of 1, has a high autocorrelation.</li>
</ul>

<p>I chose to make the intercept of my model (<code>a</code> in the above formulation) 1, and the slope (<code>b</code>) equal to 0.3.  Here’s what the first 200 observations of the response variable looks like:
<img src="/img/0017-original.svg" alt="lorenz-plot" /></p>

<p>In fact, I’ve over-simplified things by leaving <code>x</code> in both datasets as independent and identically distributed white noise.  In reality, if y has a time series random component, <code>x</code> probably will have too.  But I wanted to illustrate how a single violation of our assumptions can lead to problems, rather than create a fully realistic case (which obviously would show up even more problems).</p>

<p>The data were generated as follows.  To illustrate a point and make it a realistic test, I generate a much larger “population” time series, and the mean of zero and standard deviation of 1 applies only to that larger population.  The first 200 points is all we see.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<a name="True-2"></a><span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<a name="True-3"></a><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<a name="True-4"></a><span class="kn">library</span><span class="p">(</span>gridExtra<span class="p">)</span>
<a name="True-5"></a><span class="kn">library</span><span class="p">(</span>showtext<span class="p">)</span>
<a name="True-6"></a>
<a name="True-7"></a><span class="c1">#-------------set up-------------</span>
<a name="True-8"></a><span class="c1"># Fonts and themes:</span>
<a name="True-9"></a>font.add.google<span class="p">(</span><span class="s">&quot;Poppins&quot;</span><span class="p">,</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-10"></a>showtext.auto<span class="p">()</span>
<a name="True-11"></a>theme_set<span class="p">(</span>theme_light<span class="p">(</span>base_family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">))</span>
<a name="True-12"></a>
<a name="True-13"></a><span class="c1"># sample and population size:</span>
<a name="True-14"></a>n <span class="o">&lt;-</span> <span class="m">200</span>
<a name="True-15"></a>popn <span class="o">&lt;-</span> n <span class="o">*</span> <span class="m">10</span>
<a name="True-16"></a>
<a name="True-17"></a>
<a name="True-18"></a><span class="c1">#----------simulate data---------</span>
<a name="True-19"></a><span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
<a name="True-20"></a>
<a name="True-21"></a><span class="c1"># Linear model with a time series random element, n * 10 in length:</span>
<a name="True-22"></a>df1 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> rnorm<span class="p">(</span>popn<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-23"></a>   mutate<span class="p">(</span>y <span class="o">=</span> <span class="m">1</span> <span class="o">+</span> <span class="m">0.3</span> <span class="o">*</span> x <span class="o">+</span> <span class="kp">scale</span><span class="p">(</span>arima.sim<span class="p">(</span><span class="kt">list</span><span class="p">(</span>ar <span class="o">=</span> <span class="m">0.99</span><span class="p">),</span> popn<span class="p">)),</span>
<a name="True-24"></a>          ind <span class="o">=</span> <span class="m">1</span><span class="o">:</span>popn<span class="p">,</span>
<a name="True-25"></a>          type <span class="o">=</span> <span class="s">&quot;TimeSeries&quot;</span><span class="p">)</span>
<a name="True-26"></a><span class="c1"># cut back to just the first n points:</span>
<a name="True-27"></a>df1 <span class="o">&lt;-</span> df1<span class="p">[</span><span class="m">1</span><span class="o">:</span>n<span class="p">,</span> <span class="p">]</span>
<a name="True-28"></a>
<a name="True-29"></a>
<a name="True-30"></a><span class="c1"># Same linear model, with i.i.d. white noise random element:</span>
<a name="True-31"></a>df2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>x <span class="o">=</span> rnorm<span class="p">(</span>n<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-32"></a>   mutate<span class="p">(</span>y <span class="o">=</span> <span class="m">1</span> <span class="o">+</span> <span class="m">0.3</span> <span class="o">*</span> x <span class="o">+</span> rnorm<span class="p">(</span>n<span class="p">),</span>
<a name="True-33"></a>          ind <span class="o">=</span> <span class="m">1</span><span class="o">:</span>n<span class="p">,</span>
<a name="True-34"></a>          type <span class="o">=</span> <span class="s">&quot;CrossSection&quot;</span><span class="p">)</span>
<a name="True-35"></a>
<a name="True-36"></a><span class="c1"># draw the time series response:</span>
<a name="True-37"></a>p0 <span class="o">&lt;-</span> df1 <span class="o">%&gt;%</span>
<a name="True-38"></a>   ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> ind<span class="p">,</span> y <span class="o">=</span> y<span class="p">))</span> <span class="o">+</span>
<a name="True-39"></a>   geom_line<span class="p">()</span> <span class="o">+</span>
<a name="True-40"></a>   labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-41"></a>   ggtitle<span class="p">(</span><span class="s">&quot;Simulated response variable from linear model\nwith time series random element&quot;</span><span class="p">)</span></code></pre></div>

<p>Creating the animation is straightforward graphics.  I make use of <a href="http://ggplot2.org/"><code>ggplot2</code>’s</a> faceting feature to cut down on some code, drawing the top two connected scatterplot images with one chunk and the bottom two residuals with another.  Each frame is saved as an individual PNG image, and <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a> ties it all together into an animated GIF as easily as usual.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>df_both <span class="o">&lt;-</span> <span class="kp">rbind</span><span class="p">(</span>df1<span class="p">,</span> df2<span class="p">)</span>
<a name="True-2"></a>
<a name="True-3"></a>
<a name="True-4"></a><span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">5</span><span class="o">:</span>n<span class="p">){</span>
<a name="True-5"></a>
<a name="True-6"></a>   <span class="c1"># I name the images i + 1000 so alphabetical order is also numeric</span>
<a name="True-7"></a>   png<span class="p">(</span><span class="kp">paste0</span><span class="p">(</span>i <span class="o">+</span> <span class="m">1000</span><span class="p">,</span> <span class="s">&quot;.png&quot;</span><span class="p">),</span> <span class="m">700</span><span class="p">,</span> <span class="m">600</span><span class="p">,</span> res <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
<a name="True-8"></a>   
<a name="True-9"></a>   df1_tmp <span class="o">&lt;-</span> df1<span class="p">[</span><span class="m">1</span><span class="o">:</span>i<span class="p">,</span> <span class="p">]</span>
<a name="True-10"></a>   df2_tmp <span class="o">&lt;-</span> df2<span class="p">[</span><span class="m">1</span><span class="o">:</span>i<span class="p">,</span> <span class="p">]</span>
<a name="True-11"></a>   
<a name="True-12"></a>   residuals1 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>res <span class="o">=</span> residuals<span class="p">(</span>lm<span class="p">(</span>y <span class="o">~</span> x<span class="p">,</span> data <span class="o">=</span> df1_tmp<span class="p">)),</span> 
<a name="True-13"></a>                            ind <span class="o">=</span> <span class="m">1</span><span class="o">:</span>i<span class="p">,</span> 
<a name="True-14"></a>                            type <span class="o">=</span> <span class="s">&quot;TimeSeries&quot;</span><span class="p">)</span>
<a name="True-15"></a>   residuals2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>res <span class="o">=</span> residuals<span class="p">(</span>lm<span class="p">(</span>y <span class="o">~</span> x<span class="p">,</span> data <span class="o">=</span> df2_tmp<span class="p">)),</span> 
<a name="True-16"></a>                            ind <span class="o">=</span> <span class="m">1</span><span class="o">:</span>i<span class="p">,</span> 
<a name="True-17"></a>                            type <span class="o">=</span> <span class="s">&quot;CrossSection&quot;</span><span class="p">)</span>
<a name="True-18"></a>   
<a name="True-19"></a>   <span class="c1"># connected scatter plots:</span>
<a name="True-20"></a>   p1 <span class="o">&lt;-</span> ggplot<span class="p">(</span>df_both<span class="p">[</span><span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span>i<span class="p">,</span> <span class="p">(</span>n <span class="o">+</span> <span class="m">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span>n <span class="o">+</span> i<span class="p">)),</span> <span class="p">],</span> aes<span class="p">(</span>x<span class="p">,</span> y<span class="p">,</span> colour <span class="o">=</span> ind<span class="p">))</span> <span class="o">+</span>
<a name="True-21"></a>      facet_wrap<span class="p">(</span><span class="o">~</span>type<span class="p">,</span> ncol <span class="o">=</span> <span class="m">2</span><span class="p">)</span> <span class="o">+</span>
<a name="True-22"></a>      geom_path<span class="p">()</span> <span class="o">+</span>
<a name="True-23"></a>      geom_point<span class="p">()</span> <span class="o">+</span>
<a name="True-24"></a>      geom_abline<span class="p">(</span>intercept <span class="o">=</span> <span class="m">1</span><span class="p">,</span> slope <span class="o">=</span> <span class="m">0.3</span><span class="p">)</span> <span class="o">+</span>
<a name="True-25"></a>      geom_smooth<span class="p">(</span>method <span class="o">=</span> <span class="s">&quot;lm&quot;</span><span class="p">,</span> se <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> size <span class="o">=</span> <span class="m">2</span><span class="p">,</span> colour <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-26"></a>      theme<span class="p">(</span>legend.position <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-27"></a>      xlim<span class="p">(</span><span class="kp">range</span><span class="p">(</span>df_both<span class="o">$</span>x<span class="p">))</span> <span class="o">+</span>
<a name="True-28"></a>      ylim<span class="p">(</span><span class="kp">range</span><span class="p">(</span>df_both<span class="o">$</span>y<span class="p">))</span> <span class="o">+</span>
<a name="True-29"></a>      ggtitle<span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;Connected scatterplot showing regression on first&quot;</span><span class="p">,</span> i<span class="p">,</span> <span class="s">&quot;points&quot;</span><span class="p">))</span>
<a name="True-30"></a>      
<a name="True-31"></a>   
<a name="True-32"></a>   <span class="c1"># Residuals plots    </span>
<a name="True-33"></a>   p2 <span class="o">&lt;-</span> residuals1 <span class="o">%&gt;%</span>
<a name="True-34"></a>      <span class="kp">rbind</span><span class="p">(</span>residuals2<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-35"></a>      mutate<span class="p">(</span>type <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span>type<span class="p">,</span> levels <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;CrossSection&quot;</span><span class="p">,</span> <span class="s">&quot;TimeSeries&quot;</span><span class="p">)))</span> <span class="o">%&gt;%</span>
<a name="True-36"></a>      ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> ind<span class="p">,</span> y <span class="o">=</span> res<span class="p">))</span> <span class="o">+</span>
<a name="True-37"></a>      scale_x_continuous<span class="p">(</span>limits <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> n<span class="p">))</span> <span class="o">+</span>
<a name="True-38"></a>      facet_wrap<span class="p">(</span><span class="o">~</span>type<span class="p">)</span> <span class="o">+</span>
<a name="True-39"></a>      geom_line<span class="p">()</span> <span class="o">+</span>
<a name="True-40"></a>      geom_point<span class="p">()</span> <span class="o">+</span>
<a name="True-41"></a>      ggtitle<span class="p">(</span><span class="s">&quot;Residuals from regression so far&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-42"></a>      labs<span class="p">(</span>x <span class="o">=</span> <span class="s">&quot;Time&quot;</span><span class="p">,</span> y <span class="o">=</span> <span class="s">&quot;Residuals&quot;</span><span class="p">)</span>
<a name="True-43"></a>   
<a name="True-44"></a>   grid.arrange<span class="p">(</span>p1<span class="p">,</span> p2<span class="p">)</span>
<a name="True-45"></a>   
<a name="True-46"></a>   dev.off<span class="p">()</span>
<a name="True-47"></a>   
<a name="True-48"></a><span class="p">}</span>
<a name="True-49"></a>
<a name="True-50"></a><span class="c1"># combine them into an animated GIF</span>
<a name="True-51"></a><span class="kp">system</span><span class="p">(</span><span class="s">&#39;&quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&quot; -loop 0 -delay 10 *.png &quot;timeseries.gif&quot;&#39;</span><span class="p">)</span></code></pre></div>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2015/10/30/MTAGDP">
        <p>&larr; Older</p>
        <p>Modelled Territorial Authority GDP for New Zealand</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2015/11/21/arima-sims">
        <p>Newer &rarr;</p>
        <p>Create ARIMA time series from bottom up</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
            <p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
	
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="/" property="cc:attributionName" rel="cc:attributionURL">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.


			</footer>
    </div>



  
</body>
</html>
   




         
