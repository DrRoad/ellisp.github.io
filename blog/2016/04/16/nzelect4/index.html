      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Election analysis contest entry part 4 - drivers of preference for Green over Labour party</title>
      	
         
         
            <meta name ="description" content ="Locations with more self employed, people with Bachelor degrees, no religion, and people living overseas five years ago were more likely to vote Green over Labour in the 2014 New Zealand General Election, and locations with more ethnically Asian and Pacific people, people born in New Zealand, and people with no qualification returned higher votes for Labour over the Greens.">
            <meta property="og:description" content ="Locations with more self employed, people with Bachelor degrees, no religion, and people living overseas five years ago were more likely to vote Green over Labour in the 2014 New Zealand General Election, and locations with more ethnically Asian and Pacific people, people born in New Zealand, and people with no qualification returned higher votes for Labour over the Greens.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Election analysis contest entry part 4 - drivers of preference for Green over Labour party" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0038-model-results.png" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2016/04/16/nzelect4/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">       
     <link rel="stylesheet" href="/css/Pygments/autumn.css">      
     <link rel="stylesheet" href="/css/Pygments/custom.css">      
            
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/06/14/graphics-presentation>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Election analysis contest entry part 4 - drivers of preference for Green over Labour party</h1>
         <p class="meta">16 Apr 2016</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   Locations with more self employed, people with Bachelor degrees, no religion, and people living overseas five years ago were more likely to vote Green over Labour in the 2014 New Zealand General Election, and locations with more ethnically Asian and Pacific people, people born in New Zealand, and people with no qualification returned higher votes for Labour over the Greens.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="motivation">Motivation</h2>
<p>This post is the fourth in a series that make up my entry in <a href="http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/">Ari Lamstein’s R Election Analysis Contest</a>.</p>

<p>Earlier posts introduced the <a href="https://github.com/ellisp/nzelect"><code>nzelect</code> R package</a>, basic usage, how it was built, and an exploratory Shiny web application.  Today I follow up on <a href="http://www.statschat.org.nz/2016/04/09/compared-to-what-4/#comment-181310">discussion in the StatsChat blog</a>.  A post there showed a screen shot from my Shiny app, zooming in on Auckland votes for Green Party compared to the Labour Party (the two principal left-leaning parties in New Zealand).  There was discussion in the comments of whether house price, income, and education were the predictors of the choice between these two parties (for the subset of voters who chose one of the two).</p>

<h2 id="combining-census-meshblock-data-with-voting-locations">Combining census meshblock data with voting locations</h2>
<p>Making it easier to investigate this issue is one the primary motivations for the <code>nzelect</code> R package and incorporating census data that can be matched to voting locations and electorates has been on the plan from the beginning.  It’s proven a bigger job than I hoped and is very incomplete, but so far I’ve incorporated around 35 selected variables from the 2013 Census at the meshblock level.</p>

<h3 id="first-look">First look</h3>
<p>The plot below shows how some of those variables relate to the variable of interest here - the Green Party votes as a proportion of all that went to Green Party or Labour Party, by voting location.</p>

<p><img src="/img/0038-green-labour.png" alt="matrix" /></p>

<p>Full descriptions of the variables are in the helpfile for the <code>Meshblocks2013</code> object in the <code>nzelect</code> package.  People without access to that can still read the <a href="https://github.com/ellisp/nzelect/blob/master/pkg/man/Meshblocks2013.Rd">source code of the helpfile</a> which hopefully will make sense.  Time and space constraints put me off creating a big table here in this blog post.</p>

<p>The blue lines show outlier-resistant robust linear regressions on one explanatory variable at a time, but the non-robust versions are almost identical.  All code has been relegated to the bottom of the post.  When the <code>nzelect</code> package has a more complete set of census data, including more variables and area unit, electorate and territorial authority variables, I’ll do a future post that focuses more on the code to join these things together.</p>

<p>Two variables that are in the <code>nzelect</code> package have been excluded.  These are <code>PropEuropean</code>, the proportion of meshblock population of European ethnicity; and <code>PropOwnResidence</code>, the proportion of individuals that own their own residence.  I excluded these early as part of my modelling strategy because they are highly collinear with the other set of candidate explanatory variables - variance inflation factors over 10.  What this means in practice is that once you know the proportions of Maori, Asian and Pacific ethnicity in a meshblock there’s not much to learn from the proportion of people of European ethnicity.  And once you know the proportion of households that are owned, there’s not much information contained in knowing the proportion of individuals who own their residence.</p>

<h3 id="spatial-elements">Spatial elements</h3>
<p>Note that I’ve left in two variables for the latitude and longitude, which (probably as expected) don’t have any obvious relationship to the proportion of Green v Labour voters.  This is so when I get into statistical modelling, I can take into account expected spatial auto-correlation.  Simply put, that means that the results from two voting places that are close together shouldn’t be treated as completely fresh independent information, but given somewhat less importance because of their co-location.  This is just a nuisance aspect of the model with regard to today’s question so I don’t report on the results; but in the modelling I do later I make sure I have a spatial spline lurking in the background to suck up any spatial effects, leaving the estimates of the impact of other explanatory variables safer.</p>

<h3 id="imputation">Imputation</h3>
<p>For confidentialisation, meshblock census results are subject to random rounding (which is why some of the proportions exceed 1 - the numerator has been rounded one way, and the denominator another) and to outright cell suppression.  For today’s purposes, the cell suppression is more of a problem.  As I’ve potentially got lots of explanatory variables in my model, many meshblocks are missing at least one variable due to the confidentialisation.  If I excluded each voting place whose meshblock was missing data, I’d be throwing out 61% of the data.</p>

<p>This is enough of a problem that I’d consider going up a level and using area units (larger shapes than meshblocks) instead, although many area units have multiple voting locations in them so we would lose a fair bit of granularity in doing so.  However, the <code>nzelect</code> data doesn’t yet include its area unit slice and I’m short of time, so I opt for imputation instead.</p>

<p>I use multiple imputation, which means that you create statistical models to predict each missing value based on the values that you do have, and do this multiple times for each missing value, including the random element of the model and hence getting a different imputed value each time.  Then when you fit your final model of actual interest you fit it to each one of your datasets with missing value imputations (in this example I have 20 full sets of the data) and you base your calculations of standard errors, confidence intervals, etc. on the randomness that comes from the imputation process as well as the usual modelling uncertainty.  It’s not a fool-proof method - nothing is in the face of missing data - but it’s a good one and it does the job in this case (how do I know?  I tried other methods, including deleting all rows, and got similar results).</p>

<h2 id="modelling">Modelling</h2>
<p>When it comes to the actual modelling I use a generalised additive model with a binomial family response.  The ‘additive’ bit comes from a flexible two dimensional spline which is just there to deal with the nuisance of the spatial autocorrelation.  The binomial family response is appropriate for the data which uses proportions.  Here’s the end results showing which variables are good for predicting the proportion of Green / Labour votes that are for the Green Party:</p>

<p><img src="/img/0038-model-results.svg" alt="results" /></p>

<h3 id="interpretation">Interpretation</h3>
<p>So, just to be really clear, here are the factors in the surrounding meshblock that seem lead to a voting place returning a high proportion of Green/Labour voters voting Green:</p>

<ul>
  <li>Higher proportion of individuals are self employed</li>
  <li>Higher proportion of individuals have a Bachelor degree</li>
  <li>Higher proportion of individuals have no religion</li>
  <li>Higher proportion of individuals were overseas 5 years ago</li>
  <li>Higher proportion of households don’t own their residence</li>
</ul>

<p>And here are the factors that are associated with a high proportion of Green/Labour voters voting Labour:</p>

<ul>
  <li>High proportion of individuals state they are of Pacific, Asian or Maori ethnicity</li>
  <li>High proportion of individuals have no qualifications</li>
  <li>High proportion of individuals were born in New Zealand</li>
  <li>High proportion of individuals have partner or are separated</li>
  <li>Higher individual median income</li>
  <li>Higher proportion of individuals are aged 20 to 24</li>
</ul>

<p>There’s no discernable impact from the median household rent, best proxy in the particular data available for household prices.  So on the data available, the general demographics argument wins over the housing prices one.</p>

<p>The surprising one here was the negative coefficient in front of median income.  This differs from the simple two variable relationship seen in the first graphic in this post; what we’re seeing with the more sophisticated modelling is evidence that the apparent relationship between income and higher proportions of Green voters over Labour is a proxy for other demographic factors (like education, ethnicity and employment), and when those factors are controlled for the relationship between income and choosing Green over Labour is negative.</p>

<p>Care needs to be taken in leaping from this analysis to conclusions about individual behaviour, which would form the <a href="https://en.wikipedia.org/wiki/Ecological_fallacy">ecological fallacy</a>.  For example, while areas with higher incomes seem more inclined to choose Labour over Green after controlling for other factors, it’s at least possible that it’s being surrounded by higher income people that has the effect, rather than being higher income oneself; and similarly with any other observed effect.  But with caution and caveats you can at least form some tentative conclusions about individuals; only individual level data could resolve that, and the New Zealand Election Study (which would provide that) <a href="http://www.nzes.org/exec/show/data">isn’t yet available for download</a>.</p>

<h3 id="final-warnings">Final warnings</h3>
<p>One thing we <em>don’t</em> do at this point is knock out all those “non significant” variables like proportion of people on unemployment benefit, proportion who are full time students, etc and refit the model.   This leads to all the standard errors being biased downwards, the effect sizes being biased upwards, test statistics not having the claimed distributions, confidence intervals being too small, and in fact pretty much any inference after that point is invalid.  This doesn’t stop that kind of stepwise model building from being common practice, but don’t let me catch you doing it in a context where inference about effect sizes and “which variables have how much explanatory power” are important (sometimes for predictive models that stepwise approach is more justifiable, if done carefully).</p>

<p>This analysis is incomplete because the <code>nzelect</code> project is incomplete.  Most glaringly, two whole sets of individual level census variables have been excluded simply because I didn’t get round to including them in the original data package.  This doesn’t invalidate the findings but it does add extra cautions and caveats.  I’ll fix that eventually but it might be a few months away.</p>

<p>OK, that’s enough to go along with.  Thanks for reading.  Here’s the code that did that analysis:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="c1">#---------load up functionality and fonts------------</span>
<a name="True-2"></a>devtools<span class="o">::</span>install_github<span class="p">(</span><span class="s">&quot;ellisp/nzelect/pkg&quot;</span><span class="p">)</span>
<a name="True-3"></a>devtools<span class="o">::</span>install_github<span class="p">(</span><span class="s">&quot;hadley/ggplot2&quot;</span><span class="p">)</span> <span class="c1"># latest version needed for subtitles and captions</span>
<a name="True-4"></a>
<a name="True-5"></a><span class="kn">library</span><span class="p">(</span>MASS<span class="p">)</span> <span class="c1"># for rlm().  Load before dplyr to avoid &quot;select&quot; conflicts</span>
<a name="True-6"></a><span class="kn">library</span><span class="p">(</span>mice<span class="p">)</span> <span class="c1"># for multiple imputation</span>
<a name="True-7"></a><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>   
<a name="True-8"></a><span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<a name="True-9"></a><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<a name="True-10"></a><span class="kn">library</span><span class="p">(</span>scales<span class="p">)</span>
<a name="True-11"></a><span class="kn">library</span><span class="p">(</span>showtext<span class="p">)</span>
<a name="True-12"></a><span class="kn">library</span><span class="p">(</span>car<span class="p">)</span>      <span class="c1"># for vif()</span>
<a name="True-13"></a><span class="kn">library</span><span class="p">(</span>ggthemes<span class="p">)</span> <span class="c1"># for theme_tufte</span>
<a name="True-14"></a><span class="kn">library</span><span class="p">(</span>mgcv<span class="p">)</span>     <span class="c1"># for a version of gam with vcov() method</span>
<a name="True-15"></a>font.add.google<span class="p">(</span><span class="s">&quot;Poppins&quot;</span><span class="p">,</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-16"></a>showtext.auto<span class="p">()</span>
<a name="True-17"></a>theme_set<span class="p">(</span>theme_light<span class="p">(</span><span class="m">10</span><span class="p">,</span> base_family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">))</span>
<a name="True-18"></a>
<a name="True-19"></a><span class="c1"># load in the data</span>
<a name="True-20"></a><span class="kn">library</span><span class="p">(</span>nzelect<span class="p">)</span>
<a name="True-21"></a>
<a name="True-22"></a><span class="c1">#-----------general data prep------------</span>
<a name="True-23"></a><span class="c1"># Some voting places don&#39;t have a match to mesthblock and hence aren&#39;t any</span>
<a name="True-24"></a><span class="c1"># good for our purposes.  Note - Chatham Islands *should* be a match, but that</span>
<a name="True-25"></a><span class="c1"># an issue to fix in the nzelect package which we&#39;ll ignore for now</span>
<a name="True-26"></a>bad_vps <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span>
<a name="True-27"></a>   <span class="s">&quot;Chatham Islands Council Building, 9 Tuku Road, Waitangi&quot;</span><span class="p">,</span>
<a name="True-28"></a>   <span class="s">&quot;Ordinary Votes BEFORE polling day&quot;</span><span class="p">,</span>
<a name="True-29"></a>   <span class="s">&quot;Overseas Special Votes including Defence Force&quot;</span><span class="p">,</span>
<a name="True-30"></a>   <span class="s">&quot;Special Votes BEFORE polling day&quot;</span><span class="p">,</span> 
<a name="True-31"></a>   <span class="s">&quot;Special Votes On polling day&quot;</span><span class="p">,</span> 
<a name="True-32"></a>   <span class="s">&quot;Votes Allowed for Party Only&quot;</span><span class="p">,</span>
<a name="True-33"></a>   <span class="s">&quot;Voting places where less than 6 votes were taken&quot;</span><span class="p">)</span>
<a name="True-34"></a>
<a name="True-35"></a>GE2014a <span class="o">&lt;-</span> GE2014 <span class="o">%&gt;%</span>
<a name="True-36"></a>   filter<span class="p">(</span><span class="o">!</span>VotingPlace <span class="o">%in%</span> bad_vps<span class="p">)</span>
<a name="True-37"></a>
<a name="True-38"></a>
<a name="True-39"></a><span class="c1">#------------Greens / (Greens + Labour)--------------</span>
<a name="True-40"></a><span class="c1"># make a dataset with the response variable we want (Greens / (Greens + Labour))</span>
<a name="True-41"></a><span class="c1"># and merged with the VotingPlace locations and the relevant meshblock data</span>
<a name="True-42"></a>greens <span class="o">&lt;-</span> GE2014a <span class="o">%&gt;%</span>
<a name="True-43"></a>   filter<span class="p">(</span>VotingType <span class="o">==</span> <span class="s">&quot;Party&quot;</span> <span class="o">&amp;</span>
<a name="True-44"></a>             Party <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;Green Party&quot;</span><span class="p">,</span> <span class="s">&quot;Labour Party&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-45"></a>   group_by<span class="p">(</span>VotingPlace<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-46"></a>   summarise<span class="p">(</span>PropGreens <span class="o">=</span> <span class="kp">sum</span><span class="p">(</span>Votes<span class="p">[</span>Party <span class="o">==</span> <span class="s">&quot;Green Party&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="kp">sum</span><span class="p">(</span>Votes<span class="p">),</span>
<a name="True-47"></a>             TotalGLVotes <span class="o">=</span> <span class="kp">sum</span><span class="p">(</span>Votes<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-48"></a>   ungroup<span class="p">()</span> <span class="o">%&gt;%</span>
<a name="True-49"></a>   left_join<span class="p">(</span>Locations2014<span class="p">,</span> by <span class="o">=</span> <span class="s">&quot;VotingPlace&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-50"></a>   left_join<span class="p">(</span>Meshblocks2013<span class="p">,</span> by <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;MB2014&quot;</span> <span class="o">=</span> <span class="s">&quot;MB&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-51"></a>   select<span class="p">(</span>PropGreens<span class="p">,</span> TotalGLVotes<span class="p">,</span> WGS84Latitude<span class="p">,</span> WGS84Longitude<span class="p">,</span>
<a name="True-52"></a>          MeanBedrooms2013<span class="o">:</span>PropStudentAllowance2013<span class="p">)</span> 
<a name="True-53"></a>
<a name="True-54"></a><span class="c1"># Tidy up names of variables.  All the census data is from 2013 so we don&#39;t</span>
<a name="True-55"></a><span class="c1"># need to say so in each variable:</span>
<a name="True-56"></a><span class="kp">names</span><span class="p">(</span>greens<span class="p">)</span> <span class="o">&lt;-</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;2013&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="kp">names</span><span class="p">(</span>greens<span class="p">))</span>
<a name="True-57"></a>
<a name="True-58"></a>
<a name="True-59"></a><span class="c1"># Identify and address collinearity in the explanatory variables</span>
<a name="True-60"></a>mod1 <span class="o">&lt;-</span> lm<span class="p">(</span>PropGreens <span class="o">~</span> <span class="m">.</span> <span class="p">,</span> data <span class="o">=</span> greens<span class="p">)</span>
<a name="True-61"></a><span class="kp">sort</span><span class="p">(</span>vif<span class="p">(</span>mod1<span class="p">)</span> <span class="p">)</span>
<a name="True-62"></a><span class="c1"># PropEuropean is 17 - can be predicted from maori, Pacific Asian.</span>
<a name="True-63"></a><span class="c1"># PropOwnResidence is 11 - can be predicted from PropNotOwnedHH</span>
<a name="True-64"></a><span class="c1"># so let&#39;s take those two un-productive variables out</span>
<a name="True-65"></a>greens <span class="o">&lt;-</span> greens<span class="p">[</span> <span class="p">,</span> <span class="o">!</span><span class="kp">names</span><span class="p">(</span>greens<span class="p">)</span> <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;PropEuropean&quot;</span><span class="p">,</span> <span class="s">&quot;PropOwnResidence&quot;</span><span class="p">)]</span>
<a name="True-66"></a>
<a name="True-67"></a>
<a name="True-68"></a><span class="c1"># Image of scatter plots of explanatory variables v response variable</span>
<a name="True-69"></a>png<span class="p">(</span><span class="s">&quot;../img/0038-green-labour.png&quot;</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span> <span class="m">1000</span><span class="p">,</span> res <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
<a name="True-70"></a>greens <span class="o">%&gt;%</span>
<a name="True-71"></a>   gather<span class="p">(</span>Variable<span class="p">,</span> Value<span class="p">,</span> <span class="o">-</span>PropGreens<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-72"></a>   mutate<span class="p">(</span>Variable <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;2013&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> Variable<span class="p">),</span>
<a name="True-73"></a>          Variable <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Prop&quot;</span><span class="p">,</span> <span class="s">&quot;Prop &quot;</span><span class="p">,</span> Variable<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-74"></a>   ggplot<span class="p">(</span>aes<span class="p">(</span>x <span class="o">=</span> Value<span class="p">,</span> y <span class="o">=</span> PropGreens<span class="p">))</span> <span class="o">+</span>
<a name="True-75"></a>   facet_wrap<span class="p">(</span><span class="o">~</span>Variable<span class="p">,</span> scales <span class="o">=</span> <span class="s">&quot;free_x&quot;</span><span class="p">,</span> ncol <span class="o">=</span> <span class="m">6</span><span class="p">)</span> <span class="o">+</span>
<a name="True-76"></a>   geom_point<span class="p">(</span>alpha <span class="o">=</span> <span class="m">0.2</span><span class="p">)</span> <span class="o">+</span>
<a name="True-77"></a>   geom_smooth<span class="p">(</span>method <span class="o">=</span> <span class="s">&quot;rlm&quot;</span><span class="p">,</span> se <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">+</span>
<a name="True-78"></a>   scale_y_continuous<span class="p">(</span><span class="s">&quot;Percentage of Labour and Green voters who voted Green Party in party vote&quot;</span><span class="p">,</span> 
<a name="True-79"></a>                      label <span class="o">=</span> percent<span class="p">)</span> <span class="o">+</span>
<a name="True-80"></a>   scale_x_continuous<span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> label <span class="o">=</span> comma<span class="p">)</span> <span class="o">+</span>
<a name="True-81"></a>   labs<span class="p">(</span>caption <span class="o">=</span> <span class="s">&quot;Note: horizontal scales vary; and some proportions exceed 1.0 due to confidentialising.\nBlue lines are outlier-resistant robust regressions.&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-82"></a>   ggtitle<span class="p">(</span><span class="s">&quot;Choosing between Labour and Green in the 2014 New Zealand General Election&quot;</span><span class="p">,</span>
<a name="True-83"></a>      subtitle <span class="o">=</span> <span class="s">&quot;Each point represents an individual voting location (vertical axis) and the meshblock within which it is located (horizontal axis).&quot;</span><span class="p">)</span> <span class="o">+</span>    theme<span class="p">(</span>panel.margin <span class="o">=</span> unit<span class="p">(</span><span class="m">1.5</span><span class="p">,</span> <span class="s">&quot;lines&quot;</span><span class="p">))</span>
<a name="True-84"></a>dev.off<span class="p">()</span>
<a name="True-85"></a>
<a name="True-86"></a>
<a name="True-87"></a><span class="c1"># More data munging prior to model fitting</span>
<a name="True-88"></a>
<a name="True-89"></a><span class="c1"># only 39% of cases are complete, due to lots of confidentialisation:</span>
<a name="True-90"></a><span class="kp">sum</span><span class="p">(</span>complete.cases<span class="p">(</span>greens<span class="p">))</span> <span class="o">/</span> <span class="kp">nrow</span><span class="p">(</span>greens<span class="p">)</span>
<a name="True-91"></a><span class="c1"># so to avoid chucking out half the data we will need to impute.  Best way</span>
<a name="True-92"></a><span class="c1"># is multiple imputation, which gives</span>
<a name="True-93"></a>
<a name="True-94"></a><span class="c1"># to make it easier to compare the ultimate coefficients, we&#39;re going to</span>
<a name="True-95"></a><span class="c1"># scale the explanatory variables.  Easiest to do this before imputationL</span>
<a name="True-96"></a>greens_scaled <span class="o">&lt;-</span> greens
<a name="True-97"></a>greens_scaled<span class="p">[</span> <span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="kp">scale</span><span class="p">(</span>greens_scaled<span class="p">[</span> <span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">)]</span> <span class="p">)</span>
<a name="True-98"></a>
<a name="True-99"></a><span class="c1"># Now we do the multiple imputation.  </span>
<a name="True-100"></a><span class="c1"># Note that we ignore PropGreens for imputation purposes - don&#39;t want to impute</span>
<a name="True-101"></a><span class="c1"># the Xs based on the Y!  First we define the default predictor matrix:</span>
<a name="True-102"></a>predMat <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">-</span> <span class="kp">diag</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="kp">ncol</span><span class="p">(</span>greens_scaled<span class="p">))</span>
<a name="True-103"></a><span class="c1"># Each row corresponds to a target variable, columns to the variables to use in</span>
<a name="True-104"></a><span class="c1"># imputing them.  We say nothing should use PropGreens (first column).  Everything</span>
<a name="True-105"></a><span class="c1"># else is ok to use, including latitude and longitude and the total green and labour</span>
<a name="True-106"></a><span class="c1"># votes:</span>
<a name="True-107"></a>predMat<span class="p">[</span> <span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">0</span>
<a name="True-108"></a>greens_mi <span class="o">&lt;-</span> mice<span class="p">(</span>greens_scaled<span class="p">,</span> m <span class="o">=</span> <span class="m">20</span><span class="p">,</span> predictorMatrix <span class="o">=</span> predMat<span class="p">)</span>
<a name="True-109"></a>
<a name="True-110"></a><span class="c1"># what are all the variable names?:</span>
<a name="True-111"></a><span class="kp">paste</span><span class="p">(</span><span class="kp">names</span><span class="p">(</span>greens_scaled<span class="p">)[</span><span class="m">-1</span><span class="p">],</span> collapse <span class="o">=</span> <span class="s">&quot; + &quot;</span><span class="p">)</span>
<a name="True-112"></a>
<a name="True-113"></a><span class="c1"># fit models to each of the imputed datasets:</span>
<a name="True-114"></a>mod2 <span class="o">&lt;-</span> <span class="kp">with</span><span class="p">(</span>greens_mi<span class="p">,</span> 
<a name="True-115"></a>             gam<span class="p">(</span>PropGreens <span class="o">~</span> MeanBedrooms <span class="o">+</span> PropPrivateDwellings <span class="o">+</span> 
<a name="True-116"></a>                   PropSeparateHouse <span class="o">+</span> NumberInHH <span class="o">+</span> PropMultiPersonHH <span class="o">+</span> 
<a name="True-117"></a>                   PropInternetHH <span class="o">+</span> PropNotOwnedHH <span class="o">+</span> MedianRentHH <span class="o">+</span> 
<a name="True-118"></a>                   PropLandlordPublic <span class="o">+</span> PropNoMotorVehicle <span class="o">+</span> PropOld <span class="o">+</span> 
<a name="True-119"></a>                   PropEarly20s <span class="o">+</span> PropAreChildren <span class="o">+</span> PropSameResidence5YearsAgo <span class="o">+</span> 
<a name="True-120"></a>                   PropOverseas5YearsAgo <span class="o">+</span> PropNZBorn <span class="o">+</span> PropMaori <span class="o">+</span> 
<a name="True-121"></a>                   PropPacific <span class="o">+</span> PropAsian <span class="o">+</span> PropNoReligion <span class="o">+</span> PropSmoker <span class="o">+</span>
<a name="True-122"></a>                   PropSeparated <span class="o">+</span> PropPartnered <span class="o">+</span> PropNoChildren <span class="o">+</span> 
<a name="True-123"></a>                   PropNoQualification <span class="o">+</span> PropBachelor <span class="o">+</span> PropDoctorate <span class="o">+</span> 
<a name="True-124"></a>                   PropFTStudent <span class="o">+</span> PropPTStudent <span class="o">+</span> MedianIncome <span class="o">+</span> 
<a name="True-125"></a>                   PropSelfEmployed <span class="o">+</span> PropUnemploymentBenefit <span class="o">+</span> 
<a name="True-126"></a>                   PropStudentAllowance <span class="o">+</span> 
<a name="True-127"></a>                    s<span class="p">(</span>WGS84Latitude<span class="p">)</span> <span class="o">+</span> s<span class="p">(</span>WGS84Longitude<span class="p">)</span> <span class="o">+</span>
<a name="True-128"></a>                    s<span class="p">(</span>WGS84Latitude <span class="o">*</span> WGS84Longitude<span class="p">),</span>
<a name="True-129"></a>                family <span class="o">=</span> binomial<span class="p">,</span> weights <span class="o">=</span> TotalGLVotes<span class="p">)</span>
<a name="True-130"></a><span class="p">)</span>
<a name="True-131"></a>
<a name="True-132"></a>   
<a name="True-133"></a><span class="c1"># extract all the estimates of coefficients, except the uninteresting intercept:</span>
<a name="True-134"></a>coefs <span class="o">&lt;-</span> <span class="kp">summary</span><span class="p">(</span>pool<span class="p">(</span>mod2<span class="p">))[</span><span class="m">-1</span><span class="p">,</span> <span class="p">]</span> 
<a name="True-135"></a>vars <span class="o">&lt;-</span> <span class="kp">rownames</span><span class="p">(</span>coefs<span class="p">)</span>
<a name="True-136"></a>coefs <span class="o">&lt;-</span> <span class="kp">as.data.frame</span><span class="p">(</span>coefs<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-137"></a>   mutate<span class="p">(</span>variable <span class="o">=</span> vars<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-138"></a>   arrange<span class="p">(</span>est<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-139"></a>   mutate<span class="p">(</span>variable <span class="o">=</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot;Prop&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> variable<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-140"></a>   mutate<span class="p">(</span>variable <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span>variable<span class="p">,</span> levels <span class="o">=</span> variable<span class="p">))</span> <span class="o">%&gt;%</span>
<a name="True-141"></a>   <span class="c1"># drop all the uninteresting estimates associated with the spatial splines:</span>
<a name="True-142"></a>   filter<span class="p">(</span><span class="o">!</span><span class="kp">grepl</span><span class="p">(</span><span class="s">&quot;WGS84&quot;</span><span class="p">,</span> variable<span class="p">))</span>
<a name="True-143"></a>
<a name="True-144"></a><span class="c1"># make names referrable:</span>
<a name="True-145"></a><span class="kp">names</span><span class="p">(</span>coefs<span class="p">)</span> <span class="o">&lt;-</span> <span class="kp">gsub</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="kp">names</span><span class="p">(</span>coefs<span class="p">),</span> fixed <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<a name="True-146"></a>
<a name="True-147"></a><span class="c1"># define plot of results:</span>
<a name="True-148"></a>p2 <span class="o">&lt;-</span> ggplot<span class="p">(</span>coefs<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> variable<span class="p">,</span> ymin <span class="o">=</span> lo_95<span class="p">,</span> ymax <span class="o">=</span> hi_95<span class="p">,</span> y <span class="o">=</span> est<span class="p">))</span> <span class="o">+</span> 
<a name="True-149"></a>   geom_hline<span class="p">(</span>yintercept <span class="o">=</span> <span class="m">0</span><span class="p">,</span> colour <span class="o">=</span> <span class="s">&quot;lightblue&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-150"></a>   geom_linerange<span class="p">(</span>colour <span class="o">=</span> <span class="s">&quot;grey20&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-151"></a>   geom_text<span class="p">(</span>aes<span class="p">(</span>label <span class="o">=</span> variable<span class="p">),</span> size <span class="o">=</span> <span class="m">3</span><span class="p">,</span> family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">,</span> vjust <span class="o">=</span> <span class="m">0</span><span class="p">,</span> nudge_x <span class="o">=</span> <span class="m">0.15</span><span class="p">)</span> <span class="o">+</span>
<a name="True-152"></a>   coord_flip<span class="p">()</span> <span class="o">+</span>
<a name="True-153"></a>   labs<span class="p">(</span>y <span class="o">=</span> <span class="s">&quot;\nHorizontal lines show 95% confidence interval of scaled impact on</span>
<a name="True-154"></a><span class="s">proportion that voted Green out of Green and Labour voters.</span>
<a name="True-155"></a><span class="s">The numbers show coefficients from a logistic regression and </span>
<a name="True-156"></a><span class="s">should be taken as indicative, not strictly interpretable.\n&quot;</span><span class="p">,</span>
<a name="True-157"></a>        x <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
<a name="True-158"></a>        caption <span class="o">=</span> <span class="s">&quot;Source: http://ellisp.github.io&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-159"></a>   ggtitle<span class="p">(</span><span class="s">&quot;Census characteristics of voting places that party-voted Green over Labour&quot;</span><span class="p">,</span>
<a name="True-160"></a>      subtitle <span class="o">=</span> <span class="s">&quot;New Zealand General Election 2014&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-161"></a>   theme_tufte<span class="p">(</span>base_family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-162"></a>   theme<span class="p">(</span>axis.text.y <span class="o">=</span> element_blank<span class="p">(),</span>
<a name="True-163"></a>         axis.ticks.y <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
<a name="True-164"></a>   annotate<span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">,</span> y <span class="o">=</span> <span class="m">-0.2</span><span class="p">,</span> x <span class="o">=</span> <span class="m">6</span><span class="p">,</span> label <span class="o">=</span> <span class="s">&quot;More likely to\nvote Labour&quot;</span><span class="p">,</span> 
<a name="True-165"></a>            colour <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">,</span> family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-166"></a>   annotate<span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">,</span> y <span class="o">=</span> <span class="m">0.18</span><span class="p">,</span> x <span class="o">=</span> <span class="m">31</span><span class="p">,</span> label <span class="o">=</span> <span class="s">&quot;More likely to\nvote Green&quot;</span><span class="p">,</span> 
<a name="True-167"></a>            colour <span class="o">=</span> <span class="s">&quot;darkgreen&quot;</span><span class="p">,</span> family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-168"></a>
<a name="True-169"></a><span class="kp">print</span><span class="p">(</span>p2<span class="p">)</span></code></pre></div>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2016/04/09/nzelect3">
        <p>&larr; Older</p>
        <p>Election analysis contest entry part 3 - interactive exploration of voting locations with leaflet and Shiny</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2016/05/07/forecastHybrid">
        <p>Newer &rarr;</p>
        <p>Announcing new forecastHybrid package</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			
			

			</footer>
    </div>



  
</body>
</html>
   




         
