      <!DOCTYPE html>
	<html lang="en">
		<head>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
			<title>Visual contrast of two robust regression methods</title>
      	
         
         
            <meta name ="description" content ="I use animations to show some of the properties of least trimmed squares compared to a Huber M estimator as alternative robust regression estimation methods for a simple linear models.">
            <meta property="og:description" content ="I use animations to show some of the properties of least trimmed squares compared to a Huber M estimator as alternative robust regression estimation methods for a simple linear models.">
         
         <meta property="og:site_name" content="Peter's stats stuff" />
         <meta property="og:title" content="Visual contrast of two robust regression methods" />
         
            <meta property="og:image" content="http://ellisp.github.io/img/0041-rtm-lqs.gif" />
         
         <meta property="og:url" content="http://ellisp.github.io/blog/2016/05/22/robust-regression/" />
         <meta property="og:author" content= "https://www.facebook.com/peter.ellis.353" />
         <meta property="og:type" content="article" />
           
          <link href="/css/bootstrap.min.css" rel ="stylesheet">
          <link href="/css/bootstrap-theme.min.css" rel ="stylesheet">
            <link href="/css/custom.css" rel ="stylesheet">       
     <link rel="stylesheet" href="/css/Pygments/autumn.css">      
     <link rel="stylesheet" href="/css/Pygments/custom.css">      
            
            
   <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-65886313-1', 'auto');
     ga('send', 'pageview');

   </script>

   <style>
    ul li { margin-bottom: 9px; }
    ol li { margin-bottom: 9px; }
   </style>
   
   <link rel="alternate" type="application/rss+xml" title="Peter's stats stuff by Peter Ellis"
      href="/feed.xml">


      
		</head>
      
  <body role = "document">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        
		<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
  
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Peter's stats stuff</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">All blog posts <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="/blog">Ordered by date</a></li>
                  <li><a href="/blog/index_by_tag.html">Grouped by subject matter</a></li>
                  <li><a href = /blog/2016/06/14/graphics-presentation>Most recent post</a></li>
                 </ul>
            </li>
              <li><a href="/blog/showcase.html">Showcase</a></li>
              <li><a href="/presentations/index.html">Presentations</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  
  
      
			<div class="container">
			
			    <div class="jumbotron">
      <div class="container">
        <h1>Visual contrast of two robust regression methods</h1>
         <p class="meta">22 May 2016</p>
        
      </div>
    </div>




<div class = "post-summary">
<h2>TL;DR Summary:</h2>
   I use animations to show some of the properties of least trimmed squares compared to a Huber M estimator as alternative robust regression estimation methods for a simple linear models.
   <hr></hr>
</div>

<div class="post">
<div class="col-md-2">

</div>
  <div class="col-md-8">

  <h2 id="robust-regression">Robust regression</h2>

<p>For training purposes, I was looking for a way to illustrate some of the different properties of two different <a href="https://en.wikipedia.org/wiki/Robust_regression">robust estimation methods</a> for linear regression models.  The two methods I’m looking at are:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Least_trimmed_squares">least trimmed squares</a>, implemented as the default option in <code>lqs()</code></li>
  <li>a <a href="https://en.wikipedia.org/wiki/M-estimator">Huber M-estimator</a>, implemented as the default option in <code>rlm()</code></li>
</ul>

<p>Both functions are in Venables and Ripley’s <code>MASS</code> R package which comes with the standard distribution of R.</p>

<p>These methods are alternatives to ordinary least squares that can provide estimates with superior qualities when the classical assumptions of linear regression aren’t met.  M-estimators are effective in dealing with various breakdowns in the classical linear model assumptions, while still giving excellent results if the assumptions happen to be valid after all.  Least trimmed squares is very resistant to outliers, at a cost to efficiency.  Unfortunately, neither of these (or any other) robust estimation methods is the best in all situations, although they generally out-perform ordinary least squares in most real-life situations (my own, non-systematic observation).</p>

<h2 id="new-zealand-income-survey-2011">New Zealand Income Survey 2011</h2>

<p>To explore this I use the simulated unit record file from the New Zealand Income Survey 2011 that I’ve used in a lot of blog posts in the past year.  My <a href="http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf/">first post on this dataset</a> sets out how to import this data and tidy it up into a database.  The data shows weekly individual income from all sources for New Zealanders aged over 15, as well as hours worked and a range of demographic information I won’t be using today.  For looking at robust regression estimation methods, I’m going to pretend that I only ever have a sample of thirty observations from this dataset.</p>

<p>To illustrate the data, here’s an animation showing the full dataset (in grey) and repeated different samples of thirty data points, as well as lines representing linear models fit to those small samples with ordinary least squares (<code>lm</code>) and the two robust regression methods I’m investigating today.
<img src="/img/0041-rtm-lqs.gif" alt="animation" /></p>

<p>Some characteristics of this data that make it a useful illustration for robust regression include:</p>

<ul>
  <li>It’s reasonable to postulate the underlying relationship between hours worked and income as linear for much of the population.  So a linear model on the original scale is likely to be appropriate.</li>
  <li>However, the population seems likely to be made up of a number of diverse groups, making assumptions of homogeneity implausible. For example, a large number of people have incomes, some of them quite substantial, despite working zero hours.  General economic and social knowledge suggests that divisions into wage-earners, profit-receivers, and social security receivers probably constitute three quite different populations, while still being a significant simplification of the actual heterogeneity.</li>
  <li>On the original scale the data are expected to show <a href="https://en.wikipedia.org/wiki/Heteroscedasticity">heteroscedasticity</a> (in this case, higher variance for higher expected income), making classical inference invalid</li>
  <li>There are a number of outliers on both the x and y axes; and a cluster of individuals with negative income that appear to form yet another group in the mixture.</li>
</ul>

<h2 id="comparing-robust-methods">Comparing robust methods</h2>

<p>To reflect one of the key features of the data which is the unusual distribution of income when working hours are zero, the models fit in this post are all of the structure:</p>

<p><code>income ~ hours + (hours == 0)</code></p>

<p>The graphics show just the relationship between income and hours for when a non-zero amount of hours is worked.  In effect, (just for the graphics), this is like fitting the model after removing all the individuals that performed zero hours of work in the surveyed week.</p>

<p>The animation shown above was the germ idea for this post and already illustrates the key points.  In particular, it shows how the randomness associated with a small sample of thirty points leads to a different result for any particular sample; and once you have that sample, different estimation methods can give you materially differing results.  In some frames of the animation, we see a sample of thirty where slopes from the different estimation methods point in different directions, suggesting that if that particular small sample was the only one available, one might conclude that working more hours leads to decreased income.</p>

<p>The animation is nice for reminding us of the randomness associated with small samples, but actually isn’t a particularly effective method of looking at how the different robust estimation methods are doing.  Here’s a better way of doing that; a plot of the actual regression lines fit to 10,000 different samples of thirty.  Each line is semi-transparent, to give a better visual impression of where the bulk of fit lines end up:</p>

<p><img src="/img/0041-compare-lqs-rlm.png" alt="comparison" /></p>

<p>This makes it graphically clear that the <code>lqs</code> method (least trimmed squares) gives a noticeably wider range of results than does the Huber M-estimator.  This is an expected result; least trimmed squares is highly resistant to outliers, but this comes at the cost of <a href="https://en.wikipedia.org/wiki/Sufficient_statistic">sufficiency</a> (effectively, a significant part of the data has very little impact on the slope, so the information contained in the data is not utilised to the full).</p>

<p>Here’s another way of looking at that; the density plots of the slopes of the three estimation methods (two robust methods plus ordinary least squares fitted with <code>lm</code>).  I am using slope because it’s the most likely parameter of interest - it represents the marginal increase in income from an extra hour of work.</p>

<p><img src="/img/0041-slope-densities.svg" alt="slopes" /></p>

<p>The density plot shows that the estimates from <code>lqs</code> tend to be lower than for either <code>rlm</code> or <code>lm</code>.  This is to be expected, in a way related to the reason that trimmed mean or median income is usually less than mean income.  An estimation method that knocks out of the data the most extreme points (as done by least trimmed squares) will give differing results for samples drawn from skewed distributions.</p>

<p>Here are the mean, median and standard deviation of the slopes estimated by the three methods for the 10,000 samples of thirty:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a>method  mean median    sd
<a name="True-2"></a>    lm  <span class="m">21.3</span>   <span class="m">21.9</span>  <span class="m">18.9</span>
<a name="True-3"></a>   rlm  <span class="m">20.5</span>   <span class="m">20.7</span>  <span class="m">10.9</span>
<a name="True-4"></a>   lqs  <span class="m">17.7</span>   <span class="m">18.2</span>  <span class="m">23.7</span></code></pre></div>

<p>We see that <code>lm</code> and <code>rlm</code> on average give similar results, but <code>rlm</code> is much more stable, with a noticeably lower variance in results (shown by the standard deviation).  <code>lqs</code> on the other hand is actually quite unstable, for this small sample size.</p>

<h2 id="preliminary-thoughts-on-robust-regression-estimators">Preliminary thoughts on robust regression estimators</h2>
<p>This post uses Venables and Ripley’s <code>MASS</code> package and the accompanying book <a href="http://www.springer.com/us/book/9780387954578"><em>Modern Applied Statistics with S</em></a>.  Their own discussion of the issue implies (to my reading) the preferred use of the MM-estimator proposed by Yohai, Stahel &amp; Zamar in 1991, which retains the outlier-resistance of the S-estimator methods related to trimmed least squares, and the greater efficiency of M-estimators.  MM-estimators are available via <code>rlm()</code> with the <code>method = 'MM'</code> argument.</p>

<p>Another book that has been influential for me and I thoroughly recommend is Wilcox’ <a href="http://www.amazon.com/Modern-Statistics-Social-Behavioral-Sciences/dp/1439834563"><em>Modern Statistics for the Social and Behavioral Sciences</em></a>.  His comments on the matter are so pertinent that I am going to quote two paragraphs at length:</p>

<h3 id="comments-on-choosing-a-regression-estimator-wilcox">Comments on Choosing a Regression Estimator (Wilcox)</h3>

<p>“Many regression estimators have been proposed that can <strong>have substantial advantages over the ordinary least squares estimator.  But no single estimator dominates</strong> and there is the practical issue that the choice of estimator can make a practical difference in the conclusions reached.  One point worth stressing is that even when an estimator has a high breakdown point, only two outliers, properly placed, can have a large impact on some of the robust estimates of the slopes…. Estimators that seem to be particularly good at avoiding this problem are the Least Trimmed Squares, Least Trimmed Absolute Value and OP regression estimators.  Among these three estimators, the OP estimator seems to have an advantage in terms of achieving a relatively low standard error and so has the potential of relatively high power.  A negative feature of the OP estimator is that with large sample sizes, execution time might be an issue…</p>

<p>“In terms of achieving a relatively small standard error when dealing with heteroscedasticity, certain robust regression estimators can offer a distinct advantage compared to the least squares estimator…. Ones that perform well include Theil-Sen, the OP regression estimator and the TSTS estimator.  The MM-estimator does not perform well for the situations considered (ie heteroscedasticity)… but perhaps there are situations where it offers a practical advantage.”</p>

<p>It should be noted that earlier in the chapter Wilcox pointed out that the MM-estimator “enjoys excellent theoretical properties … but its standard error can be relatively large when there is heteroscedasticity.”</p>

<p>The “OP” estimator is a method of outlier detection and removal followed by <a href="https://en.wikipedia.org/wiki/Theil%E2%80%93Sen_estimator">Theil-Sen estimation</a>, a method that takes the median slope between all the pairs of sample points.  Topic for a future post.</p>

<h2 id="code">Code</h2>

<p>Here’s the R code behind all this.  It won’t be immediately reproducible.  Prior work is needed to establish the database as described in my earlier post; and the animation sequence is dependent on a particular folder structure.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><a name="True-1"></a><span class="c1">#===================setup=======================</span>
<a name="True-2"></a><span class="kn">library</span><span class="p">(</span>showtext<span class="p">)</span>
<a name="True-3"></a><span class="kn">library</span><span class="p">(</span>RMySQL<span class="p">)</span>
<a name="True-4"></a><span class="kn">library</span><span class="p">(</span>MASS<span class="p">)</span> 
<a name="True-5"></a><span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
<a name="True-6"></a><span class="kn">library</span><span class="p">(</span>tidyr<span class="p">)</span>
<a name="True-7"></a><span class="kn">library</span><span class="p">(</span>stringr<span class="p">)</span>
<a name="True-8"></a><span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<a name="True-9"></a><span class="kn">library</span><span class="p">(</span>scales<span class="p">)</span>
<a name="True-10"></a><span class="kn">library</span><span class="p">(</span>directlabels<span class="p">)</span>
<a name="True-11"></a>
<a name="True-12"></a><span class="c1">#================download and transform data==============</span>
<a name="True-13"></a><span class="c1"># See http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf/ for</span>
<a name="True-14"></a><span class="c1"># instructions on setting up the database</span>
<a name="True-15"></a>
<a name="True-16"></a>sql <span class="o">&lt;-</span> <span class="s">&quot;SELECT hours, income FROM vw_mainheader&quot;</span>
<a name="True-17"></a>PlayPen <span class="o">&lt;-</span> dbConnect<span class="p">(</span>RMySQL<span class="o">::</span>MySQL<span class="p">(),</span> username <span class="o">=</span> <span class="s">&quot;analyst&quot;</span><span class="p">,</span> dbname <span class="o">=</span> <span class="s">&quot;nzis11&quot;</span><span class="p">)</span>
<a name="True-18"></a>nzis <span class="o">&lt;-</span> dbGetQuery<span class="p">(</span>PlayPen<span class="p">,</span> sql<span class="p">)</span> 
<a name="True-19"></a>dbDisconnect<span class="p">(</span>PlayPen<span class="p">)</span>
<a name="True-20"></a>
<a name="True-21"></a><span class="c1"># An early version of the analysis used a cube root transform; this was dropped</span>
<a name="True-22"></a><span class="c1"># as it reduces interpretability and is not really germane to the illustration</span>
<a name="True-23"></a><span class="c1"># of robust regression methods</span>
<a name="True-24"></a><span class="c1"># cuberoot &lt;- function(x){</span>
<a name="True-25"></a><span class="c1">#    sign(x) * abs(x)^(1/3)</span>
<a name="True-26"></a><span class="c1"># }</span>
<a name="True-27"></a><span class="c1"># nzis &lt;- nzis %&gt;%</span>
<a name="True-28"></a><span class="c1">#    mutate(income2 = cuberoot(income),</span>
<a name="True-29"></a><span class="c1">#           hours2 = cuberoot(hours))</span>
<a name="True-30"></a>
<a name="True-31"></a><span class="c1"># create the variables to be used for x and y (as finally used, this</span>
<a name="True-32"></a><span class="c1"># is just income and hours on their original scale):</span>
<a name="True-33"></a>nzis <span class="o">&lt;-</span> nzis <span class="o">%&gt;%</span>
<a name="True-34"></a>   mutate<span class="p">(</span>income2 <span class="o">=</span> income<span class="p">,</span>
<a name="True-35"></a>          hours2 <span class="o">=</span> hours<span class="p">)</span>
<a name="True-36"></a>
<a name="True-37"></a><span class="c1">#==================simulations of many samples and estimated models==============</span>
<a name="True-38"></a><span class="c1"># create empty lists to hold the samples and the model results</span>
<a name="True-39"></a>points_samp <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">()</span>
<a name="True-40"></a>mod_lm <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">()</span>
<a name="True-41"></a>mod_rlm <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">()</span>
<a name="True-42"></a>mod_lqs <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">()</span>
<a name="True-43"></a>
<a name="True-44"></a><span class="c1"># create the samples, estimate the models and store the results</span>
<a name="True-45"></a>reps <span class="o">&lt;-</span> <span class="m">10000</span>
<a name="True-46"></a><span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>reps<span class="p">){</span>
<a name="True-47"></a>   nzis_samp <span class="o">&lt;-</span> nzis<span class="p">[</span><span class="kp">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="kp">nrow</span><span class="p">(</span>nzis<span class="p">),</span> <span class="m">30</span><span class="p">),</span> <span class="p">]</span>   
<a name="True-48"></a>   points_samp<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> nzis_samp
<a name="True-49"></a>   mod_lm<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> lm<span class="p">(</span>income2 <span class="o">~</span> hours2 <span class="o">+</span> <span class="p">(</span>hours2 <span class="o">==</span> <span class="m">0</span><span class="p">),</span> data <span class="o">=</span> nzis_samp<span class="p">)</span>
<a name="True-50"></a>   mod_rlm<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> rlm<span class="p">(</span>income2 <span class="o">~</span> hours2 <span class="o">+</span> <span class="p">(</span>hours2 <span class="o">==</span> <span class="m">0</span><span class="p">),</span> data <span class="o">=</span> nzis_samp<span class="p">)</span>
<a name="True-51"></a>   mod_lqs<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> lqs<span class="p">(</span>income2 <span class="o">~</span> hours2 <span class="o">+</span> <span class="p">(</span>hours2 <span class="o">==</span> <span class="m">0</span><span class="p">),</span> data <span class="o">=</span> nzis_samp<span class="p">)</span>
<a name="True-52"></a>   
<a name="True-53"></a><span class="p">}</span>
<a name="True-54"></a>
<a name="True-55"></a><span class="c1">#======================reporting results==============</span>
<a name="True-56"></a>
<a name="True-57"></a><span class="c1">#------------setup-----------------</span>
<a name="True-58"></a><span class="c1"># Fonts:</span>
<a name="True-59"></a>font.add.google<span class="p">(</span><span class="s">&quot;Poppins&quot;</span><span class="p">,</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-60"></a>showtext.auto<span class="p">()</span>
<a name="True-61"></a>theme_set<span class="p">(</span>theme_light<span class="p">(</span>base_family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">))</span>
<a name="True-62"></a>
<a name="True-63"></a>
<a name="True-64"></a>
<a name="True-65"></a><span class="c1"># define a generic plot function that does the background pale grey</span>
<a name="True-66"></a><span class="c1"># plot of the full dataset and draws the axes:</span>
<a name="True-67"></a>draw_plot <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(){</span>
<a name="True-68"></a>   <span class="kp">with</span><span class="p">(</span>nzis<span class="p">,</span> plot<span class="p">(</span>hours2<span class="p">,</span> income2<span class="p">,</span> cex <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> col <span class="o">=</span> <span class="s">&quot;grey80&quot;</span><span class="p">,</span> bty <span class="o">=</span> <span class="s">&quot;l&quot;</span><span class="p">,</span>
<a name="True-69"></a>                   xlab <span class="o">=</span> <span class="s">&quot;Hours worked&quot;</span><span class="p">,</span> 
<a name="True-70"></a>                   ylab <span class="o">=</span> <span class="s">&quot;Weekly income&quot;</span><span class="p">,</span>
<a name="True-71"></a>                   axes <span class="o">=</span> <span class="kc">FALSE</span><span class="p">))</span>
<a name="True-72"></a>   
<a name="True-73"></a>   axis<span class="p">(</span><span class="m">2</span><span class="p">,</span> at <span class="o">=</span> axTicks<span class="p">(</span><span class="m">2</span><span class="p">),</span> labels <span class="o">=</span> <span class="kp">paste0</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">,</span> str_trim<span class="p">(</span><span class="kp">format</span><span class="p">(</span>
<a name="True-74"></a>      axTicks<span class="p">(</span><span class="m">2</span><span class="p">),</span> big.mark <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="p">))))</span>
<a name="True-75"></a>   axis<span class="p">(</span><span class="m">1</span><span class="p">,</span> at <span class="o">=</span> axTicks<span class="p">(</span><span class="m">1</span><span class="p">),</span> labels <span class="o">=</span> axTicks<span class="p">(</span><span class="m">1</span><span class="p">))</span>
<a name="True-76"></a><span class="p">}</span>
<a name="True-77"></a>
<a name="True-78"></a>
<a name="True-79"></a>
<a name="True-80"></a><span class="c1">#-----------animation-------------</span>
<a name="True-81"></a><span class="c1"># This code is dependent on the particular folder structure.  File locations</span>
<a name="True-82"></a><span class="c1"># will need to be changed if people want to reproduce the analysis.</span>
<a name="True-83"></a><span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">){</span>
<a name="True-84"></a>   
<a name="True-85"></a>   png<span class="p">(</span><span class="kp">paste0</span><span class="p">(</span><span class="s">&quot;_output/0041-rlm-lqs/&quot;</span><span class="p">,</span> i <span class="o">+</span> <span class="m">20000</span><span class="p">,</span> <span class="s">&quot;.png&quot;</span><span class="p">),</span>
<a name="True-86"></a>       <span class="m">650</span><span class="p">,</span> <span class="m">650</span><span class="p">,</span> res <span class="o">=</span> <span class="m">100</span><span class="p">)</span>
<a name="True-87"></a>   par<span class="p">(</span>family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-88"></a>   draw_plot<span class="p">()</span>
<a name="True-89"></a>   title<span class="p">(</span>main <span class="o">=</span> <span class="s">&quot;Comparison of different estimation methods\nfor linear models on a subset of income data&quot;</span><span class="p">)</span>
<a name="True-90"></a>   <span class="kp">with</span><span class="p">(</span>points_samp<span class="p">[[</span>i<span class="p">]],</span> points<span class="p">(</span>hours2<span class="p">,</span> income2<span class="p">,</span> cex <span class="o">=</span> <span class="m">2</span><span class="p">))</span>
<a name="True-91"></a>   abline<span class="p">(</span>mod_lm<span class="p">[[</span>i<span class="p">]],</span> col <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">)</span>
<a name="True-92"></a>   abline<span class="p">(</span>mod_rlm<span class="p">[[</span>i<span class="p">]],</span> col <span class="o">=</span> <span class="s">&quot;blue&quot;</span><span class="p">)</span>
<a name="True-93"></a>   abline<span class="p">(</span>mod_lqs<span class="p">[[</span>i<span class="p">]],</span> col <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
<a name="True-94"></a>   
<a name="True-95"></a>   legend<span class="p">(</span><span class="s">&quot;topright&quot;</span><span class="p">,</span> legend <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;lm&quot;</span><span class="p">,</span> <span class="s">&quot;rlm&quot;</span><span class="p">,</span> <span class="s">&quot;lts&quot;</span><span class="p">),</span> lty <span class="o">=</span> <span class="m">1</span><span class="p">,</span> 
<a name="True-96"></a>          col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="s">&quot;blue&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span><span class="p">),</span> text.col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="s">&quot;blue&quot;</span><span class="p">,</span> <span class="s">&quot;red&quot;</span><span class="p">),</span>
<a name="True-97"></a>          bty <span class="o">=</span> <span class="s">&quot;n&quot;</span><span class="p">)</span>
<a name="True-98"></a>   
<a name="True-99"></a>   legend<span class="p">(</span><span class="s">&quot;bottomright&quot;</span><span class="p">,</span> legend <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;Full data&quot;</span><span class="p">,</span> <span class="s">&quot;Sampled data&quot;</span><span class="p">),</span>
<a name="True-100"></a>          pch <span class="o">=</span> <span class="m">1</span><span class="p">,</span> col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;grey50&quot;</span><span class="p">,</span> <span class="s">&quot;black&quot;</span><span class="p">),</span> pt.cex <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">,</span> 
<a name="True-101"></a>          bty <span class="o">=</span> <span class="s">&quot;n&quot;</span><span class="p">,</span> text.col <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;grey50&quot;</span><span class="p">,</span> <span class="s">&quot;black&quot;</span><span class="p">))</span>
<a name="True-102"></a>   
<a name="True-103"></a>   dev.off<span class="p">()</span>
<a name="True-104"></a><span class="p">}</span>
<a name="True-105"></a>
<a name="True-106"></a><span class="c1"># next sequence turns the various static frames into an animated GIF</span>
<a name="True-107"></a><span class="c1"># and depends on the actual location of ImageMagick:</span>
<a name="True-108"></a>projdir <span class="o">&lt;-</span> <span class="kp">setwd</span><span class="p">(</span><span class="s">&quot;_output/0041-rlm-lqs/&quot;</span><span class="p">)</span>
<a name="True-109"></a><span class="kp">system</span><span class="p">(</span><span class="s">&#39;&quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&quot; -loop 0 -delay 65 *.png &quot;../../../img/0041-rtm-lqs.gif&quot;&#39;</span><span class="p">)</span> 
<a name="True-110"></a><span class="kp">setwd</span><span class="p">(</span>projdir<span class="p">)</span>
<a name="True-111"></a>
<a name="True-112"></a>
<a name="True-113"></a><span class="c1">#--------------visual static comparison-----------------</span>
<a name="True-114"></a>par<span class="p">(</span>mfrow <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span> family <span class="o">=</span> <span class="s">&quot;myfont&quot;</span><span class="p">)</span>
<a name="True-115"></a>
<a name="True-116"></a><span class="c1"># draw graph for lqs</span>
<a name="True-117"></a>draw_plot<span class="p">()</span>
<a name="True-118"></a>title<span class="p">(</span>main <span class="o">=</span> <span class="s">&quot;Least trimmed squares&quot;</span><span class="p">)</span>
<a name="True-119"></a>
<a name="True-120"></a>
<a name="True-121"></a><span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>reps<span class="p">){</span>
<a name="True-122"></a>   abline<span class="p">(</span>mod_lqs<span class="p">[[</span>i<span class="p">]],</span> col <span class="o">=</span> adjustcolor<span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">,</span> alpha.f <span class="o">=</span> <span class="m">0.02</span><span class="p">))</span>
<a name="True-123"></a><span class="p">}</span>
<a name="True-124"></a>   
<a name="True-125"></a><span class="c1"># draw graph for rlm</span>
<a name="True-126"></a>draw_plot<span class="p">()</span>
<a name="True-127"></a>title<span class="p">(</span>main <span class="o">=</span> <span class="s">&quot;M-estimator&quot;</span><span class="p">)</span>
<a name="True-128"></a><span class="kr">for</span><span class="p">(</span>i <span class="kr">in</span> <span class="m">1</span><span class="o">:</span>reps<span class="p">){</span>
<a name="True-129"></a>   abline<span class="p">(</span>mod_rlm<span class="p">[[</span>i<span class="p">]],</span> col <span class="o">=</span> adjustcolor<span class="p">(</span><span class="s">&quot;blue&quot;</span><span class="p">,</span> alpha.f <span class="o">=</span> <span class="m">0.02</span><span class="p">))</span>
<a name="True-130"></a><span class="p">}</span>
<a name="True-131"></a>
<a name="True-132"></a>
<a name="True-133"></a><span class="c1">#-----------------compare estimated slopes-------------------</span>
<a name="True-134"></a>slopes <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>
<a name="True-135"></a>   lm <span class="o">=</span> <span class="kp">unlist</span><span class="p">(</span><span class="kp">lapply</span><span class="p">(</span>mod_lm<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">){</span>coef<span class="p">(</span>x<span class="p">)[</span><span class="m">2</span><span class="p">]})),</span>
<a name="True-136"></a>   rlm <span class="o">=</span> <span class="kp">unlist</span><span class="p">(</span><span class="kp">lapply</span><span class="p">(</span>mod_rlm<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">){</span>coef<span class="p">(</span>x<span class="p">)[</span><span class="m">2</span><span class="p">]})),</span>
<a name="True-137"></a>   lqs <span class="o">=</span> <span class="kp">unlist</span><span class="p">(</span><span class="kp">lapply</span><span class="p">(</span>mod_lqs<span class="p">,</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">){</span>coef<span class="p">(</span>x<span class="p">)[</span><span class="m">2</span><span class="p">]}))</span>
<a name="True-138"></a><span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-139"></a>   gather<span class="p">(</span>method<span class="p">,</span> value<span class="p">)</span>
<a name="True-140"></a>
<a name="True-141"></a><span class="c1"># summary table:</span>
<a name="True-142"></a>slopes <span class="o">%&gt;%</span>
<a name="True-143"></a>   mutate<span class="p">(</span>method <span class="o">=</span> <span class="kp">factor</span><span class="p">(</span>method<span class="p">,</span> levels <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;lm&quot;</span><span class="p">,</span> <span class="s">&quot;rlm&quot;</span><span class="p">,</span> <span class="s">&quot;lqs&quot;</span><span class="p">)))</span> <span class="o">%&gt;%</span>
<a name="True-144"></a>   group_by<span class="p">(</span>method<span class="p">)</span> <span class="o">%&gt;%</span>
<a name="True-145"></a>   summarise<span class="p">(</span>
<a name="True-146"></a>      mean <span class="o">=</span> <span class="kp">round</span><span class="p">(</span><span class="kp">mean</span><span class="p">(</span>value<span class="p">),</span> <span class="m">1</span><span class="p">),</span>
<a name="True-147"></a>      median <span class="o">=</span> <span class="kp">round</span><span class="p">(</span>median<span class="p">(</span>value<span class="p">),</span> <span class="m">1</span><span class="p">),</span>
<a name="True-148"></a>      sd <span class="o">=</span> <span class="kp">round</span><span class="p">(</span>sd<span class="p">(</span>value<span class="p">),</span> <span class="m">1</span><span class="p">)</span>
<a name="True-149"></a>   <span class="p">)</span>
<a name="True-150"></a>
<a name="True-151"></a>   
<a name="True-152"></a><span class="c1"># density plot, taking care to use same colours for each method</span>
<a name="True-153"></a><span class="c1"># as in previous graphics:</span>
<a name="True-154"></a>colours <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;lm&quot;</span> <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="s">&quot;rlm&quot;</span> <span class="o">=</span> <span class="s">&quot;blue&quot;</span><span class="p">,</span> <span class="s">&quot;lqs&quot;</span> <span class="o">=</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
<a name="True-155"></a><span class="kp">print</span><span class="p">(</span>direct.label<span class="p">(</span>
<a name="True-156"></a>ggplot<span class="p">(</span>slopes<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> value<span class="p">,</span> fill <span class="o">=</span> method<span class="p">,</span> colour <span class="o">=</span> method<span class="p">))</span> <span class="o">+</span>
<a name="True-157"></a>   geom_density<span class="p">(</span>alpha <span class="o">=</span> <span class="m">0.3</span><span class="p">)</span> <span class="o">+</span>
<a name="True-158"></a>   coord_cartesian<span class="p">(</span>xlim <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">-25</span><span class="p">,</span> <span class="m">75</span><span class="p">))</span> <span class="o">+</span>
<a name="True-159"></a>   scale_x_continuous<span class="p">(</span><span class="s">&quot;Estimated marginal return of extra hour of work&quot;</span><span class="p">,</span>
<a name="True-160"></a>                      label <span class="o">=</span> dollar<span class="p">)</span> <span class="o">+</span>
<a name="True-161"></a>   labs<span class="p">(</span>y <span class="o">=</span> <span class="s">&quot;Density of estimates from\nsamples of 30 each&quot;</span><span class="p">)</span> <span class="o">+</span>
<a name="True-162"></a>   scale_fill_manual<span class="p">(</span>values <span class="o">=</span> colours<span class="p">)</span> <span class="o">+</span>
<a name="True-163"></a>   scale_colour_manual<span class="p">(</span>values <span class="o">=</span> colours<span class="p">)</span>
<a name="True-164"></a><span class="p">))</span></code></pre></div>



</div>

<div class = "container">
   <div class="col-md-4">
    
        <a rel="prev" href="/blog/2016/05/14/scots-female-ratio">
        <p>&larr; Older</p>
        <p>Minimalist Tufte-inspired axis text with Scottish-New Zealand historical material</p>
        
        </a>
    
    </div>
    <div class="col-md-4">
    </div>
    <div class="col-md-4" style="text-align: right;">
     
        <a rel="next" href="/blog/2016/05/29/standard-deviation-confidence-intervals">
        <p>Newer &rarr;</p>
        <p>Actual coverage of confidence intervals for standard deviation</p>
        
        </a>
    
      </div>
      </div>
      
      
      
</div>


   
    <div id="disqus_thread"></div>

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'statsinthewild';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    
    
   
			
			</div><!-- /.container -->

         

   <div class = "container footer">
			<footer>
	    		
        	<p>Follow <a href = "/feed.xml">this blog with RSS</a>.  Or follow <a href = "/feed.r.xml">posts in this blog featuring R with RSS</a>.</p>
			
            <p>This blog is built with <a href = "http://jekyllrb.com/">Jekyll</a>, <a href = "http://getbootstrap.com/">Bootstrap</a>, <a href = "https://www.ruby-lang.org/en/">Ruby</a> and <a href = "https://cran.r-project.org/">R</a>.  Read my <a href="/about/acknowledgements.html">acknowledgements</a> for a little more on how.  I'm pleased to be aggregated at <a href="http://www.r-bloggers.com/">R-bloggers</a>, the one-stop shop for blog posts featuring R.</p>

			<div class="fb-like" data-href="https://www.facebook.com/peterstats/" data-layout="standard" data-action="like" data-show-faces="true" data-share="false"></div>
			
			<p>			
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Peter's stats stuff</span> by <a href = "/about/index.html">Peter Ellis</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
			</p>

			
			

			</footer>
    </div>



  
</body>
</html>
   




         
