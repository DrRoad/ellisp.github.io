---
layout: post
title: X13-SEATS-ARIMA as an automated forecasting tool
date: 2015-12-21
tag: 
   - Forecasting
   - Timeseries
   - DataFromTheWeb
   - R
description: X13-SEATS-ARIMA does not perform particularly well as an automated forecasting tool on the 3,003 test data series in the M3 forecasting competition.  For 412 series it fails to fit a model without manual intervention.  When it does fit a model, on average they don't perform as well as auto.arima from Hyndman's forecast package (but it does have a spooky ability to predict the 1987 stock crash).
image: /img/0024-dots.svg
socialimage: http://ellisp.github.io/img/0024-dots.png
category: R
---
## The M3 forecasting competition
The M3 forecasting competition in 2000, organized by Spyros Makridakis and Michele Hibon, tested a variety of methods against 3,003 time series, with forecasts compared to held out test sets.  The data are conveniently available for R users in the [Mcomp package](https://cran.r-project.org/web/packages/Mcomp/index.html) and [Rob Hyndman has published example code](http://robjhyndman.com/hyndsight/show-me-the-evidence/) benchmarking the ets() and auto.arima() functions from his [forecast package](https://cran.r-project.org/web/packages/forecast/) against the results in 2000.

Hyndman has [a good outline of the various various measures of forecast accuracy](http://www.robjhyndman.com/papers/forecast-accuracy.pdf).  I buy the argument that Mean Absolute Scaled Error (MASE) - not one used in the original M3 competition - is a better general indicator of forecast accuracy than any of the variants on percentage error, which fall apart when the series has negative values or values that go near to zero.  

## Objectives
I wanted to:

1. confirm Hyndman's results in his ["show me the evidence"](http://robjhyndman.com/hyndsight/show-me-the-evidence/) blog post, showing that a combination of auto.arima() and ets() gives very good out-of-the-box forecasting results
2. see how X13-SEATS-ARIMA, when run with its default values, compares to the methods benchmarked by Hyndman
3. explore for myself how the extremely successful Theta method works, and check whether Hyndman's implementation of the theta method in his forecast package (slightly different to that used in the competition in 2000) gives better results on these data than does the combination of ets() and auto.arima() that he recommends
4. See if alternative hybrids of methods may be better than the hybrid of ets() and auto.arima()

As it turned out, the most interesting part of this was item 2, and item 3 also has a question mark against it for further investigation.

To do all this I modified [Hyndman's benchmarking code](http://robjhyndman.com/m3comparisons.R) to add five additional forecasting methods:

* forecast::thetaf
* X13-SEATS-ARIMA
* hybrid of thetaf, ets and auto.arima
* hybrid of thetaf and ets
* hybrid of thetaf and auto.arima

This exercise ended up much more complex than I'd envisaged, and there's too much code to integrate into the text, so the full set of code can be found in the [\<source\> branch of my blog repository](https://github.com/ellisp/ellisp.github.io/blob/source/_working/0024-m3.R).

### X13-SEATS-ARIMA
[X13-SEATS-ARIMA](https://www.census.gov/srd/www/x13as/) is the industry standard tool for seasonal adjustment, particularly for official statistics published by national statistics offices.  It gives a choice of the SEATS algorithm from the Bank of Spain, and X11 (Statistics Canada and US Census Bureau).  X13-SEATS-ARIMA combines these into a single application, available for download from the US Census Bureau.  Christoph Sax's excellent [{seasonal} R package](https://cran.r-project.org/web/packages/seasonal/index.html) gives easy access from R.

To seasonally adjust historical data, X13 can automatically select a seasonal ARIMA model, and it can forecast future values.  This made me wonder how it goes as a automated forecasting tool.  I couldn't find (on an admittedly very cursory look) anyone who had benchmarked it against a large number of time series, so I thought I'd try it against the M3 competiton set.  I thought it might do well because of its default settings to automatically handle outliers, level shifts, transformations, and moving holidays like Easter.

In testing X13 on the M3 data, I had to give it different settings for annual data from seasonal, as otherwise it trips over in trying to find effects from Easter, number of trading days, etc.

### Theta
One of the secondary objectives was to compare the implementation of the Theta method in Hyndman's {forecast} package (referred to in this post as forecast::thetaf) with the version that won the original 2000 M3 competition.  In [a 2001 paper](http://www.robjhyndman.com/papers/Theta.pdf), Hyndman and Billah showed that the Theta method is equivalent to simple exponential smoothing with drift and this was implemented in {forecast}.  The 2001 paper tested the new implementation on the annual data but not the seasonal data; I wanted to use it on the remaining series, to see how it compares to the exponential smoothing model ets() recommended by Hyndman as a complement to his auto.arima().

## Results
The big surprises for me were:

* X13-SEATS-ARIMA, run with the defaults, doesn't do particularly well
* forecast::thetaf() doesn't do particularly well.

One result that came out as expected was:

* hybrids of methods perform well, and the best result obtained by me in fact was an average of the forecasts of all three of auto.arima(), ets() and theta().

For 412 series X13-SEATS-ARIMA cannot choose a model to fit without human intervention.  In the remaining cases it is mediocre on average, coming out materially worse than auto.arima.  The clever model selection in auto.arima clearly more than compensates for not considering transforms, outliers and moving holidays.

To get some kind of overall result at all for X13 I replaced all the cases where it couldn't fit a model with the forecasts from auto.arima().  This is obviously grossly unfair as a statement of the overall strength of X13 (fairer might have been to replace with a naive model - final value in the test set repeats itself over the forecast period), but it does mean that I can at least make crude comparisons.

![dots](/img/0024-dots.svg)

* "Hybrid 3" is my average of the point estimates of all three of ets(), auto.arima(), and thetaf() from the {forecast} package.
* theta_fc is forecast::thetaf
* ETS is forecast::ets ie an exponential smoothing state space model
* Theta is the Theta results from the original 2000 competition

### Why does X13 sometimes fail?

There are five types of error that lead to X13 failing to fit a model on this collection of data series.  Each error message is shown below with a minimal example to produce it.

#### Struggles to handle high degree of integration
{% highlight R lineanchors %}
> library(seasonal)
> library(Mcomp)
> seas(M3[[434]]$x, regression.aictest = NULL)
Error: X-13 run failed

Errors:
- Nonseasonal AR polynomial with initial parameters is nonstationary 
with root(s) on or inside the unit circle. RESPECIFY the model with 
different initial parameters.
{% endhighlight %}

Basically, this is a failure of the model selection process in X13-SEATS-ARIMA to correctly identify the degree of integration - ie how many times the series must be "differenced" to turn it into a stationary series.  auto.arima() uses a [clearly superior method](http://www.jstatsoft.org/article/view/v027i03/v27i03.pdf) that gives more robust results.  The problem could be resolved by using auto.arima() to determine the order of a model and then fitting it with X13-SEATS-ARIMA - in the case of annual data without outliers like series 434 X13 and auto.arima then give identical results because there is no Easter or similar impacts that are handled differently by the two.

Note - actually, if you use the version of {seasonal} on CRAN you won't get even this error message, but another one that is caused by problems parsing the X13 error message into R.  Christoph Sax kindly patched {seasonal} with a hack around this which will make it onto CRAN eventually.


#### Matrix singularity because of trading days
{% highlight R lineanchors %}
> seas(M3[[1154]]$x)
Error: X-13 run failed

Errors:
- A model estimation error has occurred during AIC testing within the automatic model
  identification procedure. The error message appears below.
- Regression matrix singular because of Sat.  Check regression model or change automatic 
outlier options i.e. method to addone or types to identify AO only.
{% endhighlight %}

This problem was relatively rare and happened with some short seasonal series.  It's easy to deal with by specifying that number of trading days should not be included as a regression variable.
  
#### Runs but produces no data
{% highlight R lineanchors %}
> seas(M3[[807]]$x)
Error: X-13 has run but produced no data
{% endhighlight %}

This is a mysterious error that I haven't been able to get to the bottom of.  It might be something to do with the R - X13 interface, or something purely with X13.

#### Cannot process spec file for an unknown reason
{% highlight R lineanchors %}
> seas(M3[[1485]]$x)
Error: X-13 has returned a non-zero exist status, which means that 
the current spec file cannot be processed for an unknown reason.
{% endhighlight %}
Again, I couldn't work out what is ultimately causing this error.

#### Can't handle phony date/times
{% highlight R lineanchors %}
> seas(M3[[3000]]$x)
Error in seas(M3[[3000]]$x) : 
  start year of 'x' must be > 999.
{% endhighlight %}
A number of the series in the Mcomp package do not have actual times and dates specified, most frequently because they are daily financial series that are not regularly spaced time series if their date information is included.  Because of the way it treats Easter and trading day variables, X13-SEATS-ARIMA needs data that is from the year 1000 or later.  There's no obvious solution for this; I don't think X13-SEATS-ARIMA can handle irregular daily time series itself (let me know in the comments if I'm wrong).

### When it succeeds, why is X13 worse than auto.arima?

#### Examples of auto.arima() out-performing X13-SEATS-ARIMA
Looking at individual forecasts is a mug's way of assessing the overall strength of forecasting methods, but it at least gets the brain moving.  Here are some examples of where the model selection of X13 wasn't as good as that of auto.arima.

![aa1](/img/0024-x13-comp-73.svg)

![aa2](/img/0024-x13-comp-64.svg)

![aa3](/img/0024-x13-comp-1388.svg)

![aa4](/img/0024-x13-comp-120.svg)


#### Examples of X13-SEATS-ARIMA out-performing auto.arima()
...and to be fair, here are some examples in the other direction.  X13 has an almost spooky ability to pick the history of unpredictability in the US stock exchange and effectively predicted the big stock market crash when it is fed data up to 1987.

![aa1](/img/0024-x13-comp-335.svg)

![aa2](/img/0024-x13-comp-334.svg)

![aa3](/img/0024-x13-comp-49.svg)

![aa4](/img/0024-x13-comp-171.svg)

### Why is forecast::thetaf() not particularly good?
Actually, this one has me completely stumped, given [Hyndman and Billah](http://www.robjhyndman.com/papers/Theta.pdf)) have shown that it does very well indeed with the annual data from M3.  My working hypothesis is that I've somehow stuffed up the benchmarking process.  Failing that, I'll have to go with the idea that the way parameters are estimated in forecast::thetaf() is a particular weakness for seasonal data.  Something to investigate further?

Interesting to note that, while forecast::thetaf() didn't do particularly well on its own account this time, it does feature in the two best hybrid methods.   Suggesting that it has strengths in some areas that other methods fail to work adequately.

## Conclusion

* X13-SEATS-ARIMA is not a particularly good tool for automated, no-hands forecasting.  This isn't particularly surprising as I don't think it's ever been spruiked as such.   It's a tool for careful specialists who correctly check diagnostic plots and tests, and who can handle a 15% failure rate of its automated model selection.
* forecast::thetaf() needs more investigation
* hybrid forecasts - averaging several methods - is the go.

Just to be clear - X13-SEATS-ARIMA is a fantastic tool, and I think it is the best out there in its role as a tool for careful analysis of quarterly and monthly seasonal time series, using real calendar dates, as part of an official statistics process.  In a big majority of cases, particularly with seasonal data, its defaults and its automatic model selection give you good results, and will deliver very good seasonal adjustment.  However, its automatic modelling under default conditions isn't as robust (ie guaranteed to get a working model) as other methods, and the resulting models don't always give optimal results for forecasting.