---
layout: post
title: Success rates of automated ARIMA fitting
date: 2015-09-30
tag: 
   - R
   - Timeseries
description: Using an automated process to select the order of an ARMA time series model returns the true data generating process less often than I thought; and with more complex models the chance of success comes down nearly to zero even with long sample sizes.
image: /img/0012-results.svg
socialimage: /img/0012-results.png
category: R
edit-location: _knitr
---

<h2>A function for testing auto.arima()</h2>
<P>This is the third, and the last from me on this particular topic for a while, in a series of posts on fitting time series models and comparing time series to eachother, originally inspired by a question on the Cross-Validated Q&A site.  In this week's post I'm exploring and testing an almost throw-away comment in my original answer - that looking at the parameterisation of an automatically chosen ARIMA (autoregressive integrated moving average) time series model is a bad idea because very similar data generating models may quite legitimately be fit by different-looking ARIMA models. I want to look at a corollory to that:</p>

<blockquote>
  <p>"How successful will an automated ARIMA selection be at returning the order of the original data generating process for a simulated time series?"</p>
</blockquote>

<P>I wanted to explore Rob Hyndman's excellent auto.arima() function, which uses small-sample corrected Akaike Information Criterion (<a href = "https://en.wikipedia.org/wiki/Akaike_information_criterion#AICc">AICc</a>) for model selection, in particular.  We use it a lot at my work and I wanted to see how it performs when fitting a known dataset.  To explore this, I created a function that:<P>
<ol>
<LI>takes as an argument a model specification (eg AR(1) for autoregression of order 1 ie a time series created by a constant times its lagged value plus white noise)
<LI>simulates a large number (user controlled) of replications of that series, of a variety of different sample lengths (defaulting to 20, 40, 80, ..., 10240)
<LI>Uses the auto.arima() model to identify the best ARIMA model for each replication of the series
<LI>Stores the order of the final model and compares it against the correct order
</ol>

<p>Here's the code for that function:</P>
 
 
{% highlight R lineanchors %}
library(dplyr)
library(tidyr)
library(ggplot2)
library(showtext) # for fonts
library(forecast)

font.add.google("Poppins", "myfont")
showtext.auto()
theme_set(theme_light(base_family = "myfont"))

arima_fit_sim <- function(model, 
                          correct_params, 
                          n = 2 ^ (1:10) * 10, 
                          reps = 10,
                          stepwise = FALSE,
                          verbose = TRUE){
   
   # function that creates @reps number of simulated ARIMA models of type @model and 
   # length @n.  @correct_params should be a vector of the correct parameters eg
   # c("ar1", "ma1", "ma2") for ARMA(1,2)
   # peter.ellis2013nz at gmail com 25 September 2015
   
   require(forecast)
   if(verbose){require(dplyr)}
   
   results <- data.frame(n = rep(n, each = reps),
                      correct = FALSE,
                      fitted = "",
                      stringsAsFactors = FALSE)
   counter <- 0

   for(j in 1:length(n)){
      if(verbose){message(n[j])}
      for(i in 1:reps){
         counter <- counter + 1
         true_series <- arima.sim(model, n = n[j])
         fit <- auto.arima(true_series, stepwise = stepwise)
         results[counter, "fitted"] <- paste(names(fit$coef), collapse = " ")
         if(length(coef(fit)) == length(correct_params) && sum(names(fit$coef) %in% correct_params) == length(correct_params) ){
            results[counter, "correct"] <- TRUE
            
         }   else {
            results[counter, "correct"] <- FALSE
         }
         
      }
   }
   
   if(verbose){
      print(
         results %>%
            group_by(n) %>%
            summarise(correct = sum(correct) / length(correct) * 100)
         )
   }

   return(results)
   }
{% endhighlight %}


<h2>The test</h2>
<P>For my actual test, I chose to try out two simple simulations - AR(1) and MA(1) processes - and two more complex ones - ARMA(2,2) and ARMA(3,3).  There's a sticking point which is the actual  autoreggressive and moving average parameters.  An AR(1) process autoregression coefficient of 0.05 for example will be almost indistinguishable from white noise, whereas as it gets closer to 1 it would be much easier for the model selection algorithm to notice.  To do a comprehensive test, I should actually compare models across the whole parameter space.  As this is just a blog post, I arbitrarily chose some values.</P>

<P>Here's the code performing the actual tests on those four processes, using my new arima_fit_sim() function with 500 repetitions of each combination of model and sample length.  This took about eight hours to run on my (nothing special) laptop:</P>

{% highlight R lineanchors %}
our_reps <- 500

results_ar1 <- arima_fit_sim(model = list(ar = c(0.5)),
                             correct_params = c("ar1"), 
                             reps = our_reps)

results_ma1 <- arima_fit_sim(model = list(ma = c(0.5)),
                             correct_params = c("ma1"), 
                             reps = our_reps)


results_arma22 <- arima_fit_sim(model = list(ar = c(0.5, -0.2), ma = c(-0.3, 0.2)),
                                correct_params = c("ar1", "ar2", "ma1", "ma2"), 
                                reps = our_reps)

results_arma33 <- arima_fit_sim(model = list(ar = c(0.5, -0.2, 0.3), ma = c(-0.3, 0.2, 0.4)),
                                correct_params = c("ar1", "ar2", "ar3", "ma1", "ma2", "ma3"), 
                                reps = our_reps)


save(results_ar1, results_ma1, results_arma22, results_arma33, file = "_output/0012_sim_results.rda")
{% endhighlight %}



<h2>Results</h2>
<p>My function stores the order of the 5000 models it has fit for each simulation.  Here are the ten most common models that were selected in the case of the AR(1) model:
<!-- html table generated in R 3.2.1 by xtable 1.7-4 package -->
<!-- Tue Sep 29 07:22:07 2015 -->
<table border=1>
<tr> <th> fitted </th> <th> count </th>  </tr>
  <tr> <td> ar1 </td> <td align="right"> 1752 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 ma2 </td> <td align="right"> 316 </td> </tr>
  <tr> <td> ar1 intercept </td> <td align="right"> 278 </td> </tr>
  <tr> <td> ma1 </td> <td align="right"> 238 </td> </tr>
  <tr> <td> ar1 ar2 </td> <td align="right"> 224 </td> </tr>
  <tr> <td> ar1 ma1 </td> <td align="right"> 210 </td> </tr>
  <tr> <td> ar1 ar2 ma1 </td> <td align="right"> 185 </td> </tr>
  <tr> <td> ma1 ma2 </td> <td align="right"> 140 </td> </tr>
  <tr> <td> ar1 ar2 ar3 </td> <td align="right"> 124 </td> </tr>
  <tr> <td> ma1 ma2 ma3 </td> <td align="right"> 116 </td> </tr>
   </table></p>

<p>As a percentage correct for different sample lengths, here's how they end up:
<!-- html table generated in R 3.2.1 by xtable 1.7-4 package -->
<!-- Wed Sep 30 07:31:01 2015 -->
<table border=1>
<tr> <th> n </th> <th> correct </th>  </tr>
  <tr> <td align="right"> 20 </td> <td align="right"> 29.0 </td> </tr>
  <tr> <td align="right"> 40 </td> <td align="right"> 35.0 </td> </tr>
  <tr> <td align="right"> 80 </td> <td align="right"> 38.6 </td> </tr>
  <tr> <td align="right"> 160 </td> <td align="right"> 31.2 </td> </tr>
  <tr> <td align="right"> 320 </td> <td align="right"> 29.8 </td> </tr>
  <tr> <td align="right"> 640 </td> <td align="right"> 35.4 </td> </tr>
  <tr> <td align="right"> 1280 </td> <td align="right"> 37.2 </td> </tr>
  <tr> <td align="right"> 2560 </td> <td align="right"> 37.4 </td> </tr>
  <tr> <td align="right"> 5120 </td> <td align="right"> 36.0 </td> </tr>
  <tr> <td align="right"> 10240 </td> <td align="right"> 40.8 </td> </tr>
   </table></p>


<p>In this simple case, auto.arima() is moderately successful.  It correctly picked an AR(1) model as the best 1752 times out of 5000, much more than the second most popular model which was a very complex ARMA(3,2).  Even when the time series is only 20 observations long it gets it right 29 percent of the time, and this goes up to 41 percent by the time there are 10,000 observations.  I suspect it gets better as the time series gets longer, but I'd (naively) expected better than this.  I was surprised that even for a longish time series only 41 percent of the time is the true model being recovered. </P>


<p>Here's a plot summarising the overall results</p>
<div class ="img-container"><img src = "/img/0012-results.svg"></div>

<p>Here it is separated out by facets so we can see that pattern closer.</p>
<div class ="img-container"><img src = "/img/0012-results-faceted.svg"></div>

<p>I was a bit astonished at the poor success rate of picking up the ARMA(3, 3) process so I tabulate here the counts of every final model that actually was selected.
<!-- html table generated in R 3.2.1 by xtable 1.7-4 package -->
<!-- Tue Sep 29 07:22:07 2015 -->
<table border=1>
<tr> <th> fitted </th> <th> count </th>  </tr>
  <tr> <td> ar1 ma1 ma2 ma3 ma4 </td> <td align="right"> 1446 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 ma5 </td> <td align="right"> 500 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 </td> <td align="right"> 444 </td> </tr>
  <tr> <td> ar1 ma1 ma2 ma3 </td> <td align="right"> 339 </td> </tr>
  <tr> <td> ar1 ma1 ma2 ma3 ma4 intercept </td> <td align="right"> 276 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 ma2 </td> <td align="right"> 248 </td> </tr>
  <tr> <td> ar1 ar2 drift </td> <td align="right"> 229 </td> </tr>
  <tr> <td> ar1 ar2 ar3 </td> <td align="right"> 168 </td> </tr>
  <tr> <td> ar1 ar2 ma1 ma2 ma3 </td> <td align="right"> 157 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 intercept </td> <td align="right"> 151 </td> </tr>
  <tr> <td> intercept </td> <td align="right"> 115 </td> </tr>
  <tr> <td> ar1 ma1 ma2 ma3 intercept </td> <td align="right"> 103 </td> </tr>
  <tr> <td>  </td> <td align="right">  88 </td> </tr>
  <tr> <td> ma1 ma2 ma3 </td> <td align="right">  61 </td> </tr>
  <tr> <td> ma1 </td> <td align="right">  54 </td> </tr>
  <tr> <td> ar1 ar2 ma1 ma2 drift </td> <td align="right">  50 </td> </tr>
  <tr> <td> ar1 ar2 ma1 ma2 ma3 intercept </td> <td align="right">  43 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ar5 </td> <td align="right">  42 </td> </tr>
  <tr> <td> ma1 ma2 ma3 intercept </td> <td align="right">  41 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 </td> <td align="right">  32 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ma1 </td> <td align="right">  31 </td> </tr>
  <tr> <td> ar1 ar2 ma1 ma2 </td> <td align="right">  29 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 drift </td> <td align="right">  28 </td> </tr>
  <tr> <td> ma1 drift </td> <td align="right">  27 </td> </tr>
  <tr> <td> ar1 ar2 ar3 drift </td> <td align="right">  25 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 ma2 intercept </td> <td align="right">  24 </td> </tr>
  <tr> <td> ar1 ar2 intercept </td> <td align="right">  24 </td> </tr>
  <tr> <td> ar1 </td> <td align="right">  21 </td> </tr>
  <tr> <td> ar1 ar2 </td> <td align="right">  19 </td> </tr>
  <tr> <td> ma1 intercept </td> <td align="right">  16 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 drift </td> <td align="right">  14 </td> </tr>
  <tr> <td> drift </td> <td align="right">  13 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 </td> <td align="right">  12 </td> </tr>
  <tr> <td> ar1 ar2 ma1 drift </td> <td align="right">  12 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 ma5 drift </td> <td align="right">  12 </td> </tr>
  <tr> <td> ma1 ma2 ma3 ma4 ma5 intercept </td> <td align="right">  12 </td> </tr>
  <tr> <td> ar1 ar2 ar3 intercept </td> <td align="right">  11 </td> </tr>
  <tr> <td> ar1 ma1 ma2 </td> <td align="right">  11 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ar5 intercept </td> <td align="right">   8 </td> </tr>
  <tr> <td> ma1 ma2 ma3 drift </td> <td align="right">   8 </td> </tr>
  <tr> <td> ma1 ma2 drift </td> <td align="right">   7 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ar5 drift </td> <td align="right">   5 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ma1 intercept </td> <td align="right">   5 </td> </tr>
  <tr> <td> ar1 ar2 ma1 ma2 ma3 drift </td> <td align="right">   5 </td> </tr>
  <tr> <td> ar1 intercept </td> <td align="right">   5 </td> </tr>
  <tr> <td> ma1 ma2 </td> <td align="right">   5 </td> </tr>
  <tr> <td> ma1 ma2 intercept </td> <td align="right">   5 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 ma2 drift </td> <td align="right">   4 </td> </tr>
  <tr> <td> ar1 ar2 ma1 intercept </td> <td align="right">   4 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 intercept </td> <td align="right">   3 </td> </tr>
  <tr> <td> ar1 drift </td> <td align="right">   2 </td> </tr>
  <tr> <td> ar1 ma1 </td> <td align="right">   2 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ar4 ma1 drift </td> <td align="right">   1 </td> </tr>
  <tr> <td> ar1 ar2 ar3 ma1 intercept </td> <td align="right">   1 </td> </tr>
  <tr> <td> ar1 ar2 ma1 </td> <td align="right">   1 </td> </tr>
  <tr> <td> ar1 ma1 intercept </td> <td align="right">   1 </td> </tr>
   </table></p>
<p>Yes, that's right, many many models are picked but not a single instance matches the "ar1 ar2 ar3 ma1 ma2 ma3" that was the original data generating process.  So the take home message is even stronger than I thought - don't pay much attention to the order of your fitted ARIMA models!  This doesn't mean there's a problem with using them - they give good fits and work well in many forecasting situations.  But we shouldn't confuse them with some essential reality of an underlying process.  It's a striking example of the famous (well in some quarters) quote by ??</p>

<blockquote>
  <p><a href = "https://en.wikiquote.org/wiki/George_E._P._Box">"All models are wrong, but some are useful" (Box)</a></p>
</blockquote>

<h3>Code that produced the summary tables</h3>
{% highlight R lineanchors %}
results_ar1 %>%
   group_by(fitted) %>%
   summarise(count = length(fitted)) %>%
   arrange(-count) %>%
   head(10) 

results_ar1 %>%
   group_by(n) %>%
   summarise(correct = sum(correct) / length(correct) * 100)



results_arma33 %>%
   group_by(fitted) %>%
   summarise(count = length(fitted)) %>%
   arrange(-count) 
{% endhighlight %}

<h3>Code that produced the summary plot</h3>
{% highlight R lineanchors %}
# code creating plot goes here

{% endhighlight %}
