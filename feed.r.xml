<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Peter&#39;s stats stuff - R</title>
		<description>Posts categorised as 'R'</description>
		<link>http://ellisp.github.io</link>
		<atom:link href="http://ellisp.github.io/feed.R.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Network charts of commuting in New Zealand with R and D3</title>
					<description>&lt;h2 id=&quot;commuting-between-districts-and-cities-in-new-zealand&quot;&gt;Commuting between districts and cities in New Zealand&lt;/h2&gt;
&lt;iframe src=&quot;http://ellisp.github.io/img/0025-networkD3.html&quot; style=&quot;overflow-y: hidden;&quot; width=&quot;100%&quot; height=&quot;430px&quot;&gt;&lt;/iframe&gt;

&lt;p&gt;At this year’s New Zealand Statisticians Association conference I gave a talk on &lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/regions-cities/research/modelled-territorial-authority-gross-domestic-product&quot;&gt;Modelled Territorial Authority Gross Domestic Product&lt;/a&gt;.  One thing I’d talked about was the impact on the estimates of people residing in one Territorial Authority (district or city) but working in another one.  This was important because data on earnings  by place of residence formed a crucial step in those particular estimates of modelled GDP, which needs to be based on place of production.  I had a slide to visualise the “commuting patterns”, which I’d prepared for that talk but isn’t used elsewhere, and thought I’d share it and a web version here on this blog.&lt;/p&gt;

&lt;p&gt;The web version is the one in the frame above this text.  It’s designed to be interacted with - try hovering over circles, or picking them up and dragging them around.&lt;/p&gt;

&lt;h2 id=&quot;data&quot;&gt;Data&lt;/h2&gt;
&lt;p&gt;The source data for this come from 2013 Census and are &lt;a href=&quot;http://www.stats.govt.nz/Census/2013-census/profile-and-summary-reports/commuter-view-visualisation.aspx&quot;&gt;published by Statistics New Zealand&lt;/a&gt;, who have their own &lt;a href=&quot;http://www.stats.govt.nz/datavisualisation/commuterview/index.html&quot;&gt;rather nifty map-based visualisation&lt;/a&gt;.  The data are published on the visualisation’s information page and it’s easy to grab the CSV and tidy it up in R:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;igraph&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;networkD3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import fonts&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download data from Statistics New Zealand&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;X &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.stats.govt.nz/~/media/Statistics/Census/2013%20Census/profile-and-summary-reports/commuter-view-interactive/2013-usual-residence-by-workplace-address-territorial-authority.csv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;              na.strings       &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;..C&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;              sep              &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;              stringsAsFactors &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;              check.names      &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;              header           &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Tidy into long form, remove clutter, make names consistent, &lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# drop uninteresting data:&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;TravelAll &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; X&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;67&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; 
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;  rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Usual.residence&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;  gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;to&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;from&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;  mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; District&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;         from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; City&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;         from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; Territory&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; Territory&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; District&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; City&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hawke s&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hawke&amp;#39;s&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Matamata Piako&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Matamata-Piako&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Queenstown Lakes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Queenstown-Lakes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;         to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Thames Coromandel&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Thames-Coromandel&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;  filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;           to &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Total workplace address&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;           to &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;No Fixed Workplace Address&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;           to &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Area Outside Territorial Authority&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;  filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Not Further Defined&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;  mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;         value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; 
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# subset dropping the small values:  &lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;Travel &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; TravelAll &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; 
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;  filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;drawing-a-static-plot&quot;&gt;Drawing a static plot&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0025-commuting.svg&quot; alt=&quot;static&quot; /&gt;
The static plot I used in my presentation is made with the excellent &lt;a href=&quot;https://cran.r-project.org/web/packages/igraph/index.html&quot;&gt;{igraph} package&lt;/a&gt; by Gabor Csadi.  There are lots of options for layouts; not being an expert in network graphs I used trial and error until I got something sufficiently visually striking.  Note that the locations of districts and cities are chosen to maximise use of white space given the various connections between them - they don’t represent physical locations (which is possible, but less impact for my purpose).&lt;/p&gt;

&lt;p&gt;The eventual code is simple enough.  The “Travel” object I created in the previous chunk of code is in the right shape, with its “from” and “to” columns enough to define both the nodes and edges (ie links connecting nodes), and the “value” column is used to define the width of each edge.  There was a bit of finesse required with size and font settings to get it looking useful.  As it sits, it’s still difficult to tell which way the arrows are pointing (most relationships are both ways of course, and all the arrows merge together into blobs for significant “target” authorities like Auckland), but it gets the job down of picturing which districts and cities are linked to which.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;draw_plot &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;seed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;125&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;seed&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# there&amp;#39;s some randomness in the graphing layout&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   g &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; Travel  &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;      graph.data.frame&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;       
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mai &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;  
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;g&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; edge.arrow.size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; layout &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; layout.davidson.harel&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;        edge.width &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Travel&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;        vertex.size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; edge.curved &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;        vertex.label.family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;        vertex.label.cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;        main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Commuting patterns 2013 (&amp;gt;100 people commuting)&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;          
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;drawing-an-interactive-plot&quot;&gt;Drawing an interactive plot&lt;/h2&gt;
&lt;iframe src=&quot;http://ellisp.github.io/img/0025-networkD3.html&quot; style=&quot;overflow-y: hidden;&quot; width=&quot;100%&quot; height=&quot;430px&quot;&gt;&lt;/iframe&gt;

&lt;p&gt;The interactive plot is a bit fiddlier, but still a fairly straightforward task with the help of the &lt;a href=&quot;https://cran.r-project.org/web/packages/networkD3/index.html&quot;&gt;{networkD3} package&lt;/a&gt; by Christopher Gandrud et al.  This package uses the &lt;a href=&quot;http://www.htmlwidgets.org/&quot;&gt;htmlwidgets paradigm&lt;/a&gt; to make JavaScript D3 network graph visualisations easy to create.  This gives us access to the data management and analysis capabilities of R as well as the web visualisations of JavaScript.&lt;/p&gt;

&lt;p&gt;There’s a bit of extra work to be done here and it’s not quite such an R-native feel as using {igraph}.  Most significantly, JavaScript (like most computer languages I know other than R) indexes its arrays starting at zero, not one, and the data frame that holds the “from” and “to” information for the edges needs to refer to nodes by number from zero to (n - 1).  There are many ways to do this but I find the easiest is to use Wickham’s dplyr pipeline - as in the code that creates the “Links” data frame below.  Note that I’m also classifying the territorial authorities by island.&lt;/p&gt;

&lt;p&gt;One of the strengths of an interactive plot is we can impart extra information by hover-over tooltips that would be way too cluttered in a static chart.  In this case, I’ve done a slightly ugly summary of an authority’s total “to” and “from” movements from residence to place of work.  The code below creating “froms”, “tos”, “both” and “TAs” data frames is for this purpose, so the “label” column can be used in the visualisation for the actual tooltips.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# vector of south island districts so we can colour nodes by island:&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;southisland &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Dunedin&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Tasman&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Nelson&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Marlborough&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Christchurch&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;s&quot;&gt;&amp;quot;Queenstown-Lakes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Invercargill&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Grey&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;s&quot;&gt;&amp;quot;Westland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Waimakariri&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hurunui&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Selwyn&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;s&quot;&gt;&amp;quot;Ashburton&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Timaru&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Mackenzie&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Waimate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Central Otago&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;s&quot;&gt;&amp;quot;Waitaki&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Clutha&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Gore&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Southland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Buller&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a look up table of TA names and ID 0:(n-1)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;TAs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Travel&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;from&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Travel&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;to&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; 
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;TAs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; TAs &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ID &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TAs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;          size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;          island &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; southisland&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;South Island&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;North Island&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a data frame with numbers 0 : n-1 instead of names of TAS          &lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;Links &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; Travel &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TAs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;from&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;from&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ID&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TAs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;to&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;to&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ID&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create some totals for more informative tooltips:&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;froms &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; TravelAll &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;From &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; from&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;tos &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; TravelAll &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;to&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;To &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; to&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;both &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; full_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;froms&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; tos&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;. From: &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; From&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;; To: &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; To&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; 
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;TAs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; TAs &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;both&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Drawing a good looking network chart is easy enough, and just a matter of getting the data in the right shape and telling the forceNetwork() R function which columns to use as Source and Target for each edge / link, and which columns of a second data frame to use for Group (which controls colour), Nodesize, and NodeID (which controls the mouse hover tooltips).  Controlling colours requires us to create a D3 scale as a palette which needs a bit of basic JavaScript, which gets passed to forceNetwork via the colourScale = JS(…) snippet below.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;pal &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;d3.scale.ordinal()&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;         .domain([&amp;quot;South Island&amp;quot;, &amp;quot;North Island&amp;quot;])&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;         .range([&amp;quot;#FF6900&amp;quot;, &amp;quot;#694489&amp;quot;]);&amp;#39;&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;net &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; forceNetwork&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Links&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Source &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;from&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Target &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;to&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;             Nodes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TAs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; NodeID &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;label&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Nodesize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;size&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Group &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;island&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;             fontFamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; height &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;350&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; width &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;650&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bounded &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;             colourScale &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; JS&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;pal&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;saveNetwork&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;net&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0025-networkD3.html&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; selfcontained &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In the code above I’ve saved the resulting HTML to a file (and folders containing the various other assets eg JavaScript).  This file is basically ready to go, but as a final touch I want to insert a line into the header, just above the &amp;lt;/head&amp;gt; tag, calling in the Cascading Style Sheets used in my blog, including the “Poppins” font from Google Fonts.  You’ll have seen in the code above that I told the D3 network chart to use Poppins font, but unless it knows where to find it it can’t do anything with this.  I also wanted to insert a heading into the body; my intended use for this HTML page was to be placed in an iframe in this blog post, and for visual coherence it needs a heading inside the iframe.&lt;/p&gt;

&lt;p&gt;So I read the HTML back into R, insert the lines I want by find and replace with the gsub() function, and write it back to file, and I’ve managed to avoid editing any HTML by hand (useful if there are going to be lots of iterations during development).&lt;/p&gt;

&lt;p&gt;These last few snippets of code would need to be adapted to your particular folder structure, fonts and CSS if you want to copy them.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;readLines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0025-networkD3.html&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;lt;/head&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;lt;link href=&amp;quot;/css/bootstrap-theme.min.css&amp;quot; rel =&amp;quot;stylesheet&amp;quot;&amp;gt;&amp;lt;/head&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;            tmp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;lt;div id=&amp;quot;htmlwidget_container&amp;quot;&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;            &lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;lt;h3&amp;gt;Residents in one area, working in another&amp;lt;/h3&amp;gt;&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;            &amp;lt;div id=&amp;quot;htmlwidget_container&amp;quot;&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;            tmp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;            
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;writeLines&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0025-networkD3.html&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If anyone’s wondering why Wellington has so many inbound commuters compared to Auckland, which is much larger, it’s just an artefact of boundaries.  Wellington Region is divided into a number of smaller cities and regions which show up in this sort of data, whereas the Auckland region is a single territorial authority.&lt;/p&gt;

&lt;p&gt;C’est tout.&lt;/p&gt;

&lt;h3 id=&quot;edits&quot;&gt;Edits&lt;/h3&gt;
&lt;p&gt;Edited 27/12/2015 so the numbers in the tooltip labels include the sums of commuters even when less than 100 - incorrectly omitted in the first version.  I now use the pre-filtered “TravelAll” object for creating the labels.  This doesn’t make any visual difference, but the numbers were understated before.&lt;/p&gt;
</description>
				<pubDate>Sat, 26 Dec 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/12/26/commuting-network</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/12/26/commuting-network</guid>
			</item>
		
			<item>
				<title>X13-SEATS-ARIMA as an automated forecasting tool</title>
					<description>&lt;h2 id=&quot;the-m3-forecasting-competition&quot;&gt;The M3 forecasting competition&lt;/h2&gt;
&lt;p&gt;The M3 forecasting competition in 2000, organized by Spyros Makridakis and Michele Hibon, tested a variety of methods against 3,003 time series, with forecasts compared to held out test sets.  The data are conveniently available for R users in the &lt;a href=&quot;https://cran.r-project.org/web/packages/Mcomp/index.html&quot;&gt;Mcomp package&lt;/a&gt; and &lt;a href=&quot;http://robjhyndman.com/hyndsight/show-me-the-evidence/&quot;&gt;Rob Hyndman has published example code&lt;/a&gt; benchmarking the ets() and auto.arima() functions from his &lt;a href=&quot;https://cran.r-project.org/web/packages/forecast/&quot;&gt;forecast package&lt;/a&gt; against the results in 2000.&lt;/p&gt;

&lt;p&gt;Hyndman has &lt;a href=&quot;http://www.robjhyndman.com/papers/forecast-accuracy.pdf&quot;&gt;a good outline of the various various measures of forecast accuracy&lt;/a&gt;.  I buy the argument that Mean Absolute Scaled Error (MASE) - not one used in the original M3 competition - is a better general indicator of forecast accuracy than any of the variants on percentage error, which fall apart when the series has negative values or values that go near to zero.&lt;/p&gt;

&lt;h2 id=&quot;objectives&quot;&gt;Objectives&lt;/h2&gt;
&lt;p&gt;I wanted to:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;confirm Hyndman’s results in his &lt;a href=&quot;http://robjhyndman.com/hyndsight/show-me-the-evidence/&quot;&gt;“show me the evidence”&lt;/a&gt; blog post, showing that a combination of auto.arima() and ets() gives very good out-of-the-box forecasting results&lt;/li&gt;
  &lt;li&gt;see how X13-SEATS-ARIMA, when run with its default values, compares to the methods benchmarked by Hyndman&lt;/li&gt;
  &lt;li&gt;confirm that hybrid forecasts (average of two or more methods) perform better than their constituent forecasts&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;To do this I modified &lt;a href=&quot;http://robjhyndman.com/m3comparisons.R&quot;&gt;Hyndman’s benchmarking code&lt;/a&gt; to add two additional forecasting methods:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;X13-SEATS-ARIMA&lt;/li&gt;
  &lt;li&gt;hybrid of X13 and auto.arima()&lt;/li&gt;
  &lt;li&gt;hybrid of X13, auto.arima(), and ets()&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This exercise ended up more complex than I’d envisaged, and there’s too much code to integrate into the text, so the full set of code can be found in the &lt;a href=&quot;https://github.com/ellisp/ellisp.github.io/blob/source/_working/0024-m3.R&quot;&gt;&amp;lt;source&amp;gt; branch of my blog repository&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;x13-seats-arima&quot;&gt;X13-SEATS-ARIMA&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://www.census.gov/srd/www/x13as/&quot;&gt;X13-SEATS-ARIMA&lt;/a&gt; is the industry standard tool for seasonal adjustment, particularly for official statistics published by national statistics offices.  It gives a choice of the SEATS algorithm (Bank of Spain) and X11 (Statistics Canada and US Census Bureau).  X13-SEATS-ARIMA combines these into a single application, available for download from the US Census Bureau.  Christoph Sax’s excellent &lt;a href=&quot;https://cran.r-project.org/web/packages/seasonal/index.html&quot;&gt;{seasonal} R package&lt;/a&gt; gives easy access from R.&lt;/p&gt;

&lt;p&gt;To seasonally adjust historical data, X13 can automatically select a seasonal ARIMA model, and it can forecast future values.  This made me wonder how it goes as a automated forecasting tool.  I couldn’t find (on an admittedly very cursory look) anyone who had benchmarked it against a large number of time series, so I thought I’d try it against the M3 competiton set.  I thought it might do well because of its default settings to automatically handle outliers, level shifts, transformations, and moving holidays like Easter.&lt;/p&gt;

&lt;p&gt;In testing X13 on the M3 data, I had to give it different settings for annual data from seasonal, as otherwise it trips over in trying to find effects from Easter, number of trading days, etc.&lt;/p&gt;

&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;
&lt;p&gt;I was surprised to find that X13-SEATS-ARIMA, run with the defaults, doesn’t do particularly well.&lt;/p&gt;

&lt;p&gt;The main obstacle is that for 412 series X13-SEATS-ARIMA cannot choose a model to fit without human intervention.  In the remaining cases it is mediocre on average, coming out a bit worse than auto.arima on the Mean Absolute Scaled Measure rating (but a bit better on the various percentage error measures).  The clever model selection in auto.arima - which is successful in fitting all 3,003 series - clearly more than compensates for not considering transforms, outliers and moving holidays.&lt;/p&gt;

&lt;p&gt;To get some kind of overall result at all for X13 I replaced all the cases where it couldn’t fit a model with the forecasts from auto.arima().  This is obviously unfair as a statement of the overall strength of X13 (fairer might have been to replace with a naive model - final value in the test set repeats itself over the forecast period), but it does mean that I can at least make crude comparisons.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-dots.svg&quot; alt=&quot;dots&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Hybrid methods perform well, as is well known in the forecasting community.  Taking an average of X13-SEATS-ARIMA and auto.arima() does better on all measures than either of them by themselves; and an average of X13, auto.arima() and ets() has a case to make to be the best method easily available to the regular R user.&lt;/p&gt;

&lt;h3 id=&quot;why-does-x13-sometimes-fail&quot;&gt;Why does X13 sometimes fail?&lt;/h3&gt;

&lt;p&gt;There are five types of error that lead to X13 failing to fit a model on this collection of data series.  Each error message is shown below with a minimal example to produce it.&lt;/p&gt;

&lt;h4 id=&quot;struggles-to-handle-high-degree-of-integration&quot;&gt;Struggles to handle high degree of integration&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;seasonal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Mcomp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;434&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; regression.aictest &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;Error&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; X&lt;span class=&quot;m&quot;&gt;-13&lt;/span&gt; run failed
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;Errors&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; Nonseasonal AR polynomial with initial parameters is nonstationary 
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;with root&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; on or inside the unit circle. RESPECIFY the model with 
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;different initial parameters.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Basically, this is a failure of the model selection process in X13-SEATS-ARIMA to correctly identify the degree of integration - ie how many times the series must be “differenced” to turn it into a stationary series.  auto.arima() uses an &lt;a href=&quot;http://www.jstatsoft.org/article/view/v027i03/v27i03.pdf&quot;&gt;apparently superior method&lt;/a&gt; that gives more robust results.  The problem could be resolved by using auto.arima() to determine the order of a model and then fitting it with X13-SEATS-ARIMA - in the case of annual data without outliers like series 434, X13 and auto.arima then give identical results because there is no Easter or similar impacts that are handled differently by the two.&lt;/p&gt;

&lt;p&gt;Note - actually, if you use the version of {seasonal} on CRAN you won’t get even this error message, but another one that is caused by problems parsing the X13 error message into R.  Christoph Sax kindly patched {seasonal} with a hack around this which will make it onto CRAN eventually.&lt;/p&gt;

&lt;h4 id=&quot;matrix-singularity-because-of-trading-days&quot;&gt;Matrix singularity because of trading days&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1154&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;Error&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; X&lt;span class=&quot;m&quot;&gt;-13&lt;/span&gt; run failed
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;Errors&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; A model estimation error has occurred during AIC testing within the automatic model
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;  identification procedure. The error message appears below.
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; Regression &lt;span class=&quot;kt&quot;&gt;matrix&lt;/span&gt; singular because of Sat.  Check regression model or change automatic 
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;outlier options i.e. method to addone or types to identify AO only.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This problem was relatively rare and happened with some short seasonal series.  It’s easy to deal with by specifying that number of trading days should not be included as a regression variable.&lt;/p&gt;

&lt;h4 id=&quot;runs-but-produces-no-data&quot;&gt;Runs but produces no data&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;807&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;Error&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; X&lt;span class=&quot;m&quot;&gt;-13&lt;/span&gt; has run but produced no data&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This is a mysterious error that I haven’t been able to get to the bottom of.  It might be something to do with the R - X13 interface, or something purely with X13.&lt;/p&gt;

&lt;h4 id=&quot;cannot-process-spec-file-for-an-unknown-reason&quot;&gt;Cannot process spec file for an unknown reason&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1485&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;Error&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; X&lt;span class=&quot;m&quot;&gt;-13&lt;/span&gt; has returned a non&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;zero exist status&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; which means that 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;the current spec file cannot be processed &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; an unknown reason.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Again, I couldn’t work out what is ultimately causing this error.&lt;/p&gt;

&lt;p&gt;Trouble-shooting these last two types of problematic series would mean taking them out of R and creating input files for X13 by hand, not something I’ve got time and inclination to do.&lt;/p&gt;

&lt;h4 id=&quot;cant-handle-phony-datetimes&quot;&gt;Can’t handle phony date/times&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;Error &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;M3&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;  start year of &lt;span class=&quot;s&quot;&gt;&amp;#39;x&amp;#39;&lt;/span&gt; must be &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;999.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;A number of the series in the Mcomp package do not have actual times and dates specified in their R format, most frequently because they are daily financial series that are not regularly spaced time series if their date information is included.  Because of the way it treats Easter and trading day variables, X13-SEATS-ARIMA needs data that is from the year 1000 or later.  There’s no obvious solution for this; I don’t think X13-SEATS-ARIMA can handle irregular daily time series itself (let me know in the comments if I’m wrong).&lt;/p&gt;

&lt;h3 id=&quot;when-it-succeeds-where-is-x13-slightly-worse-than-autoarima&quot;&gt;When it succeeds, where is X13 slightly worse than auto.arima?&lt;/h3&gt;

&lt;h4 id=&quot;examples-of-autoarima-out-performing-x13-seats-arima&quot;&gt;Examples of auto.arima() out-performing X13-SEATS-ARIMA&lt;/h4&gt;
&lt;p&gt;Looking at individual forecasts is a mug’s way of assessing the overall strength of forecasting methods, but it at least gets the brain moving.  Here are some examples of where the model selection of X13 wasn’t as good as that of auto.arima.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-73.svg&quot; alt=&quot;aa1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-64.svg&quot; alt=&quot;aa2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-1388.svg&quot; alt=&quot;aa3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-120.svg&quot; alt=&quot;aa4&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;examples-of-x13-seats-arima-out-performing-autoarima&quot;&gt;Examples of X13-SEATS-ARIMA out-performing auto.arima()&lt;/h4&gt;
&lt;p&gt;…and to be fair, here are some examples in the other direction.  X13 has an almost spooky ability to pick the history of unpredictability in the US stock exchange and effectively predicted the big stock market crash when it is fed data up to 1987.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-335.svg&quot; alt=&quot;aa1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-334.svg&quot; alt=&quot;aa2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-49.svg&quot; alt=&quot;aa3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0024-x13-comp-171.svg&quot; alt=&quot;aa4&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Because of the fragility of its model selection when faced with a large number of diverse time series, X13-SEATS-ARIMA is not a particularly good tool for automated, no-hands forecasting.  This isn’t particularly surprising as I don’t think it’s ever been spruiked as such.   It’s a tool for careful specialists who correctly check diagnostic plots and tests, and who can handle a potentially 15% failure rate of its automated model selection when used outside its native territory.&lt;/li&gt;
  &lt;li&gt;As expected, hybrid forecasts - averaging several methods - work well.  There may be a place for X13-SEATS-ARIMA as part of a hybrid automated forecaster.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Just to be clear - X13-SEATS-ARIMA is a fantastic tool, and I think it is the best out there in its role as a tool for careful analysis of quarterly and monthly seasonal time series, using real calendar dates, as part of an official statistics process.  In a big majority of cases, particularly with seasonal data, its defaults and its automatic model selection give you good results, and will deliver very good seasonal adjustment.  However, its automatic modelling under default conditions isn’t as robust (ie guaranteed to get a working model) as other methods, and the resulting models don’t always give optimal results for forecasting.&lt;/p&gt;
</description>
				<pubDate>Mon, 21 Dec 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/12/21/m3-and-x13</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/12/21/m3-and-x13</guid>
			</item>
		
			<item>
				<title>Importance of exports and economic growth, cross-country time series</title>
					<description>&lt;h2 id=&quot;exports-and-economic-growth&quot;&gt;Exports and economic growth&lt;/h2&gt;
&lt;p&gt;I was looking to show a more substantive piece of analysis using the World Development Indicators data, and at the same time show how to get started on fitting a mixed effects model with grouped time series data.  The relationship between exports’ importance in an economy and economic growth forms a good start as it is of considerable theoretical and practical policy interest and has fairly reliable time series data for many countries.  At the most basic level, there is a well known positive relationship between these two variables:
&lt;img src=&quot;http://ellisp.github.io/img/0023-p3.svg&quot; alt=&quot;scatterplot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The relationship is made particularly strong by the small, rich countries in the top right corner.  Larger countries, with their own large domestic markets, can flourish economically while being less exports-dependent than smaller countries - the USA being the example par excellence.  If the regression is weighted by population, the relationship is much weaker than shown in the above diagram.&lt;/p&gt;

&lt;p&gt;However, today, I’m looking at a different aspect of the relationship - changes over time.  Partly this is because I’m genuinely interested, but mostly because I needed an example demonstrating fitting a mixed effects model to longitudinal data with a time series component.&lt;/p&gt;

&lt;p&gt;The data come from the World Bank’s &lt;a href=&quot;http://databank.worldbank.org/data/reports.aspx?source=world-development-indicators&quot;&gt;World Development Indicators&lt;/a&gt; (WDI), which I explored recently in &lt;a href=&quot;http://ellisp.github.io/blog/2015/12/05/wdi-inequality/&quot;&gt;my last post&lt;/a&gt;.  I’m comparing “Exports of goods and services (% of GDP)” with “GDP per capita (constant 2000 US$)”.  The WDI have at least some data on these variables for 186 countries, but different starting years for each (earliest being 1962).  The data look like this, in a connected scatterplot showing the relationship between the two variables for 12 randomly chosen countries:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0023-p1.svg&quot; alt=&quot;csp1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;… and this, in a more straightforward time series line plot:
&lt;img src=&quot;http://ellisp.github.io/img/0023-p2.svg&quot; alt=&quot;ts1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Close watchers will see that there are some country groupings in the dataset (eg “Pacific island small states”) that we don’t want, in addition to the individual countries we do.  So our first job is to get rid of these.  Here’s the R code that pulls in the data, draws the plots so far, and removes those country groupings.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WDI&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nlme&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import fonts&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------------data imports, first explore, and clean-----------------&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;exports&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Exports of goods and services (% of GDP)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   exports &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;NE.EXP.GNFS.ZS&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1950&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# GDP per capita (constant 2000 US$)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   gdp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;NY.GDP.PCAP.KD&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1950&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;both &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gdp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; NE.EXP.GNFS.ZS&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;          gdp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; NY.GDP.PCAP.KD&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# removing any year-country combos missing eith gdp or exports:&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gdp&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# let&amp;#39;s look at 12 countries at a time&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;all_countries &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;both&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;sampled &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both    &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;all_countries&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# connected scatter plot:&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sampled &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gdp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; exports&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   geom_path&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Exports as a percentage of GDP&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;GDP per capita, constant 2000 US dollars&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Exports and GDP over time, selected countries&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# univariate time series plots&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sampled &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;iso2c&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; country &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# how to get rid of the country groups?&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;both&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;iso2c&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;country&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;iso2c&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# they have a number as first or second digit, or X or Z as first digit (but ZW ZA ZM legit)&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;both2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;X.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; iso2c&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;[0-9]&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; iso2c&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Z.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; iso2c&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; iso2c &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ZW&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ZA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ZM&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;iso2c &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;OE&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;EU&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------------------simple cross section used for first plot-------------------&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;country_sum &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both2 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;year &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;p3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; country_sum &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; exports &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gdp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   scale_y_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Exports as a percentage of GDP&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;GDP per capita, constant 2000 US dollars&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Cross section of exports and GDP, latest years when data are present&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The plan is to fit an appropriate time series model with GDP as a response variable and exports as a percentage of GDP as an explanatory variable, allowing country to be a group random effect, and the country-year individual randomness to be related year to year as a time series.  This means a &lt;a href=&quot;https://en.wikipedia.org/wiki/Mixed_model&quot;&gt;mixed effects model&lt;/a&gt;. There’s a bit of transforming I need to do:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;To avoid spurious correlation I’ll need to transform the data until each time series is at least approximately stationary.  I’ll do this by taking differences of the logarithm of the series, which has the same impact as looking at year on year growth rates.&lt;/li&gt;
  &lt;li&gt;I’ll also need some kind of control for the nuisance factor that each country has a different starting year for its data.&lt;/li&gt;
  &lt;li&gt;I want to control for the possibility that the absolute value of exports-orientation at the &lt;em&gt;start&lt;/em&gt; of recorded data has a persistent impact, so I need to have that absolute level (or the logarithm of it, which has nicer properties) as a country-level variable.&lt;/li&gt;
  &lt;li&gt;I’m interested in whether a change in exports has a persistent impact, so I’ll need a lagged value of my transformed exports variable.  Otherwise we might just be picking up the inherent impact on GDP of a change in exports or their prices, with domestic contribution to GDP kept constant.  If there’s a persistent effect on future years from a change exports-orientation in one year, it’s much more likely to reflect something significant economically (still not necessarily causal though).&lt;/li&gt;
  &lt;li&gt;Even after taking first differences of the logarithms of my two main variables (GDP, and Exports as a percentage of GDP), I’m still a little worried that in particular countries there will be non-stationary time series that result in spurious associations.  For example, if the growth rates of both variables are steadily growing or declining.  To reduce this risk I’m going to include year in my model, so at least any linear trend of that sort is removed before looking at whether the two variables move together.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here’s the distribution of the first recorded value of the logarithm of exports as a percentage of gdp:
&lt;img src=&quot;http://ellisp.github.io/img/0023-p4.svg&quot; alt=&quot;first&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Here’s the connected scatter plot of the differenced logarithms (effectively, growth rates):
&lt;img src=&quot;http://ellisp.github.io/img/0023-p6.svg&quot; alt=&quot;csp2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Here’s the traditional time series plots:
&lt;img src=&quot;http://ellisp.github.io/img/0023-p5.svg&quot; alt=&quot;ts2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And here’s the code that does the transformations and plots:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# first we want to know the value of exports at the beginning of each series&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;first_values &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both2 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;year &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports_starter &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;          first_year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;iso2c&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exports_starter&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; first_year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;p4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;both3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; exports_starter&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# all those individual time series have problem of non-stationarity and of course autocorrelation&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so when we merge with the starting values of exports we also calculate first&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# differences of logarithms&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;both3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both2 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;first_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;iso2c&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports_g &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports&lt;span class=&quot;p&quot;&gt;))),&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;          gdp_g &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gdp&lt;span class=&quot;p&quot;&gt;))),&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;          exports_lag &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lag&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports_g&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gdp_g&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;exports_lag&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;all_countries2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;both3&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;sampled &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; both3 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;all_countries2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; 
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;p5 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sampled &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exports_g&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gdp_g&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; country &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;p6 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sampled &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exports_g&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gdp_g&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; exports_g&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gdp_g&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   geom_path&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;change in logarithm of exports share of GDP&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;change in logarithm of GDP per capita, constant 2000 USD&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Changing importance of exports and GDP growth, selected countries&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So we’re ready for some modelling.  After all the data transformations, this part is relatively easy.  I use a mixed effects model that lets the key effects vary in each country, around an average level of the effect.&lt;/p&gt;

&lt;p&gt;I tried a few simpler models than below and checked the auto-correlation functions to be sure the time series part was needed (it is; ACF() returns an autocorrelation at lag 1 of around 0.23, and the decay of autocorrelation in subsequent lags characteristic of a fairly simple AR process).  So here we go:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;model4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gdp_g &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ordered&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;first_year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; exports_g &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; exports_lag &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; exports_starter &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;              random &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; exports_g &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; exports_lag &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; year &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;              correlation &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; corAR1&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;form &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; year &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;              data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; both3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Just to visualise what this model is doing, imagine the connected scatter plot of the differenced logarithms of each variable, as shown earlier.  We’re drawing a diagonal line of best fit on each facet, with the  slope and  intercept of each line allowed to different for each country.  The average slope is the average impact of changes in exports as a percent of GDP on GDP growth.  Now add to this the complication of the other variables - the first year data starts (basically just a nuisance variable we want to control for); each countrys’ absolute level of exports as a percentage of GDP when its data started; the lagged value of exports (which is actually the number of most interest); and year, for which we’re trying to control for any linear trend.&lt;/p&gt;

&lt;p&gt;The “correlation = corAR1(…)” part is important, as it means that when we come to conduct inference (t statistics, p values and confidence intervals) the model takes into account that each observation in a particular country is related to the previous year’s - they aren’t as valuable as independent and identically distributed data from a simple random sample.  Failing to include this factor would mean that inference was biased in the direction of concluding results are significant that are in fact due to chance.&lt;/p&gt;

&lt;p&gt;And here are the results.  Bear in mind that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;the response variable is change in the logarithm of GDP;&lt;/li&gt;
  &lt;li&gt;exports_g is change in the logarithm of exports as a percentage of GDP;&lt;/li&gt;
  &lt;li&gt;exports_lag is the lagged value of exports_g;&lt;/li&gt;
  &lt;li&gt;exports_starter is the logarithm of the starting value of exports as a percentage of GDP;&lt;/li&gt;
  &lt;li&gt;year is year, and we are testing for a linear trend in growth of GDP&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model4&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;tTable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;                 Value Std.Error   DF &lt;span class=&quot;kp&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;value p&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;value
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;exports_g        &lt;span class=&quot;m&quot;&gt;0.031&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;0.010&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7006&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;3.191&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;0.001&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;exports_lag      &lt;span class=&quot;m&quot;&gt;0.021&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;0.006&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7006&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;3.579&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;0.000&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;exports_starter &lt;span class=&quot;m&quot;&gt;-0.002&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;0.002&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;150&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-1.233&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;0.220&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;year             &lt;span class=&quot;m&quot;&gt;0.000&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;0.000&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7006&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-1.328&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;0.184&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Not wanting to give too precise an interpretation of this without a bit more theory and thinking, it suggests for countries on average:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;evidence of impact (on GDP growth) of a change in exports as a percentage of GDP, and the impact is in the same direction;&lt;/li&gt;
  &lt;li&gt;the impact persists beyond the immediate year into subsequent years;&lt;/li&gt;
  &lt;li&gt;no evidence of a systematic change in growth rates of GDP over time simply related to time and nothing else in the model;&lt;/li&gt;
  &lt;li&gt;no evidence that the starting absolute value of exports as a percentage of GDP impacts on subsequent GDP growth rates&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As exports_g, exports_lag and year were all allowed to be random effects ie take different values by country, their differing values for each country are of interest.  The figures above reflect an overall effect of these variables; the actual value in any country is a (approximately) normally distributed random variable.  Here’s how their’ densities look:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0023-p7.svg&quot; alt=&quot;ref&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Each observation (the little rug marks on the horizontal axis) is the size of the effect for a particular country.  So we can see that while overall value of exports_lag - the persistent impact of a change in exports as a percentage of GDP on GDP growth - was 0.021 as per the table above, any particular country has a value that is lower or hight than that, with a reasonable number of countries seeing a negative impact.&lt;/p&gt;

&lt;p&gt;The value for the exports_g parameter plus the exports_lag parameter gives a crude sense of the overall impact, for a particular country, of changing importance of exports on GDP growth.  As can be seen from the top right panel of the above set of plots, this combined value is generally but not always positive.&lt;/p&gt;

&lt;p&gt;All up, while we might conclude that for countries “on average” there is a positive relationship between growth in the importance of exports and GDP growth, for any particular country the relationship will vary and may in fact be negative.  Further investigation would need to place this in a more theoretical context, and control for other variables that might be confounding the results; but the above is probably enough for an exploratory blog post.&lt;/p&gt;

&lt;p&gt;Here’s how to extract those country-level effects from our mixed effects model object:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;cf &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; coef&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model4&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# let&amp;#39;s look at just the last four coefficients ie exclude the nuisance of first_year&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;cf_df &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; cf&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;ncol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cf&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;ncol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cf&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;as.data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rownames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cf&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;          combined &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; exports_lag &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; exports_g&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;combined&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;p7 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; cf_df &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;exports_starter&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;combined&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;exports_g + exports_lag&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Sat, 12 Dec 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/12/12/exports-gdp</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/12/12/exports-gdp</guid>
			</item>
		
			<item>
				<title>Inequality measures in the World Development Indicators</title>
					<description>&lt;h2 id=&quot;world-development-indicators&quot;&gt;World Development Indicators&lt;/h2&gt;
&lt;p&gt;After my &lt;a href=&quot;http://ellisp.github.io/blog/2015/11/26/violent-deaths/&quot;&gt;last post&lt;/a&gt; on deaths from assault, I got a few comments both on and off-line asking for exploration of developing country issues, in contrast to the OECD focus of the previous post.  I’d always intended at some point to do something with the World Bank’s &lt;a href=&quot;http://databank.worldbank.org/data/reports.aspx?source=world-development-indicators&quot;&gt;World Development Indicators&lt;/a&gt; so now seems a good time to at least get started.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“World Development Indicators (WDI) is the primary World Bank collection of development indicators, compiled from officially recognized international sources. It presents the most current and accurate global development data available, and includes national, regional and global estimates”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I’ll be analysing the data using Vincent Arel-Bundock’s &lt;a href=&quot;https://cran.r-project.org/web/packages/WDI/index.html&quot;&gt;{WDI} R package&lt;/a&gt; which makes it super easy to grab data via the World Bank’s Application Programming Interface, including fast searching a cached version of the indicator names and of course downloading the actual data into an R session.  With that search ability and the Bank’s own page with its categorisations of indicators it wasn’t hard to find data that I was interested in.&lt;/p&gt;

&lt;p&gt;However I quickly found myself doing some repetitive tasks - downloading a dataset and turning them into a standard faceted time series plot.  Following the DRY (Don’t Repeat Yourself) fundamental principle of programming I decided this phase of exploration was more suited to a graphic user interface so I spun up this &lt;a href=&quot;https://ellisp.shinyapps.io/WorldDevelopmentIndicators&quot;&gt;web-app&lt;/a&gt; using Shiny.&lt;/p&gt;

&lt;p&gt;The app has my standard plot I was making each time I looked at a new indicator:
&lt;a href=&quot;https://ellisp.shinyapps.io/WorldDevelopmentIndicators&quot;&gt;&lt;img src=&quot;http://ellisp.github.io/img/0022-shiny-screenshot1.png&quot; alt=&quot;screen1&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and a responsive, fast, searchable table of the available indicators:
&lt;a href=&quot;https://ellisp.shinyapps.io/WorldDevelopmentIndicators&quot;&gt;&lt;img src=&quot;http://ellisp.github.io/img/0022-shiny-screenshot2.png&quot; alt=&quot;screen1&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The source code is available in the &amp;lt;source&amp;gt; branch of my blog repository if anyone wants to hunt it down.&lt;/p&gt;

&lt;p&gt;As well as producing my standard plot quickly for me, putting all the 3,700 indicators into a JavaScript DataTable gave me even more convenient searching and navigating.  While developing that app I did a one-off download all 7,145 available indicators, which is the number of rows returned in this snippet of code:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WDI&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;search_results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDIsearch&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;search_results&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This was convenient to have a local copy of all that data (1.1GB of download - took about 10 hours - but only about 70MB when saved in R’s super efficient .rda format), but the main motivation for doing this was identifying which series actually have data.  Only the 3,700 series with at least one row of data on 3 December 2015 are listed in my Shiny app.  The app does download the live data, not using my cached copy; this obviously makes the performance quite slow (about 10 - 20 seconds of apparent unresponsiveness when downloading a dataset) but saves me having a very large shiny app on a hosted server, and ensures the data are current.&lt;/p&gt;

&lt;h2 id=&quot;inequality-measures&quot;&gt;Inequality measures&lt;/h2&gt;
&lt;p&gt;There are five measures that I found in the WDI that are related to income inequality:&lt;/p&gt;

&lt;table border=&quot;1&quot; style=&quot;width:100%&quot;&gt;
   &lt;tr&gt;&lt;b&gt;
      &lt;td&gt;Indicator code&lt;/td&gt;
      &lt;td&gt;Indicator name&lt;/td&gt;
   &lt;/b&gt;&lt;/tr&gt;
   &lt;tr&gt;
      &lt;td&gt;SI.POV.GINI &lt;/td&gt;
      &lt;td&gt;Gini coefficient of income&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
      &lt;td&gt;SI.DST.10TH.10&lt;/td&gt;
      &lt;td&gt;Income share held by highest 10%&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
      &lt;td&gt;SI.DST.05TH.20&lt;/td&gt;
      &lt;td&gt;Income share held by highest 20&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
      &lt;td&gt;SI.DST.FRST.10&lt;/td&gt;
      &lt;td&gt;Income share held by lowest 10%&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
      &lt;td&gt;SI.DST.FRST.20	&lt;/td&gt;
      &lt;td&gt;Income share held by lowest 20%&lt;/td&gt;
   &lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;With these, I’ll also create two other common measures: the P80P20 and P90P10 measures.  The first of these is the income share of the highest earning 20% divided by that of the lowest earning 20%; the second is the same but for the 10th percentile instead.&lt;/p&gt;

&lt;p&gt;I’ve talked a bit about the definitions of these measures in &lt;a href=&quot;http://ellisp.github.io/blog/2015/09/12/inequality-stats-distributions/&quot;&gt;an earlier post&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Once we’ve brought in the data and created our two new variables we can have a look at what we’ve got.  I do this by picking six countries at random and looking at the full data for those six:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0022-eg-countries.svg&quot; alt=&quot;time-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From just this example (and a few others I ran and some back up analysis but won’t bother to show) a few things suggest themselves:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;country data are pretty much equally complete across the measures.  For example, Fiji has values for two years for every measure; France has about 10; etc.&lt;/li&gt;
  &lt;li&gt;the variables change over time in consistent ways (not surprising given they are all based on the same underlying data).  For example, as the proportion of the country’s income that goes to the bottom percentile (P10) in Cyprus goes down, so does the P20; and the Gini coefficient, P90 (income share of the top 10%) and P80 (income share of the top 20%) all go up together.&lt;/li&gt;
  &lt;li&gt;P90P10 and P80P20 are the measures in which it is hardest to detect variation visually on the untransformed scale.  For example, Central African Republic’s high inequality dominates the scale in each measure’s row, but only in P90P10 and P80P20 does it do so so much that it’s difficult to see variation at all in the other countries.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Looking at the average values for each measure over time gives a rough sense of their correlation.  In the pairs plot below, each of the 156 points represents a single country’s trimmed mean value on a particular inequality measure over all the years where they had data.  Countries aren’t comparable to eachother (as they have different years of data), but variables are (because countries have observations on all measures for the same years, for that particular country).&lt;/p&gt;

&lt;p&gt;Bhutan is excluded from this plot because its average values on P90P10 and P80P20 were so extreme other variation couldn’t be seen.  Suriname is excluded because it only has a value for Gini coefficient, not the other variables.  A small number of other excluded countries (including New Zealand!) are absent from the entire World Bank dataset on these variables.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0022-pairs.svg&quot; alt=&quot;pairs-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Overall, I’m happy that the measures of the Gini coefficient and of the share going to the richest X% are highly correlated.  As I’ve mentioned before, I can see the argument (by Thomas Picketty) that the proportion of national income going to the richest X% is a good measure for interpetability and ease of explanation, but I disagree with some of the other criticisms of the Gini coefficient.  However, I’m more convinced than ever that Picketty is correct that the P90P10 and P80P20 measures aren’t good choices, because of the instability that comes from dividing a large number by a small number.&lt;/p&gt;

&lt;p&gt;Here’s the code in R for the inequality plots.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WDI&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GGally&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   &lt;span class=&quot;c1&quot;&gt;# for ggplot pairs plot&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import fonts&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import data from the World Bank&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;gini &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SI.POV.GINI&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1960&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;p90 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.10TH.10&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1960&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;p80 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.05TH.20&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1960&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;p10 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.FRST.10&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1960&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;p20 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; WDI&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;indicator &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.FRST.20&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; end &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2015&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1960&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# merge and tidy up&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;inequality &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gini&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p10&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; all &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p20&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; all &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p80&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; all &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p90&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; all &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# create synthetic variables&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;P90P10 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; SI.DST.10TH.10 &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; SI.DST.FRST.10&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;          P80P20 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; SI.DST.05TH.20 &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; SI.DST.FRST.20&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;iso2c&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# gather into long form&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;year&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# rename the variables:&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.FRST.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;P&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;          variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.10TH.10&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;P90 (Share of richest 10%)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;          variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SI.DST.05TH.20&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;P80 (Share of richest 20%)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;          variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SI.POV.GINI&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Gini&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;all_countries &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inequality&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 158 countries&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------all 7 measures over time?-------------&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# example plot of 6 random countries over time&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;svg&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0022-eg-countries.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;inequality &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;all_countries&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; replace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; str_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   facet_grid&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# average observations per country and variable:&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;inequality &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ObsPerCountry &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AveObsPerCountry &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ObsPerCountry&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;             Countries &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ObsPerCountry&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------trimmed mean for each country on each variable, in wide format----------&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;inequality_aves &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; inequality &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; tr &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# make the column names legal&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringsAsFactors &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; check.names &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inequality_aves&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inequality_aves&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# what are the extreme values of those averages of ratios:&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;inequality_aves &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;P90P10&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Draw pairs plots&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;svg&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0022-pairs.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;inequality_aves &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Bhutan has an average P90P10 of 600 so we exclude it&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;country &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Bhutan&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;   ggpairs&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; 
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Sat, 05 Dec 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/12/05/wdi-inequality</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/12/05/wdi-inequality</guid>
			</item>
		
			<item>
				<title>Deaths from assault over time in 40 relatively rich countries</title>
					<description>&lt;h2 id=&quot;deaths-from-assault&quot;&gt;Deaths from assault&lt;/h2&gt;
&lt;p&gt;A friend was looking at comparative data on violent deaths in a range of countries and I couldn’t resist the chance to turn out some graphics.  The data come from the &lt;a href=&quot;http://stats.oecd.org/&quot;&gt;OECD&lt;/a&gt;, who compiles them from contributions by member and associated country governments - effectively, wealthier countries - and makes them available via a web Application Programming Interface in the SDMX format.  I ended up with some graphics that I think tell a powerful story.&lt;/p&gt;

&lt;p&gt;The data in this post are age-standardised deaths per 100,000 for whole population, male population, and female population; the OECD variables coded as TXCMILTX, TXCMHOTH and TXCMFETF.  I’m not an expert in this area - if they mean something else (I’m a little unsure on the age-standardisation) don’t just curse me, let me know.&lt;/p&gt;

&lt;h3 id=&quot;compare-across-countries-and-sex&quot;&gt;Compare across countries and sex&lt;/h3&gt;
&lt;p&gt;Looking at snapshot cross-sectional average data since 1990 (for which there is more comparable data across countries, with a number of countries such as Germany and Czech Republic only coming into existence at or around that period) we see two things that met the “intra-ocular impact test” ie they hit you between the eyes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;For nearly all the listed countries, males are much more likely to killed in a assault than are females&lt;/li&gt;
  &lt;li&gt;The Americas and the former Soviet Socialist Republics (Russia, Estonia, Latvia, Lithuania) dominate the list of most violent places to live (or rather, to die).  Other than countries of these two types, only South Africa makes the top 11 countries.  The safer countries include those in eastern Europe (other than former USSR, but including countries that were in its political orbit), Asia, Australasia and western Europe.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Remember that this only shows relatively weathly countries - for a more complete list (but less complete data) check out this &lt;a href=&quot;https://en.wikipedia.org/wiki/List_of_countries_by_intentional_homicide_rate&quot;&gt;Wikipedia list of countries that can be ranked by intentional homicide rates&lt;/a&gt; (not quite the same as our data, which includes all deaths from assault, intentional or otherwise) or this &lt;a href=&quot;https://www.unodc.org/documents/data-and-analysis/Crime-statistics/International_Statistics_on_Crime_and_Justice.pdf&quot;&gt;report from the UN Office on Drugs and Crime&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the chart below, the label for each country is centred at the overall population rate of deaths from assault and the red and blue vertical strokes mark the female and male rates respectively.  Beware that the scale is logarithmic - this was necessary to stop everywhere except Colombia being squashed into the left of the chart.
&lt;img src=&quot;http://ellisp.github.io/img/0020-assault-average.svg&quot; alt=&quot;snapshot&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;compare-across-time&quot;&gt;Compare across time&lt;/h3&gt;
&lt;p&gt;Looking at trends across time we see an encouraging sign.  Most countries’ violent death rates peaked in the 1980s or 90s and have been declining, in some cases dramatically, in recent years.&lt;/p&gt;

&lt;p&gt;In the chart below the vertical axis for each country has been set to make most use of the plot area and draw attention to trends rather than absolute levels, so you can’t compare the absolute levels of violence across countries.  That’s what the first chart was for, so the two charts complement eachother.  The facets in the trend chart below have been &lt;em&gt;ordered&lt;/em&gt; from lowest to highest rates (1990+ averages), so there is still some visual indicator of absolute size of the problem.&lt;/p&gt;

&lt;p&gt;The recent declines are particularly strong in the  Eastern Europe and USSR region - Russia, Estonia, Latvia, Lithuania, Poland, Slovak Republic, Slovenia, Czech Republic, and Germany have all seen dramatic drops in rates of death from assault after rapid growth in the early 1990s, associated with the magnitude of the transition in economic and political systems that took place at that time.  There’s also the possibility of changing official statistical practice with the changing political system, but there’s no particular reason I know of (I’m not an expert in former and post Soviet statistics systems, either…) to think of that, and the general curve looks plausible given an outsider’s view of the recent history there.
&lt;img src=&quot;http://ellisp.github.io/img/0020-deaths-trends.svg&quot; alt=&quot;over-time&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Tragically, Norway’s &lt;a href=&quot;https://en.wikipedia.org/wiki/2011_Norway_attacks&quot;&gt;spike in 2011&lt;/a&gt; is really noticeable to a close viewer, even in a chart like this with 40 countries covering 50 years.&lt;/p&gt;

&lt;h3 id=&quot;secondary-point---catholic-countries-and-gender-more-men-getting-killed-violence-patterns&quot;&gt;Secondary point - Catholic countries and gender (more men getting killed) violence patterns?&lt;/h3&gt;
&lt;p&gt;Looking into the imbalance between the sexes, we see that the countries with consistently high male to female ratios of rates of violent death are Colombia, Brazil, Mexico, Chile, Costa Rica and South Africa, in all of which males are at least 5 times more likely to be killed violently than are females.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0020-gender-ratios.svg&quot; alt=&quot;gender-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;At first glance there looks to be a possible correlation between being predominantly Catholic and a high ratio of male to female violent death rates (as well as the Latin American countries leading the pool, Italy and Ireland are also fairly high up on the list).  In an early draft of this post I had a casual mention of this and just a warning against slack inference, but I decided it was irresponsible to leave it at that.  To be more professional, I followed up my hunch with data on the proportion of a country that was Catholic in 2005 courtesy of &lt;a href=&quot;http://www.catholic-hierarchy.org/country/sc1.html&quot;&gt;data published by David M. Cheney&lt;/a&gt;, a Catholic enthusiast (not sanctioned by any Catholic church authority but good enough for our purposes).&lt;/p&gt;

&lt;p&gt;As often proves to be the case, the answer is &lt;a href=&quot;http://www.goodreads.com/book/show/23132200-i-think-you-ll-find-it-s-a-bit-more-complicated-than-that&quot;&gt;“I think you’ll find it’s a bit more complicated than that”&lt;/a&gt; and in fact there isn’t an easy way to draw a conclusion about whether females are protected, or males picked on, particularly in Catholic countries, just from this aggregated data.&lt;/p&gt;

&lt;p&gt;The challenge is that we’ve made up our hypothesis - relationship between Catholicism and males being disproportionately killed in assaults - after peeking at the data.  This generally renders post-peek model building difficult if not impossible, at least as a basis of hypothesis testing.&lt;/p&gt;

&lt;p&gt;The nub of the issue is that the apparent relationship with Catholicism might be an artefact of the high male murder by assault rates in five specific countries - Colmbia, Brazil, Mexico, etc - where the high Catholicism is highly correlated with other factors, specifically “Latin Americanism”.  Any decent model should take this into account - it’s just wrong to treat these five countries as independent observations (as is implicitly done in fitting a simple regression).  The image below illustrates the conundrum:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0020-gender-catholic.svg&quot; alt=&quot;catholics-gender&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The top plot ignores the Latin Americanism of those five countries and fits a simple linear regression, which finds (illusory) statistically significant evidence of a link between Catholicism and a higher ratio of male to female death-from-assault rates.  As mentioned above, this approach is unsound because it ignores the grouping of the five prominent countries that drag up the slope of the line.&lt;/li&gt;
  &lt;li&gt;The second plot controls for this by adding a dummy variable for “Americas”.  The result is still statistically significant evidence of a Catholic effect, but interacting with the continent effect ie only in the Americas does it seem to matter being an increasingly Catholic country when wondering if males are more likely to be killed in an assault than females.&lt;/li&gt;
  &lt;li&gt;The third plot (which I think is my preferred) adds a dummy variable for “Latin American” and finds no statistically significant relationship between Catholicism and male-female death ratios after that effect is accounted for.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s no simple way to solve the correlation of our two explnatory variables - Americanism and Catholicism - and picking which of the second or third model above is best, and the essentially arbitrary nature of our continent-classification variable.  There’s no possibility of creating a test-set of data, for example.  Even if we brought in what data are available on poorer countries and used them as a test set, the confounding relationship between Latin America and Catholicism would pertain to that dataset too.  So until more data or ideas come out (and I’m not claiming to have looked for them, either way) I prefer to stick to the third plot, and say only that male/female assault death ratios are much higher in Latin American countries, we don’t know why from just this dataset, and after we’ve taken that into account there’s no real further evidence in this particular dataset of an additional Catholic effect.&lt;/p&gt;

&lt;h2 id=&quot;arranging-the-data&quot;&gt;Arranging the data&lt;/h2&gt;
&lt;p&gt;Here’s how I import the data into R.  If you know exactly what you’re looking for, you can import data directly from OECD.Stat with the &lt;a href=&quot;https://cran.r-project.org/web/packages/rsdmx/index.html&quot;&gt;{rsdmx}&lt;/a&gt; package by sending an appropriately structured URL (line 18 below) to their website.  However, to work out that URL you’ll probably need to navigate &lt;a href=&quot;http://stats.oecd.org/&quot;&gt;their site&lt;/a&gt; by hand and choose your particular ‘customising’, then choose the “export” and “SDMX” options, then copy the URL it generates for you.  It’s useful for reproducibility purposes (for example, it meant I didn’t need to save a copy of the data anywhere to make the code below reproducible for others).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;grid&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gridExtra&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# added 27/11/2015, for grid.arrange() to work!&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rsdmx&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# for importing OECD data&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ISOcodes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for merging country codes with names&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rvest&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# for screen scraping data about Catholicism&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_grey&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------Import and mung the death from assault data---------------&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load deaths by assault from OECD.Stat&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;viol_sdmx&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   myUrl &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;http://stats.oecd.org/restsdmx/sdmx.ashx/GetData/HEALTH_STAT/CICDHOCD.TXCMFETF+TXCMHOTH+TXCMILTX.AUS+AUT+BEL+CAN+CHL+CZE+DNK+EST+FIN+FRA+DEU+GRC+HUN+ISL+IRL+ISR+ITA+JPN+KOR+LUX+MEX+NLD+NZL+NOR+POL+PRT+SVK+SVN+ESP+SWE+CHE+TUR+GBR+USA+NMEC+BRA+CHN+COL+CRI+IND+IDN+LVA+LTU+RUS+ZAF/all?startTime=1960&amp;amp;endTime=2014&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   dataset &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; readSDMX&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;myUrl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# takes about 30 seconds on a slow hotel internet connection&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   viol_sdmx &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dataset&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# takes about 10 seconds on an i5&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The country codes provided by the OECD are ISO 3166 three digit country codes and we want to turn them into something more friendly for presentation purposes.  We also want to rename the levels of our units (“TXCMILTX” is less friendly than “Deaths per 100 000 population”), order some factor levels for future graphics purposes, and knock out Turkey which only has a few year’s data.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load Country codes from ISOcodes R package&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;data&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ISO_3166_1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# mung:&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;viol &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol_sdmx &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# match country codes to country names:&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ISO_3166_1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Alpha_3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Name&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;COU&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Alpha_3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# more friendly names:&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Name&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;          Year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; obsTime&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;          Value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; obsValue&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# limit to columns we want:&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;UNIT&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# make graphics-friendly versions of Unit and Year variables:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;UNIT &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TXCMILTX&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                        &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths per 100 000 population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths per 100 000 males&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;          Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;UNIT &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TXCMFETF&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths per 100 000 females&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;          Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]),&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;          Year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Year&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# not enough data for Turkey to be useful so we knock it out:&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Turkey&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Having created the original object “viol” I make a few summary and total objects to help with structuring my graphics.  In particular, I need a data frame that provides average rates since 1990 for the first chart, and a data frame of totals so I can arrange the plots in order of increasing rates of death from assault.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create country x Unit summaries   &lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;viol_sum &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Year &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1990&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create country totals (for ordering in charts)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;totals &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol_sum &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create wider version, with one column per variable:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;viol_spread &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol_sum &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;          Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;female&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Female&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;          Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; males&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Male&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;          Unit &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Unit&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; totals&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;the-actual-plots&quot;&gt;The actual plots&lt;/h2&gt;
&lt;p&gt;Now we’re ready to draw some plots.  Here’s the code that makes the main two plots:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;viol_sum &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; totals&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;|&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   geom_segment&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; viol_spread&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; yend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Male&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Female&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Label&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;             family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths per 100,000 (logarithmic scale)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bottom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   scale_colour_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey10&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Mean annual deaths from assault 1990 to 2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;viol &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; totals&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;se &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;loess&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   scale_colour_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey10&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bottom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths per 100,000 per year - note changing vertical scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths from assault&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;To investigate the Catholicism and gender ratio issues in the second set of plots, I had to pull down some data from the web using &lt;a href=&quot;https://cran.r-project.org/web/packages/rvest/index.html&quot;&gt;Hadley Wickham’s amazing {rvest} package&lt;/a&gt;.  It’s inspired by Python’s wonderful &lt;a href=&quot;http://www.crummy.com/software/BeautifulSoup/&quot;&gt;Beautiful Soup&lt;/a&gt; but I have to say is &lt;em&gt;astonishingly&lt;/em&gt; user friendly.&lt;/p&gt;

&lt;p&gt;Here’s my complete set of code for the gender dot plot, downloading the Catholicism data, and the resulting scatter plot.  The web-scraping part occupies a total of two lines of code (21 and 22 in the code below) - amazing:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a gender summary:&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;viol_gender &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Unit&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;UNIT&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Year&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;UNIT&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; 
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TXCMHOTH &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; TXCMFETF&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; tr &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# knock out Luxembourg and Iceland, too many NAs:&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# plot it:   &lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;viol_gender &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ratio&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Trimmed mean annual ratio of male to female rates\nof deaths from assault over whole period&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download catholic proportion data&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;cath_page &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read_html&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.catholic-hierarchy.org/country/sc1.html&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;cath_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; html_table&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cath_page&lt;span class=&quot;p&quot;&gt;)[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; 
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cath_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cath_data&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create vectors of country names for use in creating dummy variables:&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;lat_american &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Colombia&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Brazil&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Mexico&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Chile&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Costa Rica&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;american &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lat_american&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Canada&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;United States&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# mung:&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;cath_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; cath_data &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;M.+xico&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Mexico&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;          Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;USA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;United States&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;          Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Great Britain&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;United Kingdom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;          Country &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Korea (South)&amp;quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Korea, Republic of&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Percent_Catholic&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Percent_Catholic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;%&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Percent_Catholic&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;          Continent1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; american&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Americas&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Other&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;          Continent2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Country &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; lat_american&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Latin American&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Other&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# join the Catholic data to the assault data:          &lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;viol_gender_cath &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; viol_gender &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cath_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Country&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set up base plot:   &lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;cath1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;    viol_gender_cath &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Percent_Catholic&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ratio&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Country&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Percentage of country reported to be Catholic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Ratio of female to male\nassault death rates&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;      xlim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;110&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# and the other two types of plots:      &lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;cath2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; cath1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Continent1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;cath3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; cath1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Continent2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# draw plots:&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cath1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cath2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cath3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# for reference, look explicitly at the underlying statistical models:&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; Percent_Catholic&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; viol_gender_cath&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; Percent_Catholic &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Continent1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; viol_gender_cath&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;mod3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ratio &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; Percent_Catholic &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Continent2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; viol_gender_cath&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Thu, 26 Nov 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/11/26/violent-deaths</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/11/26/violent-deaths</guid>
			</item>
		
			<item>
				<title>Create ARIMA time series from bottom up</title>
					<description>&lt;h2&gt;Simulating ARIMA models&lt;/h2&gt;
&lt;p&gt;
Generating an arbitrary &lt;a href = &quot;https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average&quot;&gt;Auto-Regressive Integrated Moving Average (ARIMA)&lt;/a&gt; model is easy in R with the &lt;a href = &quot;https://stat.ethz.ch/R-manual/R-devel/library/stats/html/arima.sim.html&quot;&gt;arima.sim()&lt;/a&gt; function that is part of the built-in {stats} package.  In fact I&#39;ve done it extensively in previous blog posts for various illustrative purposes.  But one cost of doing this for educational purposes is that the mechanics of generating them are hidden from the user (of course, that&#39;s the point!).  As was the case in last week&#39;s post, I&#39;m motivated by teaching purposes.  I wanted to show people how an ARIMA model can be created, with high school maths and no special notation, from white noise.
&lt;/p&gt;

&lt;iframe width=&quot;700&quot; height=&quot;700&quot;
src=&quot;http://www.youtube.com/embed/CiGM-NOV7Ms?autoplay=1&amp;loop=1&amp;playlist=CiGM-NOV7Ms&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;allowfullscreen&quot;&gt;
&lt;/iframe&gt;

&lt;p&gt;
The movie that is (hopefully) playing above shows this.  It takes a single series of independent and identical standard normally distributed variables (top left).  It shows how this can be turned into (from left to right one row at a time, starting at the top right):
&lt;ul&gt;
&lt;li&gt;an autoregressive model of order 1, where each value of x equals the previous value times 0.8, plus the white noise;
&lt;li&gt;a moving average of order 1, where each value of x equals the latest bit of white noise plus 0.8 times the previous value of white noise;
&lt;li&gt;an autoregressive moving average model of order (1, 1), combining the two;
&lt;li&gt;an ARIMA(1, 1, 1) model that is the cumulative sum of the ARMA(1, 1); and
&lt;li&gt;an ARIMA(2, 2, 2) model that is like all the above but with extra parameters and an extra cumulative sum stage
&lt;/ul&gt;
&lt;/p&gt;
&lt;p&gt;
One interesting thing is how the AR(1) and ARMA(1, 1) models look almost identical, except for the larger variance of the ARMA(1, 1) model which comes from throwing into the mix 80% of the last period&#39;s randomness.  This similarity is just a result of the the particular parameters chosen - the 0.8 times the previous value of x quickly dominates the moving average part.
&lt;/p&gt;
&lt;p&gt;
Here&#39;s the code that simulates the actual data.  It&#39;s simple enough that it can be easily explained and related to the equations on the images in the movie.  Note that I&#39;ve avoided using the usual lag operator, or putting all the autoregression parts of the equation on the left as is normally done.  That&#39;s all so it is easy to explain exactly where the latest value is coming from.  Also note that I&#39;ve done this in what might seem a very un-R-like fashion - creating a vector with a for() loop!  This is purely for to make it really obvious what is going on.  There&#39;s no issues with performance to worry about, and in this situation transparency and ease of reading is always paramount.
&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------generate data-------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# white noise:&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;wn &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# initialise the first two values:&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;ar1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ma1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arma11 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arma22 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# loop through and create the 3:1000th values:&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   ar1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ar1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   ma1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   arma11&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arma11&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; 
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   arma22&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arma22&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; arma22&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;m&quot;&gt;-2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# turn them into time series, and for the last two, &amp;quot;integrate&amp;quot; them via cumulative sum&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;ar1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;ma1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ma1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;arma11 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma11&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;arima111 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma11&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;arima222 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma22&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;
The animation is created one frame at a time with basic R plots.  For the equations I used Stefano Meschiari&#39;s useful &lt;a href = &quot;https://cran.r-project.org/web/packages/latex2exp/index.html&quot;&gt;{latex2exp}&lt;/a&gt; package.  I don&#39;t really understand R&#39;s plotmath expressions that let you add equations to plots, and I don&#39;t really want to understand them if I can avoid it.  {latex2exp} let&#39;s me avoid it by using the much more commonly known LaTeX syntax and translating it for me into plotmath.
&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;latex2exp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;extrafont&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;      par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; cex.main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Calibri&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;wn&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$\\epsilon ~ N(0, \\sigma)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;           bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;x = white noise&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$x_t = 0.8x_{t-1} + \\epsilon_t$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;           bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;x =AR (1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ma1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$x_t = 0.8\\epsilon_{t-1} + \\epsilon_t$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;           bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;x = MA(1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma11&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$x_t = 0.8x_{t-1} + 0.8\\epsilon_{t-1} + \\epsilon_t$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;           bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;x = ARMA(1, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arima111&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$x_t = 0.8x_{t-1} + 0.8\\epsilon_{t-1} + \\epsilon_t$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;           bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;y = ARIMA(1, 1, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      mtext&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$y_t = x_t + x_{t-1} + ... + x_0$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arima222&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;s&quot;&gt;&amp;quot;$x_t = 0.8x_{t-1} - 0.3x_{t-2} - 0.3\\epsilon_{t-2} + 0.8\\epsilon_{t-1} + \\epsilon_t$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;         bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;z = ARIMA(2, 2, 2)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      mtext&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$y_t = x_t + x_{t-1} + ... + x_0$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;      mtext&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;latex2exp&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$z_t = y_t + y_{t-1} + ... + y_0$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; line &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-2.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;
The result has 998 frames and is probably too big for the sort of animated GIF I usually make.  When a web browser comes across an animated GIF it has to load the whole thing in - in this case, around 28MB worth - before it starts playing and I&#39;d probably lose some audiences while that happened.  So I used Microsoft MovieMaker to turn the stills into an mp4 and uploaded it to YouTube, which is basically the standard and easiest way to stream video over the web.
&lt;/p&gt;</description>
				<pubDate>Sat, 21 Nov 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/11/21/arima-sims</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/11/21/arima-sims</guid>
			</item>
		
			<item>
				<title>Linear model with time series random component</title>
					<description>&lt;h2 id=&quot;what-do-auto-correlated-residuals-do-to-your-linear-model&quot;&gt;What do auto-correlated residuals do to your linear model?&lt;/h2&gt;
&lt;p&gt;For training purposes I wanted to illustrate the dangers of ignoring time series characteristics of the random part of a classical linear regression, and I came up with this animation to do it:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0017-timeseries.gif&quot; alt=&quot;animated-regression&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I like this, because it shows how easy it is to fit something that looks to be a good fit but actually misses important parts of reality.  The red lines show where the fitted model is, based on a small window of the data - from 5 to 200 points.  The black line shows the true data generating process.  From very early on the model fit to the simple cross-sectional has converged to pretty close to the black line. However, the model fit to the data with time series errors spends a long time greatly overestimating the value of one of the parameters in the model, and not until there are 120 observations has it converged to anywhere near the true process.&lt;/p&gt;

&lt;p&gt;At the very least, it shows that you need many more - four times as many in this case, but unfortunately that’s not a magic number that will always work - observations from a time series to reliably estimate the structural part of a model.  Even if we’d explicitly modelled the time series part of the data on the right of the animation, we’d still have that problem.&lt;/p&gt;

&lt;p&gt;By including the residual plots below the scatter plots we get a nice picture of a warning sign in this basic (and should be fundamental and universal) diagnostic plot.  In this particular case the pattern is obvious; when working with real data you should check with partial autocorrelation function plots too.&lt;/p&gt;

&lt;h2 id=&quot;simulating-data&quot;&gt;Simulating data&lt;/h2&gt;

&lt;p&gt;The animation illustrates the results of simulating and contrasting two fairly extreme cases:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;cross section data, generated exactly from a model of y = a + b.x + e, e ~ N(0, 1).  This is the textbook case introduced in any basic statistics course;&lt;/li&gt;
  &lt;li&gt;time series data, generated with exactly the same model except the error term, in addition to be normally distributed with mean of zero and standard deviation of 1, has a high autocorrelation.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I chose to make the intercept of my model (a in the above formulation) 1, and the slope (b) equal to 0.3.  Here’s what the first 200 observations of the response variable looks like:
&lt;img src=&quot;http://ellisp.github.io/img/0017-original.svg&quot; alt=&quot;lorenz-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In fact, I’ve over-simplified things by leaving x in both datasets as independent and identically distributed white noise.  In reality, if y has a time series random component, x probably will have too.  But I wanted to illustrate how a single violation of our assumptions can lead to problems, rather than create a fully realistic case (which obviously would show up even more problems).&lt;/p&gt;

&lt;p&gt;The data were generated as follows.  To illustrate a point and make it a realistic test, I generate a much larger “population” time series, and the mean of zero and standard deviation of 1 applies only to that larger population.  The first 200 points is all we see.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gridExtra&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------set up-------------&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Fonts and themes:&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# sample and population size:&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;200&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;popn &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------simulate data---------&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Linear model with a time series random element, n * 10 in length:&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;df1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;popn&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.99&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; popn&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;          ind &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;popn&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;          type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TimeSeries&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# cut back to just the first n points:&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;df1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; df1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Same linear model, with i.i.d. white noise random element:&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;df2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;          ind &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;          type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;CrossSection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# draw the time series response:&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;p0 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; df1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ind&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Time&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Simulated response variable from linear model\nwith time series random element&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Creating the animation is straightforward graphics.  I make use of &lt;a href=&quot;http://ggplot2.org/&quot;&gt;ggplot2’s&lt;/a&gt; faceting feature to cut down on some code, drawing the top two connected scatterplot images with one chunk and the bottom two residuals with another.  Each frame is saved as an individual PNG image, and &lt;a href=&quot;http://www.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt; ties it all together into an animated GIF as easily as usual.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;df_both &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; df2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# I name the images i + 1000 so alphabetical order is also numeric&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;700&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;600&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   df1_tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; df1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   df2_tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; df2&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   residuals1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; residuals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; df1_tmp&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                            ind &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                            type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TimeSeries&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   residuals2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; residuals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; df2_tmp&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; 
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                            ind &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;                            type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;CrossSection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# connected scatter plots:&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df_both&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ind&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;type&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      geom_path&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;      geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;      geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; se &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;      xlim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df_both&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;      ylim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df_both&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Connected scatterplot showing regression on first&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;points&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Residuals plots    &lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; residuals1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;residuals2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;      mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;type&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;CrossSection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;TimeSeries&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;      ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ind&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; res&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;      scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;limits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;      facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;type&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;      geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;      geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Residuals from regression so far&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Time&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Residuals&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# combine them into an animated GIF&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&amp;quot; -loop 0 -delay 10 *.png &amp;quot;timeseries.gif&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sun, 15 Nov 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/11/15/linear-model-timeseries</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/11/15/linear-model-timeseries</guid>
			</item>
		
			<item>
				<title>Modelled Territorial Authority GDP for New Zealand</title>
					<description>&lt;p&gt;A big project at my work that I was involved with over the past year was the production of modelled estimates of gross domestic product at the District and City level.  There are official statistics at the Regional Council level (16 of them in New Zealand), so the aim of this project was to get that extra bit of granularity that makes analysis more meaningful.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0017-MTAGDP-screenshot.png&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Publication was on Wednesday 14 October 2015.  Writing about the project here would mix up my work and personal personas, but here’s some links:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/regions-cities/research/modelled-territorial-authority-gross-domestic-product&quot;&gt;Main page&lt;/a&gt; including links to everything else such as the methodology, summary document, and web app&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/regions-cities/research/modelled-territorial-authority-gross-domestic-product/interactive-web-tool&quot;&gt;Interactive web tool&lt;/a&gt;, built with R, Shiny and ggvis&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/nz-mbie/MTAGDP&quot;&gt;Source code on GitHub.&lt;/a&gt;  Unfortunately you can’t run this, as it depends on databases only available in the MBIE environment.  It’s published to make the methodology more transparent.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The day after MBIE published these, New Zealand Minister for Economic Development the Hon Steven Joyce launched the &lt;a href=&quot;http://www.mbie.govt.nz/info-services/business/business-growth-agenda/regions&quot;&gt;Regional Economic Activity Report&lt;/a&gt;, which includes some slices of the Modelled Territorial Authority GDP plus many, many other datasets at the Regional and Territorial Authority level.  It has an interactive web tool that is very fancy indeed, and a mobile app that gives simpler but still powerful access to the same data.  This was another big project at my workplace, with the team I used to manage cleaning and tidying data for a database of over 100 data series that was used under the hood for all the products.&lt;/p&gt;
</description>
				<pubDate>Fri, 30 Oct 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/10/30/MTAGDP</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/10/30/MTAGDP</guid>
			</item>
		
			<item>
				<title>Silver flows in the seventeenth and eighteenth centuries</title>
					<description>&lt;h2 id=&quot;silver-trade&quot;&gt;Silver trade&lt;/h2&gt;
&lt;p&gt;I’ve been reading  Ronald Findlay and Kevin H. O’Rourke’s 2009 book &lt;a href=&quot;http://press.princeton.edu/titles/8493.html&quot;&gt;&lt;em&gt;Power and Plenty: Trade, War, and the World Economy in the Second Millennium&lt;/em&gt;&lt;/a&gt; and finding it an excellent piece of big picture economic history.&lt;/p&gt;

&lt;p&gt;I felt the urge to re-express one of their figures (Figure 4.7 in the original).  The original is made up of two flow diagrams, summarising a fantastic piece of work by Jan DeVries pulling together the best understanding of where silver was traded from and to in the seventeenth and eighteenth centuries.  Here’s my reworked effort:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0015-silver.gif&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Some points worth noting:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Substantial amounts of silver remained in Europe.  The trade was not, by a long shot, all about shipping silver &lt;a href=&quot;https://en.wikipedia.org/wiki/Economy_of_the_Ming_dynasty&quot;&gt;from the Americas to China&lt;/a&gt; via Europe, although this was clearly a significant feature.&lt;/li&gt;
  &lt;li&gt;In the earlier period, there was more silver travelling from the Americas via the Pacific (stopping off at Manila) to China and the rest of East Asian than via Europe and the Cape of Good Hope.  By the mid eighteenth century, the Europe/Cape route was far larger.&lt;/li&gt;
  &lt;li&gt;Although the Chinese Ming dynasty fell in 1644, suspiciously soon after the &lt;a href=&quot;https://en.wikipedia.org/wiki/Tokugawa_shogunate&quot;&gt;seclusion of Japan from the outside world in 1635&lt;/a&gt;, the fall can’t be blamed on a shortage of silver because the decline was compensated for by increases from the Americas.&lt;/li&gt;
  &lt;li&gt;Not all the silver going via the Baltic and Levant “routes” makes it to East Asia.  Some stays in the Middle East and Russia.  In the diagram above this is shown by the ribbons flowing from the Baltic and Levant to South East Asia being only half the width of those flowing from Western Europe to the Baltic and Levant.  I’m not entirely happy with this aspect of the diagram, but it’s good enough for now.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;the-original&quot;&gt;The original&lt;/h2&gt;
&lt;p&gt;I don’t have access to DeVries’ original 2003 article:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Connecting Europe and Asia: a quantitative analysis of the Cape-route trade, 1497– 1795”. In &lt;em&gt;Global Connections and Monetary History, 1470– 1800&lt;/em&gt; (ed. D. O. Flynn, A. Gir ´ ldez, and R. von Glahn). Aldershot: Ashgate.,&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;but it must be an impressive piece of detective work.  &lt;a href=&quot;http://history.berkeley.edu/people/jan-devries&quot;&gt;Jan de Vries has a web page at Berkeley.&lt;/a&gt;  Here’s his flow diagrams as reproduced by Findlay and O’Rourke:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0015-silver-screenshot.png&quot; alt=&quot;original&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Note that the caption says the flows are in kilogrammes per year, but it’s obvious from the text that this is a typo and in fact the measures are in tonnes per year.&lt;/p&gt;

&lt;h2 id=&quot;re-creating-it&quot;&gt;Re-creating it&lt;/h2&gt;
&lt;p&gt;I wanted to improve this diagram in several ways to give it a more immediate visual impact related to the underlying data:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;use colour rather than shape to indicate which areas were producers and which were consumers&lt;/li&gt;
  &lt;li&gt;use width of lines to show volumes so it becomes a &lt;a href=&quot;https://en.wikipedia.org/wiki/Sankey_diagram&quot;&gt;Sankey diagram&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;use animation to facilitate direct comparison of the two periods&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In combination, this should be more effective than the wireframe original at drawing the viewer’s eye to the increase in volume in the Americas - Atlantic - Europe - Cape - Asia triangle, and the reduction to nothing in flows from Japan when the Tokugawa regime shut that country to the world and expelled the Portuguese traders who had been making a nice living carrying between China and Japan.&lt;/p&gt;

&lt;p&gt;I also rounded a few decimal numbers that in the original gave a false idea of precision.&lt;/p&gt;

&lt;p&gt;To do this efficiently for two diagrams that have the same basic structure, I created a project-specific function in R for the purpose of drawing a Sankey chart for different levels of silver flows.  The two images are created separately as PNG files, and then I use &lt;a href=&quot;http://www.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt; to tie them together into an animated GIF.  To allow the whole thing to be run programmatically from R, I send the command to ImageMagick from R, effectively using R as a shell script for that part of the program.  This means I don’t need to leave my R development environment to run iterations of the program (for example, while tweaking exactly where each continent’s label is placed on the page).&lt;/p&gt;

&lt;p&gt;The actual drawing of the plots is done by January Weiner’s excellent &lt;a href=&quot;https://cran.r-project.org/web/packages/riverplot/index.html&quot;&gt;{riverplot}&lt;/a&gt; R package.  Until {riverplot} came out some time in the last year or so, drawing Sankey charts was either a pain, or impossible without specialist software.  It’s great that we can now draw and polish (to a degree) Sankey charts without leaving the R environment.&lt;/p&gt;

&lt;p&gt;One trick needed for this, common when you want to set a scale to be the same in multiple plots, was to draw an invisible (ie white) ribbon connecting two invisible nodes at the top of the diagram, reflecting movement of 650 tonnes per year of silver between two imaginary locations.  This value is controlled by the cal_width argument in my silver() function below.  As 650 is equal to or larger than any of the actual flows, it forms the calibration value against which all the other ribbon widths are defined.  This means the widths of the ribbons in the two images are comparable and on the same scale.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;riverplot&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   &lt;span class=&quot;c1&quot;&gt;# for Sankey charts&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;grid&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;silver &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;node_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; edge_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; title&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                   pal &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;orange&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;cyan&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey90&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                   cal_width &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;650&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Function that draws a Sankey chart of intercontinental silver flows&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @node_values - the number of production / consumption / travel to be added&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#   to America, Western Europe, Levant, Baltic, Cape, Japan, SE Asia, Atlantic, Pacific, Sea of Japan&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @edge_values - the width of the connections in this order:&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    America to Pacific to South East Asia&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    America to Atlantic to Western Europe&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    Western Europe to Baltic to South East Asia&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    Western Europe to Levant to South East Asia&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    Western Europe to Cape to South East Asia&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    Japan to Sea of Japan to South East Asia&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @title title for plot&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @pal vector of colours for producers, consumers, and travel routes respectively&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @family font family to use&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# @cal_width width of an invisible white ribbon to draw, implicitly the maximum, &lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#    so scale is constant for multiple plots&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# edge_values comes in as just a single number and we need two edges for &lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# each (eg America to Pacific to SE Asia is two edges)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   edge_values &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;edge_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; each &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# we don&amp;#39;t know how much of the silver that goes via the Baltic and the Levant&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# actually gets to Asia (as opposed to staying in middle East and Russia),&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# so to represent this we halve the width of those two edges:&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   edge_values&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; edge_values&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   nodes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;c1&quot;&gt;# The X and Y coordinates of the nodes (Americas, Atlantic, etc) are &lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;c1&quot;&gt;# just chosen by hand:&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;      x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4.7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;      y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;      ID &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;LETTERS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;      labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;America&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Western Europe&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Levant&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Baltic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Cape of\nGood Hope&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Japan&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;South &amp;amp;\nEast Asia&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;                 &lt;span class=&quot;s&quot;&gt;&amp;quot;Atlantic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Pacific&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;      amount &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;node_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;      col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;      stringsAsFactors &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;      mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; amount&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sep &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;             labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;\n59.3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;59.3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;   edges &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;c1&quot;&gt;# Each N1 - N2 pair connects two nodes eg A-I connects America to Atlantic:&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;      N1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;    &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;H&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;D&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;E&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;&amp;quot;F&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;J&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;K&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;      N2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;    &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;H&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;D&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;E&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;&amp;quot;J&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;L&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;      Value &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;edge_values&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cal_width&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;   p &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; makeRiver&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nodes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; edges&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;   my_style &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; default.style&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;   my_style&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;textcol &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey20&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;   my_style&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;srt &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; family&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; default_style &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; my_style&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; plot_area &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.94&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; title&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;             gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; family&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.13&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;             str_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Source: DeVries (2003), reproduced in Findlay and O&amp;#39;Rourke (2007) &amp;#39;Power and Plenty&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;34&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;             gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; family&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;italic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;   legend&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; legend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Producer&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Trade route&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Consumer&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;          bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; border &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# draw the two images&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;01.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;   silver&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;      node_values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;368&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;158&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;38&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;56&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;?&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;91-126&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;268&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;17-51&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;59&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;      edge_values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;34&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;268&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;56&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;38&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;15.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;59.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;      title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Intercontinental flows of silver, tonnes per year, 1600 to 1650&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;02.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;silver&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;   node_values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;650&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;230&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;160&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;?&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;175-211&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;15-51&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;   edge_values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;33.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;160&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.00&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;   title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Intercontinental flows of silver, tonnes per year, 1725 to 1750&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# combine them into an animated GIF&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&amp;quot; -loop 0 -delay 250 *.png &amp;quot;silver.gif&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# move the asset over to where needed for the blog&lt;/span&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;file.copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;silver.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0015-silver.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; overwrite &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# cleanup&lt;/span&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;0?.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;silver.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sun, 25 Oct 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/10/25/silver</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/10/25/silver</guid>
			</item>
		
			<item>
				<title>Seasonal adjusment on the fly with X-13ARIMA-SEATS, seasonal and ggplot2</title>
					<description>&lt;h2 id=&quot;calling-seasonal-adjustment-software-from-r&quot;&gt;Calling seasonal adjustment software from R&lt;/h2&gt;
&lt;p&gt;I recently explored for the first time (having languished on the “check this out later” list) &lt;a href=&quot;http://www.christophsax.com/&quot;&gt;Christoph Sax&lt;/a&gt;’s excellent &lt;a href=&quot;https://cran.r-project.org/web/packages/seasonal/index.html&quot;&gt;{seasonal} R package&lt;/a&gt;.  It makes it super easy for R users to engage with X-13ARIMA-SEATS, the latest industry standard software for time series analysis and in particular seasonal adjustment of official statistics series.  It’s a huge step forward in ease of use from the {x12} package which was a good interface to X-12ARIMA but never felt to me as R-native as {seasonal} does; I was always conscious of X-12ARIMA in the background.  For example, to control for Chinese New Year (important at my work), you had to save a text file with the relevant dates encoded in it, rather than pass it directly to the function in an R-native way.&lt;/p&gt;

&lt;p&gt;{seasonal} calls on the latest US Census Bureau software X-13ARIMA-SEATS which has an &lt;a href=&quot;https://www.census.gov/srd/www/x13as/&quot;&gt;excellently informative website&lt;/a&gt; and free downloads.  See the definitive &lt;a href=&quot;https://www.census.gov/ts/x13as/docX13ASHTML.pdf&quot;&gt;reference manual&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To avoid confusion, some terminology:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ARIMA stands for “autoregressive integrated moving average” and is one of a class of models for time series&lt;/li&gt;
  &lt;li&gt;X11, originally the name of software by the US Census Bureau and taken up by Statistics Canada, now usually refers to the X11 &lt;em&gt;method&lt;/em&gt; for seasonal adjustment (or other inference) via ARIMA modelling first developed in the 1960s (Shiskin, Young and Musgrave in 1967)&lt;/li&gt;
  &lt;li&gt;SEATS is Signal Extraction in ARIMA Time Series and is an alternative &lt;em&gt;method&lt;/em&gt; for seasonal adjustment (or other inference) via ARIMA modelling, developed by Gomez and Maravall at Bank of Spain (various 1990s references)&lt;/li&gt;
  &lt;li&gt;X13-ARIMA-SEATS is the US Census Bureau’s latest program that implements both the X11 and SEATS methods plus some additional diagnostic and model strategy tools&lt;/li&gt;
  &lt;li&gt;{seasonal} is an R package that acts as a front end to X13-ARIMA-SEATS and gives all the needed functionality including both the X11 and SEATS methods without leaving the R environment&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;electronic-card-transactions-in-new-zealand&quot;&gt;Electronic card transactions in New Zealand&lt;/h2&gt;
&lt;p&gt;I’ll demonstrate this functionality generously made available by the US Census Bureau and Sax with &lt;a href=&quot;http://www.stats.govt.nz/browse_for_stats/businesses/business_characteristics/electronic-card-transactions-info-releases.aspx&quot;&gt;electronic card transactions spend in New Zealand, published by Statistics New Zealand&lt;/a&gt;.  The data are published on a monthly basis from October 2002 to (at the time of writing) August 2015.&lt;/p&gt;

&lt;p&gt;To get started I look at a single subset of the data, spend in millions of New Zealand dollars on apparel.  Here’s the basic data, its autocorrelation function, partial autocorrelation function, and  spectrum.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-ts-basics.svg&quot; alt=&quot;basics&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Key characteristics include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;there’s an obvious and unsurprising trend upwards - it’s not a stationary time series&lt;/li&gt;
  &lt;li&gt;the variance increases as the series increases, so some form of transformation (probably logarithm, which I checked and works well) needed if we want methods where the variance doesn’t vary with the trend&lt;/li&gt;
  &lt;li&gt;there’s a strong partial autocorrelation at 1.0 (ie annual, showing spend in a particular month is correlated with spend in the same month a year before) and at 1/12 (showing spend in a particular month is also correlated with spend in the immediately previous month).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here’s the code for downloading this data from where I’ve stashed a clean version (available for you all) and producing those basics:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;seasonal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set up fonts etc&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set path to X13-SEATS and check it&amp;#39;s working&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;Sys.setenv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;X13_PATH &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;c:/winx13/x13as&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;checkX13&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download file with data ultimately from Statistics New Zealand&amp;#39;s Infoshare, prepared &lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# earlier: &amp;quot;Values - Electronic card transactions A/S/T by industry group (Monthly)&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;download.file&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;https://github.com/ellisp/ellisp.github.io/blob/master/data/Electronic card transactions by industry group Monthly.rda?raw=true&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;              mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# ie binary&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;              destfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;tmp.rda&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp.rda&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;apparel &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ect &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;group &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Apparel&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;apparel_ts &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2002&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;pacf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;spectrum&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here’s the classic decomposition into trend, seasonal and random components that can be multiplied together to form the original series.  I use multiplicative decomposition because of the way the variance increases as the mean increases.
&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-decompose.svg&quot; alt=&quot;decomposition&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;decompose&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;multiplicative&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;A simple form of seasonal adjustment can be performed by multiplying that trend value in the plot above by the random value which can be seen to hover around 1.0 (or, equivalently, dividing the original value by the seasonal values).  This is a bit simplistic however; most notably it means the multiplier for a month stays the same over time, which is unlikely to be true over longer periods (although it might be a reasonable approximation for this relatively short series).&lt;/p&gt;

&lt;h2 id=&quot;seats-seasonal-adjustment&quot;&gt;SEATS seasonal adjustment&lt;/h2&gt;
&lt;p&gt;To perform a more sophisticated seasonal adjustment it’s best to go to the best in breed software, which is the US Census’ X-13ARIMA-SEATS.  Sax’s seasonal package makes it super-easy to fit a model and extract the seasonally adjusted values and residuals for diagnostic purposes.  In fact it’s a one liner  - a call to seas(), which gives us very sensible defaults using the SEATS method:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;automatically fits a seasonal ARIMA model based on the frequency defined in the ts object it is fed&lt;/li&gt;
  &lt;li&gt;detects outliers and in effect leaves them out of the calculation of the seasonal effects (turns out not to be important in this dataset)&lt;/li&gt;
  &lt;li&gt;detects any impact of number of trading days per month and Easter, and creates external regressors for them if necessary&lt;/li&gt;
  &lt;li&gt;detects if a transformation is necessary and chooses a good one if necessary (in this case it opts for logarithmic as we’d guessed)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;mod &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;resid&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Residuals&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;qqnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;resid&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Residuals compared to Normal&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;pacf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;resid&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial ACF of residuals&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-ts-seats.svg&quot; alt=&quot;SEATS&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Super simple.&lt;/p&gt;

&lt;p&gt;The main reasons we’re doing this from R rather than hand coding a X-13 .spc file are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;its data management ease and flexibility,&lt;/li&gt;
  &lt;li&gt;access to a wide class of analytical functions (as used in my initial explorations), and&lt;/li&gt;
  &lt;li&gt;graphics.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So the basic workflow will be to take the results from our SEATS model and manipulate them in R for re-use, whether performing diagnostic statistical tests or just visuals to understand the data.  For example, the connected scatter plot below lets us see how the original values get adjusted down (those in the right bottom triangle of the plot) or up (those in the left upper triangle) in the seasonal adjustment process.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-compare.svg&quot; alt=&quot;compare&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;apparel_sa &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   Time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_ts&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   Original &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; apparel_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   SA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; final&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel_sa&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Original&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; SA&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Time&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   geom_path&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Original ($m)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Seasonally adjusted ($m)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Comparison of original and seasonally adjusted\n electronic card transactions on apparel in New Zealand&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In fact, Sax provides a super-useful inspect() function that spins up a Shiny app that lets you interact with all the key settings and diagnostics.  I can’t show that here though as I don’t have access to a server with X-13ARIMA-SEATS and Shiny Server on it (couldn’t run it on shinyapps.io at this point for example, because of the requirement for the X-13ARIMA-SEATS software).&lt;/p&gt;

&lt;p&gt;For those interested in the actual results, the standard summary is shown below.  Months with more Fridays and Saturdays in them get increased spend on apparel (something I hadn’t expected, but I guess I hadn’t thought about it very much); months with Easter in them get less spending; and the randomness can be modelled adequately with integration of order 1 and a moving average for both the month to month change, and the year-on-year month comparison:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;Call&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; apparel_ts&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;Coefficients&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                    Estimate Std. Error z value Pr&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;|&lt;/span&gt;z&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;    
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;Mon               &lt;span class=&quot;m&quot;&gt;-0.0042437&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0042013&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-1.010&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.312446&lt;/span&gt;    
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;Tue               &lt;span class=&quot;m&quot;&gt;-0.0005243&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0041054&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-0.128&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.898375&lt;/span&gt;    
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;Wed               &lt;span class=&quot;m&quot;&gt;-0.0049353&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0040414&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-1.221&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.222013&lt;/span&gt;    
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;Thu               &lt;span class=&quot;m&quot;&gt;-0.0037071&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0041312&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-0.897&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.369540&lt;/span&gt;    
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;Fri                &lt;span class=&quot;m&quot;&gt;0.0150563&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0040701&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;3.699&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.000216&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;Sat                &lt;span class=&quot;m&quot;&gt;0.0153981&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0041104&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;3.746&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.000180&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;Easter&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;m&quot;&gt;-0.0407969&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0085273&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;-4.784&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.72e-06&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;MA&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Nonseasonal&lt;span class=&quot;m&quot;&gt;-01&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.6739188&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0611324&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;11.024&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2e-16&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;MA&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Seasonal&lt;span class=&quot;m&quot;&gt;-12&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;0.6326280&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0.0671190&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;9.425&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2e-16&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;---&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;Signif. codes&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; ‘&lt;span class=&quot;o&quot;&gt;***&lt;/span&gt;’ &lt;span class=&quot;m&quot;&gt;0.001&lt;/span&gt; ‘&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;’ &lt;span class=&quot;m&quot;&gt;0.01&lt;/span&gt; ‘&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;’ &lt;span class=&quot;m&quot;&gt;0.05&lt;/span&gt; ‘&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;’ &lt;span class=&quot;m&quot;&gt;0.1&lt;/span&gt; ‘ ’ &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;SEATS adj.  ARIMA&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  Obs.&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;155&lt;/span&gt;  Transform&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;AICc&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;949.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; BIC&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;977.1&lt;/span&gt;  QS &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;no seasonality &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; final&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;  
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;Box&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Ljung &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;no autocorr.&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;23.7&lt;/span&gt;   Shapiro &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;normality&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.9963&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here’s how I turn the output into a ggplot2 graphic:
&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-adjusted-ggplot.svg&quot; alt=&quot;compare&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;apparel_sa &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;variable&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;value&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Time&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SA&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Seasonally adjusted by SEATS&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Time&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Value of transactions ($m)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Electronic card transactions on apparel in New Zealand&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bottom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;create-a-new-ggplot2-stat&quot;&gt;Create a new ggplot2 stat&lt;/h2&gt;
&lt;p&gt;So that’s nice, but to make this feel super useful and integrate into my graphics-based data exploration workflow, I’m going to want to seasonally adjust on the fly a dataset that is sliced and diced by different dimensions.  I want something that works like geom_smooth().  Luckily, Hadley Wickham’s amazing ggplot2 package is designed to allow exactly this sort of extension.  We just need to create a new statistical transformation, with the help of the proto package which lets us briefly treat R as though it were an object-oriented programming language.&lt;/p&gt;

&lt;p&gt;In the code below, StatSeas is an object that creates functions, and stat_seas(…) is a function that works just like stat_smooth(), except instead of fitting a scatter plot smoother it performs a call to X-13ARIMA-SEATS with whatever arguments the user has passed through with the ….  The user has to specify the frequency and the starting point of the time series, and the approach isn’t robust to missing values (ie all the time series after slicing into groups need to begin at the same date).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;proto&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;StatSeas &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; proto&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;o&quot;&gt;:::&lt;/span&gt;Stat&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;    
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   required_aes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;x&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   default_geom &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; GeomLine
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   objname &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;seasadj&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   calculate_groups &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;super&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;calculate_groups&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   calculate &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; frequency&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;      y_ts &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; frequency&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; start&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;      y_sa &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; seasonal&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;final&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;seasonal&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;      result &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y_sa&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt; 
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;stat_seas &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; StatSeas&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;new&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here’s the new function in action:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;apparel&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TimePeriod&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# original:&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# seasonally adjusted:&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2002&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0014-apparel-ts-new-stat.svg&quot; alt=&quot;compare&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nice and easy!&lt;/p&gt;

&lt;p&gt;But the real beauty is that we can use this on data that is grouped by aesthetics like colour or linetype, or facets.  I demo this by going back to the full set of data of which spend on apparel was just one element.  The eight lines of code below take the original data, fit SEATS models and seasonally adjust for every spend category, and produce a nicely polished plot.  Not bad!&lt;/p&gt;

&lt;p&gt;Thanks Hadley Wickham for {ggplot2}, Christoph Sax for {seasonal}, the US Census Bureau for X-13ARIMA-SEATS, and the Bank of Spain for the SEATS method.
&lt;img src=&quot;http://ellisp.github.io/img/0014-faceted.svg&quot; alt=&quot;faceted&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ect &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TimePeriod&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; group&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1978&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; group&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SEATS-seasonally adjusted monthly transaction value ($m)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Electronic card transactions in New Zealand&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note - Statistics New Zealand publish an official seasonally adjusted series from this data, making the exercise above redundant other than as a demonstration.  Where their results differ from mine (which is only in tiny details - I checked but decided too boring to include in here), use their’s not mine.&lt;/p&gt;
</description>
				<pubDate>Sat, 10 Oct 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/10/10/X13ARIMA-SEATS</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/10/10/X13ARIMA-SEATS</guid>
			</item>
		
	</channel>
</rss>