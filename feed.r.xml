<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Peter&#39;s stats stuff - R</title>
		<description>Posts categorised as 'R'</description>
		<link>http://ellisp.github.io</link>
		<atom:link href="http://ellisp.github.io/feed.R.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Election analysis contest entry part 4 - drivers of preference for Green over Labour party</title>
					<description>&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the fourth in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Earlier posts introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt;, basic usage, how it was built, and an exploratory Shiny web application.  Today I follow up on &lt;a href=&quot;http://www.statschat.org.nz/2016/04/09/compared-to-what-4/#comment-181310&quot;&gt;discussion in the StatsChat blog&lt;/a&gt;.  A post there showed a screen shot from my Shiny app, zooming in on Auckland votes for Green Party compared to the Labour Party (the two principal left-leaning parties in New Zealand).  There was discussion in the comments of whether house price, income, and education were the predictors of the choice between these two parties (for the subset of voters who chose one of the two).&lt;/p&gt;

&lt;h2 id=&quot;combining-census-meshblock-data-with-voting-locations&quot;&gt;Combining census meshblock data with voting locations&lt;/h2&gt;
&lt;p&gt;Making it easier to investigate this issue is one the primary motivations for the &lt;code&gt;nzelect&lt;/code&gt; R package and incorporating census data that can be matched to voting locations and electorates has been on the plan from the beginning.  It’s proven a bigger job than I hoped and is very incomplete, but so far I’ve incorporated around 35 selected variables from the 2013 Census at the meshblock level.&lt;/p&gt;

&lt;h3 id=&quot;first-look&quot;&gt;First look&lt;/h3&gt;
&lt;p&gt;The plot below shows how some of those variables relate to the variable of interest here - the Green Party votes as a proportion of all that went to Green Party or Labour Party, by voting location.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0038-green-labour.png&quot; alt=&quot;matrix&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Full descriptions of the variables are in the helpfile for the &lt;code&gt;Meshblocks2013&lt;/code&gt; object in the &lt;code&gt;nzelect&lt;/code&gt; package.  People without access to that can still read the &lt;a href=&quot;https://github.com/ellisp/nzelect/blob/master/pkg/man/Meshblocks2013.Rd&quot;&gt;source code of the helpfile&lt;/a&gt; which hopefully will make sense.  Time and space constraints put me off creating a big table here in this blog post.&lt;/p&gt;

&lt;p&gt;The blue lines show outlier-resistant robust linear regressions on one explanatory variable at a time, but the non-robust versions are almost identical.  All code has been relegated to the bottom of the post.  When the &lt;code&gt;nzelect&lt;/code&gt; package has a more complete set of census data, including more variables and area unit, electorate and territorial authority variables, I’ll do a future post that focuses more on the code to join these things together.&lt;/p&gt;

&lt;p&gt;Two variables that are in the &lt;code&gt;nzelect&lt;/code&gt; package have been excluded.  These are &lt;code&gt;PropEuropean&lt;/code&gt;, the proportion of meshblock population of European ethnicity; and &lt;code&gt;PropOwnResidence&lt;/code&gt;, the proportion of individuals that own their own residence.  I excluded these early as part of my modelling strategy because they are highly collinear with the other set of candidate explanatory variables - variance inflation factors over 10.  What this means in practice is that once you know the proportions of Maori, Asian and Pacific ethnicity in a meshblock there’s not much to learn from the proportion of people of European ethnicity.  And once you know the proportion of households that are owned, there’s not much information contained in knowing the proportion of individuals who own their residence.&lt;/p&gt;

&lt;h3 id=&quot;spatial-elements&quot;&gt;Spatial elements&lt;/h3&gt;
&lt;p&gt;Note that I’ve left in two variables for the latitude and longitude, which (probably as expected) don’t have any obvious relationship to the proportion of Green v Labour voters.  This is so when I get into statistical modelling, I can take into account expected spatial auto-correlation.  Simply put, that means that the results from two voting places that are close together shouldn’t be treated as completely fresh independent information, but given somewhat less importance because of their co-location.  This is just a nuisance aspect of the model with regard to today’s question so I don’t report on the results; but in the modelling I do later I make sure I have a spatial spline lurking in the background to suck up any spatial effects, leaving the estimates of the impact of other explanatory variables safer.&lt;/p&gt;

&lt;h3 id=&quot;imputation&quot;&gt;Imputation&lt;/h3&gt;
&lt;p&gt;For confidentialisation, meshblock census results are subject to random rounding (which is why some of the proportions exceed 1 - the numerator has been rounded one way, and the denominator another) and to outright cell suppression.  For today’s purposes, the cell suppression is more of a problem.  As I’ve potentially got lots of explanatory variables in my model, many meshblocks are missing at least one variable due to the confidentialisation.  If I excluded each voting place whose meshblock was missing data, I’d be throwing out 61% of the data.&lt;/p&gt;

&lt;p&gt;This is enough of a problem that I’d consider going up a level and using area units (larger shapes than meshblocks) instead, although many area units have multiple voting locations in them so we would lose a fair bit of granularity in doing so.  However, the &lt;code&gt;nzelect&lt;/code&gt; data doesn’t yet include its area unit slice and I’m short of time, so I opt for imputation instead.&lt;/p&gt;

&lt;p&gt;I use multiple imputation, which means that you create statistical models to predict each missing value based on the values that you do have, and do this multiple times for each missing value, including the random element of the model and hence getting a different imputed value each time.  Then when you fit your final model of actual interest you fit it to each one of your datasets with missing value imputations (in this example I have 20 full sets of the data) and you base your calculations of standard errors, confidence intervals, etc. on the randomness that comes from the imputation process as well as the usual modelling uncertainty.  It’s not a fool-proof method - nothing is in the face of missing data - but it’s a good one and it does the job in this case (how do I know?  I tried other methods, including deleting all rows, and got similar results).&lt;/p&gt;

&lt;h2 id=&quot;modelling&quot;&gt;Modelling&lt;/h2&gt;
&lt;p&gt;When it comes to the actual modelling I use a generalised additive model with a binomial family response.  The ‘additive’ bit comes from a flexible two dimensional spline which is just there to deal with the nuisance of the spatial autocorrelation.  The binomial family response is appropriate for the data which uses proportions.  Here’s the end results showing which variables are good for predicting the proportion of Green / Labour votes that are for the Green Party:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0038-model-results.svg&quot; alt=&quot;results&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;interpretation&quot;&gt;Interpretation&lt;/h3&gt;
&lt;p&gt;So, just to be really clear, here are the factors in the surrounding meshblock that seem lead to a voting place returning a high proportion of Green/Labour voters voting Green:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Higher proportion of individuals are self employed&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals have a Bachelor degree&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals have no religion&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals were overseas 5 years ago&lt;/li&gt;
  &lt;li&gt;Higher proportion of households don’t own their residence&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And here are the factors that are associated with a high proportion of Green/Labour voters voting Labour:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;High proportion of individuals state they are of Pacific, Asian or Maori ethnicity&lt;/li&gt;
  &lt;li&gt;High proportion of individuals have no qualifications&lt;/li&gt;
  &lt;li&gt;High proportion of individuals were born in New Zealand&lt;/li&gt;
  &lt;li&gt;High proportion of individuals have partner or are separated&lt;/li&gt;
  &lt;li&gt;Higher individual median income&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals are aged 20 to 24&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s no discernable impact from the median household rent, best proxy in the particular data available for household prices.  So on the data available, the general demographics argument wins over the housing prices one.&lt;/p&gt;

&lt;p&gt;The surprising one here was the negative coefficient in front of median income.  This differs from the simple two variable relationship seen in the first graphic in this post; what we’re seeing with the more sophisticated modelling is evidence that the apparent relationship between income and higher proportions of Green voters over Labour is a proxy for other demographic factors (like education, ethnicity and employment), and when those factors are controlled for the relationship between income and choosing Green over Labour is negative.&lt;/p&gt;

&lt;p&gt;Care needs to be taken in leaping from this analysis to conclusions about individual behaviour, which would form the &lt;a href=&quot;https://en.wikipedia.org/wiki/Ecological_fallacy&quot;&gt;ecological fallacy&lt;/a&gt;.  For example, while areas with higher incomes seem more inclined to choose Labour over Green after controlling for other factors, it’s at least possible that it’s being surrounded by higher income people that has the effect, rather than being higher income oneself; and similarly with any other observed effect.  But with caution and caveats you can at least form some tentative conclusions about individuals; only individual level data could resolve that, and the New Zealand Election Study (which would provide that) &lt;a href=&quot;http://www.nzes.org/exec/show/data&quot;&gt;isn’t yet available for download&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;final-warnings&quot;&gt;Final warnings&lt;/h3&gt;
&lt;p&gt;One thing we &lt;em&gt;don’t&lt;/em&gt; do at this point is knock out all those “non significant” variables like proportion of people on unemployment benefit, proportion who are full time students, etc and refit the model.   This leads to all the standard errors being biased downwards, the effect sizes being biased upwards, test statistics not having the claimed distributions, confidence intervals being too small, and in fact pretty much any inference after that point is invalid.  This doesn’t stop that kind of stepwise model building from being common practice, but don’t let me catch you doing it in a context where inference about effect sizes and “which variables have how much explanatory power” are important (sometimes for predictive models that stepwise approach is more justifiable, if done carefully).&lt;/p&gt;

&lt;p&gt;This analysis is incomplete because the &lt;code&gt;nzelect&lt;/code&gt; project is incomplete.  Most glaringly, two whole sets of individual level census variables have been excluded simply because I didn’t get round to including them in the original data package.  This doesn’t invalidate the findings but it does add extra cautions and caveats.  I’ll fix that eventually but it might be a few months away.&lt;/p&gt;

&lt;p&gt;OK, that’s enough to go along with.  Thanks for reading.  Here’s the code that did that analysis:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------load up functionality and fonts------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ellisp/nzelect/pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;hadley/ggplot2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# latest version needed for subtitles and captions&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MASS&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for rlm().  Load before dplyr to avoid &amp;quot;select&amp;quot; conflicts&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mice&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for multiple imputation&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;car&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;c1&quot;&gt;# for vif()&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggthemes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for theme_tufte&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mgcv&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# for a version of gam with vcov() method&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load in the data&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzelect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------general data prep------------&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Some voting places don&amp;#39;t have a match to mesthblock and hence aren&amp;#39;t any&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# good for our purposes.  Note - Chatham Islands *should* be a match, but that&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# an issue to fix in the nzelect package which we&amp;#39;ll ignore for now&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;bad_vps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Chatham Islands Council Building, 9 Tuku Road, Waitangi&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Ordinary Votes BEFORE polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Overseas Special Votes including Defence Force&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Special Votes BEFORE polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Special Votes On polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Votes Allowed for Party Only&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Voting places where less than 6 votes were taken&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;GE2014a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;VotingPlace &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; bad_vps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------Greens / (Greens + Labour)--------------&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make a dataset with the response variable we want (Greens / (Greens + Labour))&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# and merged with the VotingPlace locations and the relevant meshblock data&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014a &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;             Party &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;             TotalGLVotes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Locations2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Meshblocks2013&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MB2014&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;MB&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TotalGLVotes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; WGS84Latitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; WGS84Longitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;          MeanBedrooms2013&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;PropStudentAllowance2013&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Tidy up names of variables.  All the census data is from 2013 so we don&amp;#39;t&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# need to say so in each variable:&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Identify and address collinearity in the explanatory variables&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# PropEuropean is 17 - can be predicted from maori, Pacific Asian.&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# PropOwnResidence is 11 - can be predicted from PropNotOwnedHH&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so let&amp;#39;s take those two un-productive variables out&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; greens&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PropEuropean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;PropOwnResidence&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Image of scatter plots of explanatory variables v response variable&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0038-green-labour.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;PropGreens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;          Variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Prop&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Prop &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; PropGreens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;Variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_x&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rlm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; se &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Percentage of Labour and Green voters who voted Green Party in party vote&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;                      label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Note: horizontal scales vary; and some proportions exceed 1.0 due to confidentialising.\nBlue lines are outlier-resistant robust regressions.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Choosing between Labour and Green in the 2014 New Zealand General Election&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;      subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Each point represents an individual voting location (vertical axis) and the meshblock within which it is located (horizontal axis).&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;    theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;panel.margin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; unit&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lines&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# More data munging prior to model fitting&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# only 39% of cases are complete, due to lots of confidentialisation:&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;complete.cases&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so to avoid chucking out half the data we will need to impute.  Best way&lt;/span&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# is multiple imputation, which gives&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# to make it easier to compare the ultimate coefficients, we&amp;#39;re going to&lt;/span&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# scale the explanatory variables.  Easiest to do this before imputationL&lt;/span&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;greens_scaled &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; greens
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Now we do the multiple imputation.  &lt;/span&gt;
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Note that we ignore PropGreens for imputation purposes - don&amp;#39;t want to impute&lt;/span&gt;
&lt;a name=&quot;True-101&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the Xs based on the Y!  First we define the default predictor matrix:&lt;/span&gt;
&lt;a name=&quot;True-102&quot;&gt;&lt;/a&gt;predMat &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;diag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ncol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-103&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Each row corresponds to a target variable, columns to the variables to use in&lt;/span&gt;
&lt;a name=&quot;True-104&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imputing them.  We say nothing should use PropGreens (first column).  Everything&lt;/span&gt;
&lt;a name=&quot;True-105&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# else is ok to use, including latitude and longitude and the total green and labour&lt;/span&gt;
&lt;a name=&quot;True-106&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# votes:&lt;/span&gt;
&lt;a name=&quot;True-107&quot;&gt;&lt;/a&gt;predMat&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-108&quot;&gt;&lt;/a&gt;greens_mi &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; mice&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; m &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; predictorMatrix &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; predMat&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-109&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-110&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# what are all the variable names?:&lt;/span&gt;
&lt;a name=&quot;True-111&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; collapse &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot; + &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-112&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-113&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fit models to each of the imputed datasets:&lt;/span&gt;
&lt;a name=&quot;True-114&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_mi&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-115&quot;&gt;&lt;/a&gt;             gam&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; MeanBedrooms &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPrivateDwellings &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-116&quot;&gt;&lt;/a&gt;                   PropSeparateHouse &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; NumberInHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropMultiPersonHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-117&quot;&gt;&lt;/a&gt;                   PropInternetHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNotOwnedHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; MedianRentHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-118&quot;&gt;&lt;/a&gt;                   PropLandlordPublic &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoMotorVehicle &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropOld &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-119&quot;&gt;&lt;/a&gt;                   PropEarly20s &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropAreChildren &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropSameResidence5YearsAgo &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-120&quot;&gt;&lt;/a&gt;                   PropOverseas5YearsAgo &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNZBorn &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropMaori &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-121&quot;&gt;&lt;/a&gt;                   PropPacific &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropAsian &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoReligion &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropSmoker &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-122&quot;&gt;&lt;/a&gt;                   PropSeparated &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPartnered &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoChildren &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-123&quot;&gt;&lt;/a&gt;                   PropNoQualification &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropBachelor &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropDoctorate &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-124&quot;&gt;&lt;/a&gt;                   PropFTStudent &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPTStudent &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; MedianIncome &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-125&quot;&gt;&lt;/a&gt;                   PropSelfEmployed &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropUnemploymentBenefit &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-126&quot;&gt;&lt;/a&gt;                   PropStudentAllowance &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-127&quot;&gt;&lt;/a&gt;                    s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Latitude&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Longitude&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-128&quot;&gt;&lt;/a&gt;                    s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Latitude &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; WGS84Longitude&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-129&quot;&gt;&lt;/a&gt;                family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; binomial&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; weights &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TotalGLVotes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-130&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-131&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-132&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-133&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# extract all the estimates of coefficients, except the uninteresting intercept:&lt;/span&gt;
&lt;a name=&quot;True-134&quot;&gt;&lt;/a&gt;coefs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;pool&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod2&lt;span class=&quot;p&quot;&gt;))[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; 
&lt;a name=&quot;True-135&quot;&gt;&lt;/a&gt;vars &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rownames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-136&quot;&gt;&lt;/a&gt;coefs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-137&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; vars&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-138&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;est&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-139&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Prop&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-140&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-141&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# drop all the uninteresting estimates associated with the spatial splines:&lt;/span&gt;
&lt;a name=&quot;True-142&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;WGS84&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-143&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-144&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make names referrable:&lt;/span&gt;
&lt;a name=&quot;True-145&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-146&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-147&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# define plot of results:&lt;/span&gt;
&lt;a name=&quot;True-148&quot;&gt;&lt;/a&gt;p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ymin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lo_95&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ymax &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hi_95&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; est&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-149&quot;&gt;&lt;/a&gt;   geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lightblue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-150&quot;&gt;&lt;/a&gt;   geom_linerange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey20&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-151&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; vjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; nudge_x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-152&quot;&gt;&lt;/a&gt;   coord_flip&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-153&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\nHorizontal lines show 95% confidence interval of scaled impact on&lt;/span&gt;
&lt;a name=&quot;True-154&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;proportion that voted Green out of Green and Labour voters.&lt;/span&gt;
&lt;a name=&quot;True-155&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;The numbers show coefficients from a logistic regression and &lt;/span&gt;
&lt;a name=&quot;True-156&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;should be taken as indicative, not strictly interpretable.\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-157&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-158&quot;&gt;&lt;/a&gt;        caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Source: http://ellisp.github.io&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-159&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Census characteristics of voting places that party-voted Green over Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-160&quot;&gt;&lt;/a&gt;      subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand General Election 2014&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-161&quot;&gt;&lt;/a&gt;   theme_tufte&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-162&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text.y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
&lt;a name=&quot;True-163&quot;&gt;&lt;/a&gt;         axis.ticks.y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-164&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More likely to\nvote Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-165&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-166&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More likely to\nvote Green&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-167&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;darkgreen&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-168&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-169&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sat, 16 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/16/nzelect4</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/16/nzelect4</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 3 - interactive exploration of voting locations with leaflet and Shiny</title>
					<description>&lt;style&gt;
               #scaled-frame { width: 1400px; height: 910px; border: 0px; }
               #scaled-frame {
               zoom: 0.67;
               -moz-transform: scale(0.7);
               -moz-transform-origin: 0 0;
               -o-transform: scale(0.7);
               -o-transform-origin: 0 0;
               -webkit-transform: scale(0.7);
               -webkit-transform-origin: 0 0;
               overflow: hidden;
               }

               @media screen and (-webkit-min-device-pixel-ratio:0) {
               #scaled-frame  { zoom: 1;  }
               }
&lt;/style&gt;

&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the third in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;First&lt;/a&gt; I introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt; from a user perspective.  &lt;a href=&quot;/blog/2016/04/04/nzelect2/&quot;&gt;Second&lt;/a&gt; was a piece on how the build of that package works.  Today, the third in the series introduces an interactive map of results by voting location drawing on the data in &lt;code&gt;nzelect&lt;/code&gt;, built with Shiny.&lt;/p&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;
&lt;p&gt;The point of the tool is to facilitate comparison of support for parties by fine grained location, well below the electorate level that is usually used as the area of analysis. I’ve included data for the party vote of the eight most successful parties in the 2014 election.  Party vote determines the ultimate make up of Parliament (see &lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;this previous post&lt;/a&gt; for a brief discussion of how the New Zealand system works) and is more comparable across locations than is candidate vote for a number of reasons.&lt;/p&gt;

&lt;p&gt;Here’s the Shiny app in action:&lt;/p&gt;
&lt;div style=&quot;height: 647px&quot;&gt;
&lt;iframe id=&quot;scaled-frame&quot; width=&quot;980&quot; src=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot; style=&quot;overflow-y: hidden;&quot;&gt;&lt;/iframe&gt;
&lt;/div&gt;

&lt;p&gt;Most users will prefer the &lt;a href=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot;&gt;full screen version&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What you can do with this app includes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;you can use the drop down box to add circles representing the percentage of vote at any voting place for each of up to 8 parties.  Each time you select a new party, it adds new circles on the front of the graphic - so if you want to compare two parties it’s a good idea to choose the more popular (for your shown location) first, and overlay the less popular one on top of it&lt;/li&gt;
  &lt;li&gt;you can move the map around to a part of New Zealand you’re interested in and zoom in or out, and the markers will resize to be visible&lt;/li&gt;
  &lt;li&gt;you can click on the individual circles to get a tooltip showing the actual number of votes for that party in that location (only really readable in the full screen version).&lt;/li&gt;
  &lt;li&gt;you can rescale the circles - recommended if you’re looking at parties other than Labour, National and Green.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It’s definitely most interesting when you’re comparing two parties.  Remember that these data show the locations where people voted (on a Saturday), which is presumed to be generally but not always close to but not identical to where they live and / or (less often) work.  Here’s some snapshots of interesting contrasts:&lt;/p&gt;

&lt;h3 id=&quot;new-zealand-first-compared-to-maori-party-in-the-northland-area&quot;&gt;New Zealand First compared to Maori Party in the Northland area&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-northland.png&quot; alt=&quot;northland&quot; /&gt;&lt;/p&gt;

&lt;p&gt;New Zealand First outperformed the Maori Party comprehensively in Northland, showing there’s no inevitable link from higher proportions of Maori ethnicity to supporting the party of that name.  More exploring shows the Maori Party’s strongest support in parts of Bay of Plenty, Taupo and Gisborne (upper right north island, for non-New Zealanders, and like Northland, concentrations of people with Maori ethnicity).&lt;/p&gt;

&lt;h3 id=&quot;national-compared-to-labour-in-auckland&quot;&gt;National compared to Labour in Auckland&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-auckland.png&quot; alt=&quot;auckland&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The fine grained pattern of National Party (blue circle) support compared to the Labour Party in Auckland’s inner suburbs is extremely marked:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Near parity in the city centre;&lt;/li&gt;
  &lt;li&gt;National dominance in the eastern and (to a lesser extent) northern inner suburbs;&lt;/li&gt;
  &lt;li&gt;Labour stronger around Tamaki (to the right of the image) plus some pockets in the south-west.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;When analysed at an electorate level, that Labour support in the bottom right of the image in Tamaki the suburb is missed because it is wrapped up in the overall strongly-National &lt;a href=&quot;https://en.wikipedia.org/wiki/T%C4%81maki_(New_Zealand_electorate)&quot;&gt;Tamaki electorate&lt;/a&gt;, Robert Muldoon’s old electorate and returning National MPs uninterruptedly since the 1960s.&lt;/p&gt;

&lt;h3 id=&quot;greens-compared-to-labour-in-wellington&quot;&gt;Greens compared to Labour in Wellington&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-wellington.png&quot; alt=&quot;wellington&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The two main parties of the left in New Zealand are Labour and the Greens.  Green Party support relative to Labour Party in the Wellington area is a very regional phenomenon.   Green party votes in 2014 were focused in the inner city and suburbs with small patches in other suburbs that perhaps are unsurprising to political tacticians who know Wellington’s spatial socio-demographics.  This follows the trend (in New Zealand and similar countries) for the educated, well off, younger left to more generally support the Greens than the older parties of the left.  Note the traditional working class Labour Party strongholds in Lower Hutt and Wainuiomata areas.&lt;/p&gt;

&lt;h2 id=&quot;a-trick-with-leaflet-and-shiny&quot;&gt;A trick with leaflet and Shiny&lt;/h2&gt;
&lt;p&gt;The web app is put together with &lt;a href=&quot;http://shiny.rstudio.com/&quot;&gt;shiny&lt;/a&gt; and &lt;a href=&quot;https://rstudio.github.io/leaflet/&quot;&gt;leaflet&lt;/a&gt;.  This next snippet of blog assumes the reader knows the basics of Shiny and is interested in specifics related to this app.&lt;/p&gt;

&lt;p&gt;The source code of the Shiny app is at &lt;a href=&quot;https://github.com/ellisp/nzelect/tree/master/examples/leaflet&quot;&gt;https://github.com/ellisp/nzelect/tree/master/examples/leaflet&lt;/a&gt;.  There’s some prep done to create the necessary data files elsewhere in the repository at &lt;a href=&quot;https://github.com/ellisp/nzelect/blob/master/prep/shiny_prep.R&quot;&gt;https://github.com/ellisp/nzelect/blob/master/prep/shiny_prep.R&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;updating-an-existing-map&quot;&gt;Updating an existing map&lt;/h3&gt;
&lt;p&gt;I won’t go through it line by line but will point out one interesting feature now available with leaflet and R.  The &lt;code&gt;leafletProxy()&lt;/code&gt; function in the &lt;code&gt;leaflet&lt;/code&gt; package, in combination with &lt;code&gt;observe()&lt;/code&gt; from &lt;code&gt;shiny&lt;/code&gt;, let’s you delete or redraw elements of an existing leaflet map that the user has zoomed in or out on and changed its location, without redrawing the whole map.  This is essential for a decent user experience and wasn’t in the early releases of the &lt;code&gt;leaflet&lt;/code&gt; R package.&lt;/p&gt;

&lt;p&gt;In case someone else is interested in it here is an excerpt from the &lt;code&gt;shiny.R&lt;/code&gt; file of my Shiny app showing how the existing map &lt;code&gt;MyMap&lt;/code&gt; gets circles added to it when the reactive object &lt;code&gt;the_data()&lt;/code&gt; changes as a result of the user picking a new political party to show.  In this case, a new set of circles is added with &lt;code&gt;addCircleMarkers()&lt;/code&gt;, superimposed over whatever is currently on the map.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;observe&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;     leafletProxy&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MyMap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;df&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;            addCircleMarkers&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;WGS84Longitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;WGS84Latitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;                             color &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;thecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                             radius &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;prop &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; input&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;sc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                             popup &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;lab&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Similarly, here’s the trick I use to clear all the circle markers when the user presses the button labelled “Clear all parties”.  That button increases the value of &lt;code&gt;input$clear1&lt;/code&gt; by one, and by referring to it inside an observer with the otherwise pointless &lt;code&gt;x &amp;lt;- input$clear1&lt;/code&gt; (see below) I activate that observer, which then updates the selected party to be blank, and clears all the markers off &lt;code&gt;MyMap&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;observe&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; input&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;clear1
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;        updateSelectInput&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;session&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; selected &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;        leafletProxy&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MyMap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; clearMarkers&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;that-watercolour-background&quot;&gt;That watercolour background…&lt;/h3&gt;
&lt;p&gt;The beautiful (I think) water colour background, with just enough labels on it to let you know where you are but not clutter it up like the usual roadmap, comes from overlaying &lt;a href=&quot;http://maps.stamen.com/#terrain/12/37.7706/-122.3782&quot;&gt;Stamen&lt;/a&gt; &lt;code&gt;Watercolor&lt;/code&gt; and &lt;code&gt;TonerLabels&lt;/code&gt; layers.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;That’s all for today.  Happy &lt;a href=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot;&gt;exploring the fine grained details of New Zealand voting locations&lt;/a&gt;.  If you spot a bug or other issue with the map please &lt;a href=&quot;https://github.com/ellisp/nzelect/issues&quot;&gt;file an issue with the &lt;code&gt;nzelect&lt;/code&gt; project&lt;/a&gt;.  If you just want to comment on this post or anything related, use comments section below.&lt;/p&gt;
</description>
				<pubDate>Sat, 09 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/09/nzelect3</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/09/nzelect3</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 2 - building the nzelect R package</title>
					<description>&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the second in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;,  &lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;Yesterday&lt;/a&gt; I introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt; from a user perspective.  Today I’m writing about how the build of that package works.  This might be of interest to someone planning on doing something similar, or to anyone who wants to contribute to &lt;code&gt;nzelect&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Here’s today’s themes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Structure - separation of the preparation from the package&lt;/li&gt;
  &lt;li&gt;Modular code&lt;/li&gt;
  &lt;li&gt;Specific techniques - combining multiple CSVs, and overlaying spatial points and shapefiles&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;structure&quot;&gt;Structure&lt;/h2&gt;
&lt;p&gt;Here’s the directory structure within the Git repo that builds this package, with the individual files in the key &lt;code&gt;./prep/&lt;/code&gt; folder shown on the right:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0036-structure.png&quot; alt=&quot;structure&quot; /&gt;&lt;/p&gt;

&lt;p&gt;You can view, fork and clone the whole project for yourself if interested from &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;GitHub&lt;/a&gt;.  The code excerpts in this blog post won’t run if you just paste them into R; they need a specific folder structure that comes from running them in a clone of the main project.&lt;/p&gt;

&lt;p&gt;Conceptually, there are three main parts of this project:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;downloads and data munging that need to be done separately to the published R package, and which include products like data tidying scripts and downloaded raw data which must not be included in the package itself.  This comprises the &lt;code&gt;prep&lt;/code&gt; and  &lt;code&gt;downloads&lt;/code&gt; folders&lt;/li&gt;
  &lt;li&gt;The R package itself, which is in the &lt;code&gt;pkg&lt;/code&gt; folder and includes subdirectories for &lt;code&gt;data&lt;/code&gt;, &lt;code&gt;man&lt;/code&gt;, &lt;code&gt;R&lt;/code&gt; and &lt;code&gt;tests&lt;/code&gt; folders&lt;/li&gt;
  &lt;li&gt;secondary material which depends on the R package being in existence and installed, such as the &lt;code&gt;README&lt;/code&gt; for the GitHub repo, extended examples in &lt;code&gt;examples&lt;/code&gt; including a Shiny app which will be the subject of the next post, etc.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s also various administrative stuff, such as the &lt;code&gt;.git&lt;/code&gt; folder holding the version control database, &lt;code&gt;.Rproj.user&lt;/code&gt; holding information on the RStudio project, the &lt;code&gt;travis.yml&lt;/code&gt; file that sets up hooks from GitHub to Travis Continuous Integration, and &lt;code&gt;nzelect.Rcheck&lt;/code&gt; holding the latest version of the R package build checks.&lt;/p&gt;

&lt;p&gt;This is a typical structure for me.  I generally don’t like an R package based in the root folder of a project.  I nearly always have a bunch of stuff I want to do - prep and extended examples - that I don’t want in the built and published version of the package for end users, but I do want kept together with the code building the package in a single RStudio project and Git repository.&lt;/p&gt;

&lt;p&gt;The project is held together by a script entitled &lt;code&gt;build.R&lt;/code&gt;.  In other projects this would make sense as a &lt;code&gt;makefile&lt;/code&gt; but my workflow with &lt;code&gt;nzelect&lt;/code&gt; is quite interactive (I pick and choose which files to run during development) and I’m more comfortable doing that with an R script.  In principle it should work if run end to end with a fresh clone of the repository, and it looks like this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#./build.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Builds (from scratch if necessary for a fresh clone) the nzelect R package&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------functionality------------&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;knitr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;devtools&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------downloads---------------&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# These are one-offs, and separated from the rest of the grooming to avoid&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# repeating expensive downloads&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# About 1MB worth of voting results:&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/download_votingplace_results.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# About 130MB of shapefiles / maps, used for locating voting places in areas:&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/download_map_shapefiles.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------tidying----------------&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import all the voting results CVS and amalgamate into a single object&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/tidy_votingplace_results.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 30 seconds&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download and import the actual locations.  Includes a 575KB download.&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script also calls ./prep/match_locations_to_areas.R from within itself &lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# (takes a few minutes to run because of importing shapefiles, downloaded earlier):&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/import_votingplace_locations.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 3 minutes&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Down the track there might be some import of economic and sociodemographic&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# data here; currently only in development&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# munge data for Shiny app and prompts to deploy it:&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/shiny_prep.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#--------------build the actual package---------&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create helpfiles:&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;document&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# unit tests, including check against published totals&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;test&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create README for GitHub repo:&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;knit&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;README.Rmd&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;README.md&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# run pedantic CRAN checks&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;check&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# currently fail due to inputenc LaTeX compile prob&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create .tar.gz for CRAN or wherever&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;build&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;modular-code&quot;&gt;Modular code&lt;/h2&gt;
&lt;p&gt;Looking at that &lt;code&gt;build.R&lt;/code&gt; script introduces my second theme for today - modularity.  I have separate scripts for different tasks such as “download election results”, “download shapefiles” and “tidy voting place results”.  This makes development easier to keep track of, and easier to run and debug a whole script at once without repeating expensive processes like downloads.  Note that the downloaded data isn’t tracked by Git - that would bloat out the repository too much, so all downloads are covered in the .gitignore instead.&lt;/p&gt;

&lt;p&gt;Some of those scripts are very short.  For example, &lt;code&gt;download_map_shapefiles.R&lt;/code&gt; is only 8 lines long including blanks:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/download_map_shapefiles.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# We want 2014 boundaries&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;download.file&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www3.stats.govt.nz/digitalboundaries/annual/ESRI_Shapefile_Digital_Boundaries_2014_Generalised_12_Mile.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;              destfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014_boundaries.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;unzip&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014_boundaries.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exdir &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This sort of thing is key for maintainability.  If multiple people are working on a project, it also stops them treading on eachothers’ toes working on the same files at once.&lt;/p&gt;

&lt;h2 id=&quot;specific-techniques&quot;&gt;Specific techniques&lt;/h2&gt;
&lt;p&gt;I won’t go through the whole project - that’s easiest done for yourself if interested from a clone of it - but will highlight three more things.&lt;/p&gt;

&lt;h3 id=&quot;munging-the-electoral-commission-csvs&quot;&gt;Munging the Electoral Commission CSVs&lt;/h3&gt;
&lt;p&gt;The 2014 general election results are published on the web in the form of 71 CSV files for candidate vote (one per electorate) and 71 CSV files for party vote.  Each CSV has data on each voting place used by voters enrolled in the electorate (voting places are not necessarily physically in the electorate).  Here’s a screenshot of a typical CSV:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0036-csv.png&quot; alt=&quot;csv&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As can be seen, they go some way towards being nicely machine readable, but are not yet in tidy shape.&lt;/p&gt;

&lt;p&gt;Some features of these CSVs include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;the name of the electorate is in cell A2&lt;/li&gt;
  &lt;li&gt;the main body of data starts in row 3&lt;/li&gt;
  &lt;li&gt;column A of the main data represents suburb, and a blank represents “same as previous entry”&lt;/li&gt;
  &lt;li&gt;the final row of the main data (not shown) is always a Total, followed by a row that is blank for columns A:E&lt;/li&gt;
  &lt;li&gt;below the main data rectangle there is a secondary rectangle of data (not shown) with data on candidates that is otherwise not presented (ie which party the candidates represent) as well as sum totals of their votes&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Luckily, each CSV has an identical pattern - not identical numbers of rows and columns, but enough pattern that it is possible to programmatically identify the main data rectangle.  For example, after skipping the first three rows, the next empty cell in column B indicates the main data rectangle is finished, and the row above that cell is the sum total (which needs to be excluded).  Here’s the part of the tidying script that deals with those candidate CSVs:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/tidy_votingplace_results.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imports previously downloaded CSVs of election results by voting place.&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# So far only for 2014 General Election&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================2014======================================&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;number_electorates &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;71&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------------2014 candidate results-------------------&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;filenames &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/elect2014/e9_part8_cand_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;number_electorates&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.csv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;results_voting_place &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;number_electorates&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# What is the electorate name?  Is in cell A2 of each csv&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;    electorate &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filenames&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; skip&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; nrows&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; header&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;                           stringsAsFactors&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fileEncoding &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;UTF-8-BOM&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# read in the bulk of the data&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filenames&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; skip&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; check.names&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                    stringsAsFactors&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fileEncoding &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;UTF-8-BOM&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# read in the candidate names and parties&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;    first_blank &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;which&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;    candidates_parties &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[(&lt;/span&gt;first_blank &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;    candidates_parties &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;                                &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# we knock out all the rows from (first_blank - 1) (which is the total)&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;first_blank &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ApproxLocation&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# in some of the data there are annoying subheadings in the second column.  We can&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# identify these as rows that return NA when you sum up where the votes should be&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;))})),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# need to fill in the gaps where there is no polling location&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;    last_ApproxLocation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;            tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; last_ApproxLocation
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;            last_ApproxLocation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;  
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# normalise / tidy&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Total Valid Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;        gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Votes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ApproxLocation&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;    tmp&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Electorate &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; electorate
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;        left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;    results_voting_place&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# combine all electorates&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;candidate_results_voting_place &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;do.call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rbind&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; results_voting_place&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;    mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;           Party &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;M..ori Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;           VotingType &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;overlaying-shapefiles&quot;&gt;Overlaying shapefiles&lt;/h3&gt;
&lt;p&gt;One important task was to take the point locations (in NZTM coordinates) of the 2,500 or so voting places and determine which meshblock, area unit, Territorial Authority and Regional Council each was in.  Luckily this is a piece of cake with the &lt;code&gt;over()&lt;/code&gt; function from the &lt;code&gt;sp&lt;/code&gt; package.  The process is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;import a shapefile of the boundaries we want (the originals are at http://www.stats.govt.nz/browse_for_stats/Maps_and_geography/Geographic-areas/digital-boundary-files.aspx and a script in the project downloads the versions for 2014) into R as a &lt;code&gt;sp::SpatialPolygonsDataFrame&lt;/code&gt; object&lt;/li&gt;
  &lt;li&gt;use the proj4string from that shapefile to help convert the NZTM coordinates into a &lt;code&gt;sp::SpatialPoints&lt;/code&gt; object&lt;/li&gt;
  &lt;li&gt;use &lt;code&gt;sp::over()&lt;/code&gt; to map the SpatialPoints to the SpatialPolygonsDataFrame.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/match_locations_to_areas.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# depends on the shapefiles having already been downloaded from&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/download_map_shapefiles.R; and Locations2014 to have&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# been created via .prep/import_votingplace_locations.R&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script then matches those point locations with the polygons&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# of Regional Councils, Territorial Authority, and Area Unit.&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script is called from ./prep/import_votingplace_locations.R&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rgdal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------Import Territorial Authority map------------------&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;TA &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; readOGR&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014 Digital Boundaries Generlised Full&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;s&quot;&gt;&amp;quot;TA2014_GV_Full&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------------convert locations to sp format-----------&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;locs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; SpatialPoints&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coords &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Locations2014&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;NZTM2000Easting&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;NZTM2000Northing&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                      proj4string &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TA&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;proj4string&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------Match to Territorial Authority-------&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;locs2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; over&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;locs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;Locations2014&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;TA2014_NAM &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; locs2&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;TA2014_NAM
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;..&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;unit-tests&quot;&gt;Unit tests&lt;/h3&gt;
&lt;p&gt;Any serious coding project needs unit tests so you can be sure that things, once fixed, continue to work as you make changes to other parts of the project.  This applies as much to analytical projects as to software development.  Hadley Wickham’s &lt;code&gt;testthat&lt;/code&gt; package gives a nice structure for including unit tests in the actual check and build of an R package, and I use that in this project.  Here’s some of the tests I’m using, in the &lt;code&gt;./pkg/tests/testthat/&lt;/code&gt; directory:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;testthat&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Must match results from &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://www.electionresults.govt.nz/electionresults_2014/e9/html/e9_part1.html&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# absolute numbers&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1131501&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1081787&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;604535&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;801287&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;208300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;73384&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Patriotic Revolutionary Front&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# percentages&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Party Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;47.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7.06&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# compare to http://www.electionresults.govt.nz/electionresults_2014/electorate-47.html&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;rotorua &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;    filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Electorate &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Rotorua 47&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;    group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;    summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;    arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])),&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;McClay, Todd Michael&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;18715&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])),&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;russell, lyall&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;132&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The three themes for today:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;structure - separating prep, package, and extended use&lt;/li&gt;
  &lt;li&gt;modularity&lt;/li&gt;
  &lt;li&gt;a few specific techniques of data cleaning&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That’s enough for now.  Stay tuned for the next post in the series, which looks at the Shiny app I built as an extended example of use of the &lt;code&gt;nzelect&lt;/code&gt; package.&lt;/p&gt;
</description>
				<pubDate>Mon, 04 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/04/nzelect2</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/04/nzelect2</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 1 - introducing the nzelect R package</title>
					<description>&lt;h2 id=&quot;the-contest&quot;&gt;The contest&lt;/h2&gt;
&lt;p&gt;Inspired by &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;, I’ve fast-tracked a project that’s been at the back of my mind for a while, to make available in a friendly, tidy R package a range of data about New Zealand elections.  My entry for the contest will involve 3 or 4 posts over the next week or so:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Today’s post, introducing the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt;&lt;/a&gt; package from a user angle and demonstrating some basic use&lt;/li&gt;
  &lt;li&gt;A post to come on how &lt;code&gt;nzelect&lt;/code&gt; was put together&lt;/li&gt;
  &lt;li&gt;A post on this &lt;a href=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot;&gt;Shiny app which provides an interactive map&lt;/a&gt; to explore the detail (down to individual voting location) of the New Zealand 2014 general election&lt;/li&gt;
  &lt;li&gt;(if I get around to it) a more formal piece of statistical modelling of some of the spatial aspects of the 2014 general election&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The first three posts are really about setting up infrastructure - tidying up the data for convenience, and exploring it in an interactive tool - so the four posts need to be seen as a unified whole.  Hopefully I’ll get round to that last one!&lt;/p&gt;

&lt;h2 id=&quot;the-need-for-an-r-package&quot;&gt;The need for an R package&lt;/h2&gt;
&lt;p&gt;Election results data in New Zealand is in pretty good shape.  The Electoral Commission publishes &lt;a href=&quot;http://www.electionresults.govt.nz/&quot;&gt;results in a nice nearly-there machine-readable format&lt;/a&gt;.  However, there’s still a bit of work required to make it analysis-ready, particularly for anything that gets seriously into the spatial aspects or matching to demographic or economic data.&lt;/p&gt;

&lt;p&gt;For example, consider &lt;a href=&quot;https://kiwipollguy.wordpress.com/2014/04/29/polling-place-geodata/&quot;&gt;this blog post by kiwipollguy&lt;/a&gt;.  He identifies that it would be useful to do a regression of voting behaviour on economic characterstics of the meshblocks (lowest geographical unit in the New Zealand census) in which they’re located, but it’s clearly a job of work to organise the data to do that.&lt;/p&gt;

&lt;p&gt;Statistics New Zealand publish census data at an electorate level, which is potentially useful, but not enough for those seeking to go an extra level of spatial granularity.&lt;/p&gt;

&lt;p&gt;By spending a couple of days in working on the &lt;code&gt;nzelect&lt;/code&gt; package I hope to make the data that much more accessible that this sort of serious analysis will be possible.  For example, I’ve now done the work of matching voting locations to meshblocks, which means that R users don’t need to confront shapefiles and polygon overlays in order to match the data to other variables.&lt;/p&gt;

&lt;h3 id=&quot;background&quot;&gt;Background&lt;/h3&gt;
&lt;p&gt;A bit of background for international readers.  New Zealand has a single house of parliament (ie no equivalent of a Senate house of review as in Australia or the USA), and the Executive is drawn from the party that can command the confidence of the house (ie no independent election of a President as in the USA).&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://www.elections.org.nz/voting-system/mmp-voting-system&quot;&gt;New Zealand electoral system&lt;/a&gt; is a mixed-member proportional (MMP) system.  Each voter gets two votes.  A candidate vote is for an individual parliamentary representative of a particular electorate, defined by place of residence of the registered voter, and counting is first past the post.  The party vote counts towards proportional representation and determines the overall make up of Parliament.  That is, the number of representatives a party gets in Parliament is determined by their share of the party vote; and the gap between the number of successful individual candidates and that number is made up from a party “List”.  The system has been around since &lt;a href=&quot;https://en.wikipedia.org/wiki/Electoral_system_of_New_Zealand&quot;&gt;1996 (replacing a simple first past the post one electorate - one candidate system)&lt;/a&gt;.  Many voters understand it well enough to engage in tactical voting (more on that below).&lt;/p&gt;

&lt;h2 id=&quot;installation-and-objects-provided&quot;&gt;Installation and objects provided&lt;/h2&gt;
&lt;p&gt;Currently {nzelect} is available on GitHub.  I’ll consider a CRAN release once it’s stable.  So far I’ve only got the 2014 General Election results in there; I’d like to have at least the 2011 election added too.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ellisp/nzelect/pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzelect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So far there are just two data frames (and their helpfiles) in the package:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;GE2014&lt;/code&gt; is the results of both the candidate and party votes, for each combination of voting location and electorate.  In data modelling terms, voting location and electorate have a many-to-many relationship because people can physically vote in locations that are not in the electorate for which they are enrolled.&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;Locations2014&lt;/code&gt; is information on the 2,568 individual voting locations: their coordinates in both NZTM and WGS terms, which electorate they are physically located in, and which mesh block, area unit, Territorial Authority, and Regional Council they are located in.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The two datasets can be matched by the street address of the location, called &lt;code&gt;VotingPlace&lt;/code&gt; in both dataframes.&lt;/p&gt;

&lt;h2 id=&quot;overall-results&quot;&gt;Overall results&lt;/h2&gt;
&lt;p&gt;Here’s how to replicate the overall election results for 2014, matching the &lt;a href=&quot;http://www.electionresults.govt.nz/electionresults_2014/e9/html/e9_part1.html&quot;&gt;official numbers published by the Electoral Commission&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzelect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GGally&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for ggpairs&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RColorBrewer&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gridExtra&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for grid.arrange&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Vote&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Party&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Party&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; PartyVote&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; CandidateVote&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PartyVote&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;Source&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; local &lt;span class=&quot;kt&quot;&gt;data frame&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;28&lt;/span&gt; x &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                              Party PartyVote CandidateVote
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                              &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;chr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;         &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;                    National Party   &lt;span class=&quot;m&quot;&gt;1131501&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;1081787&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;                      Labour Party    &lt;span class=&quot;m&quot;&gt;604535&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;801287&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;                       Green Party    &lt;span class=&quot;m&quot;&gt;257359&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;165718&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;           New Zealand First Party    &lt;span class=&quot;m&quot;&gt;208300&lt;/span&gt;         &lt;span class=&quot;m&quot;&gt;73384&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;                      Conservative     &lt;span class=&quot;m&quot;&gt;95598&lt;/span&gt;         &lt;span class=&quot;m&quot;&gt;81075&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;                     Internet MANA     &lt;span class=&quot;m&quot;&gt;34094&lt;/span&gt;            &lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;                       Maori Party     &lt;span class=&quot;m&quot;&gt;31849&lt;/span&gt;         &lt;span class=&quot;m&quot;&gt;42108&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;                   ACT New Zealand     &lt;span class=&quot;m&quot;&gt;16689&lt;/span&gt;         &lt;span class=&quot;m&quot;&gt;27778&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;  Aotearoa Legalise Cannabis Party     &lt;span class=&quot;m&quot;&gt;10961&lt;/span&gt;          &lt;span class=&quot;m&quot;&gt;4936&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;             Informal Party Votes     &lt;span class=&quot;m&quot;&gt;10857&lt;/span&gt;            &lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;..&lt;/span&gt;                              &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;       &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;           &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Here’s how to get the results for a single electorate:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Electorate &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Wellington Central 60&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Proportion &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;Source&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; local &lt;span class=&quot;kt&quot;&gt;data frame&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;11&lt;/span&gt; x &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                        Candidate                            Party Votes Proportion
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;chr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;chr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;         ROBERTSON&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Grant Murray                     Labour Party &lt;span class=&quot;m&quot;&gt;19807&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;51.6&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;  FOSTER&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;BELL&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Paul Ayers Robert                   National Party &lt;span class=&quot;m&quot;&gt;11540&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;30.1&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;        SHAW&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; James Peter Edward                      Green Party  &lt;span class=&quot;m&quot;&gt;5077&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;13.2&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;                      BARR&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Hugh          New Zealand First Party   &lt;span class=&quot;m&quot;&gt;580&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;               GREGORY&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Alistair Aotearoa Legalise Cannabis Party   &lt;span class=&quot;m&quot;&gt;353&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.9&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;           HOOPER&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Brian William                     Conservative   &lt;span class=&quot;m&quot;&gt;307&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;        Informal Candidate Votes         Informal Candidate Votes   &lt;span class=&quot;m&quot;&gt;273&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.7&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;      VALENTINE&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Callum Nicholas                   Internet Party   &lt;span class=&quot;m&quot;&gt;217&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.6&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;        ROBINSON&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Peter Franklin                      Independent    &lt;span class=&quot;m&quot;&gt;90&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; KNUCKEY&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; James Nicholas Ransom      Democrats &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; Social Credit    &lt;span class=&quot;m&quot;&gt;57&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.1&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;     KARENA WHUIMAONO&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Geoffrey                      Independent    &lt;span class=&quot;m&quot;&gt;52&lt;/span&gt;        &lt;span class=&quot;m&quot;&gt;0.1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;comparing-party-and-candidate-vote&quot;&gt;Comparing party and candidate vote&lt;/h2&gt;
&lt;p&gt;The first table shown above reveals an interesting pattern, perhaps more visible in a graphic:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0035-p1.svg&quot; alt=&quot;p1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The Labour Party gets more candidate votes than party votes; whereas the Green Party, New Zealand First Party and Conservatives receive more party votes than their individual candidates receive.  This is an expected feature resulting from how voters and parties treat the MMP system.  Voters who want to support a minority party’s presence in the overall makeup of Parliament cast their crucial party vote for that party; but in the absence of preferential voting for the candidate vote it often makes sense to support whichever of the top two parties (Labour and National) most closely matches their actual preference; this makes sense because of the first past the post system for the candidate vote.  The National Party might be expected to similarly lose party votes to minor parties that are in general its supporters - which would mean the Maori Party and ACT New Zealand in recent years - but this hasn’t been the case in the way it has for the Green Party and Labour.&lt;/p&gt;

&lt;p&gt;This feature is nicely shown in a scatterplot matrix of the proportion of Party and Candidate votes given to five parties at the Voting Place level.  In the graphic below, each point is an individual Voting Place.  We see the proportion voting Labour and that voting National is strongly negatively correlated as might be expected, reflecting this as the primary competition in the New Zealand electoral system at the moment.  The proportion voting Green in any voting place has a more complex relationship with that voting Labour.  The blue points, representing the party vote, show if anything a slightly positive relationship, until a bunch of blue dots in the bottom right corner indicate locations that vote strongly for Labour with low support for the Greens.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0035-pairs.svg&quot; alt=&quot;pairs&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The orange bulge in the density plot of voting places proportion for Labour indicates the on average stronger candidate vote, with the blue party vote more bunched up to the left.  This contrasts with the Nationals, who receive roughly similar densities of candidate and party votes.&lt;/p&gt;

&lt;p&gt;In this light, it’s useful to look one party at a time at the relationship between candidate and party vote (apologies for those with small screens):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0035-cand-v-party.svg&quot; alt=&quot;parties&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Interestingly, the National Party have a cluster of voting locations (shown with the red ellipse in the bottom left graphic) where the candidate seems relatively unpopular (or their rival is popular) compared to the party vote that determines the overall composition of Parliament.  Obviously these would be locations for strategists (ie not me) to identify and plan for.&lt;/p&gt;

&lt;p&gt;New Zealand First generally do much better on the party vote than the candidate vote, like the Green Party; but they also have a noticeable bunch of locations that do much better for individual candidates than on the party vote (also indicated by a red ellipse in the graphic above).  Again, one for the strategists identifying the success or popularity of individual candidates.&lt;/p&gt;

&lt;p&gt;Here’s the code that produced the three graphics above:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;br &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Vote&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Party&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Party&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; PartyVote&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; CandidateVote&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PartyVote&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; CandidateVote&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; PartyVote&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rosybrown&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;First past the post vote for candidates&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                 label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; br&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   scale_y_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Proportional representation vote for parties&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;                 label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; br&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#--------------proportions----------&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;proportions &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ProportionLabour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;             ProportionNational &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;             ProportionGreens &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;             ProportionNZF &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;             ProportionMaori &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;ggpairs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;proportions&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; columns &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------------------candidate v party vote for Labour and Greens---------------&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; proportions &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionLabour&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionLabour&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;In the 2014 General Election by voting location,\nLabour candidate vote usually exceeded the party vote&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Candidate Vote for Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Party Vote for Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; proportions &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionGreens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionGreens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;\nThe situation is reversed for Greens party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Candidate Vote for Greens&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Party Vote for Greens&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Blue line shows\nequality of the two\nvoting types&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; proportions &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionNational&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionNational&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;p3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;For the National Party, candidate and\nparty vote are more closely aligned, but not always&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Party Vote for National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Candidate Vote for National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;   stat_ellipse&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Candidate &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; proportions &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionNZF&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;   spread&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ProportionNZF&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;p4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First generally does better\nfor the party than candidates, but not always&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Candidate Vote for New Zealand First Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of Party Vote for New Zealand First Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;   stat_ellipse&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Candidate &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.6&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Candidate &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p4&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;voting-locations&quot;&gt;Voting Locations&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;nzelect&lt;/code&gt; does the work of matching voting results to the point locations where the votes were made, when available (noting that nearly a million votes this information is not available).  This lets us do more fine grained geographic analysis than is possible by focusing just on electorates.&lt;/p&gt;

&lt;p&gt;The dominant party in the 2014 election was the National Party so if we need to consider a single variable of interest without any particular research question in mind it would be the proportion of voters in any location that voted National.  The map below is a starting point for this sort of analysis.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0035-map.png&quot; alt=&quot;map&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Splitting the map into two facets as is done above, we can visually identify some areas that tended to support the National Party less than elsewhere: Northland (top left of north island), Bay of Plenty and Gisborne (top right), Tasman (top left of south island), and Dunedin.  This is unlikely to surprise anyone with an interest in New Zealand politics; the same conclusions could be reached from electorate-level analysis.  For now we’ll park that and perhaps come back to it in a later post.&lt;/p&gt;

&lt;p&gt;Code that produced the map:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# theme_map proviaged by briatte@GitHub&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;https://gist.githubusercontent.com/briatte/4718656/raw/2c4e71efe6d46f37e7ea264f5c9e1610511bcb09/ggplot2-map-theme.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ProportionNational &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Locations2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlaceSuburb &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Chatham Islands&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MostlyNational &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ProportionNational &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;s&quot;&gt;&amp;quot;Mostly voted National&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Mostly didn&amp;#39;t vote National&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; WGS84Longitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; WGS84Latitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ProportionNational&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;MostlyNational&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   coord_map&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   borders&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;nz&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   scale_colour_gradient2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Voted\nNational&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey80&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; midpoint &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   theme_map&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.55&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Voting patterns in the 2014 General Election\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;rolling-up-to-meshblock-area-unit-territorial-authority-and-regional-council&quot;&gt;Rolling up to meshblock, area unit, Territorial Authority and Regional Council&lt;/h2&gt;
&lt;p&gt;One of the purposes of the &lt;code&gt;nzelect&lt;/code&gt; package is to match voting point locations to the geographical category they are part of, facilitating analysis with socio-economic variables.  This was done by overlaying the points with polygons of the area boundaries, to be discussed more in the next post.  For now, here’s how to use this feature to roll up to Regional Council, showing the proportion of party vote that went to the National Party from lowest to highest.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Locations2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;REGC2014_N&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;      TotalVotes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;      ProportionNational &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; TotalVotes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ProportionNational&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;Source&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; local &lt;span class=&quot;kt&quot;&gt;data frame&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;17&lt;/span&gt; x &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                 REGC2014_N TotalVotes ProportionNational
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fctr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;              &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dbl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;           Gisborne Region      &lt;span class=&quot;m&quot;&gt;14342&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.351&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;             Nelson Region      &lt;span class=&quot;m&quot;&gt;18754&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.398&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;          Northland Region      &lt;span class=&quot;m&quot;&gt;53688&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.427&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;         Wellington Region     &lt;span class=&quot;m&quot;&gt;165207&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.430&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;  Manawatu&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Wanganui Region      &lt;span class=&quot;m&quot;&gt;78841&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.447&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;              Otago Region      &lt;span class=&quot;m&quot;&gt;75933&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.447&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;                        &lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;     &lt;span class=&quot;m&quot;&gt;934589&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.451&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;        Hawke s Bay Region      &lt;span class=&quot;m&quot;&gt;53833&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.460&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;             Tasman Region      &lt;span class=&quot;m&quot;&gt;17935&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.465&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;        West Coast Region      &lt;span class=&quot;m&quot;&gt;12226&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.465&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;     Bay of Plenty Region      &lt;span class=&quot;m&quot;&gt;89065&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.473&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;          Auckland Region     &lt;span class=&quot;m&quot;&gt;478760&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.486&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;13&lt;/span&gt;           Waikato Region     &lt;span class=&quot;m&quot;&gt;134511&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.512&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;14&lt;/span&gt;        Canterbury Region     &lt;span class=&quot;m&quot;&gt;192577&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.520&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;15&lt;/span&gt;       Marlborough Region      &lt;span class=&quot;m&quot;&gt;17474&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.520&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;16&lt;/span&gt;         Southland Region      &lt;span class=&quot;m&quot;&gt;36158&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.528&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;17&lt;/span&gt;          Taranaki Region      &lt;span class=&quot;m&quot;&gt;42586&lt;/span&gt;              &lt;span class=&quot;m&quot;&gt;0.552&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note the 934,589 votes that can’t be allocated to a Regional Council.  These are mostly (630,000) ordinary votes cast before polling day and (150,000) special votes cast on polling day.  In New Zealand the election is on a Saturday but voters are encouraged to cast their vote beforehand.  Because it seems that location isn’t captured and reported on in this instance, as this behaviour becomes more prevalent analysis by voting place will become less meaningful.&lt;/p&gt;

&lt;p&gt;Another note - for all the above I’ve left “informal party votes” in the denominator when calculating percentages.  This gives slightly deflated figures compared to those reported by the Electoral Commission but saves a few lines of code.  The &lt;a href=&quot;https://github.com/ellisp/nzelect/tree/master/pkg/tests/testthat&quot;&gt;package’s unit tests&lt;/a&gt; take care to use the correct method to exactly match the Electoral Commission results.  Of course, the Electoral Commission don’t report results by Regional Council, only by Electorate.&lt;/p&gt;

&lt;p&gt;Finally, here’s the voting results rolled up to Territorial Authority (a local government classification below that of Regional Council - but not neatly hierarchically classified, much to the annoyance of statisticians).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0035-ta.svg&quot; alt=&quot;ta&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Locations2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA2014_NAM&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;      TotalVotes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;      ProportionNational &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; TotalVotes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ProportionNational&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA2014_NAM&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Special or other&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA2014_NAM&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;          TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; District&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;          TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; City&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;          TA &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;TA&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ProportionNational&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TotalVotes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion voting National Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   scale_size&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Number of\nvotes cast&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Voting in the New Zealand 2014 General Election by Territorial Authority&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Hopefully I’ve created an asset that will be used by a few people; and we can extend it to further (past and future) election results.  In this post I’ve:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;demonstrated some basic analysis that’s made relatively easy with this package;&lt;/li&gt;
  &lt;li&gt;made observations about the relationship of candidate and party vote; and&lt;/li&gt;
  &lt;li&gt;touched on some the regional patterns in voting behaviour.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Issues and enhancement requests can be &lt;a href=&quot;https://github.com/ellisp/nzelect/issues&quot;&gt;filed on GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;extra-disclaimer&quot;&gt;Extra disclaimer&lt;/h3&gt;
&lt;p&gt;As always, this post is very much written in my personal capacity and should not be associated in any way with my day job.  To be absolutely explicit, I’m operating in accordance with this part of the &lt;a href=&quot;http://www.cabinetmanual.cabinetoffice.govt.nz/3.50&quot;&gt;Cabinet manual&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Generally, public servants acting in a private capacity have the same rights of free speech and conduct of their private affairs as other members of the public. They should, however, ensure that their personal contribution to public discussion maintains a level of discretion appropriate to the position they hold. Senior public servants, or those working closely with Ministers, need to exercise particular care.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;For me ‘discretion’ means I’ll be very careful in drawing conclusions, and won’t be making judgements on parties’ strategies or tactics.  Any conclusions will be aiming to inform public debate and understanding of voting patterns, rather than being aimed at influencing the political process itself.  In fact, public servants have rights as political citizens and it might be acceptable to go considerably further than I am; but I’m just being clear that I’m not seeking to go into that space in these posts.&lt;/p&gt;

</description>
				<pubDate>Sun, 03 Apr 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/03/nzelect1</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/03/nzelect1</guid>
			</item>
		
			<item>
				<title>Seasonal decomposition in the ggplot2 universe with ggseas</title>
					<description>&lt;p&gt;The &lt;code&gt;ggseas&lt;/code&gt; package for R, which provides convenient treatment of seasonal time series in the &lt;code&gt;ggplot2&lt;/code&gt; universe, was first released by me in February 2016 and since then has been enhanced several ways.  The latest version, 0.4.0, is now on CRAN.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0034-ggsdc.svg&quot; alt=&quot;ggsdc&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The improvements since I last blogged about &lt;code&gt;ggseas&lt;/code&gt; include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;added the convenience function &lt;code&gt;tsdf()&lt;/code&gt; to convert a time series or multiple time series object easily into a data frame&lt;/li&gt;
  &lt;li&gt;added stats for rolling functions (most likely to be rolling sums or averages of some sort)&lt;/li&gt;
  &lt;li&gt;stats no longer need to be told the &lt;code&gt;frequency&lt;/code&gt; and &lt;code&gt;start&lt;/code&gt; date if the variable mapped to the x axis is numeric, but can deduce it from the data (thanks Christophe Sax for the idea and starting the code)&lt;/li&gt;
  &lt;li&gt;series can be converted to an index (eg starting point = 100)&lt;/li&gt;
  &lt;li&gt;added &lt;code&gt;ggplot&lt;/code&gt; seasonal decomposition into trend, seasonal and irregular components, including for multiple series at once (thanks Paul Hendricks for the enhancement request)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I think it’s pretty stable now unless anyone identifies some bugs - I don’t have any planned work on this for the immediate future.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/ellisp/ggseas&quot;&gt;&lt;img src=&quot;https://travis-ci.org/ellisp/ggseas.svg?branch=master&quot; alt=&quot;Travis-CI Build Status&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;http://www.r-pkg.org/pkg/ggseas&quot;&gt;&lt;img src=&quot;http://www.r-pkg.org/badges/version/ggseas&quot; alt=&quot;CRAN version&quot; /&gt;&lt;/a&gt;
&lt;a href=&quot;http://www.r-pkg.org/pkg/ggseas&quot;&gt;&lt;img src=&quot;http://cranlogs.r-pkg.org/badges/ggseas&quot; alt=&quot;CRAN RStudio mirror downloads&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Installation can be done from CRAN:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;install.packages&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ggseas&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let’s go through the changes one at a time.&lt;/p&gt;

&lt;h2 id=&quot;convert-time-series-to-data-frame&quot;&gt;Convert time series to data frame&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;tsdf()&lt;/code&gt; is a new, very simple function that takes a &lt;code&gt;ts&lt;/code&gt; or &lt;code&gt;mts&lt;/code&gt; (univariate or multiple time series) object and converts it to a data frame that is then convenient for use with packages built around data frames, such as &lt;code&gt;ggplot2&lt;/code&gt; and &lt;code&gt;dplyr&lt;/code&gt;.  It’s super simple to use:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ap_df &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tsdf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AirPassengers&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;rolling-averages-and-sums&quot;&gt;Rolling averages and sums&lt;/h2&gt;
&lt;p&gt;Rolling averages (usually rolling mean) and sums are commonly used, particularly for audiences that aren’t used to the greater sophistication of seasonal adjustment.  It’s an inferior form of smoothing and comes from the days when seasonal adjustment and scatter plot smoothers weren’t readily available, but it’s still sometimes useful to be able to do this easily in a &lt;code&gt;ggplot&lt;/code&gt; graphic.  The &lt;code&gt;stat_rollapplyr&lt;/code&gt; function does this, using the rollapplyr function from the &lt;code&gt;zoo&lt;/code&gt; package under the hood.  A &lt;code&gt;width&lt;/code&gt; argument is mandatory, and &lt;code&gt;FUN&lt;/code&gt; specifying which function to apply is optional (defaults to &lt;code&gt;mean&lt;/code&gt;).  There’s also an optional &lt;code&gt;align&lt;/code&gt; function which defaults to the &lt;code&gt;right&lt;/code&gt;; this means that the graphic shows the rolling average (or whatever other function) for the width number of observations up to the latest observation (alternatives are &lt;code&gt;center&lt;/code&gt; or &lt;code&gt;left&lt;/code&gt;).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ldeaths_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; YearMon&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; deaths&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;sex&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   stat_rollapplyr&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;width &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; FUN &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; median&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Lung deaths in the UK\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths (including moving median&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0034-rolling.svg&quot; alt=&quot;rolling&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;deduce-frequency-from-data&quot;&gt;Deduce frequency from data&lt;/h2&gt;
&lt;p&gt;If the variable that is mapped to the x axis is numeric (as will be the case if it was created with &lt;code&gt;tsdf()&lt;/code&gt;, but not if it is of class &lt;code&gt;Date&lt;/code&gt;) the functions in &lt;code&gt;ggseas&lt;/code&gt; can now deduce the starting point of the time period and its frequency from the data.  This makes it easier to just chuck in &lt;code&gt;stat_seas()&lt;/code&gt; into your &lt;code&gt;ggplot&lt;/code&gt; pipeline:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ldeaths_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; YearMon&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; deaths&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sex&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;sex&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Number of deaths&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Seasonally adjusted lung deaths in the UK\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0034-deduce-frequency.svg&quot; alt=&quot;simple-seas&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;series-can-be-converted-to-an-index&quot;&gt;Series can be converted to an index&lt;/h2&gt;
&lt;p&gt;If you’re interested in trends including growth and other patterns over time rather than absolute levels, it can be useful to convert time series to an index.  All the &lt;code&gt;ggplot2&lt;/code&gt;-related functions in ggseas now offer arguments &lt;code&gt;index.ref&lt;/code&gt; (to set the reference period - commonly but not always the first point, or an average of the first w points) and &lt;code&gt;index.basis&lt;/code&gt; (what value to give the index in the reference period, usually 100, 1 or 1000).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ldeaths_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; YearMon&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; deaths&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sex&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;index.ref &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Indexed lung deaths in the UK\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Seasonally adjusted deaths\n(first 12 months average = 100\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0034-index.svg&quot; alt=&quot;index&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;seasonal-decomposition&quot;&gt;Seasonal decomposition&lt;/h2&gt;
&lt;p&gt;The biggest addition is the ability to easily do graphical decomposition of an original time series into trend, seasonal and irregular components, comparable to &lt;code&gt;plot(stl())&lt;/code&gt; or &lt;code&gt;plot(decompose())&lt;/code&gt; in base graphics but with the added access to X13-SEATS-ARIMA, and the ability to use the &lt;code&gt;ggplot&lt;/code&gt; ethos to map a variable to colour and hence decompose several variables at once.&lt;/p&gt;

&lt;p&gt;This is done with the &lt;code&gt;ggsdc()&lt;/code&gt; function, which produces an object of class &lt;code&gt;ggplot&lt;/code&gt; with four facets.  The user needs to specify the geom (normally &lt;code&gt;geom_line&lt;/code&gt;).  The image at the top of this post was produced with the code below.  It expands on an example in the helpfile and uses Balance of Payments data from Statistics New Zealand, which has been included in the &lt;code&gt;ggseas&lt;/code&gt; package for illustrative purposes.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;serv &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;subset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzbop&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Account &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Current account&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;                  Category &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Services; Exports total&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Services; Imports total&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                  
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;ggsdc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;serv&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TimePeriod&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Category&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;      method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;seas&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1971&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;   \n  &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Value in millions of New Zealand dollars\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand service exports and imports&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.17&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.92&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Source: Statistics New Zealand, Balance of Payments&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.03&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;          gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;italic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;ggseas&lt;/code&gt; aims to make it easier and quicker to incorporate seasonal adjustment, including with the professional standard X13-SEATS-ARIMA algorithms, into exploratory work flows.  It does this by letting you incorporate seasonally adjusted variables into graphics with multiple series (dimensions mapped to facets or to colour), and by letting you simultaneously decompose and plot on the same graphic at once several related series.  Adding indexing, rolling averages or sums, and quick conversion from &lt;code&gt;ts&lt;/code&gt; to &lt;code&gt;data.frame&lt;/code&gt; to the toolbox is part of the same idea, making it easier to do exploratory data analysis with many time series at once.&lt;/p&gt;

&lt;p&gt;All the functions mentioned above have helpfiles that are more comprehensive than the examples can show.&lt;/p&gt;

&lt;p&gt;Please log any issues - enhancement and bug requests - at &lt;a href=&quot;https://github.com/ellisp/ggseas/issues&quot;&gt;https://github.com/ellisp/ggseas/issues&lt;/a&gt;.&lt;/p&gt;
</description>
				<pubDate>Mon, 28 Mar 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/03/28/ggseas-update</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/03/28/ggseas-update</guid>
			</item>
		
			<item>
				<title>Skill v luck in determining backgammon winners</title>
					<description>&lt;h2 id=&quot;getting-backgammon-data-out-of-xg-gammon&quot;&gt;Getting backgammon data out of XG-Gammon&lt;/h2&gt;
&lt;p&gt;Backgammon is a game that combines chance and skill, and everyone who comes across it asks “how much is luck, and how much skill?”.  The answer of course is “it depends”.  Consider that for two exactly equally skilled players, the result appears to be 100% luck and the best forecast for a result is a coin flip.  For a complete mismatch - a master playing a beginner - the master will win about 75% of one point matches, and nearly 100% of matches to 11 or more (the longer the match, the more chance for skill to emerge as dominant) - see my &lt;a href=&quot;/blog/2015/08/07/fibs-elo-ratings-basics/&quot;&gt;earlier post on those odds&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Since the rise of robot players that used machine learning neural networks to identify winning strategies, we’ve had a new way to quantify exactly how much skill and how much chance.  Each decision by a player can be compared with an optimal play that the computer would have made, and the computer can estimate exactly how much equity in the final result you just gave up by playing differently to how it would have done.  If you give up 1, you just moved from being certain to win to certain to lose; in practice losing 0.080 of your equity in one turn is usually defined as a “blunder”, and 0.020 as an “error”.  Whereas gaining 0.300 of equity by a luck dice roll is a common threshold for a “joker”.  Here’s a &lt;a href=&quot;http://www.bkgm.com/rgb/rgb.cgi?view+1273&quot;&gt;post from ancient history (ie 2005) on the origin of the term “blunder” in backgammon&lt;/a&gt; - apparently it only goes back to 1998, who knew?&lt;/p&gt;

&lt;p&gt;Of course, while you’re playing a human under match conditions, you don’t know that you just gave up (for example) 0.096 of your equity, although sometimes you have a pretty good idea from a nagging feeling of “I really shouldn’t have done that…”.  We quantify our errors in post-match analysis (you can play a computer in tutor mode too, and that’s the best way to train, but not the subject of today’s post).&lt;/p&gt;

&lt;p&gt;As well as being the best backgammon players on the planet, XG-Gammon and other software such as GNU Backgammon and Snowie are used by many backgammon players to analyse their own matches, to identify areas for improvement and (let’s face it) to find out if the opponent really was as lucky as we thought they were.  Online sites like &lt;a href=&quot;http://www.fibs.com/&quot;&gt;FIBS&lt;/a&gt; (the First Internet Backgammon Server - open, free for all, lots of swearing, a bit clunky but a a great environment) and &lt;a href=&quot;http://usbgf.org/support/faqs/#GridGammon&quot;&gt;grid.gammon&lt;/a&gt; (invitation only, more players and more of them are very serious and skilled) let you save games you’ve just played in formats that can be opened and analysed for luck and mistakes by the various backgammon-playing software.  If the user saves the analytical results to player profiles, you build up a database of games and matches.  Against humans, I play mostly matches (eg first to X points, where common values of X are 3, 5, 7 and 11) and in this post I’m analysing match-level data; that is, ultimately I am using a spreadsheet generated by XG-Gammon where there is one row for each match I’ve played, with 54 columns of interesting data about that match.&lt;/p&gt;

&lt;p&gt;To get this data out of XG-Gammon:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;choose “players”&lt;/li&gt;
  &lt;li&gt;“see profile results”&lt;/li&gt;
  &lt;li&gt;From the “Results” menu, choose “Copy to clipboard”&lt;/li&gt;
  &lt;li&gt;“sessions list” (not sessions list (Match Play) - for me, this just freezes my system)&lt;/li&gt;
  &lt;li&gt;open Excel or equivalent and paste it in.&lt;/li&gt;
  &lt;li&gt;save it as a CSV, close Excel and load the data into a real analytical environment like R.  Actually, this is me being snobbish - any backgammon players reading this who don’t want to use specialist analytical software like R, you can do a lot with Excel and I encourage you to have a go.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I keep my on-line profile, where I play matches against real opponents, separate from any practice I do against XG-Gammon in tutor mode, so when I do the above steps I get the genuine record of how well I’ve played.  For this post, I’m analysing approximately 650 matches, which is the number I’ve played and recorded since I started using XG-Gammon as my main backgammon analytical tool (I try to record all, and probably do 99%, of matches I play on FIBS and grid.gammon).&lt;/p&gt;

&lt;h2 id=&quot;blunders-and-jokers&quot;&gt;Blunders and jokers&lt;/h2&gt;
&lt;p&gt;OK, let’s have a first look at some data.  One of those columns is the number of blunders I made in each match and here’s a histogram showing the count of matches for which I made different numbers of blunders:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-blunders.svg&quot; alt=&quot;blunders&quot; /&gt;&lt;/p&gt;

&lt;p&gt;All the code that created graphics is at the bottom of the post.&lt;/p&gt;

&lt;p&gt;My most common number of blunders in a single match is 4, followed by 2 and 5.  In one nightmare I committed more than 40 blunders - quite an achievement!&lt;/p&gt;

&lt;p&gt;Another item of interest is the number of jokers - dice rolls that materially changed the odds of success.  Think of the double six you roll when it was your only chance:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-jokers.svg&quot; alt=&quot;jokers&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It seems I most frequently get 4 or 5 really lucky rolls per match.&lt;/p&gt;

&lt;p&gt;Backgammon matches are of different numbers of moves, of course, and the longer they are the more opportunities for both blunders and jokers.  Apart from the fact that this dataset includes matches for first-to-11 down to first-to-1, sometimes things just whizz by, and sometimes the to-and-fro can go on forever.  Better than the total number of blunders and jokers is the number of such events per move.  Looking at the density of blunders and jokers per move, I’m pleased to see that on average my lucky jokers are more frequent than my blunders:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-jokers-blunders.svg&quot; alt=&quot;jokers-blunders&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;elo-rating&quot;&gt;Elo rating&lt;/h2&gt;
&lt;p&gt;One thing people sometimes wonder about is the relationship between equity loss per decision and &lt;a href=&quot;http://www.bkgm.com/faq/Ratings.html&quot;&gt;Elo rating&lt;/a&gt;.  There can be no fundamental permanent relationship.  Elo rating is basically a relativistic statement of how good you are (or rather, how well you’ve gone) &lt;em&gt;compared to the people you play against&lt;/em&gt;; equity loss per decision is an absolute comparison of your decision making to a robot powered by a neural network.&lt;/p&gt;

&lt;p&gt;Imagine a backgammon competition, with the same rules as FIBS, populated only by bots.  In FIBS current conditions, these bots have ratings around 2100 compared to the starting point that all new players get of 1500 (chess players may think 2100 is surprisingly low - that’s because the element of chance in backgammon means that the worst player in the world still has a chance against the best, which puts a virtual ceiling on how high the Elo ratings can get).  But in our new world after we reboot FIBS only for expert bot players, the bots will only be able to play eachother, and their Elo ratings will all hover around their starting point of 1500.  Not exactly 1500, there will be a range, but it will be an illusion created by random chance.  See &lt;a href=&quot;http://ellisp.github.io/blog/2015/08/07/fibs-elo-ratings-basics/&quot;&gt;my earlier post on Elo ratings for more discussion of how actual Elo ratings are volatile around their ‘true’ value&lt;/a&gt;.  So the 2100 ratings the bots have in our current world are arbitrarily linked to the errors of the people they happen to be playing.&lt;/p&gt;

&lt;p&gt;There’s enough stability in player standards that we know roughly how good a player with a FIBS rating of 1800 is, and XG-Gammon at some point in its life worked out a rule of thumb (ie statistical model) that mapped from the equity given up per decision to the Elo rating you’d expect an online player who consistently played at that level to end up with.  From the data we’ve just extracted from XG-Gammon, it’s possible to reverse engineer that relationship.  The data we got from our player profile included a column for “Eq per decision” and one for “Elo Level”.  The first of these is it’s estimate of how much equity on average I gave up when I had a choice to make (ie excluding times I had only one or no legal moves); the second is the estimate of what my Elo level should be given my decision-making in an individual match.  Here’s the relationship:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-Elo.svg&quot; alt=&quot;elo-ratings&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As well as showing the equity given up per decision, I’ve annnotated it with XG “Player Rating” (PR), which is the most commonly recognisable assessment of the actual quality of a player’s decisions (as opposed to their Elo rating, which depends on luck and the competition).  The lower a PR the better; world class players have PRs consistently below 5.&lt;/p&gt;

&lt;p&gt;So we can see that if you consistently play with a PR of 10 - which qualifies you to be ‘advanced’ in most people’s books -  you should expect eventually an Elo rating of a bit over 1700.  This seems a lowish Elo rating to me compared to what I intuit are standards on FIBS (my average PR hovers around 11 and Elo rating on FIBS currently at 1800 whereas XG thinks I should be only 1663), but it will be different in any different pool of players and without more data there’s no point in arguing.  Probably XG’s idea of Elo rating is relative to the pool on grid.gammon, which I think has a higher standard of play than FIBS.&lt;/p&gt;

&lt;p&gt;Note - I couldn’t find PR defined in the XG manual (I imagine it’s there but I didn’t spend long looking), but according to this &lt;a href=&quot;http://www.bgonline.org/forums/webbbs_config.pl?noframes;read=53424&quot;&gt;authoritative sounding forum post&lt;/a&gt; the XG Player Rating is just the equity error per decision multiplied by 500.  So if you give up 0.01 (or 1%) of your equity each decision on average, you come up with a PR rating of 5, which is excellent &lt;a href=&quot;http://bgmastersab.com/&quot;&gt;and qualifies you as a ‘Master’&lt;/a&gt;.  By definition (at least when it is XG that does the rating), XG’s PR is 0.&lt;/p&gt;

&lt;h2 id=&quot;skill-versus-luck&quot;&gt;Skill versus luck&lt;/h2&gt;
&lt;p&gt;Another column of interest in the data obtained from XG is the “Cost luck” column.  This contains XG’s estimate of how much the rolls of the dice cost you in total.  It’s all very well if you’re a ‘Master’ to keep your error rate down to only give up 0.01 of your equity each turn, but what about those jokers and anti-jokers that push it 0.3 or more in either direction at a single roll of the dice?  An obvious thing to do is to compare the “Cost luck” column with the equity per turn / PR data, and colour code each point on the resulting scatter plot by whether it was a win or a loss.  The result is illuminating:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-luck-v-skill.svg&quot; alt=&quot;skill-v-luck&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Very few of the red triangles denoting my wins happened when the dice were against me (ie luck &amp;lt; 0), no matter how well I played.  And only one blue triangle (denoting a match loss) happened when I had good luck (luck &amp;gt; 0).  Yup, the luck alone is all you need to divide matches into two very obvious clusters - those where you were lucky, and those where you weren’t.  It’s a cruel game, and a fascinating one - this luck means that you have to play a lot of games before your skill level starts determining your average success rate, and at the end of the game you don’t know (without a bot to help you) whether it was your fault or not…&lt;/p&gt;

&lt;p&gt;There’s two players in backgammon so better than looking at just my own skill rating is to examine the difference between my error rate and my opponents.  Here’s the image of that:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0032-luck-v-net-skill.svg&quot; alt=&quot;skill-v-luck2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In fact, doing some statistical modelling we find some results that confirm the visuals:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;predicting the result of a match with just luck as an explanatory variable gets it right 97.9% of the time&lt;/li&gt;
  &lt;li&gt;predicting the result with just net error rate as an explanatory variable gets it right only 65.0% of the time (remember, guessing at random would give you 50%)&lt;/li&gt;
  &lt;li&gt;predicting the result using both luck and error rate as explanatory variables gets it right 99.7% of the time.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;Skill matters in backgammon, but when you play people at similar skill levels the games become more and more like a coin flip.  Good playing can overcome moderately bad luck in an individual match, but mostly it doesn’t.  You have to play a lot of matches for the skill to become important.&lt;/p&gt;

&lt;h2 id=&quot;code&quot;&gt;Code&lt;/h2&gt;
&lt;p&gt;All the data management and analysis was done in R.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------load up functionality and fonts------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;readr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# see http://stackoverflow.com/questions/13627735/stat-contour-with-data-labels-on-lines&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;caret&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;# for cross-validation&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RColorBrewer&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;pal &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; brewer.pal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------import data----------------&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Open XG-Gammon, choose &amp;quot;players&amp;quot;, &amp;quot;see profile results&amp;quot;, &amp;quot;Results&amp;quot;,&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# &amp;quot;Copy to clipboard&amp;quot;, &amp;quot;sessions list&amp;quot;.  Paste result into Excel and save as a csv.&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# xg_orig &amp;lt;- read_csv(&amp;quot;../data/xg-export.csv&amp;quot;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# or you can use one I&amp;#39;ve prepared earlier, just with the column of opponent names deleted:&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;xg_orig &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read_csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;https://raw.githubusercontent.com/ellisp/ellisp.github.io/source/data/xg-export.csv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xg_orig&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xg_orig&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;xg &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; xg_orig &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Match_Length &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# knock out a 99999 outlier&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xg&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Blunders&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   geom_histogram&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;binwidth &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Blunders per match&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;           y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Number of matches&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xg&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Jokers&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;      geom_histogram&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;binwidth &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Jokers per match&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;           y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Number of matches&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; xg &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bm &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Blunders &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; Moves&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;          jm &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Jokers &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; Moves&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bm&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; jm&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;        Blunders per move&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;  Jokers per move&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Events per move&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   direct.label&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#--------equity v Elo-----------&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# PR = -(equity error per decision) * 500&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://www.bgonline.org/forums/webbbs_config.pl?noframes;read=53424&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# therefore e =  -PR / 500&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make a data frame I&amp;#39;ll use for convertin equity per decision to Player Rating&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# (PR) on various plots&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;pr_steps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PR &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Eq_per_Decision &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; PR &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;          PR &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PR &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;PR:&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PR&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# this plot shows that the &amp;quot;Elo_Level&amp;quot; is estimated by XG-Gammon based on error rate&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xg&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Eq_per_Decision&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Elo_Level&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;limits&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;670&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;                      breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pr_steps&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;700&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; PR&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;             colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Equity change per decision (negative means lost equity)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Equivalent Elo level estimated by XG-Gammon&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;XG-Gammon estimate of how equity per decision\nshould be related to Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------------skill v luck v winning------------------------&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;xg &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; xg &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Cost_luck_per_move &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Cost_luck &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; Moves&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;xg &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Loss&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Win&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;                          levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Win&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Loss&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Eq_per_Decision&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Cost_luck_per_move&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Result&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Match_Length&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; shape &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pr_steps&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-1.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; PR&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;             colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;   scale_radius&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Match\nlength&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;   scale_colour_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Match equity gained through luck, per move\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Skill: equity change per decision\nnegative means equity lost through poor choices&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Luck is more important than skill\nin any single backgammon match&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;xg_with_skill &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; xg &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Loss&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Win&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;                          levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Win&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Loss&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;          Opp_Eq_per_Decision &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Opp_Eq_per_move &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Opp_Roll &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; Opp_Decisions&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;          net_skill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Eq_per_Decision &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; Opp_Eq_per_Decision &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;xg_with_skill &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; net_skill&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Cost_luck_per_move&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Result&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-101&quot;&gt;&lt;/a&gt;   geom_vline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey45&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-102&quot;&gt;&lt;/a&gt;   geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey45&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-103&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Match_Length&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; shape &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-104&quot;&gt;&lt;/a&gt;   scale_radius&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Match\nlength&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-105&quot;&gt;&lt;/a&gt;   scale_colour_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-106&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Match equity gained through luck, per move\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-107&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Skill: net equity change per decision from both players&amp;#39; decisions\nnegative means net equity loss through poor choices&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-108&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Luck is more important than skill\nin any single backgammon match&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-109&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More skilled\nand luckier&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-110&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey40&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-111&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.085&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Less skilled\nand unluckier&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-112&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey40&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-113&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-114&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More skilled and\novercame bad luck&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-115&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-116&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;segment&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.09&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; yend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-117&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; arrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; arrow&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-118&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-119&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.17&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.085&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More skilled\nbut luck won out&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-120&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-121&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;segment&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.085&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; yend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.085&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-122&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; pal&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; arrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; arrow&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-123&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-124&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------------------luck v skill in modelling----------&lt;/span&gt;
&lt;a name=&quot;True-125&quot;&gt;&lt;/a&gt;ctrl &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; trainControl&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;repeatedcv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; number &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; savePredictions &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-126&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-127&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; train&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; Cost_luck_per_move&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;glm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;binomial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-128&quot;&gt;&lt;/a&gt;              data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; xg_with_skill&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trControl &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ctrl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-129&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;c1&quot;&gt;# 98.0% accuracy&lt;/span&gt;
&lt;a name=&quot;True-130&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-131&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; train&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; net_skill&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;glm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;binomial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-132&quot;&gt;&lt;/a&gt;              data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; xg_with_skill&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trControl &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ctrl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-133&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;c1&quot;&gt;# 65.0%&lt;/span&gt;
&lt;a name=&quot;True-134&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-135&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-136&quot;&gt;&lt;/a&gt;mod3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; train&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Result &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; net_skill &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; Cost_luck_per_move&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;glm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;binomial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-137&quot;&gt;&lt;/a&gt;              data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; xg_with_skill&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trControl &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ctrl&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-138&quot;&gt;&lt;/a&gt;mod3 &lt;span class=&quot;c1&quot;&gt;# 99.7%&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sat, 19 Mar 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/03/19/elo-pr-luck</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/03/19/elo-pr-luck</guid>
			</item>
		
			<item>
				<title>Explore  with Shiny the impact of sample size on &quot;p-charts&quot;</title>
					<description>&lt;h2 id=&quot;control-charts&quot;&gt;Control charts&lt;/h2&gt;
&lt;p&gt;I wanted to help explore the implications of changing sample size for a quality control process aimed at determining the defect rate in multiple sites.  Defect in this particular case is binary ie the products are either good or not.  &lt;a href=&quot;http://www.isixsigma.com/tools-templates/sampling-data/how-determine-sample-size-determining-sample-size/&quot;&gt;Much of the advice on this&lt;/a&gt; in the quality control literature strikes me as rather abstract and technical, while still not sufficiently detailed on what really needs to be done for power calculations.  My idea was to instead let an end user see in advance what &lt;em&gt;sort&lt;/em&gt; of thing they would see if they went into the exercise with different sample sizes.&lt;/p&gt;

&lt;p&gt;The result was this interactive R/Shiny/ggvis web app:
&lt;a href=&quot;https://ellisp.shinyapps.io/control-charts/&quot;&gt;
   &lt;img src=&quot;http://ellisp.github.io/img/0033_control_charts.png&quot; alt=&quot;screenshot&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I’m not an expert in statistical quality control by any means, but the statistics are straightforward.  The &lt;a href=&quot;https://en.wikipedia.org/wiki/p-chart&quot;&gt;“p-chart”&lt;/a&gt; is simply a time series of the proportion of recorded defects in samples taken over time, compared to horizontal lines for the central tendency of the process “under control” and upper and lower limits of acceptability before being seen as “our of control”.  When they exceed some margin - typically three standard deviations, but see below -  beyond some central acceptable target you conclude there’s strong evidence of something going wrong in that particular process at that particular point of time.  Of course, about 3 times in 1,000 if the true defect rate is bang on the target you’ll still get that “three standard deviations too big” threshold, but that’s deemed an acceptable false positive rate.&lt;/p&gt;

&lt;h3 id=&quot;x-sigma-versus-exact-binomial&quot;&gt;3 x sigma versus exact binomial&lt;/h3&gt;
&lt;p&gt;Coming to this for the first time from a more general statistics backgroun, I raised an eyebrow at the “Six Sigma” approach of just making an Upper Control Limit (UCL) of 3 standard deviations away from the general population.  This rule of thumb comes from a judgement of what an acceptable false positive / false negative rate is when the observations have a Gaussian (‘Normal’) distribution.  It turns out that in &lt;a href=&quot;http://www.stat.unipg.it/luca/Rnews_2004-1-pag11-17.pdf&quot;&gt;some quarters&lt;/a&gt; this is known as “American practice”; and the “British practice”, in contrast, is to specify  a given confidence level calculated on the basis of the actual distribution of the observed variable (in this case, binomial) and set the UCL on that basis.  The results are pretty much equivalent so long as you choose the correct confidence level if using the ‘British’ approach; in my Shiny app I’ve given the option to use either.  I think the Six Sigma simplification is fully justified if it gets the core concepts out to a wider audience than mathematical statisticians.&lt;/p&gt;

&lt;h3 id=&quot;a-stable-upper-control-limit&quot;&gt;A stable Upper Control Limit&lt;/h3&gt;
&lt;p&gt;The example p control charts I found (eg Figure 12 on &lt;a href=&quot;http://www.isixsigma.com/tools-templates/control-charts/a-guide-to-control-charts/&quot;&gt;this iSixSigma site&lt;/a&gt;) look to calculate the standard deviation independently at each time point.  Instead, I’ve taken the approach of treating the idea “the true rate is at the target rate” as my null hypothesis, and calculating the standard deviation on the assumption that the null hypothesis is true.  This is consistent with a big stream of statistical practice and has the advantage of making a neater graph (a horizontal line for the upper control limit rather than a wobbly one - my approach only introduces wobbles when the sample size changes, not the observed rate at a particular point in time).  The standard p-chart practice, from what I can tell, calculates the standard deviation for each time period based on the observed defect rate and has the counter-intuitive result that the higher the observed defect rate in any particular sample, the higher the Upper Control Limit and hence it becomes easier to be officially noted as officially “in control”.  In practice, this doesn’t matter much.&lt;/p&gt;

&lt;h3 id=&quot;an-alternative-to-the-p-chart-for-a-slightly-different-purpose&quot;&gt;An alternative to the P chart for a slightly different purpose&lt;/h3&gt;
&lt;p&gt;For some purposes, I’m not happy with the approach the P chart takes of treating each sample in each time period as independent.  This makes sense in a context where you’ve got a process you’re happy with, and you just want to get warning when it starts going out of control - in fact, the classic stable QC process question such as “are 99.99% of memory chips we product going to work, as they have over the past two years of production?”.  But in many real world situations, one isn’t yet “happy” with the process and just watching for change over time - we might instead want to find out if the overall process is good or bad, from a position of basic ignorance.  For this purpose it makes sense to cumulatively pool the data as it comes in and create an estimate of the overall defect rate, over the full time period, for a particular site or process.  Hence the second graphic in the Shiny app, at bottom right of the screen, lets a user see how the confidence interval for the defect rate narrows over time.&lt;/p&gt;

&lt;p&gt;Check it out:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The &lt;a href=&quot;https://ellisp.shinyapps.io/control-charts/&quot;&gt;Shiny app&lt;/a&gt; itself&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://github.com/ellisp/control-charts&quot;&gt;source code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Suggestions welcomed.  This was done in a bit of a rush and I may well have gotten something muddled up.&lt;/p&gt;
</description>
				<pubDate>Sun, 06 Mar 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/03/06/control-charts</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/03/06/control-charts</guid>
			</item>
		
			<item>
				<title>New Zealand Tourism Dashboard pushes Shiny to the max</title>
					<description>&lt;p&gt;Just a short note that in my day job we’ve released the &lt;a href=&quot;https://mbienz.shinyapps.io/tourism_dashboard_prod/&quot;&gt;New Zealand Tourism Dashboard&lt;/a&gt;, launched by the &lt;a href=&quot;http://www.scoop.co.nz/stories/PA1602/S00350/new-tool-to-improve-tourism-data-use.htm&quot;&gt;Associate Minister for Tourism earlier today&lt;/a&gt;.  It’s built with R and Shiny and I won’t say more about it than that to avoid mixing up my work and outside-work hats.  Except that it’s really really awesome, and there’s an enormous amount of data in there to explore.  Great work by the team.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://mbienz.shinyapps.io/tourism_dashboard_prod/&quot;&gt;&lt;img src=&quot;http://ellisp.github.io/img/0033-tourism-dashboard.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
</description>
				<pubDate>Wed, 24 Feb 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/02/24/tourism-dashboard</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/02/24/tourism-dashboard</guid>
			</item>
		
			<item>
				<title>Dynamic Stochastic General Equilibrium models made (relatively) easy with R</title>
					<description>&lt;h2 id=&quot;general-equilibrium-economic-models&quot;&gt;General Equilibrium economic models&lt;/h2&gt;
&lt;p&gt;To expand my economics toolkit I’ve been trying to get my head around &lt;a href=&quot;https://en.wikipedia.org/wiki/Computable_general_equilibrium&quot;&gt;Computable General Equilibrium (CGE)&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/Dynamic_stochastic_general_equilibrium&quot;&gt;Dynamic Stochastic General Equilibrium (DSGE)&lt;/a&gt; models.  Both classes of model are used in theoretical and policy settings to understand the impact of changes to an economic system on its equilibrium state.&lt;/p&gt;

&lt;p&gt;I’m not a specialist in this area so the below should be taken as the best effort by a keen amateur.  Corrections or suggestions welcomed!&lt;/p&gt;

&lt;p&gt;CGE models have the simpler approach of the two and a longer history and have been very widely applied to practical policy questions such as the impact of trade deals.  Many economic consultancies have their own in-house CGE model/s which they wheel out and aadapt to a range of their clients’ questions.  They work by comparing static equilibrium states, assumed to meet requirements (such as markets clearing effectively instantly) needed to be in equilibrium, “calibrated” to the real economy by choosing a set of numbers for the various parameters that match the state of the economy at a particular point in time.  The model is then adjusted - for example, to allow for changes in prices from a free trade agreement - and the new equilibrium compared to the old.&lt;/p&gt;

&lt;p&gt;DSGE models are also based on an assumption of a steady state equilibrium of the economy, but they allow for real amounts of time being taken to move towards that steady state, and for a random (ie stochastic) element in the path taken towards that steady state.  This greatly improves their coherence in terms of philosophy of science - compared to a CGE which simply calibrates to a single point of time and doesn’t have any degrees of freedom to quantify uncertainty or the fit of the model to reality, the parameters in DSGEs can be estimated based on a history of observations, and parameters can have probability distributions not just points.  Parameters are typically estimated with Bayesian methods.&lt;/p&gt;

&lt;p&gt;Over the past 15 years or so as the maths and computing has gotten better, the DSGE approach has become dominant in macroeconomic modelling, although not yet (to my observation) in everyday applied economics of the sort done by consultants for government agencies contemplating policy choices.  DSGE models perform ok (to the degree that anything does) at economic forecasting, and give a nice coherent framework for considering policy options.  For example, the Reserve Bank of New Zealand (like many if not all monetary authorities around the world - I haven’t counted) developed the cutely-named &lt;a href=&quot;http://www.rbnz.govt.nz/research-and-publications/research-programme/additional-research/kitt---a-dsge-model-for-forecasting-and-policy-analysis&quot;&gt;KITT (Kiwi Inflation Targeting Technology)&lt;/a&gt; DSGE model and adopted it in 2009 as the main forecasting and scenario tool; and apparently replaced this with &lt;a href=&quot;http://www.nzae.org.nz/wp-content/uploads/2015/01/Sander.pdf&quot;&gt;NZSIM, a more parsimonious model in 2014&lt;/a&gt; - slightly condescendingly described as “deliberately kept small so is easily understood and applied by a range of users.”&lt;/p&gt;

&lt;h2 id=&quot;critiques&quot;&gt;Critiques&lt;/h2&gt;
&lt;p&gt;General Equilibrium approach has been roundly criticised from the margins of the economics field (pun) ever since it leapt to dominance in the second half of the twentieth century, from a philosophy of science perspective (doesn’t really make Popperian falsifiable predictions) and from the obvious and acknowledged absurdity/simplification of the assumptions needed to make the system tractable.&lt;/p&gt;

&lt;p&gt;Noah Smith provides a &lt;a href=&quot;http://noahpinionblog.blogspot.co.nz/2013/05/what-can-you-do-with-dsge-model.html&quot;&gt;good sceptical discussion of the worth of DSGE in this post&lt;/a&gt; and elsewhere.&lt;/p&gt;

&lt;p&gt;I find the arguments for a &lt;a href=&quot;http://www.amazon.com/Post-Walrasian-Macroeconomics-Stochastic-Equilibrium/dp/052168420X&quot;&gt;post-Walrasian economics - beyond the DSGE&lt;/a&gt; fairly compelling.  My key takeout from that book (not necessarily it’s main intent) is that new computing power means that we are increasingly in a position where we no longer have to just accept the simplifying assumptions needed for General Equilibrium approach to be tractable.  &lt;a href=&quot;https://en.wikipedia.org/wiki/Agent-based_computational_economics&quot;&gt;Agent-based models&lt;/a&gt; are now possible that allow simulation of much more complex interactions between agents who lack the perfect knowledge required in the GE approach and behave realistically in terms of interactions and other ways.  Such models lack analytical solutions (ie ones that could in principle be worked out with pen and paper) but Monte Carlo methods can lead to insight as to how the real economy behaves.&lt;/p&gt;

&lt;h2 id=&quot;defining-a-ge-model-with-gecon&quot;&gt;Defining a GE model with gEcon&lt;/h2&gt;
&lt;p&gt;While I do think that these general equilibrium approaches will be superseded in the next 20 years (bit of a call I know), the alternatives are currently immature.  I still need to get my head around GE approaches.  Luckily I came across the &lt;a href=&quot;http://gecon.r-forge.r-project.org/&quot;&gt;&lt;code&gt;gEcon&lt;/code&gt; project&lt;/a&gt; - an exciting off-shoot of work done for the Polish government, now open-sourced and maintained by the original authors.  &lt;code&gt;gEcon&lt;/code&gt; provides an easy language for defining a CGE or DSGE model, taking much of the hand-done mathematics pain out of the whole thing:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“Owing to the development of an algorithm for automatic derivation of first order conditions and implementation of a comprehensive symbolic library, gEcon allows users to describe their models in terms of optimisation problems of agents. To authors’ best knowledge there is no other publicly available framework for writing and solving DSGE &amp;amp; CGE models in this natural way. Writing models in terms of optimisation problems instead of the FOCs is far more natural to an economist, takes off the burden of tedious differentiation, and reduces the risk of making a mistake.”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The definition of agents’ optimisation problems in a sophisticated DGSE in the gEcon environment looks like this example extract from &lt;a href=&quot;https://ideas.repec.org/p/pra/mprapa/64440.html&quot;&gt;an implementation of the classic Smets-Wouters 2003 DSGE for the Euro area&lt;/a&gt;.  The total model description is around 500 lines of code.  This particular block  is describing aspects of the price setting mechanism.  It’s not easy, but it is a lot easier than solving first order conditions by hand:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;block PRICE_SETTING_PROBLEM &lt;span class=&quot;c1&quot;&gt;# example gEcon language extract&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;    identities
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;        g_1&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; lambda_p&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; g_2&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; eta_p&lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;        g_1&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; pi_star&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Y&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; beta &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; xi_p &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                E&lt;span class=&quot;p&quot;&gt;[][(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; gamma_p &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda_p&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;pi_star&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; pi_star&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; g_1&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]];&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;        g_2&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; mc&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; Y&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; beta &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; xi_p &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;                E&lt;span class=&quot;p&quot;&gt;[][(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; gamma_p &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;pi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; lambda_p&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda_p&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; g_2&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]];&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;    shocks
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;        eta_p&lt;span class=&quot;p&quot;&gt;[];&lt;/span&gt;                &lt;span class=&quot;c1&quot;&gt;# Price mark-up shock&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;    calibration
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;        xi_p &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.908&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;           &lt;span class=&quot;c1&quot;&gt;# Probability of not receiving the ``price-change signal&amp;#39;&amp;#39;&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;        gamma_p &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.469&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;# Indexation parameter for non-optimising firms&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Similar code controls parts of the system such as the approach taken by the monetary authority (how much weight do they give to controlling inflation?), government expenditure, friction in the labour market, etc.&lt;/p&gt;

&lt;p&gt;Incidentally, when the gEcon authors implemented the Smets-Wouters ‘03 model they identified a few small mistakes in the original implementation, which for me adds to the credibility of their argument that their (relatively) natural agent-based optimisation language is less prone to human error.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;gEcon&lt;/code&gt; is implemented in R; the authors give the reason for this (as opposed to more traditional Matlab / Octave / GAMS solution) being the greater flexibility (“not everything needs to be a matrix”) and easy connections to full range of other econometric and data management methods.&lt;/p&gt;

&lt;h2 id=&quot;solving-a-gecon-dsge-model-from-r&quot;&gt;Solving a gEcon DSGE model from R&lt;/h2&gt;
&lt;p&gt;Once the model has been defined, R functions can perform tasks such as :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;calculate its steady state&lt;/li&gt;
  &lt;li&gt;estimate the impact of randomness&lt;/li&gt;
  &lt;li&gt;simulate paths through time (the “dynamic stochastic” bit)&lt;/li&gt;
  &lt;li&gt;estimate the impact of changes over time through impulse-response functions&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For example, here is a simulation of one path through time for the deviation from the steady state of consumption, investment, capital, wages and income just from randomness in the Smets-Wouters ‘03 model:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0031-onepath.svg&quot; alt=&quot;onepath&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Getting to this point used this R code.  Note that I’m not reproducing below the full definition of the model, though I am including code that downloads it for you&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ###################################################################&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# (c) Chancellery of the Prime Minister 2012-2015                   #&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Licence terms for gEcon can be found in the file:                 #&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://gecon.r-forge.r-project.org/files/gEcon_licence.txt        #&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#                                                                   #&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# gEcon authors: Grzegorz Klima, Karol Podemski,                    #&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#          Kaja Retkiewicz-Wijtiwiak, Anna Sowińska                 #&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ###################################################################&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gEcon&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download model definition and import into R:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;download.file&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://gecon.r-forge.r-project.org/models/SW_03/SW_03.gcn&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;              destfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SW_03.gcn&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;sw_gecon1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; make_model&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;SW_03.gcn&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set some initial variable values:&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;initv &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;z &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; z_f &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Q &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Q_f &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;pi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; pi_obj &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;              epsilon_b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; epsilon_L &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; epsilon_I &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; epsilon_a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; epsilon_G &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;              r_k &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; r_k_f &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.01&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;sw_gecon1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; initval_var&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; init_var &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; initv&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set some initial parameter values:&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;initf &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   beta &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.99&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;# Discount factor&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   tau &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.025&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;# Capital depreciation rate&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   varphi &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6.771&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;# Parameter of investment adjustment cost function&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   psi &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.169&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;# Capacity utilisation cost parameter&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   sigma_c &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.353&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;# Coefficient of relative risk aversion&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   h &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.573&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;              &lt;span class=&quot;c1&quot;&gt;# Habit formation intensity&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   sigma_l &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;          &lt;span class=&quot;c1&quot;&gt;# Reciprocal of labour elasticity w.r.t. wage&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   omega &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;               &lt;span class=&quot;c1&quot;&gt;# Labour disutility parameter&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;sw_gecon1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; set_free_par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; initf&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt; 
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# find the steady state for that set of starting values:&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;sw_gecon2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; steady_state&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;get_ss_values&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# solve the model in linearised form for 1st order perturbations/randomness:&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;sw_gecon2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; solve_pert&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; loglin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# simulate one path:&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;one_path &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; random_path&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; var_list &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;K&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;I&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;W&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;plot_simulation&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;one_path&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# shows deviation from the steady_state&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;impulse-response-functions&quot;&gt;Impulse response functions&lt;/h2&gt;
&lt;p&gt;In a method familiar to users of other economic modelling methods like Vector Autoregressions (VARs), it’s possible to “shock” the DSGE system and see the impact play out over time as the complex inter-relationships of agents within the system move from the shock towards a new equilibrium.  Here’s an example of the expected impact of a shock to the inflation objective applied to the Smets-Wouters ‘03 model:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0031-irf.svg&quot; alt=&quot;irf&quot; /&gt;&lt;/p&gt;

&lt;p&gt;One of the characteristics of the DSGE models is the importance they give to agents’ expectations.  As their philosophy has increasingly dominated in recent decades, discussion of monetary policy has become less focused on individual actions of the monetary authority than on the overal regime and set of targets.  Any more-than-casual observer of public economic debate will have noticed the importance given to discussion of the overall inflation-targetting regime.  Hence the plot above shows the modelled impact of a change in the inflation objective - with no other direct exogenous shock in the model at all.&lt;/p&gt;

&lt;p&gt;Here’s the R code that produced that plot:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# set covariance matrix of the parameters to be used in shock simulation:&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;eta_b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.336&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_L &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3.52&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_I &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.085&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.598&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;       eta_w &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.6853261&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_p &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.7896512&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;       eta_G &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.325&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.081&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; eta_pi &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.017&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;sw_gecon3  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; set_shock_cov_mat&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; shock_matrix &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;diag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; shock_order &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# compute the moments with that covariance matrix:&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;sw_gecon3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; compute_moments&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;sw_gecon_irf &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; compute_irf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; var_list &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;C&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;Y&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;K&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;I&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; chol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                            shock_list &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;eta_pi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; path_length &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;plot_simulation&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sw_gecon_irf&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to_tex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;putting-a-dsge-model-into-shiny&quot;&gt;Putting a DSGE model into Shiny&lt;/h2&gt;
&lt;p&gt;With so many complex and mysteriously named parameters - and I’ve shown very few of them - an interactive web application seems an obvious way to explore a model of this sort.  I’ve set up a prototype which explores the impulse response functions of the model, responding to shocks to parameters like labour supply, investment, productivity and government spending:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The &lt;a href=&quot;https://ellisp.shinyapps.io/0031-shiny/&quot;&gt;full screen version&lt;/a&gt;  of the web app.  Once all buttons on the screen appear, give it 90 seconds or so to solve its steady state.  Then try choosing different variables to shock by from the drop down list.&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://github.com/ellisp/ellisp.github.io/tree/source/_working/_output/0031-shiny&quot;&gt;source code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I’m a way off from being able to define my own DSGE for the New Zealand and connecting economies.  In particular the important question of calibration/estimation of parameters based on actual observable data is a a mystery to me at this stage.  But I can see how the basic idea works, and the gEcon package looks very promising for its relatively simple agent-optimisation approach to specifying the model.&lt;/p&gt;

</description>
				<pubDate>Sat, 20 Feb 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/02/20/DSGE</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/02/20/DSGE</guid>
			</item>
		
			<item>
				<title>ggseas package for seasonal adjustment on the fly with ggplot2</title>
					<description>&lt;p&gt;In &lt;a href=&quot;http://ellisp.github.io/blog/2015/10/10/X13ARIMA-SEATS/&quot;&gt;a post a few months ago&lt;/a&gt; I built a new &lt;code&gt;ggplot2&lt;/code&gt; statistical transformation (&lt;code&gt;stat&lt;/code&gt;) to provide X13-SEATS-ARIMA seasonal adjustment on the fly.  With certain exploratory workflows this can be useful, saving on a step of seasonally adjusting many different slices and dices of a multi-dimensional time series during data reshaping, and just drawing it for you as part of the graphics definition process.&lt;/p&gt;

&lt;p&gt;That code no longer works - one of the hazards of the fast changing data science environment - since the release of &lt;code&gt;ggplot2&lt;/code&gt; version 2.0 just before Christmas.  &lt;code&gt;ggplot2&lt;/code&gt; v.2 introduced a whole new system of object oriented programming, &lt;code&gt;ggproto&lt;/code&gt;, replacing the old approach that was based on &lt;code&gt;proto&lt;/code&gt;.  The good news is that the new approach is easy to use and &lt;a href=&quot;http://docs.ggplot2.org/dev/vignettes/extending-ggplot2.html&quot;&gt;well documented&lt;/a&gt;, and it’s been so successful in encouraging development based on &lt;code&gt;ggplot&lt;/code&gt; that there’s now a &lt;a href=&quot;http://ggplot2-exts.github.io/&quot;&gt;whole website just to keep track of packages extending &lt;code&gt;ggplot&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So it seemed time to wrap my little convenience function for seasonal adjustment into an R package which duly has &lt;a href=&quot;https://github.com/ellisp/ggseas&quot;&gt;its home on GitHub&lt;/a&gt;.  Like my similar posts on this, this work depends on Christophe Sax’s &lt;a href=&quot;https://cran.r-project.org/web/packages/seasonal/index.html&quot;&gt;{seasonal} R package&lt;/a&gt;, and of course the &lt;a href=&quot;https://www.census.gov/srd/www/x13as/&quot;&gt;US Census Bureau’s X13-SEATS-ARIMA software&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;x13-seats-arima&quot;&gt;X13-SEATS-ARIMA&lt;/h3&gt;
&lt;p&gt;Here’s how it works, applying SEATS seasonal adjustment with the default outlier etc settings to the classic international Air Passengers example dataset.  The original unadjusted data are in pale grey in the background, and the seasonally adjusted line is the dark one:
&lt;img src=&quot;http://ellisp.github.io/img/0030-p1.svg&quot; alt=&quot;p1&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# installation if not already done&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;install.packages&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ggseas&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# edited 20/2/2016 to use CRAN version&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggseas&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make demo data&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;ap_df &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AirPassengers&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AirPassengers&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;jeky
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ap_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey80&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1949&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SEATS seasonal adjustment - international airline passengers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   ylab&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;International airline passengers per month&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Extra arguments can get passed through to X13 via the &lt;code&gt;x13_params&lt;/code&gt; argument, which takes a list of arguments that are passed through to the “list” argument to &lt;code&gt;seas()&lt;/code&gt;:
&lt;img src=&quot;http://ellisp.github.io/img/0030-p2.svg&quot; alt=&quot;p2&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ap_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey80&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1949&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x13_params &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x11 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; outlier &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;X11 seasonal adjustment - international airline passengers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   ylab&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;International airline passengers per month&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The reason for doing this with &lt;code&gt;ggplot2&lt;/code&gt; of course is that we can have not just univariate series, but data split by dimensions mapped to facets, colour or other aesthetics.  This works very naturally, with &lt;code&gt;stat_seas&lt;/code&gt; working just like other stats and geoms in the &lt;code&gt;ggplot2&lt;/code&gt; universe:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0030-p3.svg&quot; alt=&quot;p3&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;p3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ldeaths_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; YearMon&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; deaths&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sex&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;sex&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   stat_seas&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1974&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Seasonally adjusted lung deaths in the UK 1974 - 1979&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   ylab&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Deaths&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   xlab&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;(light grey shows original data;\ncoloured line is seasonally adjusted)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt; &lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p3&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# note - the call to seas() isn&amp;#39;t run until each and every time you *print* the plot&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;more-basic-seasonal-decomposition&quot;&gt;More basic seasonal decomposition&lt;/h2&gt;
&lt;p&gt;I included two alternative ways of doing seasonal adjustment, more for completion than anything else.  Here’s one demo with Loess-based seasonal decomposition, using the &lt;code&gt;stl()&lt;/code&gt; function from the &lt;code&gt;stats&lt;/code&gt; package:
&lt;img src=&quot;http://ellisp.github.io/img/0030-p4.svg&quot; alt=&quot;p4&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ap_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   stat_stl&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; s.window &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This sort of seasonal decomposition is quicker to fit than X13-SEATS-ARIMA but not good enough for (for example) publishing official statistics.  However, it might be useful in an exploratory workflow when you don’t want the computation overhead of fitting ARIMA models.  This package is aiming to help is that sort of quick analysis.&lt;/p&gt;
</description>
				<pubDate>Mon, 08 Feb 2016 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2016/02/08/ggseas</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/02/08/ggseas</guid>
			</item>
		
	</channel>
</rss>