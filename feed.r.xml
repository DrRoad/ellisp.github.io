<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Peter&#39;s stats stuff - R</title>
		<description>Posts categorised as 'R'</description>
		<link>http://ellisp.github.io</link>
		<atom:link href="http://ellisp.github.io/feed.R.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Monthly Regional Tourism Estimates</title>
					<description>&lt;p&gt;A big 18 month project at work culminated today in the release of new &lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/tourism/tourism-research-data/monthly-regional-tourism-estimates&quot;&gt;Monthly Regional Tourism Estimates&lt;/a&gt; for New Zealand.  Great work by the team in an area where we’ve pioneered the way, using administrative data from electronic transactions to supplement traditional sources in producing official statistics.&lt;/p&gt;

&lt;p&gt;Here’s a screen shot from one of the pages letting people play with the data:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/tourism/tourism-research-data/monthly-regional-tourism-estimates/annual-spend-grouped-by-region-country-of-origin-and-product-category&quot;&gt;&lt;img src=&quot;http://ellisp.github.io/img/0045-rtes.png&quot; alt=&quot;MRTES&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The source data include electronic card spend, survey data, and the National Accounts.  All the data production is done in R, with iterative proportional fitting, smoothing, time series forecasts, and yet more iterative proportional fitting before we come up with the best available estimates of how much is spent by tourists by product by origin by time period.  This project builds on a range of developments we’ve made since 2012 with previous Regional Tourism Indicators and annual Regional Tourism Estimates.  The data will be updated every month from now on.&lt;/p&gt;

&lt;p&gt;A collection of web pages with interactive graphics help users explore the data, all of which can also be &lt;a href=&quot;http://www.mbie.govt.nz/info-services/sectors-industries/tourism/tourism-research-data/monthly-regional-tourism-estimates/data-download&quot;&gt;downloaded for re-use&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The interactive graphics are hand coded in JavaScript, with R used for all the pre-processing (eg reshaping, tidying, calculating moving averages, etc).&lt;/p&gt;

&lt;p&gt;Great work, team at work!&lt;/p&gt;
</description>
				<pubDate>Thu, 16 Jun 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/06/16/mrtes</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/06/16/mrtes</guid>
			</item>
		
			<item>
				<title>Presentation slides on using graphics</title>
					<description>&lt;p&gt;Last week I gave a seminar for around 40 analysts from another government agency on using graphics to represent data.  In doing such presentations, I usually focus on different purposes of graphics:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;exploratory&lt;/li&gt;
  &lt;li&gt;as part of the analysis workflow (eg as diagnosis for statistical models)&lt;/li&gt;
  &lt;li&gt;for presenting results&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Exactly what the purpose is makes quite a difference to how you go about developing the graphic - and how long you spend polishing of course.&lt;/p&gt;

&lt;p&gt;I’m heavily influenced by Tufte’s idea of “Graphical Excellence”.  Here’s a Tufte-inspired taster of an alternative to a side-by-side barchart:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0044-control-trial.png&quot; alt=&quot;tufte-eg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;OK, it’s not perfect, and it doesn’t mean much without its context, but it gives an idea…&lt;/p&gt;

&lt;p&gt;This particular presentation was a cut-down version of a seminar session I give at the beginning of a five week (5 x 90 minutes) internal training course on Graphics Fundamentals, with the next four sessions all hands-on implementing the principles with R, layered grammar of graphics and &lt;code&gt;ggplot2&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Making slides available without the context of the talk is always dangerous.  If the slides are self-sufficient, you’re not doing it right.  They should be props, not scripts.  Nonetheless, they might be of some interest even for those who weren’t there (a bit like Jeopardy - try to imagine what points the speaker is trying to make at different points).&lt;/p&gt;

&lt;p&gt;This particular set of slides makes use of the &lt;a href=&quot;https://github.com/hakimel/reveal.js/&quot;&gt;&lt;code&gt;reveal.js&lt;/code&gt; HTML presentation framework&lt;/a&gt; and in particular RStudio’s easy-to-use &lt;a href=&quot;https://github.com/rstudio/revealjs&quot;&gt;R Markdown plugin &lt;code&gt;revealjs&lt;/code&gt;&lt;/a&gt; which makes it super easy to integrate R code and graphics into a nice-looking presentation.  I don’t have any R code in this presentation - it was deliberately software-neutral - but I use &lt;code&gt;revealjs&lt;/code&gt; all the time for training material and it’s fantastic to have a snippet of code so easily integrated.  And the general look and feel of &lt;code&gt;reveal.js&lt;/code&gt; is extremely pleasant.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;reveal.js&lt;/code&gt; supports two-dimensional presentations, which means you can navigate through the slides in a slightly more sophisticated way than PowerPoint.  Tip for navigating - just keep using &lt;code&gt;PgDn&lt;/code&gt; if the arrows are confusing you!&lt;/p&gt;

&lt;p&gt;Browse:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;the &lt;a href=&quot;/presentations/graphics-intro.html&quot;&gt;presentation slides on using graphics to represent data&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;the &lt;a href=&quot;https://github.com/ellisp/graphics-taster/blob/master/graphics-ird.Rmd&quot;&gt;source code&lt;/a&gt; - which won’t be fully reproducible because of some data availability issues, but will give you a good idea.&lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Tue, 14 Jun 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/06/14/graphics-presentation</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/06/14/graphics-presentation</guid>
			</item>
		
			<item>
				<title>Bootstrap and cross-validation for evaluating modelling strategies</title>
					<description>&lt;h2 id=&quot;modelling-strategies&quot;&gt;Modelling strategies&lt;/h2&gt;
&lt;p&gt;I’ve been re-reading Frank Harrell’s &lt;a href=&quot;http://www.springer.com/us/book/9781441929181&quot;&gt;Regression Modelling Strategies&lt;/a&gt;, a must read for anyone who ever fits a regression model, although be prepared - depending on your background, you might get 30 pages in and suddenly become convinced you’ve been doing nearly everything wrong before, which can be disturbing.&lt;/p&gt;

&lt;p&gt;I wanted to evaluate three simple modelling strategies in dealing with data with many variables.  Using data with 54 variables on 1,785 area units from New Zealand’s 2013 census, I’m looking to predict median income on the basis of the other 53 variables.  The features are all continuous and are variables like “mean number of bedrooms”, “proportion of individuals with no religion” and “proportion of individuals who are smokers”.   Restricting myself to traditional linear regression with a normally distributed response, my three alternative strategies were:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;use all 53 variables;&lt;/li&gt;
  &lt;li&gt;eliminate the variables that can be predicted easily from the other variables (defined by having a &lt;a href=&quot;https://en.wikipedia.org/wiki/Variance_inflation_factor&quot;&gt;variance inflation factor&lt;/a&gt; greater than ten), one by one until the main collinearity problems are gone; or&lt;/li&gt;
  &lt;li&gt;eliminate variables one at a time from the full model on the basis of comparing &lt;a href=&quot;https://en.wikipedia.org/wiki/Akaike_information_criterion&quot;&gt;Akaike’s Information Criterion&lt;/a&gt; of models with and without each variable.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;None of these is exactly what I would use for real, but they serve the purpose of setting up a competition of strategies that I can test with a variety of model validation techniques.&lt;/p&gt;

&lt;h2 id=&quot;validating-models&quot;&gt;Validating models&lt;/h2&gt;
&lt;p&gt;The main purpose of the exercise was actually to ensure I had my head around different ways of estimating the validity of a model, loosely definable as how well it would perform at predicting new data.  As there is no possibility of new areas in New Zealand from 2013 that need to have their income predicted, the “prediction” is a thought-exercise which we need to find a plausible way of simulating.  Confidence in hypothetical predictions gives us confidence in the insights the model gives into relationships between variables.&lt;/p&gt;

&lt;p&gt;There are many methods of validating models, although I think k-fold cross-validation has market dominance (not with Harrell though, who prefers varieties of the bootstrap).  The three validation methods I’ve used for this post are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;‘simple’ bootstrap.  This involves creating resamples with replacement from the original data, of the same size; applying the modelling strategy to the resample; using the model to predict the values of the full set of original data and calculating a goodness of fit statistic (eg either R-squared or root mean squared error) comparing the predicted value to the actual value.  &lt;em&gt;Note - Following Efron, Harrell calls this the “simple bootstrap”, but other authors and the useful &lt;code&gt;caret&lt;/code&gt; package use “simple bootstrap” to mean the resample model is used to predict the out-of-bag values at each resample point, rather than the full original sample.&lt;/em&gt;&lt;/li&gt;
  &lt;li&gt;‘enhanced’ bootstrap.  This is a little more involved and is basically a method of estimating the ‘optimism’ of the goodness of fit statistic.  There’s a nice step by step explanation by &lt;a href=&quot;http://thestatsgeek.com/2014/10/04/adjusting-for-optimismoverfitting-in-measures-of-predictive-ability-using-bootstrapping/&quot;&gt;thestatsgeek&lt;/a&gt; which I won’t try to improve on.&lt;/li&gt;
  &lt;li&gt;repeated 10-fold cross-validation.  10-fold cross-validation involves dividing your data into ten parts, then taking turns to fit the model on 90% of the data and using that model to predict the remaining 10%.  The average of the 10 goodness of fit statistics becomes your estimate of the actual goodness of fit.  One of the problems with k-fold cross-validation is that it has a high variance ie doing it different times you get different results based on the luck of you k-way split; so repeated k-fold cross-validation addresses this by performing the whole process a number of times and taking the average.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;As the sample sizes get bigger relative to the number of variables in the model the methods should converge.  The bootstrap methods can give over-optimistic estimates of model validity compared to cross-validation; there are various other methods available to address this issue although none seem to me to provide all-purpose solution.&lt;/p&gt;

&lt;p&gt;It’s critical that the re-sampling in the process envelopes the entire model-building strategy, not just the final fit.  In particular, if the strategy involves variable selection (as two of my candidate strategies do), you have to automate that selection process and run it on each different resample.  That’s because one of the highest risk parts of the modelling process is that variable selection.  Running cross-validation or the bootstrap on a final model after you’ve eliminated a bunch of variables is missing the point, and will give materially misleading statistics (biased towards things being more “significant” than there really is evidence for).  Of course, that doesn’t stop this being common misguided practice.&lt;/p&gt;

&lt;h2 id=&quot;results&quot;&gt;Results&lt;/h2&gt;

&lt;p&gt;One nice feature of statistics since the revolution of the 1980s is that the bootstrap helps you conceptualise what might have happened but didn’t.  Here’s the root mean squared error from the 100 different bootstrap resamples when the three different modelling strategies (including variable selection) were applied:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0043-boot-results.svg&quot; alt=&quot;boot-results&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Notice anything?  Not only does it seem to be generally a bad idea to drop variables just because they are collinear with others, but occasionally it turns out to be a &lt;em&gt;really&lt;/em&gt; bad idea - like in resamples #4, #6  and around thirty others.  Those thirty or so spikes are in resamples where random chance led to one of the more important variables being dumped before it had a chance to contribute to the model.&lt;/p&gt;

&lt;p&gt;The thing that surprised me here was that the generally maligned step-wise selection strategy performed nearly as well as the full model, judged by the simple bootstrap.  That result comes through for the other two validation methods as well:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0043-boot-v-cv.svg&quot; alt=&quot;boot-v-cv&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In all three validation methods there’s really nothing substantive to choose between the “full model” and “stepwise” strategies, based purely on results.&lt;/p&gt;

&lt;h2 id=&quot;reflections&quot;&gt;Reflections&lt;/h2&gt;
&lt;p&gt;The full model is much easier to fit, interpret, estimate confidence intervals and perform tests on than stepwise.  All the standard statistics for a final model chosen by stepwise methods are misleading and careful recalculations are needed based on elaborate bootstrapping.  So the full model wins hands-down as a general strategy in this case.&lt;/p&gt;

&lt;p&gt;With this data, we have a bit of freedom from the generous sample size.  If approaching this for real I wouldn’t eliminate any variables unless there were theoretical / subject matter reasons to do so.  I have made the mistake of eliminating the co-linear variables before from this dataset but will try not to do it again.  The rule of thumb is to have 20 observations for each parameter (this is one of the most asked and most dodged questions in statistics education; see Table 4.1 of &lt;em&gt;Regression Modelling Strategies&lt;/em&gt; for this particular answer), which suggests we can have up to 80 parameters with a bit to spare.  This gives us 30 parameters to use for non-linear relationships and/or interactions, which is the direction I might go in a subsequent post.  Bearing that in mind, I’m not bothering to report here the actual substantive results (eg which factors are related to income and how); that can wait for a better model down the track.&lt;/p&gt;

&lt;h2 id=&quot;data-and-computing&quot;&gt;Data and computing&lt;/h2&gt;

&lt;p&gt;The census data are ultimately from Statistics New Zealand of course, but are tidied up and available in my &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt;&lt;/a&gt; R package, which is still very much under development and may change without notice.  It’s only available from GitHub at the moment (installation code below).&lt;/p&gt;

&lt;p&gt;I do the bootstrapping with the aid of the &lt;code&gt;boot&lt;/code&gt; package, which is generally the recommended approach in R.  For repeated cross-validation of the two straightforward strategies (full model and stepwise variable selection) I use the &lt;code&gt;caret&lt;/code&gt; package, in combination with &lt;code&gt;stepAIC&lt;/code&gt; which is in the Venables and Ripley &lt;code&gt;MASS&lt;/code&gt; package.  For the more complex strategy that involved dropping variables with high variance inflation factors I found it easiest to do the repeated cross-validation old-school with my own &lt;code&gt;for&lt;/code&gt; loops.&lt;/p&gt;

&lt;p&gt;This exercise was a bit complex and I won’t be astonished if someone points out an error.  If you see a problem, or have any suggestions or questions, please leave a comment.&lt;/p&gt;

&lt;p&gt;Here’s the code:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#===================setup=======================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MASS&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;boot&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;caret&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# install nzelect package that has census data&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ellisp/nzelect/pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzelect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# drop the columns with areas&amp;#39; code and name&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;au &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; AreaUnits2013 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;AU2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;Area_Code_and_Description&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# give meaningful rownames, helpful for some diagnostic plots later&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;row.names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; AreaUnits2013&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Area_Code_and_Description
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# remove some repetition from the variable names&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# restrict to areas with no missing data.  If this was any more complicated (eg&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imputation),it would need to be part of the validation resampling too; but&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# just dropping them all at the beginning doesn&amp;#39;t need to be resampled; the only&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# implication would be sample size which would be small impact and complicating.&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;au &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;complete.cases&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================functions for two of the modelling strategies=====================&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# The stepwise variable selection:&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;model_process_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;the_data&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   model_full &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   model_final &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; stepAIC&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; direction &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;both&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_final&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# The dropping of highly collinear variables, based on Variance Inflation Factor:&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;model_process_vif &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;the_data&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# remove the collinear variables based on vif&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;      mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;      x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;car&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; decreasing &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;      the_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;the_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;c1&quot;&gt;# message(paste(&amp;quot;dropping&amp;quot;, names(x)[1]))&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   model_vif &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_vif&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# The third strategy, full model, is only a one-liner with standard functions&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so I don&amp;#39;t need to define a function separately for it.&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================Different validation methods=================&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------------simple bootstrap comparison-------------------------&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a function suitable for boot that will return the goodness of fit&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# statistics testing models against the full original sample.&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;compare &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;orig_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# create the resampled data&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   train_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; orig_data&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   test_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; orig_data &lt;span class=&quot;c1&quot;&gt;# ie the full original sample&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# fit the three modelling processes&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   model_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_step&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   model_vif  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;   model_full &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# predict the values on the original, unresampled data&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;   predict_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; test_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;   predict_vif  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; test_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;   predict_full  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; test_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# return a vector of 6 summary results&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;      step_R2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;      vif_R2  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;      full_R2  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;      step_RMSE &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;      vif_RMSE  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;      full_RMSE  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# perform bootstrap&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;Repeats &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; compare&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Repeats&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# restructure results for a graphic showing root mean square error, and for&lt;/span&gt;
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# later combination with the other results.  I chose just to focus on RMSE;&lt;/span&gt;
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the messages are similar if R squared is used.&lt;/span&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;RMSE_res &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RMSE_res&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;AIC stepwise selection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Remove collinear variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Use all variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-101&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-102&quot;&gt;&lt;/a&gt;RMSE_res &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-103&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trial &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;Repeats&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-104&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; 
&lt;a name=&quot;True-105&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# re-order levels:&lt;/span&gt;
&lt;a name=&quot;True-106&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-107&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;s&quot;&gt;&amp;quot;Remove collinear variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;AIC stepwise selection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Use all variables&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-108&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-109&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; trial&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-110&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-111&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-112&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;#39;Simple&amp;#39; bootstrap of model fit of three different regression strategies&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-113&quot;&gt;&lt;/a&gt;           subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Predicting areas&amp;#39; median income based on census variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-114&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Resample id (there no meaning in the order of resamples)\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-115&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Root Mean Square Error (higher is worse)\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-116&quot;&gt;&lt;/a&gt;        colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Strategy&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-117&quot;&gt;&lt;/a&gt;        caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Data from New Zealand Census 2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-118&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-119&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# store the three &amp;quot;simple bootstrap&amp;quot; RMSE results for later&lt;/span&gt;
&lt;a name=&quot;True-120&quot;&gt;&lt;/a&gt;simple &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RMSE_res&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-121&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-122&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------------enhanced (optimism) bootstrap comparison-------------------&lt;/span&gt;
&lt;a name=&quot;True-123&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# for convenience, estimate the models on the original sample of data&lt;/span&gt;
&lt;a name=&quot;True-124&quot;&gt;&lt;/a&gt;orig_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_step&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-125&quot;&gt;&lt;/a&gt;orig_vif &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-126&quot;&gt;&lt;/a&gt;orig_full &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-127&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-128&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a function suitable for boot that will return the optimism estimates for&lt;/span&gt;
&lt;a name=&quot;True-129&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# statistics testing models against the full original sample.&lt;/span&gt;
&lt;a name=&quot;True-130&quot;&gt;&lt;/a&gt;compare_opt &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;orig_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-131&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# create the resampled data&lt;/span&gt;
&lt;a name=&quot;True-132&quot;&gt;&lt;/a&gt;   train_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; orig_data&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-133&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-134&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# fit the three modelling processes&lt;/span&gt;
&lt;a name=&quot;True-135&quot;&gt;&lt;/a&gt;   model_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_step&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-136&quot;&gt;&lt;/a&gt;   model_vif  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; model_process_vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-137&quot;&gt;&lt;/a&gt;   model_full &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; train_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-138&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-139&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# predict the values on the original, unresampled data&lt;/span&gt;
&lt;a name=&quot;True-140&quot;&gt;&lt;/a&gt;   predict_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; orig_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-141&quot;&gt;&lt;/a&gt;   predict_vif  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; orig_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-142&quot;&gt;&lt;/a&gt;   predict_full  &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; orig_data&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-143&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-144&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# return a vector of 6 summary optimism results&lt;/span&gt;
&lt;a name=&quot;True-145&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-146&quot;&gt;&lt;/a&gt;      step_R2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_step&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-147&quot;&gt;&lt;/a&gt;      vif_R2  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_vif&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-148&quot;&gt;&lt;/a&gt;      full_R2  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_full&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; R2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-149&quot;&gt;&lt;/a&gt;      step_RMSE &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_step&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_step&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-150&quot;&gt;&lt;/a&gt;      vif_RMSE  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_vif&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-151&quot;&gt;&lt;/a&gt;      full_RMSE  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_full&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; train_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;predict_full&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; orig_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-152&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-153&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-154&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-155&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-156&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# perform bootstrap&lt;/span&gt;
&lt;a name=&quot;True-157&quot;&gt;&lt;/a&gt;res_opt &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; compare_opt&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Repeats&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-158&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-159&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# calculate and store the results for later&lt;/span&gt;
&lt;a name=&quot;True-160&quot;&gt;&lt;/a&gt;original &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-161&quot;&gt;&lt;/a&gt;   RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;orig_step&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; au&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-162&quot;&gt;&lt;/a&gt;   RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;orig_vif&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; au&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-163&quot;&gt;&lt;/a&gt;   RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;orig_full&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; au&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-164&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-165&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-166&quot;&gt;&lt;/a&gt;optimism &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res_opt&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-167&quot;&gt;&lt;/a&gt;enhanced &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; original &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; optimism
&lt;a name=&quot;True-168&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-169&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-170&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------------repeated cross-validation------------------&lt;/span&gt;
&lt;a name=&quot;True-171&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# The number of cross validation repeats is the number of bootstrap repeats / 10:&lt;/span&gt;
&lt;a name=&quot;True-172&quot;&gt;&lt;/a&gt;cv_repeat_num &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; Repeats &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;
&lt;a name=&quot;True-173&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-174&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# use caret::train for the two standard models:&lt;/span&gt;
&lt;a name=&quot;True-175&quot;&gt;&lt;/a&gt;the_control &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; trainControl&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;repeatedcv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; number &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; repeats &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; cv_repeat_num&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-176&quot;&gt;&lt;/a&gt;cv_full &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; train&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trControl &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_control&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-177&quot;&gt;&lt;/a&gt;cv_step &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; train&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MedianIncome &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lmStepAIC&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trControl &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_control&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-178&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-179&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# do it by hand for the VIF model:&lt;/span&gt;
&lt;a name=&quot;True-180&quot;&gt;&lt;/a&gt;results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; cv_repeat_num&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-181&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cv_repeat_num &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-182&quot;&gt;&lt;/a&gt;   cv_group &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;au&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; replace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-183&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-184&quot;&gt;&lt;/a&gt;      train_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;cv_group &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-185&quot;&gt;&lt;/a&gt;      test_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; au&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;cv_group &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-186&quot;&gt;&lt;/a&gt;      results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; RMSE&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-187&quot;&gt;&lt;/a&gt;         predict&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model_process_vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;train_data&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; newdata &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; test_data&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-188&quot;&gt;&lt;/a&gt;         test_data&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;MedianIncome&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-189&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-190&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-191&quot;&gt;&lt;/a&gt;cv_vif &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-192&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-193&quot;&gt;&lt;/a&gt;cv_vif_results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-194&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; results&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-195&quot;&gt;&lt;/a&gt;   trial &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cv_repeat_num&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-196&quot;&gt;&lt;/a&gt;   cv_repeat &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;cv_repeat_num&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; each &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-197&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-198&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-199&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-200&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#===============reporting results===============&lt;/span&gt;
&lt;a name=&quot;True-201&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# combine the three cross-validation results together and combined with&lt;/span&gt;
&lt;a name=&quot;True-202&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the bootstrap results from earlier&lt;/span&gt;
&lt;a name=&quot;True-203&quot;&gt;&lt;/a&gt;summary_results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-204&quot;&gt;&lt;/a&gt;   simple&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-205&quot;&gt;&lt;/a&gt;   enhanced&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-206&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cv_step&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;resample&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;RMSE&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-207&quot;&gt;&lt;/a&gt;     cv_vif&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-208&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cv_full&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;resample&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;RMSE&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-209&quot;&gt;&lt;/a&gt;     &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-210&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; check.names &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-211&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Simple bootstrap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Enhanced bootstrap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-212&quot;&gt;&lt;/a&gt;                     &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;cv_repeat_num&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;repeats 10-fold\ncross-validation&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-213&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;method&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-214&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-215&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Draw a plot summarising the results&lt;/span&gt;
&lt;a name=&quot;True-216&quot;&gt;&lt;/a&gt;direct.label&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-217&quot;&gt;&lt;/a&gt;summary_results &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-218&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-219&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;s&quot;&gt;&amp;quot;Use all variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;AIC stepwise selection&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Remove collinear variables&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-220&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-221&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-222&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-223&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimated Root Mean Square Error (higher is worse)\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-224&quot;&gt;&lt;/a&gt;        colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Modelling\nstrategy&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-225&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Method of estimating model fit\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-226&quot;&gt;&lt;/a&gt;        caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Data from New Zealand Census 2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-227&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Three different validation methods of three different regression strategies&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-228&quot;&gt;&lt;/a&gt;           subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Predicting areas&amp;#39; median income based on census variables&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-229&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-230&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sun, 05 Jun 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/06/05/bootstrap-cv-strategies</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/06/05/bootstrap-cv-strategies</guid>
			</item>
		
			<item>
				<title>Actual coverage of confidence intervals for standard deviation</title>
					<description>&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;
&lt;p&gt;How big a sample size would you think you need to get a reliable 95% confidence interval (ie one that really does contain the true value 95% of the time) for a single univariate statistic like standard deviation? 30? 50?  Turns out the answer is more like 20,000 for some not-particularly-extreme real-world data.&lt;/p&gt;

&lt;p&gt;In this post I explore the phenomenon shown in the first chart below; lower than hoped-for coverage of 95% confidence intervals calculated with the bootstrap when estimating a population standard deviation from a modest sample size.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-sd-ci-coverage.svg&quot; alt=&quot;coverage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The test is admittedly a tough one, albeit realistic.  The population data from which my samples are drawn are the &lt;a href=&quot;http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&quot;&gt;simulated unit record file microdata&lt;/a&gt; from Statistics New Zealand’s New Zealand Income Survey 2011, which I’ve written about in &lt;a href=&quot;/blog/index_by_tag.html&quot;&gt;numerous posts&lt;/a&gt;.  The distribution of weekly income in this data set is complex; it could perhaps be described as a mixture of:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;individuals with positive income that is approximately log-normal distributed;&lt;/li&gt;
  &lt;li&gt;individuals with negative income of some difficult-to-describe distribution;&lt;/li&gt;
  &lt;li&gt;a large spike of individuals with zero income; plus a sprinkling of outliers.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In fact, it looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-full-data.svg&quot; alt=&quot;fulldata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The actual standard deviation of all 29,471 observations of income is $806.&lt;/p&gt;

&lt;p&gt;The inference problem is how to estimate that value if you have only a smaller sample, eg 50?  Because if you have only 50 observations, you think the data looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-sample-data.svg&quot; alt=&quot;sampledata&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the case of this particular sample of 50, the standard deviation is $527.&lt;/p&gt;

&lt;h2 id=&quot;unbiased-estimate-of-standard-deviation&quot;&gt;Unbiased estimate of standard deviation&lt;/h2&gt;
&lt;p&gt;The first challenge - although it turns out to be a relatively small detail in terms of the challenge - is to get the best estimator for the situation when you want to estimate a population’s standard deviation from a sample.  While an unbiased estimator of variance is well known, standard deviation (the square root of variance) is complex.  Creating an &lt;a href=&quot;https://en.wikipedia.org/wiki/Unbiased_estimation_of_standard_deviation&quot;&gt;unbiased estimator of standard deviation&lt;/a&gt; turns out to depend on the vagaries of the shape of the original population, with the &lt;em&gt;fourth&lt;/em&gt; moment (expected value of the variable to the power of four) playing a role.&lt;/p&gt;

&lt;p&gt;A reasonably generally well-performing estimator for non-Normal variables is reportedly (image from the Wikipedia article linked to above):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-unbiased-sd.png&quot; alt=&quot;equation&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;method&quot;&gt;Method&lt;/h2&gt;
&lt;p&gt;Using the unbiased estimate of standard deviation above, I set out to test the performance of bootstrap confidence intervals in covering the true value of population standard deviation for sample sizes of 50, 100, 200, 400, …, 12800.  I took 2,500 samples of the data for each of these sample sizes; estimated the standard deviation from each sample; and use the bootstrap to estimate confidence intervals for population standard deviation from each sample, with 499 bootstrap replicates.  I tested both the &lt;a href=&quot;https://en.wikipedia.org/wiki/Bootstrapping_(statistics)#Methods_for_bootstrap_confidence_intervals&quot;&gt;basic and the percentile methods for bootstrap confidence intervals&lt;/a&gt;.  To reduce the complications of my finite population, each of the 2,500 samples is taken with replacement from the original data set.&lt;/p&gt;

&lt;h2 id=&quot;results---income&quot;&gt;Results - income&lt;/h2&gt;
&lt;p&gt;The unbiased estimator works ok, at least in terms of bias.  Here’s the full distribution of the estimated standard deviation from all those different samples:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-sd-bias-full.svg&quot; alt=&quot;sd-bias-full&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For the smaller samples, it’s obvious that most of the estimates are to the left of the blue line ie the estimated standard deviation is less than the true standard deviation from the full 29,471 observations.  However, this frequent underestimation is compensated for by the fact that when the standard deviation is &lt;em&gt;over&lt;/em&gt;-estimated, it tends to be by quite a lot - with a strong rightwards skew in the distribution of this statistic for all the smaller sample sizes.  This all sounds bad of course, but it is the sort of thing that’s needed if a statistic with a skewed sampling distribution is going to be on average unbiased.  We see how this plays out when we look at the actual average error of the estimator:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-sd-bias-summary.svg&quot; alt=&quot;sd-bias-summ&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There’s a slight bias to under-estimation for smaller sample sizes (six percent isn’t that much in the scheme of things), but by the time sample size is 800 or higher the estimator on average gets it pretty much right.&lt;/p&gt;

&lt;p&gt;It’s the coverage of the bootstrapped confidence intervals that is disappointing however.  Here’s a repeat of that graphic I started the post with:
&lt;img src=&quot;http://ellisp.github.io/img/0042-sd-ci-coverage.svg&quot; alt=&quot;coverage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Basically, when you have a really complex mixed and dirty variable like this one (New Zealand weekly income from survey data), not until you have a sample size of 20,000 or so do your bootstrapped confidence intervals start to have the coverage that is planned for them.&lt;/p&gt;

&lt;p&gt;What’s going on here?  Well, the bootstrap depends on you taking many re-samples with replacements from your original sample, in the hope that doing this mimics the behaviour of taking many samples from the whole population which isn’t possible for reasons of expense or logistics.  For this to work, the original sample has to sufficiently resemble the whole population that the resamples from the sample behave similarly to samples from the population.  There’s no straightforward definition of “sufficiently resemble” that I know of, but what we’re seeing here is that until the sample size is really quite moderately large, for a statistic like standard deviation for a moderately complex population distribution, the sample does not “sufficiently resemble” the population for the bootstrap to work as advertised.&lt;/p&gt;

&lt;h2 id=&quot;results---other-variables&quot;&gt;Results - other variables&lt;/h2&gt;

&lt;p&gt;To get more of a feel for what was going on here, I ran the same computer program over more regular, simulated data:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;a standard normal distribution (mean zero, variance one)&lt;/li&gt;
  &lt;li&gt;a standard uniform distribution (bounded by zero and one)&lt;/li&gt;
  &lt;li&gt;a standard log-normal distribution (e to the power of standard normal)&lt;/li&gt;
  &lt;li&gt;a mixture of all three&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The results in terms of confidence interval coverage can be seen in this graphic:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0042-other-dists.svg&quot; alt=&quot;other-dists&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Points to make from this are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;In all cases the “basic” and “percentile” methods perform similarly, with neither of the two consistently outperforming the other for the two symmetrical distributions, but percentile performing slightly better for the two asymmetrical distributions.&lt;/li&gt;
  &lt;li&gt;For the two symmetrical distributions - uniform and normal - the coverage at small sample sizes isn’t bad.  Even with only 50 observations in the sample, more than 90% of the confidence intervals contain the true value, and the sample size doesn’t need to be much larger than that before it gets up to the desired 95%.&lt;/li&gt;
  &lt;li&gt;In contrast, for the non-symmetrical, right-skewed log-normal data and the mixture distribution, the success rate of 95% confidence intervals actually containing the true value is relatively low until the sample size is many thousands, and it never reaches (with the sample sizes tested) the desired 95% rate.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Mixed or “contaminated” distributions are known to cause problems for statistical inference (although I don’t like the word “contaminated” as too value-laden - as though it is the data’s fault it doesn’t live up to twentieth century simplifying assumptions!).  The bootstrap was part of the late twentieth century revolution in applied statistical methods to help address those and other problems, but the observations in this post confirm that it doesn’t magically make them go away.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“Classic, routinely used statistical methods are based on the assumptions that observations follow a normal curve.  It was once thought that violating the normality assumption rarely had a detrimental impact on these methods, but theoretical and empirical advances have made it clear that general types of non-normality cause serious practical problems in a wide range of commonly occurring situations.  Indeed, even very slight departures from normality can be a source of concern.”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Wilcox, &lt;a href=&quot;http://www.amazon.com/Modern-Statistics-Social-Behavioral-Sciences/dp/1439834563&quot;&gt;&lt;em&gt;Modern Statistics for the Social and Behavioral Sciences&lt;/em&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;simpler-statistics&quot;&gt;Simpler statistics&lt;/h2&gt;

&lt;p&gt;Finally, to round out the picture I tried the same approach on statistics that are simpler than standard deviation - mean and trimmed mean - on the same awkward weekly income data.&lt;/p&gt;

&lt;p&gt;The confidence interval coverage is pretty satisfactory even with small sample sizes, hovering close to the desired 95%.
&lt;img src=&quot;http://ellisp.github.io/img/0042-mean-ci-coverage.svg&quot; alt=&quot;ci-means&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And as expected from theoretical results, there’s no discernable bias:
&lt;img src=&quot;http://ellisp.github.io/img/0042-mean-bias.svg&quot; alt=&quot;bias-means&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The overall conclusion: standard deviation of non-normal(skewed, contaminated, or both) distributions is a really tough statistic to get a valid confidence interval for.  But a simple statistic (like mean) for an awkward distribution - or standard deviation of a simple distribution (like Normal or Uniform) - perform fine.&lt;/p&gt;

&lt;h2 id=&quot;code&quot;&gt;Code&lt;/h2&gt;
&lt;p&gt;Here’s the computer programs, all in R.&lt;/p&gt;

&lt;p&gt;First I load up the packages I’m using.  This is fairly straightforward.  The &lt;code&gt;moments&lt;/code&gt; package is needed because I need to estimate excess kurtosis as part of the formula for an unbiased estimate of standard deviation&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#===================setup=======================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# using the dev version from GitHub so can have subtitles and captions&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;boot&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;moments&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for kurtosis()&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;gridExtra&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for grid.arrange()&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# themes for graphics&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;theme_small &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text.x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; hjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next I create two functions.  One is unbiased standard deviation of a vector x, to be scrambled/resampled by means of the index i - the sort of function that is accepted by the &lt;code&gt;boot&lt;/code&gt; function as a statistic:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==========Functions==================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;sampsd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xbar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# function suitable for boot which returns estimated standard deviation&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# from a sample x that has been scrambled by the index i&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   d &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   n &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# this next formula is the best general approximation to a general  &lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# unbiased estimator of standard deviation from a non-normal distribution&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# https://en.wikipedia.org/wiki/Unbiased_estimation_of_standard_deviation&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   unbiased_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;d &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; xbar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;kurtosis&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;d&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unbiased_sd&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Second is the main routine that performs the actual testing of the confidence interval.  This is little involved so I won’t try to explain it line by line.  Hopefully the in-function comments are adequate:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;test_boot_ci &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;                         statistic&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                         truevalue &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; statistic&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                         reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;                         R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;499&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                         title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;match.call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()){&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Function to explore the coverage of basic and percentile bootstrap &lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# 95% confidence intervals.&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @full_data A full population of data from which samples of various sizes&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#           will be drawn without replacement, and each of those samples will&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#           be analysed with the bootstrap as though it were all that is&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#           available.&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @statistic a function suitable for passing to the statistic argument of boot&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#           ie first argument is data, second argument is an index for &lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#           scrambling the data&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @truevalue true value that the statistic is trying to esimate.&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @reps number of repeats of each sample size to analyse&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @R number of bootstrap resamples for each sample&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;#&amp;#39; @title Title for plots&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# create a data frame to hold the results, with &amp;quot;reps&amp;quot; rows for each&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# sample size from 50, 100, 200, ..., 12800&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   ns &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; each &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;      n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ns&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;      point_est &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;      ci_basic_correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;logical&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;      ci_perc_correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;logical&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Create point estimates and two types of bootstrap confidence interval&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# for each repetition at each value of sample size:&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;      this_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; full_data&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; replace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt;   
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;      res &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;this_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; statistic&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;      results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;point_est&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; res&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;t0
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;      ciobj &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot.ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;basic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;      citest &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;truevalue &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ciobj&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;basic&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; truevalue &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; ciobj&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;basic&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;      results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ci_basic_correct&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; citest
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;      ciobj &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot.ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;res&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;perc&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;      citest &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;truevalue &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; ciobj&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;perc&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; truevalue &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; ciobj&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;perc&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;      results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ci_perc_correct&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; citest
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# Prepare summary table and plots for output&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;   tab &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;      group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;      summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coverage_basic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ci_basic_correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ci_basic_correct&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;                coverage_perc &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;  &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ci_perc_correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ci_perc_correct&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;                bias &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;point_est&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; truevalue&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; truevalue&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;   p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tab &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;      dplyr&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;bias&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;      gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;      mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;coverage_perc&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Percentile&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Method&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;             Method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;coverage_basic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Basic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Method&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;             Method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Percentile&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Basic&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;      ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; color &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Method&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;      geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.95&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;      geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;      geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;      scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Proportion of 95% confidence intervals\nthat include true value&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;                         label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;      scale_x_sqrt&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Sample size&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Bootstrap\nmethod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;title&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;      theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text.x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; hjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;   p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tab &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;      ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; bias&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;      geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;      geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;      geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;      scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Bias (as percentage of true value)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;                         label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;      scale_x_sqrt&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Sample size&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;title&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;   p3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;      mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;n =&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;             n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;n =&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ns&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;      ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;point_est&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;      geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey75&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;      geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;      facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;      geom_vline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; truevalue&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;title&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Point estimates (blue line shows true value)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tab&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; p1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; p2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; p3 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; p3&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Next I load in the data, and apply my testing program to the income data and to the various simulated datasets needed for the blog.&lt;/p&gt;

&lt;p&gt;Note that with the settings in the code below, nearly 1.25 million sets of data are analysed for each call to &lt;code&gt;test_boot_ci()&lt;/code&gt;, so it takes overnight to run the whole thing on my laptop.  The &lt;code&gt;reps_per_sample_size&lt;/code&gt; and &lt;code&gt;reps_per_bootstrap&lt;/code&gt; variables should be set to much lower values (eg 20 and 99) if you just want to give this a go, or to adapt it.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;nzis&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   nzis &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.stats.govt.nz/~/media/Statistics/services/microdata-access/nzis11-cart-surf/nzis11-cart-surf.csv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;reps_per_sample_size &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2500&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;reps_per_bootstrap &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;499&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------standard deviation of income data------------&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;income_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                            statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sampsd&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                            reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                            R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                            title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating standard deviation from income data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------standard deviation of simulated data--------------&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;normal_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;300000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;                          statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sampsd&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                          reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;                          R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;                          title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating standard deviation from simulated Normal data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;unif_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; runif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;300000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;                        statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sampsd&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;                        reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                        R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;                        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating standard deviation from simulated uniform data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;lognormal_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;300000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; 
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;                             reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;                             statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sampsd&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;                             R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;                             title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating standard deviation from simulated log-normal data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;mixture &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; runif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;mixture_sd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mixture&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;                             reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;                             statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sampsd&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;                             R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;                             title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating standard deviation from simulated mixture data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------simpler statistics on income data-----------&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;income_mean &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;                            statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;])},&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;                            reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;                            R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;                            title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating mean from income data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;income_trmean &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; test_boot_ci&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;full_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;                              statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; tr &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)},&lt;/span&gt; 
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;                              reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_sample_size&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;                              R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps_per_bootstrap&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;                              title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Estimating trimmed mean from income data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Finally, I present the results in the graphics used in this post:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------Density of income data---------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey75&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand Income Survey 2011&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Full data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey75&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand Income Survey 2011&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Subsample of 50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------standard deviation of income--------------&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;income_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1  &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Source: New Zealand Income Survey 2011, Statistics New Zealand&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;income_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p2
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;income_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p3
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------other distributions--------------&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   normal_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   unif_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   lognormal_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   mixture_sd&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------mean and trimmed mean-----------------&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   income_mean&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   income_trmean&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; theme_small&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;grid.arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   income_mean&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p2 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;      theme_small &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;      scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;limits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   income_trmean&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p2 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;      theme_small &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;      scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;limits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sun, 29 May 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/05/29/standard-deviation-confidence-intervals</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/05/29/standard-deviation-confidence-intervals</guid>
			</item>
		
			<item>
				<title>Visual contrast of two robust regression methods</title>
					<description>&lt;h2 id=&quot;robust-regression&quot;&gt;Robust regression&lt;/h2&gt;

&lt;p&gt;For training purposes, I was looking for a way to illustrate some of the different properties of two different &lt;a href=&quot;https://en.wikipedia.org/wiki/Robust_regression&quot;&gt;robust estimation methods&lt;/a&gt; for linear regression models.  The two methods I’m looking at are:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Least_trimmed_squares&quot;&gt;least trimmed squares&lt;/a&gt;, implemented as the default option in &lt;code&gt;lqs()&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;a &lt;a href=&quot;https://en.wikipedia.org/wiki/M-estimator&quot;&gt;Huber M-estimator&lt;/a&gt;, implemented as the default option in &lt;code&gt;rlm()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Both functions are in Venables and Ripley’s &lt;code&gt;MASS&lt;/code&gt; R package which comes with the standard distribution of R.&lt;/p&gt;

&lt;p&gt;These methods are alternatives to ordinary least squares that can provide estimates with superior qualities when the classical assumptions of linear regression aren’t met.  M-estimators are effective in dealing with various breakdowns in the classical linear model assumptions, while still giving excellent results if the assumptions happen to be valid after all.  Least trimmed squares is very resistant to outliers, at a cost to efficiency.  Unfortunately, neither of these (or any other) robust estimation methods is the best in all situations, although they generally out-perform ordinary least squares in most real-life situations (my own, non-systematic observation).&lt;/p&gt;

&lt;h2 id=&quot;new-zealand-income-survey-2011&quot;&gt;New Zealand Income Survey 2011&lt;/h2&gt;

&lt;p&gt;To explore this I use the simulated unit record file from the New Zealand Income Survey 2011 that I’ve used in a lot of blog posts in the past year.  My &lt;a href=&quot;http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf/&quot;&gt;first post on this dataset&lt;/a&gt; sets out how to import this data and tidy it up into a database.  The data shows weekly individual income from all sources for New Zealanders aged over 15, as well as hours worked and a range of demographic information I won’t be using today.  For looking at robust regression estimation methods, I’m going to pretend that I only ever have a sample of thirty observations from this dataset.&lt;/p&gt;

&lt;p&gt;To illustrate the data, here’s an animation showing the full dataset (in grey) and repeated different samples of thirty data points, as well as lines representing linear models fit to those small samples with ordinary least squares (&lt;code&gt;lm&lt;/code&gt;) and the two robust regression methods I’m investigating today.
&lt;img src=&quot;http://ellisp.github.io/img/0041-rtm-lqs.gif&quot; alt=&quot;animation&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Some characteristics of this data that make it a useful illustration for robust regression include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;It’s reasonable to postulate the underlying relationship between hours worked and income as linear for much of the population.  So a linear model on the original scale is likely to be appropriate.&lt;/li&gt;
  &lt;li&gt;However, the population seems likely to be made up of a number of diverse groups, making assumptions of homogeneity implausible. For example, a large number of people have incomes, some of them quite substantial, despite working zero hours.  General economic and social knowledge suggests that divisions into wage-earners, profit-receivers, and social security receivers probably constitute three quite different populations, while still being a significant simplification of the actual heterogeneity.&lt;/li&gt;
  &lt;li&gt;On the original scale the data are expected to show &lt;a href=&quot;https://en.wikipedia.org/wiki/Heteroscedasticity&quot;&gt;heteroscedasticity&lt;/a&gt; (in this case, higher variance for higher expected income), making classical inference invalid&lt;/li&gt;
  &lt;li&gt;There are a number of outliers on both the x and y axes; and a cluster of individuals with negative income that appear to form yet another group in the mixture.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;comparing-robust-methods&quot;&gt;Comparing robust methods&lt;/h2&gt;

&lt;p&gt;To reflect one of the key features of the data which is the unusual distribution of income when working hours are zero, the models fit in this post are all of the structure:&lt;/p&gt;

&lt;p&gt;&lt;code&gt;income ~ hours + (hours == 0)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;The graphics show just the relationship between income and hours for when a non-zero amount of hours is worked.  In effect, (just for the graphics), this is like fitting the model after removing all the individuals that performed zero hours of work in the surveyed week.&lt;/p&gt;

&lt;p&gt;The animation shown above was the germ idea for this post and already illustrates the key points.  In particular, it shows how the randomness associated with a small sample of thirty points leads to a different result for any particular sample; and once you have that sample, different estimation methods can give you materially differing results.  In some frames of the animation, we see a sample of thirty where slopes from the different estimation methods point in different directions, suggesting that if that particular small sample was the only one available, one might conclude that working more hours leads to decreased income.&lt;/p&gt;

&lt;p&gt;The animation is nice for reminding us of the randomness associated with small samples, but actually isn’t a particularly effective method of looking at how the different robust estimation methods are doing.  Here’s a better way of doing that; a plot of the actual regression lines fit to 10,000 different samples of thirty.  Each line is semi-transparent, to give a better visual impression of where the bulk of fit lines end up:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0041-compare-lqs-rlm.png&quot; alt=&quot;comparison&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This makes it graphically clear that the &lt;code&gt;lqs&lt;/code&gt; method (least trimmed squares) gives a noticeably wider range of results than does the Huber M-estimator.  This is an expected result; least trimmed squares is highly resistant to outliers, but this comes at the cost of &lt;a href=&quot;https://en.wikipedia.org/wiki/Sufficient_statistic&quot;&gt;sufficiency&lt;/a&gt; (effectively, a significant part of the data has very little impact on the slope, so the information contained in the data is not utilised to the full).&lt;/p&gt;

&lt;p&gt;Here’s another way of looking at that; the density plots of the slopes of the three estimation methods (two robust methods plus ordinary least squares fitted with &lt;code&gt;lm&lt;/code&gt;).  I am using slope because it’s the most likely parameter of interest - it represents the marginal increase in income from an extra hour of work.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0041-slope-densities.svg&quot; alt=&quot;slopes&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The density plot shows that the estimates from &lt;code&gt;lqs&lt;/code&gt; tend to be lower than for either &lt;code&gt;rlm&lt;/code&gt; or &lt;code&gt;lm&lt;/code&gt;.  This is to be expected, in a way related to the reason that trimmed mean or median income is usually less than mean income.  An estimation method that knocks out of the data the most extreme points (as done by least trimmed squares) will give differing results for samples drawn from skewed distributions.&lt;/p&gt;

&lt;p&gt;Here are the mean, median and standard deviation of the slopes estimated by the three methods for the 10,000 samples of thirty:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;method  mean median    sd
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;    lm  &lt;span class=&quot;m&quot;&gt;21.3&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;21.9&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;18.9&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   rlm  &lt;span class=&quot;m&quot;&gt;20.5&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;20.7&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;10.9&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   lqs  &lt;span class=&quot;m&quot;&gt;17.7&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;18.2&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;23.7&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;We see that &lt;code&gt;lm&lt;/code&gt; and &lt;code&gt;rlm&lt;/code&gt; on average give similar results, but &lt;code&gt;rlm&lt;/code&gt; is much more stable, with a noticeably lower variance in results (shown by the standard deviation).  &lt;code&gt;lqs&lt;/code&gt; on the other hand is actually quite unstable, for this small sample size.&lt;/p&gt;

&lt;h2 id=&quot;preliminary-thoughts-on-robust-regression-estimators&quot;&gt;Preliminary thoughts on robust regression estimators&lt;/h2&gt;
&lt;p&gt;This post uses Venables and Ripley’s &lt;code&gt;MASS&lt;/code&gt; package and the accompanying book &lt;a href=&quot;http://www.springer.com/us/book/9780387954578&quot;&gt;&lt;em&gt;Modern Applied Statistics with S&lt;/em&gt;&lt;/a&gt;.  Their own discussion of the issue implies (to my reading) the preferred use of the MM-estimator proposed by Yohai, Stahel &amp;amp; Zamar in 1991, which retains the outlier-resistance of the S-estimator methods related to trimmed least squares, and the greater efficiency of M-estimators.  MM-estimators are available via &lt;code&gt;rlm()&lt;/code&gt; with the &lt;code&gt;method = &#39;MM&#39;&lt;/code&gt; argument.&lt;/p&gt;

&lt;p&gt;Another book that has been influential for me and I thoroughly recommend is Wilcox’ &lt;a href=&quot;http://www.amazon.com/Modern-Statistics-Social-Behavioral-Sciences/dp/1439834563&quot;&gt;&lt;em&gt;Modern Statistics for the Social and Behavioral Sciences&lt;/em&gt;&lt;/a&gt;.  His comments on the matter are so pertinent that I am going to quote two paragraphs at length:&lt;/p&gt;

&lt;h3 id=&quot;comments-on-choosing-a-regression-estimator-wilcox&quot;&gt;Comments on Choosing a Regression Estimator (Wilcox)&lt;/h3&gt;

&lt;p&gt;“Many regression estimators have been proposed that can &lt;strong&gt;have substantial advantages over the ordinary least squares estimator.  But no single estimator dominates&lt;/strong&gt; and there is the practical issue that the choice of estimator can make a practical difference in the conclusions reached.  One point worth stressing is that even when an estimator has a high breakdown point, only two outliers, properly placed, can have a large impact on some of the robust estimates of the slopes…. Estimators that seem to be particularly good at avoiding this problem are the Least Trimmed Squares, Least Trimmed Absolute Value and OP regression estimators.  Among these three estimators, the OP estimator seems to have an advantage in terms of achieving a relatively low standard error and so has the potential of relatively high power.  A negative feature of the OP estimator is that with large sample sizes, execution time might be an issue…&lt;/p&gt;

&lt;p&gt;“In terms of achieving a relatively small standard error when dealing with heteroscedasticity, certain robust regression estimators can offer a distinct advantage compared to the least squares estimator…. Ones that perform well include Theil-Sen, the OP regression estimator and the TSTS estimator.  The MM-estimator does not perform well for the situations considered (ie heteroscedasticity)… but perhaps there are situations where it offers a practical advantage.”&lt;/p&gt;

&lt;p&gt;It should be noted that earlier in the chapter Wilcox pointed out that the MM-estimator “enjoys excellent theoretical properties … but its standard error can be relatively large when there is heteroscedasticity.”&lt;/p&gt;

&lt;p&gt;The “OP” estimator is a method of outlier detection and removal followed by &lt;a href=&quot;https://en.wikipedia.org/wiki/Theil%E2%80%93Sen_estimator&quot;&gt;Theil-Sen estimation&lt;/a&gt;, a method that takes the median slope between all the pairs of sample points.  Topic for a future post.&lt;/p&gt;

&lt;h2 id=&quot;code&quot;&gt;Code&lt;/h2&gt;

&lt;p&gt;Here’s the R code behind all this.  It won’t be immediately reproducible.  Prior work is needed to establish the database as described in my earlier post; and the animation sequence is dependent on a particular folder structure.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#===================setup=======================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RMySQL&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MASS&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#================download and transform data==============&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# See http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf/ for&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# instructions on setting up the database&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;sql &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT hours, income FROM vw_mainheader&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dbConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RMySQL&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;MySQL&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; username &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;analyst&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; dbname &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;nzis &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dbGetQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sql&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;dbDisconnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# An early version of the analysis used a cube root transform; this was dropped&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# as it reduces interpretability and is not really germane to the illustration&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# of robust regression methods&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# cuberoot &amp;lt;- function(x){&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#    sign(x) * abs(x)^(1/3)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# }&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# nzis &amp;lt;- nzis %&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#    mutate(income2 = cuberoot(income),&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#           hours2 = cuberoot(hours))&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create the variables to be used for x and y (as finally used, this&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# is just income and hours on their original scale):&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;nzis &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; nzis &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;          hours2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hours&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================simulations of many samples and estimated models==============&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create empty lists to hold the samples and the model results&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;points_samp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;mod_lm &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;mod_rlm &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;mod_lqs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create the samples, estimate the models and store the results&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;reps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   nzis_samp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; nzis&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;   
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   points_samp&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; nzis_samp
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   mod_lm&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income2 &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; hours2 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;hours2 &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis_samp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   mod_rlm&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; rlm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income2 &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; hours2 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;hours2 &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis_samp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   mod_lqs&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lqs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income2 &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; hours2 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;hours2 &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; nzis_samp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#======================reporting results==============&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------setup-----------------&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Fonts:&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# define a generic plot function that does the background pale grey&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# plot of the full dataset and draws the axes:&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;draw_plot &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(){&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;hours2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; income2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey80&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;                   xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hours worked&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;                   ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;                   axes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;   axis&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; at &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; axTicks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;$&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; str_trim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;      axTicks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; big.mark &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))))&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;   axis&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; at &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; axTicks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; axTicks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------animation-------------&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This code is dependent on the particular folder structure.  File locations&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# will need to be changed if people want to reproduce the analysis.&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;   png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_output/0041-rlm-lqs/&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;m&quot;&gt;650&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;650&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;   par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;   draw_plot&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;   title&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Comparison of different estimation methods\nfor linear models on a subset of income data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;points_samp&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; points&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;hours2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; income2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;   abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_lm&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;   abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_rlm&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;   abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_lqs&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;   legend&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;topright&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; legend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rlm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lts&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; lty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;          col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; text.col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;          bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;   legend&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;bottomright&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; legend &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Full data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Sampled data&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;          pch &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; pt.cex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-101&quot;&gt;&lt;/a&gt;          bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; text.col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-102&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-103&quot;&gt;&lt;/a&gt;   dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-104&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-105&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-106&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# next sequence turns the various static frames into an animated GIF&lt;/span&gt;
&lt;a name=&quot;True-107&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# and depends on the actual location of ImageMagick:&lt;/span&gt;
&lt;a name=&quot;True-108&quot;&gt;&lt;/a&gt;projdir &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;_output/0041-rlm-lqs/&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-109&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&amp;quot; -loop 0 -delay 65 *.png &amp;quot;../../..http://ellisp.github.io/img/0041-rtm-lqs.gif&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-110&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;projdir&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-111&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-112&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-113&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#--------------visual static comparison-----------------&lt;/span&gt;
&lt;a name=&quot;True-114&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-115&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-116&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# draw graph for lqs&lt;/span&gt;
&lt;a name=&quot;True-117&quot;&gt;&lt;/a&gt;draw_plot&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-118&quot;&gt;&lt;/a&gt;title&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Least trimmed squares&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-119&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-120&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-121&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-122&quot;&gt;&lt;/a&gt;   abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_lqs&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; adjustcolor&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha.f &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.02&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-123&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-124&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-125&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# draw graph for rlm&lt;/span&gt;
&lt;a name=&quot;True-126&quot;&gt;&lt;/a&gt;draw_plot&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-127&quot;&gt;&lt;/a&gt;title&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;M-estimator&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-128&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-129&quot;&gt;&lt;/a&gt;   abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_rlm&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]],&lt;/span&gt; col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; adjustcolor&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha.f &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.02&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-130&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-131&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-132&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-133&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------compare estimated slopes-------------------&lt;/span&gt;
&lt;a name=&quot;True-134&quot;&gt;&lt;/a&gt;slopes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-135&quot;&gt;&lt;/a&gt;   lm &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;lapply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_lm&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]})),&lt;/span&gt;
&lt;a name=&quot;True-136&quot;&gt;&lt;/a&gt;   rlm &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;lapply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_rlm&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]})),&lt;/span&gt;
&lt;a name=&quot;True-137&quot;&gt;&lt;/a&gt;   lqs &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;unlist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;lapply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod_lqs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}))&lt;/span&gt;
&lt;a name=&quot;True-138&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-139&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-140&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-141&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# summary table:&lt;/span&gt;
&lt;a name=&quot;True-142&quot;&gt;&lt;/a&gt;slopes &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-143&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rlm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lqs&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-144&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-145&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-146&quot;&gt;&lt;/a&gt;      mean &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-147&quot;&gt;&lt;/a&gt;      median &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;median&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-148&quot;&gt;&lt;/a&gt;      sd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sd&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-149&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-150&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-151&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-152&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# density plot, taking care to use same colours for each method&lt;/span&gt;
&lt;a name=&quot;True-153&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# as in previous graphics:&lt;/span&gt;
&lt;a name=&quot;True-154&quot;&gt;&lt;/a&gt;colours &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;lm&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rlm&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lqs&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-155&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;direct.label&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-156&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;slopes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; method&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-157&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-158&quot;&gt;&lt;/a&gt;   coord_cartesian&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xlim &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;75&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-159&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Estimated marginal return of extra hour of work&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-160&quot;&gt;&lt;/a&gt;                      label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-161&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Density of estimates from\nsamples of 30 each&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-162&quot;&gt;&lt;/a&gt;   scale_fill_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-163&quot;&gt;&lt;/a&gt;   scale_colour_manual&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;values &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-164&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sun, 22 May 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/05/22/robust-regression</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/05/22/robust-regression</guid>
			</item>
		
			<item>
				<title>Minimalist Tufte-inspired axis text with Scottish-New Zealand historical material</title>
					<description>&lt;h2 id=&quot;minimalist-axes-text-and-tick-marks&quot;&gt;Minimalist axes text and tick marks&lt;/h2&gt;

&lt;p&gt;One of the ideas in Edward Tufte’s &lt;a href=&quot;http://www.amazon.com/Visual-Display-Quantitative-Information/dp/0961392142&quot;&gt;&lt;em&gt;The Visual Display of Quantitative Information&lt;/em&gt;&lt;/a&gt; was to minimise non-data-ink by dropping the regular text labelling values on axis guides, and instead using the axis guides to mark the values of the actual data.  For those of you with the book in front of you, I’m thinking of the graphic &lt;em&gt;Current Receipts of Government as a Percentage of Gross Domestic Product, 1970 and 1979&lt;/em&gt;, on page 158 of the 2013 edition.&lt;/p&gt;

&lt;p&gt;Looking for example data on which to apply this, I picked up a table from Rebecca Lenihan’s &lt;a href=&quot;http://www.otago.ac.nz/press/books/otago115810.html&quot;&gt;&lt;em&gt;From Alba to Aotearoa&lt;/em&gt;&lt;/a&gt; which I’m reading at the moment.  It’s a comprehensive look at what can be known about Scottish immigrants to New Zealand from 1840 to 1920 and includes a fair amount of tabular information that is ideal for presentation with this sort of graphic.  Here’s where I got to with visualising one of her tables (Table 3.6 on page 105, for those following along), showing the disproportionately maleness of Scottish immigrants in the nineteenth century even compared to other ethnic groups.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0040-females.svg&quot; alt=&quot;plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The key message from this graphic is that for both Scottish and Irish migrants to New Zealand in the nineteenth century, females were under-represented; but the ratio of females to males was noticeably lower for those of Scottish origin (all the provinces to the left of and above the pale blue diagonal line).&lt;/p&gt;

&lt;p&gt;Lenihan’s original table includes a range of additional information that can’t be easily shown in this graphic, so the graphic is very much a complement rather than replacement of the detailed numeric information.  But for the two dimensions that it does show, it’s nice example of integration of detailed numeric data into spatial representation - a combination of numbers and graphic visualisation.&lt;/p&gt;

&lt;h2 id=&quot;features-of-this-approach&quot;&gt;Features of this approach&lt;/h2&gt;

&lt;p&gt;Now I’ve noticed the trick of over-riding the boring, traditional regular spacing of axis text and tick marks, I think it might become a regular part of the repertoire for sparse two-dimensional data.  The key technical features of this as a graphic include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The province labels are carefully in pale grey, and the points representing the actual data are the final layer and in black so they are in the foreground of the graphic&lt;/li&gt;
  &lt;li&gt;I use pale blue, with different shades of transparency, to put some of the non-data guides (like the line representing equality between the two ethnicities’ female-male ratios) into the background.&lt;/li&gt;
  &lt;li&gt;Even with this sparse summarised data, some of the actual values are too close for the axis text to include every value.  In those cases (eg 81.3% and 81.5% female-male ratios for Canterbury and Otago people of Scottish descent) I’ve included a single average value as the axis text and tick mark, but used “rug” marks to indicate the two different actual values&lt;/li&gt;
  &lt;li&gt;the vertical and horizontal coordinate systems are forced to be equal, so a centimetre of distance in either direction equates to the same amount of change in female-male ratio&lt;/li&gt;
  &lt;li&gt;Because it’s all a homage to Tufte, I’ve used serif fonts rather than my usually preferred non-serifs…&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;using-the-breaks-argument-in-scalexxxcontinuous&quot;&gt;Using the breaks= argument in scale_XXX_continuous()&lt;/h2&gt;

&lt;p&gt;Here’s the code in R that does all that.  Big thanks to the authors of the &lt;code&gt;ggplot2&lt;/code&gt;, &lt;code&gt;scales&lt;/code&gt;, &lt;code&gt;ggrepel&lt;/code&gt; and &lt;code&gt;ggthemes&lt;/code&gt; R packages, and a note that the latest dev version (from GitHub) of &lt;code&gt;ggplot2&lt;/code&gt; is needed for the subtitle and caption to work.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggrepel&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggthemes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Ratio of females to males in the Scotland- and Ireland- born population in 1881&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;fem_ratio &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   province &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Auckland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Taranaki&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Hawke&amp;#39;s Bay&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Wellington&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Marlborough&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Nelson&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;West Coast&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Canterbury&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Otago&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   scots &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;68.14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;55.24&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;58.74&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;71.07&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;51.56&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;52.66&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;38.95&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;67.80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;75.16&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   irish &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;84.96&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;43.40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;65.87&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;87.73&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;69.98&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;50.20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;67.92&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;81.28&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;81.52&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a set of axis tick/text breakpoints that combine those which are too close&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# together for showing on screen:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;sanitise_ticks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; digits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   ticks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; digits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; digits&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ticks&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ticks&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; ticks&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.004&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;         ticks&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ticks&lt;span class=&quot;p&quot;&gt;[(&lt;/span&gt;i&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;         ticks&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   ticks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ticks&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;ticks &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; 
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;yticks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sanitise_ticks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fem_ratio&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;irish&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;xticks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sanitise_ticks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fem_ratio&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;scots&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Define a frequently used colour and draw plot:&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;linecol &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;steelblue&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fem_ratio&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; scots&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; irish&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; province&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   theme_tufte&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;intercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; linecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;steelblue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;   geom_text_repel&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey60&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; segment.color &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;serif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; xticks&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; yticks&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;steelblue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;         axis.ticks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;steelblue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text.x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; hjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; vjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\nScottish born\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Irish born\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;        caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Source: Census, analysed in Lenihan &amp;#39;From Alba to Aotearoa&amp;#39;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Females as a percentage of males in New Zealand 1881&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;           subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Selected places of birth shown&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.68&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; linecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;serif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;            label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Line shows same ratio\nfor Scots- and Irish- born&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;            alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sat, 14 May 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/05/14/scots-female-ratio</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/05/14/scots-female-ratio</guid>
			</item>
		
			<item>
				<title>Announcing new forecastHybrid package</title>
					<description>&lt;h2 id=&quot;background-and-motivation&quot;&gt;Background and motivation&lt;/h2&gt;
&lt;p&gt;In an &lt;a href=&quot;/blog/2016/01/30/hybrid-forecasts/&quot;&gt;earlier post&lt;/a&gt; I explored ways that might improve on standard methods for prediction intervals from univariate time series forecasting.  One of the tools I used was a convenience function to combine forecasts from Rob Hyndman’s &lt;code&gt;ets&lt;/code&gt; and &lt;code&gt;auto.arima&lt;/code&gt; functions.  David Shaub (with a small contribution from myself) has now built and published an R package &lt;code&gt;forecastHybrid&lt;/code&gt; that expands on this idea to create ensembles from other forecasting methods from Hyndman’s &lt;code&gt;forecast&lt;/code&gt; package.&lt;/p&gt;

&lt;p&gt;The motivation is to make it easy to improve forecasts, both their point estimates and their prediction intervals.  It has been well known for many years that taking the average of rival forecast methods improves the performance of forecasts.  This new R package aims to make it as easy for people to do this as to fit the individual models in the first place.&lt;/p&gt;

&lt;h2 id=&quot;installation&quot;&gt;Installation&lt;/h2&gt;
&lt;p&gt;The stable version of the &lt;code&gt;forecastHybrid&lt;/code&gt; package is on CRAN, and is installed the usual way:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;install.packages&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;forecastHybrid&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;forecastHybrid&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It requires at least version 7.1 of Rob Hyndman’s &lt;code&gt;forecast&lt;/code&gt; package, which is a recent upgrade.&lt;/p&gt;

&lt;h2 id=&quot;usage&quot;&gt;Usage&lt;/h2&gt;

&lt;h3 id=&quot;basic&quot;&gt;Basic&lt;/h3&gt;
&lt;p&gt;Usage is a two step process:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;fitting the required time series models&lt;/li&gt;
  &lt;li&gt;forecasting them and taking a weighted average&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; hybridModel&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AirPassengers&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;fc1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; forecast&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;fc1
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;         Point Forecast    Lo &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;    Hi &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;    Lo &lt;span class=&quot;m&quot;&gt;95&lt;/span&gt;    Hi &lt;span class=&quot;m&quot;&gt;95&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;Jan &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;449.0761&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;420.9284&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;474.4528&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;409.9071&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;486.2105&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;Feb &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;430.5014&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;402.5180&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;463.4376&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;392.8622&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;477.7219&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;Mar &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;476.6044&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;427.8241&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;541.2952&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;416.7423&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;560.7848&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;Apr &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;489.6462&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;445.6985&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;533.1953&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;425.6737&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;554.8180&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;May &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;499.3256&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;443.0128&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;546.2434&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;420.7317&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;570.5889&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;Jun &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;565.3663&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;498.8558&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;624.6220&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;471.1949&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;654.7751&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;Jul &lt;span class=&quot;m&quot;&gt;1961&lt;/span&gt;       &lt;span class=&quot;m&quot;&gt;642.3351&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;550.5136&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;710.4620&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;517.2336&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;747.2133&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;truncated&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Prediction intervals are based on the conservative (and accurate, at least for the auto.arima / ets combination and the M3 competition data) method I set out in my &lt;a href=&quot;/blog/2016/01/30/hybrid-forecasts/&quot;&gt;earlier post&lt;/a&gt; on hybrid methods.  That is, at each time period of the forecast, the points of the prediction intervals of all the component models in the ensemble that are highest in absolute magnitude are used for the boundaries of the ensemble prediction interval.  This method seems to give truer prediction intervals than any individual model’s prediction intervals, which are usually too narrow (ie give a false sense of precision) because they don’t take model uncertainty into account.  This is an active area of investigation; &lt;a href=&quot;https://github.com/ellisp/forecastHybrid/issues/19&quot;&gt;we’re not sure we’re going to keep them calculated this way&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The object created by the above procedure is of class &lt;code&gt;forecast&lt;/code&gt; and the base graphics plotting method from Hyndman’s &lt;code&gt;forecast&lt;/code&gt; package applies:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fc1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;International airline passengers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0039-airpassengers1.svg&quot; alt=&quot;basic&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;custom-combinations-and-weights&quot;&gt;Custom combinations and weights&lt;/h3&gt;
&lt;p&gt;Controlling which of the five types of available models are used in the ensemble is done via the &lt;code&gt;models&lt;/code&gt; argument of &lt;code&gt;hybridModel&lt;/code&gt;.  &lt;code&gt;models&lt;/code&gt; is a character string of any combination of &lt;code&gt;a&lt;/code&gt;, &lt;code&gt;e&lt;/code&gt;, &lt;code&gt;n&lt;/code&gt;, &lt;code&gt;s&lt;/code&gt;, and &lt;code&gt;t&lt;/code&gt; for &lt;code&gt;auto.arima&lt;/code&gt;, &lt;code&gt;ets&lt;/code&gt;, &lt;code&gt;nnetar&lt;/code&gt;, &lt;code&gt;stlm&lt;/code&gt; and &lt;code&gt;tbats&lt;/code&gt; respectively.  In the code below I combine just &lt;code&gt;auto.arima&lt;/code&gt; and &lt;code&gt;ets&lt;/code&gt; (exponential state space smoothing) models, two component models that make up a high-performing (on average) forecasting method.&lt;/p&gt;

&lt;p&gt;I also use this example to show how, instead of weighting the models equally, we can specify greater weight to be given to the model that fits the historical data better.  This procedure isn’t recommended - it seems better just to give the models a priori weights, usually equal, rather than let the data dictate them.  Why this is the case is out of my scope just here.  Here’s the example:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; hybridModel&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;AirPassengers&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; models &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ae&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;                    weights &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;insample.errors&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;fc2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; forecast&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fc2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;International airline passengers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0039-airpassengers2.svg&quot; alt=&quot;ae&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;external-regressors&quot;&gt;External regressors&lt;/h3&gt;
&lt;p&gt;While most of the candidate models for an ensemble are univariate methods, &lt;code&gt;auto.arima&lt;/code&gt; and &lt;code&gt;nnetar&lt;/code&gt; models can incorporate an &lt;code&gt;xreg&lt;/code&gt; argument.  If you have actual values for the forecast period of external regressors, it’s often useful to use them in the forecasting process.  The forecastHybrid approach lets you do this with the component models that support &lt;code&gt;xreg&lt;/code&gt;, while ignoring it and fitting univariate time series models with other component models (eg &lt;code&gt;ets&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;To pass &lt;code&gt;xreg&lt;/code&gt; or other parameters through to the model-fitting functions, the user passes up to five lists of parameters (&lt;code&gt;a.arg&lt;/code&gt;, &lt;code&gt;e.arg&lt;/code&gt;, &lt;code&gt;n.arg&lt;/code&gt;, &lt;code&gt;s.arg&lt;/code&gt; and &lt;code&gt;t.arg&lt;/code&gt;).  Here’s an example showing how to pass through xreg parameters to &lt;code&gt;auto.arima&lt;/code&gt; for automated ARIMA modelling and &lt;code&gt;nnetar&lt;/code&gt; for the feed-forward neural network model.  This example tries to forecast 12 months of unemployment in Wisconsin, given known values of unemployment in surrounding states and for the USA as a whole (this isn’t a particularly realistic example in itself, but is of a type of forecast that does occur in reality, for example when one economic time series is only available after a much longer delay than other more timely measures).&lt;/p&gt;

&lt;p&gt;The data management and forecast question below has been pinched from &lt;a href=&quot;http://biba.etsii.upm.es/web/tiki-view_blog_post.php?postId=26&quot;&gt;an example on the BIBA blog by joaquin&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# adapted from http://biba.etsii.upm.es/web/tiki-view_blog_post.php?postId=26 &lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# donwload individual datasets from QUANDL&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;wi&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/WIUR.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;us&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/UNRATE.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;il&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/ILUR.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;mi&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/MIUR.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;mn&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/MNUR.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;io&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;http://www.quandl.com/api/v1/datasets/FRED/IAUR.csv?&amp;amp;auth_token=gigXwpxd6Ex91cjgz1B7&amp;amp;trim_start=1976-01-01&amp;amp;trim_end=2013-04-01&amp;amp;sort_order=desc&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colClasses&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#merging the data into one dataframe&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;unemp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;wi&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; io&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;colnames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;wi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;io&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;unemp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mi&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;colnames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;wi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;io&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;unemp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mn&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;colnames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;wi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;io&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mn&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;unemp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; us&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;colnames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;wi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;io&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mn&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;us&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;unemp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; il&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;colnames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;DATE&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;wi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;io&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mi&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;mn&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;us&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;il&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# break into historical and forecast periods&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;unemp_hist &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; unemp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;unemp_fc &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; unemp&lt;span class=&quot;p&quot;&gt;[(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;448&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,]&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;unemp_hist_ts &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp_hist&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;wi&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; start &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1976&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; frequency &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fit hybrid model, passing arguments to auto.arima with a.args and to&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# nnetar with n.args&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;mod4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; hybridModel&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;unemp_hist_ts&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; models &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;aen&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                    a.args &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xreg &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; unemp_hist&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;                    n.args &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;xreg &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; unemp_hist&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fit the forecast - note that you have to supply the future xreg values,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# but you only need to do it once (both nnetar and auto.arima use the same &lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ones):                    &lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fc4&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Unemployment in Wisonsin&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;     sub &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Forecasts based on unemployment in\nUSA, Iowa, Michigan, Minnesota, and Illinois&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0039-unemployment.svg&quot; alt=&quot;unemp&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There’s a lot more functionality in this package, mostly just inherited from Hyndman’s &lt;code&gt;forecast&lt;/code&gt; package.  So &lt;a href=&quot;https://cran.rstudio.com/web/packages/forecastHybrid/&quot;&gt;check it out on CRAN&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;future-work&quot;&gt;Future work&lt;/h2&gt;
&lt;p&gt;Future work on the package, if / when we get around to it, is likely to include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Allowing the weights between the models to be set based on cross-validation performance of the component models&lt;/li&gt;
  &lt;li&gt;Allowing weights between the models to change over different forecast horizons (eg some models are known to be generally better at predicting long term than short term, so could be given extra weight as the forecast horizon increase)&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;ggplot2&lt;/code&gt; graphics integration&lt;/li&gt;
  &lt;li&gt;More models&lt;/li&gt;
  &lt;li&gt;Improved parallelization (it already works with parallel processing, but this could be improved between models)&lt;/li&gt;
  &lt;li&gt;Automating model selection&lt;/li&gt;
  &lt;li&gt;Various under the hood things&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also hope to do some more work &lt;em&gt;with&lt;/em&gt; the package, eg more systematic tests of the performance of these hybrid model forecasts both as point forecasters and prediction intervals.&lt;/p&gt;

&lt;p&gt;Bugs, issues and enhancement requests can be &lt;a href=&quot;https://github.com/ellisp/forecastHybrid/issues&quot;&gt;filed at GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Nearly all the credit for this package goes to David Shaub; although it’s hosted on my GitHub account, my contribution has been small.  So thanks David for a great convenient set of functionality for forecasters using R.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;Manual&lt;span class=&quot;p&quot;&gt;{,&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;    title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;forecastHybrid&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; Convenient Functions &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; Ensemble Time Series Forecasts&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;    author &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;David Shaub&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;    year &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2016&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;    note &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;R package version &lt;span class=&quot;m&quot;&gt;0.1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;    url &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;https&lt;span class=&quot;o&quot;&gt;://&lt;/span&gt;CRAN.R&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;project.org&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;package&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;forecastHybrid&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sat, 07 May 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/05/07/forecastHybrid</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/05/07/forecastHybrid</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 4 - drivers of preference for Green over Labour party</title>
					<description>&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the fourth in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Earlier posts introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt;, basic usage, how it was built, and an exploratory Shiny web application.  Today I follow up on &lt;a href=&quot;http://www.statschat.org.nz/2016/04/09/compared-to-what-4/#comment-181310&quot;&gt;discussion in the StatsChat blog&lt;/a&gt;.  A post there showed a screen shot from my Shiny app, zooming in on Auckland votes for Green Party compared to the Labour Party (the two principal left-leaning parties in New Zealand).  There was discussion in the comments of whether house price, income, and education were the predictors of the choice between these two parties (for the subset of voters who chose one of the two).&lt;/p&gt;

&lt;h2 id=&quot;combining-census-meshblock-data-with-voting-locations&quot;&gt;Combining census meshblock data with voting locations&lt;/h2&gt;
&lt;p&gt;Making it easier to investigate this issue is one the primary motivations for the &lt;code&gt;nzelect&lt;/code&gt; R package and incorporating census data that can be matched to voting locations and electorates has been on the plan from the beginning.  It’s proven a bigger job than I hoped and is very incomplete, but so far I’ve incorporated around 35 selected variables from the 2013 Census at the meshblock level.&lt;/p&gt;

&lt;h3 id=&quot;first-look&quot;&gt;First look&lt;/h3&gt;
&lt;p&gt;The plot below shows how some of those variables relate to the variable of interest here - the Green Party votes as a proportion of all that went to Green Party or Labour Party, by voting location.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0038-green-labour.png&quot; alt=&quot;matrix&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Full descriptions of the variables are in the helpfile for the &lt;code&gt;Meshblocks2013&lt;/code&gt; object in the &lt;code&gt;nzelect&lt;/code&gt; package.  People without access to that can still read the &lt;a href=&quot;https://github.com/ellisp/nzelect/blob/master/pkg/man/Meshblocks2013.Rd&quot;&gt;source code of the helpfile&lt;/a&gt; which hopefully will make sense.  Time and space constraints put me off creating a big table here in this blog post.&lt;/p&gt;

&lt;p&gt;The blue lines show outlier-resistant robust linear regressions on one explanatory variable at a time, but the non-robust versions are almost identical.  All code has been relegated to the bottom of the post.  When the &lt;code&gt;nzelect&lt;/code&gt; package has a more complete set of census data, including more variables and area unit, electorate and territorial authority variables, I’ll do a future post that focuses more on the code to join these things together.&lt;/p&gt;

&lt;p&gt;Two variables that are in the &lt;code&gt;nzelect&lt;/code&gt; package have been excluded.  These are &lt;code&gt;PropEuropean&lt;/code&gt;, the proportion of meshblock population of European ethnicity; and &lt;code&gt;PropOwnResidence&lt;/code&gt;, the proportion of individuals that own their own residence.  I excluded these early as part of my modelling strategy because they are highly collinear with the other set of candidate explanatory variables - variance inflation factors over 10.  What this means in practice is that once you know the proportions of Maori, Asian and Pacific ethnicity in a meshblock there’s not much to learn from the proportion of people of European ethnicity.  And once you know the proportion of households that are owned, there’s not much information contained in knowing the proportion of individuals who own their residence.&lt;/p&gt;

&lt;h3 id=&quot;spatial-elements&quot;&gt;Spatial elements&lt;/h3&gt;
&lt;p&gt;Note that I’ve left in two variables for the latitude and longitude, which (probably as expected) don’t have any obvious relationship to the proportion of Green v Labour voters.  This is so when I get into statistical modelling, I can take into account expected spatial auto-correlation.  Simply put, that means that the results from two voting places that are close together shouldn’t be treated as completely fresh independent information, but given somewhat less importance because of their co-location.  This is just a nuisance aspect of the model with regard to today’s question so I don’t report on the results; but in the modelling I do later I make sure I have a spatial spline lurking in the background to suck up any spatial effects, leaving the estimates of the impact of other explanatory variables safer.&lt;/p&gt;

&lt;h3 id=&quot;imputation&quot;&gt;Imputation&lt;/h3&gt;
&lt;p&gt;For confidentialisation, meshblock census results are subject to random rounding (which is why some of the proportions exceed 1 - the numerator has been rounded one way, and the denominator another) and to outright cell suppression.  For today’s purposes, the cell suppression is more of a problem.  As I’ve potentially got lots of explanatory variables in my model, many meshblocks are missing at least one variable due to the confidentialisation.  If I excluded each voting place whose meshblock was missing data, I’d be throwing out 61% of the data.&lt;/p&gt;

&lt;p&gt;This is enough of a problem that I’d consider going up a level and using area units (larger shapes than meshblocks) instead, although many area units have multiple voting locations in them so we would lose a fair bit of granularity in doing so.  However, the &lt;code&gt;nzelect&lt;/code&gt; data doesn’t yet include its area unit slice and I’m short of time, so I opt for imputation instead.&lt;/p&gt;

&lt;p&gt;I use multiple imputation, which means that you create statistical models to predict each missing value based on the values that you do have, and do this multiple times for each missing value, including the random element of the model and hence getting a different imputed value each time.  Then when you fit your final model of actual interest you fit it to each one of your datasets with missing value imputations (in this example I have 20 full sets of the data) and you base your calculations of standard errors, confidence intervals, etc. on the randomness that comes from the imputation process as well as the usual modelling uncertainty.  It’s not a fool-proof method - nothing is in the face of missing data - but it’s a good one and it does the job in this case (how do I know?  I tried other methods, including deleting all rows, and got similar results).&lt;/p&gt;

&lt;h2 id=&quot;modelling&quot;&gt;Modelling&lt;/h2&gt;
&lt;p&gt;When it comes to the actual modelling I use a generalised additive model with a binomial family response.  The ‘additive’ bit comes from a flexible two dimensional spline which is just there to deal with the nuisance of the spatial autocorrelation.  The binomial family response is appropriate for the data which uses proportions.  Here’s the end results showing which variables are good for predicting the proportion of Green / Labour votes that are for the Green Party:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0038-model-results.svg&quot; alt=&quot;results&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;interpretation&quot;&gt;Interpretation&lt;/h3&gt;
&lt;p&gt;So, just to be really clear, here are the factors in the surrounding meshblock that seem lead to a voting place returning a high proportion of Green/Labour voters voting Green:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Higher proportion of individuals are self employed&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals have a Bachelor degree&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals have no religion&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals were overseas 5 years ago&lt;/li&gt;
  &lt;li&gt;Higher proportion of households don’t own their residence&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And here are the factors that are associated with a high proportion of Green/Labour voters voting Labour:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;High proportion of individuals state they are of Pacific, Asian or Maori ethnicity&lt;/li&gt;
  &lt;li&gt;High proportion of individuals have no qualifications&lt;/li&gt;
  &lt;li&gt;High proportion of individuals were born in New Zealand&lt;/li&gt;
  &lt;li&gt;High proportion of individuals have partner or are separated&lt;/li&gt;
  &lt;li&gt;Higher individual median income&lt;/li&gt;
  &lt;li&gt;Higher proportion of individuals are aged 20 to 24&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s no discernable impact from the median household rent, best proxy in the particular data available for household prices.  So on the data available, the general demographics argument wins over the housing prices one.&lt;/p&gt;

&lt;p&gt;The surprising one here was the negative coefficient in front of median income.  This differs from the simple two variable relationship seen in the first graphic in this post; what we’re seeing with the more sophisticated modelling is evidence that the apparent relationship between income and higher proportions of Green voters over Labour is a proxy for other demographic factors (like education, ethnicity and employment), and when those factors are controlled for the relationship between income and choosing Green over Labour is negative.&lt;/p&gt;

&lt;p&gt;Care needs to be taken in leaping from this analysis to conclusions about individual behaviour, which would form the &lt;a href=&quot;https://en.wikipedia.org/wiki/Ecological_fallacy&quot;&gt;ecological fallacy&lt;/a&gt;.  For example, while areas with higher incomes seem more inclined to choose Labour over Green after controlling for other factors, it’s at least possible that it’s being surrounded by higher income people that has the effect, rather than being higher income oneself; and similarly with any other observed effect.  But with caution and caveats you can at least form some tentative conclusions about individuals; only individual level data could resolve that, and the New Zealand Election Study (which would provide that) &lt;a href=&quot;http://www.nzes.org/exec/show/data&quot;&gt;isn’t yet available for download&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;final-warnings&quot;&gt;Final warnings&lt;/h3&gt;
&lt;p&gt;One thing we &lt;em&gt;don’t&lt;/em&gt; do at this point is knock out all those “non significant” variables like proportion of people on unemployment benefit, proportion who are full time students, etc and refit the model.   This leads to all the standard errors being biased downwards, the effect sizes being biased upwards, test statistics not having the claimed distributions, confidence intervals being too small, and in fact pretty much any inference after that point is invalid.  This doesn’t stop that kind of stepwise model building from being common practice, but don’t let me catch you doing it in a context where inference about effect sizes and “which variables have how much explanatory power” are important (sometimes for predictive models that stepwise approach is more justifiable, if done carefully).&lt;/p&gt;

&lt;p&gt;This analysis is incomplete because the &lt;code&gt;nzelect&lt;/code&gt; project is incomplete.  Most glaringly, two whole sets of individual level census variables have been excluded simply because I didn’t get round to including them in the original data package.  This doesn’t invalidate the findings but it does add extra cautions and caveats.  I’ll fix that eventually but it might be a few months away.&lt;/p&gt;

&lt;p&gt;OK, that’s enough to go along with.  Thanks for reading.  Here’s the code that did that analysis:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------load up functionality and fonts------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ellisp/nzelect/pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;devtools&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;install_github&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;hadley/ggplot2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# latest version needed for subtitles and captions&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MASS&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for rlm().  Load before dplyr to avoid &amp;quot;select&amp;quot; conflicts&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mice&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for multiple imputation&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;car&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;      &lt;span class=&quot;c1&quot;&gt;# for vif()&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggthemes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for theme_tufte&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mgcv&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# for a version of gam with vcov() method&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load in the data&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzelect&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------general data prep------------&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Some voting places don&amp;#39;t have a match to mesthblock and hence aren&amp;#39;t any&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# good for our purposes.  Note - Chatham Islands *should* be a match, but that&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# an issue to fix in the nzelect package which we&amp;#39;ll ignore for now&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;bad_vps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Chatham Islands Council Building, 9 Tuku Road, Waitangi&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Ordinary Votes BEFORE polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Overseas Special Votes including Defence Force&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Special Votes BEFORE polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Special Votes On polling day&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Votes Allowed for Party Only&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;Voting places where less than 6 votes were taken&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;GE2014a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;VotingPlace &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; bad_vps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------Greens / (Greens + Labour)--------------&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make a dataset with the response variable we want (Greens / (Greens + Labour))&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# and merged with the VotingPlace locations and the relevant meshblock data&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014a &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;             Party &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;             TotalGLVotes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   ungroup&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Locations2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Meshblocks2013&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MB2014&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;MB&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TotalGLVotes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; WGS84Latitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; WGS84Longitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;          MeanBedrooms2013&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;PropStudentAllowance2013&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Tidy up names of variables.  All the census data is from 2013 so we don&amp;#39;t&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# need to say so in each variable:&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Identify and address collinearity in the explanatory variables&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;mod1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;vif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# PropEuropean is 17 - can be predicted from maori, Pacific Asian.&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# PropOwnResidence is 11 - can be predicted from PropNotOwnedHH&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so let&amp;#39;s take those two un-productive variables out&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; greens&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PropEuropean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;PropOwnResidence&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Image of scatter plots of explanatory variables v response variable&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0038-green-labour.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;greens &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;PropGreens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;2013&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;          Variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Prop&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Prop &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; PropGreens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;Variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_x&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-76&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-77&quot;&gt;&lt;/a&gt;   geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;rlm&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; se &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-78&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Percentage of Labour and Green voters who voted Green Party in party vote&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-79&quot;&gt;&lt;/a&gt;                      label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-80&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-81&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Note: horizontal scales vary; and some proportions exceed 1.0 due to confidentialising.\nBlue lines are outlier-resistant robust regressions.&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-82&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Choosing between Labour and Green in the 2014 New Zealand General Election&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-83&quot;&gt;&lt;/a&gt;      subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Each point represents an individual voting location (vertical axis) and the meshblock within which it is located (horizontal axis).&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;    theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;panel.margin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; unit&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lines&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-84&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-85&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-86&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-87&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# More data munging prior to model fitting&lt;/span&gt;
&lt;a name=&quot;True-88&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-89&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# only 39% of cases are complete, due to lots of confidentialisation:&lt;/span&gt;
&lt;a name=&quot;True-90&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;complete.cases&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-91&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# so to avoid chucking out half the data we will need to impute.  Best way&lt;/span&gt;
&lt;a name=&quot;True-92&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# is multiple imputation, which gives&lt;/span&gt;
&lt;a name=&quot;True-93&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-94&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# to make it easier to compare the ultimate coefficients, we&amp;#39;re going to&lt;/span&gt;
&lt;a name=&quot;True-95&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# scale the explanatory variables.  Easiest to do this before imputationL&lt;/span&gt;
&lt;a name=&quot;True-96&quot;&gt;&lt;/a&gt;greens_scaled &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; greens
&lt;a name=&quot;True-97&quot;&gt;&lt;/a&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;scale&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-98&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-99&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Now we do the multiple imputation.  &lt;/span&gt;
&lt;a name=&quot;True-100&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Note that we ignore PropGreens for imputation purposes - don&amp;#39;t want to impute&lt;/span&gt;
&lt;a name=&quot;True-101&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the Xs based on the Y!  First we define the default predictor matrix:&lt;/span&gt;
&lt;a name=&quot;True-102&quot;&gt;&lt;/a&gt;predMat &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;diag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ncol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-103&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Each row corresponds to a target variable, columns to the variables to use in&lt;/span&gt;
&lt;a name=&quot;True-104&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imputing them.  We say nothing should use PropGreens (first column).  Everything&lt;/span&gt;
&lt;a name=&quot;True-105&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# else is ok to use, including latitude and longitude and the total green and labour&lt;/span&gt;
&lt;a name=&quot;True-106&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# votes:&lt;/span&gt;
&lt;a name=&quot;True-107&quot;&gt;&lt;/a&gt;predMat&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-108&quot;&gt;&lt;/a&gt;greens_mi &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; mice&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; m &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; predictorMatrix &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; predMat&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-109&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-110&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# what are all the variable names?:&lt;/span&gt;
&lt;a name=&quot;True-111&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_scaled&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; collapse &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot; + &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-112&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-113&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fit models to each of the imputed datasets:&lt;/span&gt;
&lt;a name=&quot;True-114&quot;&gt;&lt;/a&gt;mod2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;with&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;greens_mi&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-115&quot;&gt;&lt;/a&gt;             gam&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PropGreens &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; MeanBedrooms &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPrivateDwellings &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-116&quot;&gt;&lt;/a&gt;                   PropSeparateHouse &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; NumberInHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropMultiPersonHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-117&quot;&gt;&lt;/a&gt;                   PropInternetHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNotOwnedHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; MedianRentHH &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-118&quot;&gt;&lt;/a&gt;                   PropLandlordPublic &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoMotorVehicle &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropOld &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-119&quot;&gt;&lt;/a&gt;                   PropEarly20s &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropAreChildren &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropSameResidence5YearsAgo &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-120&quot;&gt;&lt;/a&gt;                   PropOverseas5YearsAgo &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNZBorn &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropMaori &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-121&quot;&gt;&lt;/a&gt;                   PropPacific &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropAsian &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoReligion &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropSmoker &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-122&quot;&gt;&lt;/a&gt;                   PropSeparated &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPartnered &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropNoChildren &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-123&quot;&gt;&lt;/a&gt;                   PropNoQualification &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropBachelor &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropDoctorate &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-124&quot;&gt;&lt;/a&gt;                   PropFTStudent &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropPTStudent &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; MedianIncome &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-125&quot;&gt;&lt;/a&gt;                   PropSelfEmployed &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; PropUnemploymentBenefit &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-126&quot;&gt;&lt;/a&gt;                   PropStudentAllowance &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-127&quot;&gt;&lt;/a&gt;                    s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Latitude&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Longitude&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-128&quot;&gt;&lt;/a&gt;                    s&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;WGS84Latitude &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; WGS84Longitude&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-129&quot;&gt;&lt;/a&gt;                family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; binomial&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; weights &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TotalGLVotes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-130&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-131&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-132&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-133&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# extract all the estimates of coefficients, except the uninteresting intercept:&lt;/span&gt;
&lt;a name=&quot;True-134&quot;&gt;&lt;/a&gt;coefs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;summary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;pool&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mod2&lt;span class=&quot;p&quot;&gt;))[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; 
&lt;a name=&quot;True-135&quot;&gt;&lt;/a&gt;vars &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rownames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-136&quot;&gt;&lt;/a&gt;coefs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-137&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; vars&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-138&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;est&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-139&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Prop&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-140&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-141&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# drop all the uninteresting estimates associated with the spatial splines:&lt;/span&gt;
&lt;a name=&quot;True-142&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;grepl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;WGS84&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-143&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-144&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# make names referrable:&lt;/span&gt;
&lt;a name=&quot;True-145&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; fixed &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-146&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-147&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# define plot of results:&lt;/span&gt;
&lt;a name=&quot;True-148&quot;&gt;&lt;/a&gt;p2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coefs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ymin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lo_95&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ymax &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hi_95&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; est&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-149&quot;&gt;&lt;/a&gt;   geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;lightblue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-150&quot;&gt;&lt;/a&gt;   geom_linerange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey20&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-151&quot;&gt;&lt;/a&gt;   geom_text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; variable&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; vjust &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; nudge_x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-152&quot;&gt;&lt;/a&gt;   coord_flip&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-153&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\nHorizontal lines show 95% confidence interval of scaled impact on&lt;/span&gt;
&lt;a name=&quot;True-154&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;proportion that voted Green out of Green and Labour voters.&lt;/span&gt;
&lt;a name=&quot;True-155&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;The numbers show coefficients from a logistic regression and &lt;/span&gt;
&lt;a name=&quot;True-156&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;should be taken as indicative, not strictly interpretable.\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-157&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-158&quot;&gt;&lt;/a&gt;        caption &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Source: http://ellisp.github.io&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-159&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Census characteristics of voting places that party-voted Green over Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-160&quot;&gt;&lt;/a&gt;      subtitle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand General Election 2014&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-161&quot;&gt;&lt;/a&gt;   theme_tufte&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-162&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axis.text.y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
&lt;a name=&quot;True-163&quot;&gt;&lt;/a&gt;         axis.ticks.y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-164&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More likely to\nvote Labour&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-165&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;red&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-166&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.18&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;More likely to\nvote Green&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-167&quot;&gt;&lt;/a&gt;            colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;darkgreen&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-168&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-169&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

</description>
				<pubDate>Sat, 16 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/16/nzelect4</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/16/nzelect4</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 3 - interactive exploration of voting locations with leaflet and Shiny</title>
					<description>&lt;style&gt;
               #scaled-frame { width: 1400px; height: 910px; border: 0px; }
               #scaled-frame {
               zoom: 0.67;
               -moz-transform: scale(0.7);
               -moz-transform-origin: 0 0;
               -o-transform: scale(0.7);
               -o-transform-origin: 0 0;
               -webkit-transform: scale(0.7);
               -webkit-transform-origin: 0 0;
               overflow: hidden;
               }

               @media screen and (-webkit-min-device-pixel-ratio:0) {
               #scaled-frame  { zoom: 1;  }
               }
&lt;/style&gt;

&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the third in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;First&lt;/a&gt; I introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt; from a user perspective.  &lt;a href=&quot;/blog/2016/04/04/nzelect2/&quot;&gt;Second&lt;/a&gt; was a piece on how the build of that package works.  Today, the third in the series introduces an interactive map of results by voting location drawing on the data in &lt;code&gt;nzelect&lt;/code&gt;, built with Shiny.&lt;/p&gt;

&lt;h2 id=&quot;overview&quot;&gt;Overview&lt;/h2&gt;
&lt;p&gt;The point of the tool is to facilitate comparison of support for parties by fine grained location, well below the electorate level that is usually used as the area of analysis. I’ve included data for the party vote of the eight most successful parties in the 2014 election.  Party vote determines the ultimate make up of Parliament (see &lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;this previous post&lt;/a&gt; for a brief discussion of how the New Zealand system works) and is more comparable across locations than is candidate vote for a number of reasons.&lt;/p&gt;

&lt;p&gt;Here’s the Shiny app in action:&lt;/p&gt;
&lt;div style=&quot;height: 647px&quot;&gt;
&lt;iframe id=&quot;scaled-frame&quot; width=&quot;980&quot; src=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot; style=&quot;overflow-y: hidden;&quot;&gt;&lt;/iframe&gt;
&lt;/div&gt;

&lt;p&gt;Most users will prefer the &lt;a href=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot;&gt;full screen version&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What you can do with this app includes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;you can use the drop down box to add circles representing the percentage of vote at any voting place for each of up to 8 parties.  Each time you select a new party, it adds new circles on the front of the graphic - so if you want to compare two parties it’s a good idea to choose the more popular (for your shown location) first, and overlay the less popular one on top of it&lt;/li&gt;
  &lt;li&gt;you can move the map around to a part of New Zealand you’re interested in and zoom in or out, and the markers will resize to be visible&lt;/li&gt;
  &lt;li&gt;you can click on the individual circles to get a tooltip showing the actual number of votes for that party in that location (only really readable in the full screen version).&lt;/li&gt;
  &lt;li&gt;you can rescale the circles - recommended if you’re looking at parties other than Labour, National and Green.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It’s definitely most interesting when you’re comparing two parties.  Remember that these data show the locations where people voted (on a Saturday), which is presumed to be generally but not always close to but not identical to where they live and / or (less often) work.  Here’s some snapshots of interesting contrasts:&lt;/p&gt;

&lt;h3 id=&quot;new-zealand-first-compared-to-maori-party-in-the-northland-area&quot;&gt;New Zealand First compared to Maori Party in the Northland area&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-northland.png&quot; alt=&quot;northland&quot; /&gt;&lt;/p&gt;

&lt;p&gt;New Zealand First outperformed the Maori Party comprehensively in Northland, showing there’s no inevitable link from higher proportions of Maori ethnicity to supporting the party of that name.  More exploring shows the Maori Party’s strongest support in parts of Bay of Plenty, Taupo and Gisborne (upper right north island, for non-New Zealanders, and like Northland, concentrations of people with Maori ethnicity).&lt;/p&gt;

&lt;h3 id=&quot;national-compared-to-labour-in-auckland&quot;&gt;National compared to Labour in Auckland&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-auckland.png&quot; alt=&quot;auckland&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The fine grained pattern of National Party (blue circle) support compared to the Labour Party in Auckland’s inner suburbs is extremely marked:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Near parity in the city centre;&lt;/li&gt;
  &lt;li&gt;National dominance in the eastern and (to a lesser extent) northern inner suburbs;&lt;/li&gt;
  &lt;li&gt;Labour stronger around Tamaki (to the right of the image) plus some pockets in the south-west.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;When analysed at an electorate level, that Labour support in the bottom right of the image in Tamaki the suburb is missed because it is wrapped up in the overall strongly-National &lt;a href=&quot;https://en.wikipedia.org/wiki/T%C4%81maki_(New_Zealand_electorate)&quot;&gt;Tamaki electorate&lt;/a&gt;, Robert Muldoon’s old electorate and returning National MPs uninterruptedly since the 1960s.&lt;/p&gt;

&lt;h3 id=&quot;greens-compared-to-labour-in-wellington&quot;&gt;Greens compared to Labour in Wellington&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0037-wellington.png&quot; alt=&quot;wellington&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The two main parties of the left in New Zealand are Labour and the Greens.  Green Party support relative to Labour Party in the Wellington area is a very regional phenomenon.   Green party votes in 2014 were focused in the inner city and suburbs with small patches in other suburbs that perhaps are unsurprising to political tacticians who know Wellington’s spatial socio-demographics.  This follows the trend (in New Zealand and similar countries) for the educated, well off, younger left to more generally support the Greens than the older parties of the left.  Note the traditional working class Labour Party strongholds in Lower Hutt and Wainuiomata areas.&lt;/p&gt;

&lt;h2 id=&quot;a-trick-with-leaflet-and-shiny&quot;&gt;A trick with leaflet and Shiny&lt;/h2&gt;
&lt;p&gt;The web app is put together with &lt;a href=&quot;http://shiny.rstudio.com/&quot;&gt;shiny&lt;/a&gt; and &lt;a href=&quot;https://rstudio.github.io/leaflet/&quot;&gt;leaflet&lt;/a&gt;.  This next snippet of blog assumes the reader knows the basics of Shiny and is interested in specifics related to this app.&lt;/p&gt;

&lt;p&gt;The source code of the Shiny app is at &lt;a href=&quot;https://github.com/ellisp/nzelect/tree/master/examples/leaflet&quot;&gt;https://github.com/ellisp/nzelect/tree/master/examples/leaflet&lt;/a&gt;.  There’s some prep done to create the necessary data files elsewhere in the repository at &lt;a href=&quot;https://github.com/ellisp/nzelect/blob/master/prep/shiny_prep.R&quot;&gt;https://github.com/ellisp/nzelect/blob/master/prep/shiny_prep.R&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;updating-an-existing-map&quot;&gt;Updating an existing map&lt;/h3&gt;
&lt;p&gt;I won’t go through it line by line but will point out one interesting feature now available with leaflet and R.  The &lt;code&gt;leafletProxy()&lt;/code&gt; function in the &lt;code&gt;leaflet&lt;/code&gt; package, in combination with &lt;code&gt;observe()&lt;/code&gt; from &lt;code&gt;shiny&lt;/code&gt;, let’s you delete or redraw elements of an existing leaflet map that the user has zoomed in or out on and changed its location, without redrawing the whole map.  This is essential for a decent user experience and wasn’t in the early releases of the &lt;code&gt;leaflet&lt;/code&gt; R package.&lt;/p&gt;

&lt;p&gt;In case someone else is interested in it here is an excerpt from the &lt;code&gt;shiny.R&lt;/code&gt; file of my Shiny app showing how the existing map &lt;code&gt;MyMap&lt;/code&gt; gets circles added to it when the reactive object &lt;code&gt;the_data()&lt;/code&gt; changes as a result of the user picking a new political party to show.  In this case, a new set of circles is added with &lt;code&gt;addCircleMarkers()&lt;/code&gt;, superimposed over whatever is currently on the map.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;observe&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;     leafletProxy&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MyMap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;df&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;            addCircleMarkers&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;WGS84Longitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;WGS84Latitude&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;                             color &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; the_data&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;thecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                             radius &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;prop &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; input&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;sc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                             popup &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;lab&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Similarly, here’s the trick I use to clear all the circle markers when the user presses the button labelled “Clear all parties”.  That button increases the value of &lt;code&gt;input$clear1&lt;/code&gt; by one, and by referring to it inside an observer with the otherwise pointless &lt;code&gt;x &amp;lt;- input$clear1&lt;/code&gt; (see below) I activate that observer, which then updates the selected party to be blank, and clears all the markers off &lt;code&gt;MyMap&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;observe&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;        x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; input&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;clear1
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;        updateSelectInput&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;session&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; selected &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;        leafletProxy&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;MyMap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; clearMarkers&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;that-watercolour-background&quot;&gt;That watercolour background…&lt;/h3&gt;
&lt;p&gt;The beautiful (I think) water colour background, with just enough labels on it to let you know where you are but not clutter it up like the usual roadmap, comes from overlaying &lt;a href=&quot;http://maps.stamen.com/#terrain/12/37.7706/-122.3782&quot;&gt;Stamen&lt;/a&gt; &lt;code&gt;Watercolor&lt;/code&gt; and &lt;code&gt;TonerLabels&lt;/code&gt; layers.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;That’s all for today.  Happy &lt;a href=&quot;https://ellisp.shinyapps.io/NZ-general-election-2014/&quot;&gt;exploring the fine grained details of New Zealand voting locations&lt;/a&gt;.  If you spot a bug or other issue with the map please &lt;a href=&quot;https://github.com/ellisp/nzelect/issues&quot;&gt;file an issue with the &lt;code&gt;nzelect&lt;/code&gt; project&lt;/a&gt;.  If you just want to comment on this post or anything related, use comments section below.&lt;/p&gt;
</description>
				<pubDate>Sat, 09 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/09/nzelect3</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/09/nzelect3</guid>
			</item>
		
			<item>
				<title>Election analysis contest entry part 2 - building the nzelect R package</title>
					<description>&lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;This post is the second in a series that make up my entry in &lt;a href=&quot;http://www.arilamstein.com/blog/2016/03/28/announcing-r-election-analysis-contest/&quot;&gt;Ari Lamstein’s R Election Analysis Contest&lt;/a&gt;,  &lt;a href=&quot;/blog/2016/04/03/nzelect1/&quot;&gt;Yesterday&lt;/a&gt; I introduced the &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;&lt;code&gt;nzelect&lt;/code&gt; R package&lt;/a&gt; from a user perspective.  Today I’m writing about how the build of that package works.  This might be of interest to someone planning on doing something similar, or to anyone who wants to contribute to &lt;code&gt;nzelect&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Here’s today’s themes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Structure - separation of the preparation from the package&lt;/li&gt;
  &lt;li&gt;Modular code&lt;/li&gt;
  &lt;li&gt;Specific techniques - combining multiple CSVs, and overlaying spatial points and shapefiles&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;structure&quot;&gt;Structure&lt;/h2&gt;
&lt;p&gt;Here’s the directory structure within the Git repo that builds this package, with the individual files in the key &lt;code&gt;./prep/&lt;/code&gt; folder shown on the right:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0036-structure.png&quot; alt=&quot;structure&quot; /&gt;&lt;/p&gt;

&lt;p&gt;You can view, fork and clone the whole project for yourself if interested from &lt;a href=&quot;https://github.com/ellisp/nzelect&quot;&gt;GitHub&lt;/a&gt;.  The code excerpts in this blog post won’t run if you just paste them into R; they need a specific folder structure that comes from running them in a clone of the main project.&lt;/p&gt;

&lt;p&gt;Conceptually, there are three main parts of this project:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;downloads and data munging that need to be done separately to the published R package, and which include products like data tidying scripts and downloaded raw data which must not be included in the package itself.  This comprises the &lt;code&gt;prep&lt;/code&gt; and  &lt;code&gt;downloads&lt;/code&gt; folders&lt;/li&gt;
  &lt;li&gt;The R package itself, which is in the &lt;code&gt;pkg&lt;/code&gt; folder and includes subdirectories for &lt;code&gt;data&lt;/code&gt;, &lt;code&gt;man&lt;/code&gt;, &lt;code&gt;R&lt;/code&gt; and &lt;code&gt;tests&lt;/code&gt; folders&lt;/li&gt;
  &lt;li&gt;secondary material which depends on the R package being in existence and installed, such as the &lt;code&gt;README&lt;/code&gt; for the GitHub repo, extended examples in &lt;code&gt;examples&lt;/code&gt; including a Shiny app which will be the subject of the next post, etc.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There’s also various administrative stuff, such as the &lt;code&gt;.git&lt;/code&gt; folder holding the version control database, &lt;code&gt;.Rproj.user&lt;/code&gt; holding information on the RStudio project, the &lt;code&gt;travis.yml&lt;/code&gt; file that sets up hooks from GitHub to Travis Continuous Integration, and &lt;code&gt;nzelect.Rcheck&lt;/code&gt; holding the latest version of the R package build checks.&lt;/p&gt;

&lt;p&gt;This is a typical structure for me.  I generally don’t like an R package based in the root folder of a project.  I nearly always have a bunch of stuff I want to do - prep and extended examples - that I don’t want in the built and published version of the package for end users, but I do want kept together with the code building the package in a single RStudio project and Git repository.&lt;/p&gt;

&lt;p&gt;The project is held together by a script entitled &lt;code&gt;build.R&lt;/code&gt;.  In other projects this would make sense as a &lt;code&gt;makefile&lt;/code&gt; but my workflow with &lt;code&gt;nzelect&lt;/code&gt; is quite interactive (I pick and choose which files to run during development) and I’m more comfortable doing that with an R script.  In principle it should work if run end to end with a fresh clone of the repository, and it looks like this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#./build.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Builds (from scratch if necessary for a fresh clone) the nzelect R package&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------functionality------------&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;knitr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;devtools&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------downloads---------------&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# These are one-offs, and separated from the rest of the grooming to avoid&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# repeating expensive downloads&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# About 1MB worth of voting results:&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/download_votingplace_results.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# About 130MB of shapefiles / maps, used for locating voting places in areas:&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/download_map_shapefiles.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------tidying----------------&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# import all the voting results CVS and amalgamate into a single object&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/tidy_votingplace_results.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 30 seconds&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download and import the actual locations.  Includes a 575KB download.&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script also calls ./prep/match_locations_to_areas.R from within itself &lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# (takes a few minutes to run because of importing shapefiles, downloaded earlier):&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/import_votingplace_locations.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 3 minutes&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Down the track there might be some import of economic and sociodemographic&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# data here; currently only in development&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# munge data for Shiny app and prompts to deploy it:&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;prep/shiny_prep.R&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#--------------build the actual package---------&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create helpfiles:&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;document&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# unit tests, including check against published totals&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;test&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create README for GitHub repo:&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;knit&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;README.Rmd&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;README.md&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# run pedantic CRAN checks&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;check&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# currently fail due to inputenc LaTeX compile prob&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create .tar.gz for CRAN or wherever&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;build&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;pkg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;modular-code&quot;&gt;Modular code&lt;/h2&gt;
&lt;p&gt;Looking at that &lt;code&gt;build.R&lt;/code&gt; script introduces my second theme for today - modularity.  I have separate scripts for different tasks such as “download election results”, “download shapefiles” and “tidy voting place results”.  This makes development easier to keep track of, and easier to run and debug a whole script at once without repeating expensive processes like downloads.  Note that the downloaded data isn’t tracked by Git - that would bloat out the repository too much, so all downloads are covered in the .gitignore instead.&lt;/p&gt;

&lt;p&gt;Some of those scripts are very short.  For example, &lt;code&gt;download_map_shapefiles.R&lt;/code&gt; is only 8 lines long including blanks:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/download_map_shapefiles.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# We want 2014 boundaries&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;download.file&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;http://www3.stats.govt.nz/digitalboundaries/annual/ESRI_Shapefile_Digital_Boundaries_2014_Generalised_12_Mile.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;              destfile &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014_boundaries.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mode &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;wb&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;unzip&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014_boundaries.zip&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exdir &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This sort of thing is key for maintainability.  If multiple people are working on a project, it also stops them treading on eachothers’ toes working on the same files at once.&lt;/p&gt;

&lt;h2 id=&quot;specific-techniques&quot;&gt;Specific techniques&lt;/h2&gt;
&lt;p&gt;I won’t go through the whole project - that’s easiest done for yourself if interested from a clone of it - but will highlight three more things.&lt;/p&gt;

&lt;h3 id=&quot;munging-the-electoral-commission-csvs&quot;&gt;Munging the Electoral Commission CSVs&lt;/h3&gt;
&lt;p&gt;The 2014 general election results are published on the web in the form of 71 CSV files for candidate vote (one per electorate) and 71 CSV files for party vote.  Each CSV has data on each voting place used by voters enrolled in the electorate (voting places are not necessarily physically in the electorate).  Here’s a screenshot of a typical CSV:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0036-csv.png&quot; alt=&quot;csv&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As can be seen, they go some way towards being nicely machine readable, but are not yet in tidy shape.&lt;/p&gt;

&lt;p&gt;Some features of these CSVs include:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;the name of the electorate is in cell A2&lt;/li&gt;
  &lt;li&gt;the main body of data starts in row 3&lt;/li&gt;
  &lt;li&gt;column A of the main data represents suburb, and a blank represents “same as previous entry”&lt;/li&gt;
  &lt;li&gt;the final row of the main data (not shown) is always a Total, followed by a row that is blank for columns A:E&lt;/li&gt;
  &lt;li&gt;below the main data rectangle there is a secondary rectangle of data (not shown) with data on candidates that is otherwise not presented (ie which party the candidates represent) as well as sum totals of their votes&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Luckily, each CSV has an identical pattern - not identical numbers of rows and columns, but enough pattern that it is possible to programmatically identify the main data rectangle.  For example, after skipping the first three rows, the next empty cell in column B indicates the main data rectangle is finished, and the row above that cell is the sum total (which needs to be excluded).  Here’s the part of the tidying script that deals with those candidate CSVs:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/tidy_votingplace_results.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imports previously downloaded CSVs of election results by voting place.&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# So far only for 2014 General Election&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================2014======================================&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;number_electorates &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;71&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------------2014 candidate results-------------------&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;filenames &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/elect2014/e9_part8_cand_&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;number_electorates&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.csv&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;results_voting_place &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;number_electorates&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# What is the electorate name?  Is in cell A2 of each csv&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;    electorate &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filenames&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; skip&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; nrows&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; header&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;                           stringsAsFactors&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fileEncoding &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;UTF-8-BOM&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)[,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# read in the bulk of the data&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filenames&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; skip&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; check.names&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                    stringsAsFactors&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fileEncoding &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;UTF-8-BOM&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# read in the candidate names and parties&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;    first_blank &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;which&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;    candidates_parties &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[(&lt;/span&gt;first_blank &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;    candidates_parties &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;                                &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# we knock out all the rows from (first_blank - 1) (which is the total)&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;first_blank &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ApproxLocation&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;VotingPlace&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# in some of the data there are annoying subheadings in the second column.  We can&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# identify these as rows that return NA when you sum up where the votes should be&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;is.na&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;))})),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# need to fill in the gaps where there is no polling location&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;    last_ApproxLocation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;            tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; last_ApproxLocation
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;            last_ApproxLocation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;  
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;c1&quot;&gt;# normalise / tidy&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Total Valid Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;        gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Votes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ApproxLocation&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;VotingPlace&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;    
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;    tmp&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Electorate &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; electorate
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;    tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;        left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;candidates_parties&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;    results_voting_place&lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; tmp
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# combine all electorates&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;candidate_results_voting_place &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;do.call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;rbind&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; results_voting_place&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;    mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;           Party &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;M..ori Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;           VotingType &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;overlaying-shapefiles&quot;&gt;Overlaying shapefiles&lt;/h3&gt;
&lt;p&gt;One important task was to take the point locations (in NZTM coordinates) of the 2,500 or so voting places and determine which meshblock, area unit, Territorial Authority and Regional Council each was in.  Luckily this is a piece of cake with the &lt;code&gt;over()&lt;/code&gt; function from the &lt;code&gt;sp&lt;/code&gt; package.  The process is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;import a shapefile of the boundaries we want (the originals are at http://www.stats.govt.nz/browse_for_stats/Maps_and_geography/Geographic-areas/digital-boundary-files.aspx and a script in the project downloads the versions for 2014) into R as a &lt;code&gt;sp::SpatialPolygonsDataFrame&lt;/code&gt; object&lt;/li&gt;
  &lt;li&gt;use the proj4string from that shapefile to help convert the NZTM coordinates into a &lt;code&gt;sp::SpatialPoints&lt;/code&gt; object&lt;/li&gt;
  &lt;li&gt;use &lt;code&gt;sp::over()&lt;/code&gt; to map the SpatialPoints to the SpatialPolygonsDataFrame.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/match_locations_to_areas.R&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Peter Ellis, April 2016&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# depends on the shapefiles having already been downloaded from&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ./prep/download_map_shapefiles.R; and Locations2014 to have&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# been created via .prep/import_votingplace_locations.R&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script then matches those point locations with the polygons&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# of Regional Councils, Territorial Authority, and Area Unit.&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# This script is called from ./prep/import_votingplace_locations.R&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rgdal&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------Import Territorial Authority map------------------&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;TA &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; readOGR&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;downloads/shapefiles/2014 Digital Boundaries Generlised Full&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;s&quot;&gt;&amp;quot;TA2014_GV_Full&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#------------------convert locations to sp format-----------&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;locs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; SpatialPoints&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coords &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Locations2014&lt;span class=&quot;p&quot;&gt;[,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;NZTM2000Easting&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;NZTM2000Northing&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)],&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                      proj4string &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; TA&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;proj4string&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-------------Match to Territorial Authority-------&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;locs2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; over&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;locs&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; TA&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;Locations2014&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;TA2014_NAM &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; locs2&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;TA2014_NAM
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;..&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;unit-tests&quot;&gt;Unit tests&lt;/h3&gt;
&lt;p&gt;Any serious coding project needs unit tests so you can be sure that things, once fixed, continue to work as you make changes to other parts of the project.  This applies as much to analytical projects as to software development.  Hadley Wickham’s &lt;code&gt;testthat&lt;/code&gt; package gives a nice structure for including unit tests in the actual check and build of an R package, and I use that in this project.  Here’s some of the tests I’m using, in the &lt;code&gt;./pkg/tests/testthat/&lt;/code&gt; directory:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;testthat&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Must match results from &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://www.electionresults.govt.nz/electionresults_2014/e9/html/e9_part1.html&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# absolute numbers&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1131501&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1081787&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;604535&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Labour Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;801287&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;208300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;New Zealand First Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;73384&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Patriotic Revolutionary Front&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# percentages&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;National Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Party Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;47.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Green Party&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;GE2014&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; Party &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Informal Candidate Votes&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;7.06&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# compare to http://www.electionresults.govt.nz/electionresults_2014/electorate-47.html&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;rotorua &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; GE2014 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;    filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Electorate &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Rotorua 47&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; VotingType &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Candidate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;    group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Candidate&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;    summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;    arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;desc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;Votes&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])),&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;McClay, Todd Michael&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;18715&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])),&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;tolower&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;russell, lyall&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;expect_that&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kp&quot;&gt;as.numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rotorua&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;    equals&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;132&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The three themes for today:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;structure - separating prep, package, and extended use&lt;/li&gt;
  &lt;li&gt;modularity&lt;/li&gt;
  &lt;li&gt;a few specific techniques of data cleaning&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;That’s enough for now.  Stay tuned for the next post in the series, which looks at the Shiny app I built as an extended example of use of the &lt;code&gt;nzelect&lt;/code&gt; package.&lt;/p&gt;
</description>
				<pubDate>Mon, 04 Apr 2016 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2016/04/04/nzelect2</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2016/04/04/nzelect2</guid>
			</item>
		
	</channel>
</rss>