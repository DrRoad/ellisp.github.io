<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Peter&#39;s stats stuff - R</title>
		<description>Posts categorised as 'R'</description>
		<link>http://ellisp.github.io</link>
		<atom:link href="http://ellisp.github.io/feed.R.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Success rates of automated ARIMA fitting</title>
					<description>&lt;h2&gt;A function for testing auto.arima()&lt;/h2&gt;
&lt;P&gt;This is the third, and the last from me on this particular topic for a while, in a series of posts on fitting time series models and comparing time series to eachother, originally inspired by a question on the Cross-Validated Q&amp;A site.  In this week&#39;s post I&#39;m exploring and testing an almost throw-away comment in my original answer - that looking at the parameterisation of an automatically chosen &lt;a href = &quot;https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average&quot;&gt;ARIMA (autoregressive integrated moving average) time series model&lt;/a&gt; is a bad idea because very similar data generating models may quite legitimately be fit by different-looking ARIMA models. I want to look at a corollory to that:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&quot;How successful will an automated ARIMA selection be at returning the order of the original data generating process for a simulated time series?&quot;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;An ARMA process consists of an &quot;autoregressive&quot; AR part (basically, a linear combination of the lagged values of the series) plus a &quot;moving average&quot; MA (a linear combination of a white noise series).  By &quot;order&quot;, I mean the number of lags in the AR part plus the number of lagged white noise values in the MA part.  An AR(1) model is just a coefficient times the lagged value, plus white noise; an MA(1) model is just a coefficient times the lagged value of the white noise, plus white noise; an ARMA(1,1) is a combination of the two.&lt;/p&gt;

&lt;P&gt;In particular, I wanted to explore Rob Hyndman&#39;s excellent auto.arima() function from his &lt;a href = &quot;https://cran.r-project.org/web/packages/forecast/index.html&quot;&gt;{forecast} package&lt;/a&gt;, which uses small-sample corrected Akaike Information Criterion (&lt;a href = &quot;https://en.wikipedia.org/wiki/Akaike_information_criterion#AICc&quot;&gt;AICc&lt;/a&gt;) for model selection.  We use it a lot at my work and I wanted to see how it performs when fitting a dataset that is known to have been created (because we did it ourselves) by an ARMA process of a particular order.  To explore this, I created a function that:&lt;P&gt;
&lt;ol&gt;
&lt;LI&gt;takes as an argument a model specification (eg AR(1) for autoregression of order 1 ie a time series created by a coefficient times its lagged value plus white noise)
&lt;LI&gt;simulates a large number (user controlled) of replications of that series, of a variety of different sample lengths (defaulting to 20, 40, 80, ..., 10240)
&lt;LI&gt;Uses the auto.arima() model to identify the best ARIMA model for each replication of the series
&lt;LI&gt;Stores the order of the final model and compares it against the correct order
&lt;/ol&gt;

&lt;p&gt;Here&#39;s the code for that function:&lt;/P&gt;
 
 
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;forecast&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;arima_fit_sim &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                          correct_params&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                          n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                          reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;                          stepwise &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                          verbose &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# function that creates @reps number of simulated ARIMA models of type @model and &lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# length @n.  @correct_params should be a vector of the correct parameters eg&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# c(&amp;quot;ar1&amp;quot;, &amp;quot;ma1&amp;quot;, &amp;quot;ma2&amp;quot;) for ARMA(1,2)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# peter.ellis2013nz at gmail com 25 September 2015&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;forecast&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;verbose&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)}&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; each &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; reps&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;                      correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;                      fitted &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;                      stringsAsFactors &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   counter &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;j &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;verbose&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;])}&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;         counter &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; counter &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;         true_series &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;j&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;         fit &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; auto.arima&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;true_series&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; stepwise &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; stepwise&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;         results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;counter&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;fitted&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fit&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; collapse &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fit&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct_params&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;names&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fit&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;coef&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; correct_params&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct_params&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;            results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;counter&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;correct&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;            
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;   &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;            results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;counter&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;correct&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;         
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;verbose&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;         results &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;            group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;            summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There&#39;s flaws with this function I didn&#39;t have time to fix.  Most notably, there&#39;s a big risk in that the call to the function needs to specify a vector of parameters eg c(&quot;ar1&quot;, &quot;ma1&quot;) for ARMA(1,1) that has to match the model provided.  A better function would deduce the vector of parameter names from the model structure; if someone knows how to do this simply, let me know.&lt;/P&gt;

&lt;h2&gt;The test&lt;/h2&gt;
&lt;P&gt;For my actual test, I chose to try out two simple simulations - AR(1) and MA(1) processes - and two more complex ones - ARMA(2,2) and ARMA(3,3).  There&#39;s a sticking point which is the actual  autoreggressive and moving average parameters.  An AR(1) process autoregression coefficient of 0.05 for example will be almost indistinguishable from white noise, whereas as it gets closer to 1 it would be much easier for the model selection algorithm to notice.  To do a comprehensive test, I should actually compare models across the whole parameter space.  As this is just a blog post, I arbitrarily chose some values.&lt;/P&gt;

&lt;P&gt;Here&#39;s the code performing the actual tests on those four processes, using my new arima_fit_sim() function with 500 repetitions of each combination of model and sample length.  This took about eight hours to run on my (nothing special) laptop:&lt;/P&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;our_reps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;results_ar1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima_fit_sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;                             correct_params &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ar1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;                             reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; our_reps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;results_ma1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima_fit_sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;                             correct_params &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ma1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;                             reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; our_reps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;results_arma22 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima_fit_sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                                correct_params &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ar1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ar2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ma1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ma2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                                reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; our_reps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;results_arma33 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima_fit_sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;                                correct_params &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;ar1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ar2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ar3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ma1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ma2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ma3&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; 
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;                                reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; our_reps&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;save&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results_ar1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; results_ma1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; results_arma22&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; results_arma33&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; file &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;_output/0012_sim_results.rda&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



&lt;h2&gt;Results&lt;/h2&gt;
&lt;p&gt;My function stores the order (ie how many autoregressive and how many moving average parameters)of the 5000 models it has fit for each simulation.  Here are the ten most common models that were selected in the case of the AR(1) model:
&lt;!-- html table generated in R 3.2.1 by xtable 1.7-4 package --&gt;
&lt;!-- Tue Sep 29 07:22:07 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; fitted &lt;/th&gt; &lt;th&gt; count &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1752 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 316 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 278 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 238 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 224 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 210 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 185 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 140 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 124 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 116 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;&lt;/p&gt;

&lt;p&gt;As a percentage correct for different sample lengths, here&#39;s how they end up:
&lt;!-- html table generated in R 3.2.1 by xtable 1.7-4 package --&gt;
&lt;!-- Wed Sep 30 07:31:01 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; n &lt;/th&gt; &lt;th&gt; correct &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 20 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 29.0 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 40 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 35.0 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 80 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 38.6 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 160 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 31.2 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 320 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 29.8 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 640 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 35.4 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 1280 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 37.2 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 2560 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 37.4 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 5120 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 36.0 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td align=&quot;right&quot;&gt; 10240 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 40.8 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;&lt;/p&gt;


&lt;p&gt;In this simple case, auto.arima() is moderately successful.  It correctly picked an AR(1) model as the best 1752 times out of 5000, much more than the second most popular model which was a very complex ARMA(3,2).  Even when the time series is only 20 observations long it gets it right 29 percent of the time, and this goes up to 41 percent by the time there are 10,000 observations.  I suspect it gets better as the time series gets longer, but I&#39;d (naively) expected better than this.  It certainly means, for example, that when your automated model selection tells you you have an ARMA(3,2) model you should not dismiss the possibility that an AR(1) model might be the true generating process (other information might help you dismiss that of course, including the actual parameters).  I was surprised that even for a longish time series only 41 percent of the time is the true model being recovered. &lt;/P&gt;


&lt;p&gt;Here&#39;s a plot summarising the overall results&lt;/p&gt;
&lt;div class =&quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0012-results.svg&quot;&gt;&lt;/div&gt;

&lt;p&gt;Here it is separated out by facets so we can see that pattern closer.&lt;/p&gt;
&lt;div class =&quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0012-results-faceted.svg&quot;&gt;&lt;/div&gt;

&lt;p&gt;I was a bit astonished at the poor success rate of picking up the ARMA(3, 3) process so I tabulate here the counts of every final model that actually was selected.
&lt;!-- html table generated in R 3.2.1 by xtable 1.7-4 package --&gt;
&lt;!-- Tue Sep 29 07:22:07 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; fitted &lt;/th&gt; &lt;th&gt; count &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 ma2 ma3 ma4 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1446 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 ma5 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 500 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 444 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 ma2 ma3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 339 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 ma2 ma3 ma4 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 276 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 248 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 229 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 168 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 ma2 ma3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 157 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 151 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 115 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 ma2 ma3 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 103 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt;  &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  88 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  61 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  54 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 ma2 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  50 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 ma2 ma3 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  43 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ar5 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  42 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  41 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  32 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  31 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  29 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  28 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  27 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  25 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 ma2 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  24 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  24 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  21 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  19 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  16 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  14 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  13 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  12 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  12 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 ma5 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  12 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 ma4 ma5 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  12 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  11 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  11 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ar5 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   8 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 ma3 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   8 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   7 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ar5 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ma1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 ma2 ma3 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ma1 ma2 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   5 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 ma2 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   4 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   4 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   3 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   2 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   2 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ar4 ma1 drift &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   1 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ar3 ma1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   1 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ar2 ma1 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   1 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; ar1 ma1 intercept &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;   1 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;&lt;/p&gt;
&lt;p&gt;Yes, that&#39;s right, many many models are picked but not a single instance matches the &quot;ar1 ar2 ar3 ma1 ma2 ma3&quot; that was the original data generating process.  So the take home message is even stronger than I thought - don&#39;t pay much attention to the order of your fitted ARIMA models!  This doesn&#39;t mean there&#39;s a problem with using them - they give good fits and work well in many forecasting situations.  But we shouldn&#39;t confuse them with some essential reality of an underlying process.  It&#39;s a striking example of the famous (well in some quarters) quote by George E. P. Box:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href = &quot;https://en.wikiquote.org/wiki/George_E._P._Box&quot;&gt;&quot;All models are wrong, but some are useful&quot; (Box)&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I found all this a bit surprising.  I&#39;d expected a material amount of variation in what models were returned, but not this much.  And I&#39;d expected the model selection process to be more consistent (to use a term loosely) ie converge to the true model more noticeably as sample length got bigger. I presume there&#39;s a literature on all this but didn&#39;t have time to research it, so any pointers are welcomed in the comments or by Twitter.&lt;/p&gt;

&lt;h3&gt;Code that produced the summary tables&lt;/h3&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;results_ar1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;count &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;count&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;results_ar1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;results_arma33 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;count &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fitted&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   arrange&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;count&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;Code that produced the summary plot&lt;/h3&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;r1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results_ar1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;AR(1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;r2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results_ma1 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;MA(1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;r3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results_arma22 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ARMA(2, 2)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;r4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; results_arma33 &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ARMA(3, 3)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;r_all &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;r1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; r2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; r3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; r4&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;factor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;                         levels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;AR(1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;MA(1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ARMA(2, 2)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ARMA(3, 3)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;						 
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; r_all &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correct&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; correct&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; model&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Percent of models correctly identified&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Length of time series&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;c1&quot;&gt;# label = comma, &lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Success rate of automated ARIMA model selection\nfitting to a known data generating process&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1 &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;		facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;model&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; scales &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;free_y&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;		theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Wed, 30 Sep 2015 00:00:00 +1300</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/30/autoarima-success-rates</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/30/autoarima-success-rates</guid>
			</item>
		
			<item>
				<title>How to compare two blackbox timeseries generators?</title>
					<description>&lt;h2 id=&quot;comparing-two-timeseries-generating-blackboxes&quot;&gt;Comparing two timeseries-generating blackboxes&lt;/h2&gt;
&lt;p&gt;In my &lt;a href=&quot;/blog/2015/09/19/timeseries-same-acf/&quot;&gt;last post&lt;/a&gt; I talked about how &lt;a href=&quot;http://stats.stackexchange.com/questions/172226/proving-similarities-of-two-time-series/172353#172353&quot;&gt;this question on Cross-Validated&lt;/a&gt; got me interested.  Basically the challenge is to compare two data generating models to see if they are essentially the same. Since then I’ve noticed that this problem comes up in a number of other contexts too; for example, this New Zealand Treasury Working paper by Kam Leong Szeto on &lt;a href=&quot;http://www.treasury.govt.nz/publications/research-policy/wp/2013/13-18/twp13-18.pdf&quot;&gt;Estimating New Zealand’s Output Gap Using a Small Macro Model&lt;/a&gt; at one point runs lots of sets of two simulations of the New Zealand economy and compares the distribution of the standard deviations of various interesting estimated parameters, and of their first order autocorrelation coefficients (ie the correlation of the series with the lagged version of itself):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0011-szeto-screenshot.png&quot; alt=&quot;szeto&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This latter process of comparing autocorrelation coefficients is similar to what user333700 suggested on Cross-Validated, and is what I showed in my last post is not a bullet-proof means of comparing time series; most importantly, linear combinations of a time series will have the same autocorrelation function. So one of Szeto’s models might be generating values 10 percent larger than the other, but still having the same autocorrelation coefficients in his Figure 2 above. However, as he also compares the standard deviations of the simulated values of interest, he fixes some of that problem (not all of it - just adding a constant, for example, would leave him with identical autocorrelation coefficients and standard deviations, but very different results).&lt;/p&gt;

&lt;h2 id=&quot;my-example-black-boxes&quot;&gt;My example black boxes&lt;/h2&gt;

&lt;p&gt;To explore this for a more general solution, I first need something to try it on. I made two functions that generate data that is close enough to wonder if they are the same, but which a good enough method can distinguish between. I define for myself two similar but different time series, one an ARIMA(2,1,1) process and the other an ARIMA(1,1,2). Here’s one instance each coming out from those black boxes. Notice that they look very different!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0011-one-instance-each.svg&quot; alt=&quot;one-each&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;theme_set&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;bb1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# ARIMA(2, 1, 1) with drift&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;bb2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# ARIMA(1, 1, 2) with drift&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.04&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# one example each from both of my black boxes&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;134&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; mar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;plot.ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bb1&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;One instance from blackbox 1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;plot.ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bb2&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;One instance from blackbox 2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So those two series look obviously different, right, no need for any fancy stats to say they’re different… except that if you make lots of examples of them, you get a different result each time. Here’s how they look when we do 100 instances of each one, 500 observations long each:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0011-hundred-reps.svg&quot; alt=&quot;hundred-each&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create skeleton of dataframe to hold data:&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;the_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;blackbox1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; blackbox2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; trial &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# populate with simulated versions:&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;reps &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;n &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for reproducibility&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;blackbox1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; bb1&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; blackbox2 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; bb2&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; trial &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   the_data &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rbind&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;the_data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; tmp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# gather into long tidy format&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;the_data_m &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; the_data &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;time&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# show the data from the two black boxes:&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;the_data_m &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; value&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;as.character&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;      facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      geom_smooth&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;se &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; method &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;loess&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;comparison-method&quot;&gt;Comparison method&lt;/h2&gt;

&lt;p&gt;My method of comparison is based on assuming blackbox1 is the known good generator and we want to see if blackbox2 is plausibly the same. I do these steps:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;calculate the average value at each point in time of the various instances of blackbox1, and the standard deviation of blackbox1’s values at that point.&lt;/li&gt;
  &lt;li&gt;calculate how the absolute value of how different each instance of both series is from that average value, standardised by the standard deviation.&lt;/li&gt;
  &lt;li&gt;correct that difference value for blackbox1 by multiplying it by the (number of instances) / (number of instances - 1), to control for the fact that the centre was defined by blackbox1 data and hence blackbox1 has a head start in trying to be close to the defined centre. In effect, I give it a degrees-of-freedom correction.&lt;/li&gt;
  &lt;li&gt;analyse the distribution of the differences to see if the instances of blackbox2 seem, on average, to be further away from the centres than are the instances of blackbox1.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here’s how it looks. In this case, blackbox2’s differences from the known-good centre is generally higher (ie displaced to the right in this density graph) than is blackbox1’s:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0011-density-differences.svg&quot; alt=&quot;density&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;difference &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; the_data_m &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   left_join&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;      the_data &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;         group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;time&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;         summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;centre_1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;blackbox1&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                   sd_1 &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sd&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;blackbox1&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;      by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;time&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# bias correction because the centres are defined from blackbox1&amp;#39;s data,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# hence on average they will always be a little closer to them&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;correction &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blackbox1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trial&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;      meandiff &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;value &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; centre_1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; sd_1 &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; correction&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;difference&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;meandiff&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;      geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Mean absolute standardise difference\nat each time point from the average of\nblackbox1 at that point&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I want a more formal method of comparing the two and testing for data to reject a hypothesis of the two black boxes being the same.  An obvious candidate is a linear regression model with the mean corrected standardised difference of each trial instance as response variable, and source (blackbox 1 or 2) as the explanatory variable.  However, the truncated nature of the differences (they are absolute differences, so are all zero or higher and there is a long tail) mean that ordinary least squares is probably a poor way of performing inference on them.  This is shown (probably unnecessarily) in the top right of the standard set of diagnostic plots below:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0011-regression-diagnostics.svg&quot; alt=&quot;diagnostics&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;model1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; lm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;meandiff &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; difference&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# definitely normality assumption violated, so let&amp;#39;s try something a bit more robust&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;There are various possible solutions but I go with using Venables and Ripley’s implementation of an M estimator in rlm(), in combination with bootstrapping.  This minimises any assumptions I need to make about distributions, and controls for awkward outliers.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;MASS&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;boot&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;R &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;booted_robust &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; boot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;difference&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;                      statistic &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; w&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                         model &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; rlm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;meandiff &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;w&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;   
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;                         &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;coefficients&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;sourceblackbox2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; R &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; R&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# p-value for one sided test of H-null no difference v. H-alt blackbox2 &lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# is more different from blackbox1 centresthan blackbox1:&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;booted_robust&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;t &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; R&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;For the given example, the p-value comes out as zero ie there is no chance that the observed differences could be a result of the same blackbox generating different data at random.  Re-running the exercise with various tests (eg comparing bb1() with bb1()) shows that the process is pretty good at not returning false positives; and it does correctly identify any true positives I’ve given it so far.  More rigorous testing would be possible, but…&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;After all this, I’m not sure where I’ve come out.  I think I have a pretty good method for telling whether two black box time series generators are identical; but does it really matter?  Going back to the &lt;a href=&quot;http://stats.stackexchange.com/questions/172226/proving-similarities-of-two-time-series/172353#172353&quot;&gt;original question on Cross-Validated&lt;/a&gt;, I guess the OP &lt;em&gt;knew&lt;/em&gt; that they were different.  So proving this tells him nothing.  Black box 2 is a model of Black box 1, and the question really is not whether it is right, but whether it is “right enough”.  Unfortunately, I don’t think there’s a rigorous objective way of determining that.  Some kind of cost function for wrongness could be developed and assessed against, but the choice of cost function will probably be subjective (maybe not, depending on the field I suppose).&lt;/p&gt;

&lt;p&gt;This is not unrelated to a common issue in modern data analysis - with enough data, any hypothesis test is “significant”.  The more so in this situation, where we control the data generating processes and hence can keep creating more data until a difference, no matter how subtle, is conclusively proven.&lt;/p&gt;

&lt;p&gt;My feel is that this sort of problem needs to go back to expert judgement aided by the best exploratory analytics graphics available.  So the approach by Szeto in the Treasury working paper linked to above is a good one, although I think that more than the standard deviations and autocorrelations need to be graphed.  It’s &lt;em&gt;known&lt;/em&gt; that the two black boxes are different - all statistics can do is help you in the judgement of whether the difference is too much or not.  So the best benefit of all the text and code above might be to give a few ideas for &lt;em&gt;starting points&lt;/em&gt; in how to explore these differences.&lt;/p&gt;
</description>
				<pubDate>Sun, 20 Sep 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/20/timeseries-differences</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/20/timeseries-differences</guid>
			</item>
		
			<item>
				<title>Autocorrelation functions of materially different time series</title>
					<description>&lt;h2 id=&quot;comparing-two-timeseries-generating-blackboxes&quot;&gt;Comparing two timeseries-generating blackboxes&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://stats.stackexchange.com/questions/172226/proving-similarities-of-two-time-series/172353#172353&quot;&gt;This question on Cross-Validated&lt;/a&gt; got me interested.  I gave a fairly inadequate answer and want to explore a few of the issues.  Actually, I have a plan for an effective technique which is what I think the original post was asking for, but I need to check out a few things first.&lt;/p&gt;

&lt;p&gt;The challenge, if I understand correctly, is this:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;We have one model we are confident generates a set of data that accurately represents what will actually happen in the epidemic. For some reason (presumably because it’s expensive or slow to build and run, or there’s theoretical interest in a simple equation that generates similar results to the complex model), we have an additional model which can also generate a set of data, and we want to check if the version generated by this model is close to the version generated by the known-good model.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;In effect, we have two blackbox time series generators.  The question of interest is&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Does blackbox 2 generate time series that are “similar” to those generated by blackbox 1?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;My substantive approach to answering that question will come in a later post.  First I want to look at an issue raised in a comment against my answer on the Cross-Validated site.  In my answer, I said that it was a bad idea to compare the best ARIMA models of datasets generated by the two black boxes because there was no easy way to go from the parameterisation of those models to an estimate of similarity.  Models that look different in their parameterisation can have very similar material impacts (and, probably, vice versa).  The comment from user333700 suggested that comparing impulse response functions, spectral densities or autocorrelation functions might be a way around this. Today’s post is just about demonstrating that even this isn’t necessarily a get out of jail card, at least as far as autocorrelation functions are concerned.&lt;/p&gt;

&lt;p&gt;There’s nothing really new in here, just me clearing the decks as part of my thinking through how I’m going to answer the main question.  Obviously, I’m getting beyond the scope of an answer on Cross-Validated, and I had to record my musings somewhere…&lt;/p&gt;

&lt;h2 id=&quot;linear-combinations-of-a-stationary-timeseries-give-identical-autocorrelation-functions-but-materially-different-original-data&quot;&gt;Linear combinations of a stationary timeseries give identical autocorrelation functions but materially different original data&lt;/h2&gt;
&lt;p&gt;The heading above says it all - it follows from the definition of the autocorrelation function - and here’s the demonstration.  I create a stationary ARMA(2, 1) time series with 1,000 observations.  series1 is just the original process; and series2 is the original process multiplied by 3 and adding 2.  This makes a big difference to the substance of the data - much larger observations - but gives the same autocorrelation function.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;arma_1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------a linear combination of a stationary time series has the same acf-------&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;series1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma_1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;series2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma_1 &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Original series&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Original * 3 + 2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0010-ts-acf-1.svg&quot; alt=&quot;image1&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;different-individual-instances-of-the-same-non-stationary-time-series-have-similar-acf-but-vary-materially-in-their-original-data&quot;&gt;Different individual instances of the same non-stationary time series have similar ACF but vary materially in their original data&lt;/h2&gt;
&lt;p&gt;Again, the heading says it all.  In this case, I generate two separate instances from an identical ARIMA(2, 2, 1) data generating process.  One grows steadily up, the other grows steadily down.  If they were real life data and you had only those two series, you would say they were radically different.  But the autocorrelation functions of the original two series are similar:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0010-ts-acf-2.svg&quot; alt=&quot;image2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;and so are the autocorrelation functions of the two series after we take the differences of the differences:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0010-ts-acf-3.svg&quot; alt=&quot;image3&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;arma_1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;234&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;arma_2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; arima.sim&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;model &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ar &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-0.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; ma &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;series3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma_1&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;series4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;cumsum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;arma_2&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# original data&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;First instance of ARIMA(2, 2, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Second instance of same ARIMA(2, 2, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation function&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# differences of differences&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;par&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mfrow &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;First instance of ARIMA(2, 2, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Second instance of same ARIMA(2, 2, 1)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation of second differences&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Autocorrelation of second differences&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series3&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation\nof second differences&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;acf&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;series4&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;partial&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; main &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Partial autocorrelation\nof second differences&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;user333700 would probably say, rightly, that this is a demonstration of how comparing autocorrelation functions of two series is in fact an effective way of identifying whether they plausibly come from the same data generating process.  In this instance, that is exactly what has happened.  However it begs the question of whether plausibly coming from the same DGP is really what the original post wanted.  With such materially different series - one showing strong positive growth, the other showing strong negative growth, does it matter that both can be modelled with a similar ARIMA model?  More important is something like “does blackbox1 always show strong positive growth and blackbox2 always strong negative growth?”&lt;/p&gt;

&lt;p&gt;This second example of how similar autocorrelation functions come from different time series relates to something I’ll take up when I answer the substantive original question.  A big part of the challenge is that each time the blackbox is run it is a random process and a different set of data will come out.  It might be radically different, so we need more than one example from each blackbox (the more the better) to form a view on whether they are similar or not.  To answer this properly, we need more data from the blackboxes, and not to confuse them with our fitted models.  More on that later.&lt;/p&gt;

</description>
				<pubDate>Sat, 19 Sep 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/19/timeseries-same-acf</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/19/timeseries-same-acf</guid>
			</item>
		
			<item>
				<title>Sampling distribution of Gini coefficient</title>
					<description>&lt;h2 id=&quot;inequality-measures&quot;&gt;Inequality measures&lt;/h2&gt;

&lt;p&gt;Part of my motivation for &lt;a href=&quot;/blog/2015/08/15/importing-nzis-surf/&quot;&gt;importing the New Zealand Income Survey&lt;/a&gt;(NZIS) simulated unit record file provided by Statistics New Zealand was to explore the characteristics of various measures of inequality.  In particular, I’m interested in what happens to the &lt;a href=&quot;https://en.wikipedia.org/wiki/Sampling_distribution&quot;&gt;sampling distributions&lt;/a&gt; as sample size changes of the following summary statistics:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Gini coefficient (ie the area between a Lorenz curve and the line of perfect equality)&lt;/li&gt;
  &lt;li&gt;P90/P10 (ie income at the 90% richest percentile divided by that at the 10% percentile)&lt;/li&gt;
  &lt;li&gt;P80/P20 (as above, but the 80 and 20 percentiles&lt;/li&gt;
  &lt;li&gt;Top 1% income as a percentage of all income&lt;/li&gt;
  &lt;li&gt;Top 0.1% income as a percentage of all income&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;A Lorenz curve is an attempt to show the full shape of the income distribution at once.  It maps the cumulative proportion of the population against the cumulative proportion of income (or whatever variable of interest) that they own.  In the example below, you can read that the poorest 50% of New Zealand individuals, for example, earn around 13% of total income in a given week&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0008-lorenz.svg&quot; alt=&quot;lorenz-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This plot was produced with the following R code, which requires the data to have been imported to a database called PlayPen in accordance with the &lt;a href=&quot;/blog/2015/08/15/importing-nzis-surf/&quot;&gt;previous post&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ineq&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# for Lc and Gini&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;stringr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# for str_wrap&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_Prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;inc &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;select income from vw_mainheader&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;lorenz &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; Lc&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;lorenz_df &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;prop_pop &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lorenz&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;p&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; income &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lorenz&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;L&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;prop_equality &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; prop_pop&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lorenz_df&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; prop_pop&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   geom_ribbon&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ymax &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; prop_equality&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ymin &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;yellow&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   geom_abline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;slope &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; xintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;\nCumulative proportion of population&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Cumulative proportion of income\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; percent&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.53&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Inequality\ngap&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Complete equality line&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; angle &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   ggtitle &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;      str_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Cumulative distribution of New Zealand individual weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;46&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Source: Statistics New Zealand\nNational Income Survey 2011 SURF&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;       gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;choice-of-measures&quot;&gt;Choice of measures&lt;/h3&gt;
&lt;p&gt;Income inequality is notoriously difficult to measure, and the P90/P10 and P80/P20 measures are attempts to deal with the patchy information available particuarly at the top level (the super rich don’t slum it filling in surveys, and are often expected to be particularly disinclined to reveal how rich they are voluntarily; and there are strong incentives to minimise income in a tax context).  However, the P90/P10 and similar measures have been criticised (for example, by Thomas Picketty in  his excellent book &lt;a href=&quot;http://www.amazon.com/Capital-Twenty-First-Century-Thomas-Piketty/dp/1491534656&quot;&gt;Capital in the 21st Century&lt;/a&gt;) on several grounds, the most important of which seem to me to be:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;They ignore what is going on in the top 10% or top 20%, which might be precisely the point of most interest&lt;/li&gt;
  &lt;li&gt;They are unstable, because by dividing by the income (or wealth) measure of the lowest 10% or 20% you are dividing by a very low number, and small changes in measurement (for example, how one counts household furniture, if looking at wealth inequality) make big changes to the measure even though inequality to most minds is unchanged.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These arguments seem to me cogent, although I see reasons for keeping those measures too.  Picketty prefers to talk about the income or wealth of the bottom 50%, the next 40%, then the top 10% and 1%.  He dislikes the Gini coefficient because it is difficult to explain (on which I agree with him) and for not really showing the true inequality (on which I disagree).  I disagree on the latter point because I think that the Gini coefficient is actually the logical extension of his approach of looking at the cumulative income or wealth of the bottom 50%, next 40% etc; all the Gini coefficient does is take it to the extreme, and it gives a genuinely good measure of total inequality (assuming the source data are ok), including the impact of the top 10%, 1%, 0.1%, etc.&lt;/p&gt;

&lt;h2 id=&quot;gini-coefficient&quot;&gt;Gini coefficient&lt;/h2&gt;
&lt;p&gt;The curve above yields a Gini coefficient of 0.51, which is high compared to the Gini coefficients that are commonly reported.  For example &lt;a href=&quot;http://www.stats.govt.nz/browse_for_stats/snapshots-of-nz/nz-social-indicators/Home/Standard%20of%20living/income-inequality.aspx&quot;&gt;Statistics New Zealand via the OECD report a Gini coefficient of 0.33&lt;/a&gt; for household income.  There are three reasons (at least) for the discrepancy, which make the NZIS a poor choice for inequality measures that are comparable to the most commonly used (although still ok for my purposes):&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The NZIS is an individual measure, whereas most reported measures are done at the household level.  In previous posts I’ve discussed the large numbers of zero income individuals in the NZIS.  Many of these will be part of households with positive total income, contributing to a lower level of inequality in a household-based measure.  There’s arguments for both methods, I think - it’s not hard to imagine the &lt;a href=&quot;https://scholar.google.co.nz/scholar?q=feminist+critique+of+measuring+income+at+the+household+level&amp;amp;hl=en&amp;amp;as_sdt=0&amp;amp;as_vis=1&amp;amp;oi=scholart&amp;amp;sa=X&amp;amp;ved=0CBkQgQMwAGoVChMIjrKF6t3wxwIVR8emCh17uwXw&quot;&gt;feminist argument for paying more attention to intra-household income differences&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;Conventionally these sorts of measures are done on an annual basis.  Again, this will lead to a more equal distribution than a snapshot of a single week.  There’s nothing magic about annual income (why not ten years? per lifetime? or a month?), but it is a strong and understandable convention.&lt;/li&gt;
  &lt;li&gt;Most income inequality measures are based on income after taxes and transfers (or if both before and after are used, more emphasis is usually given to ‘after taxes and transfers’).  My interpretation of the “gross weekly income from all sources” described in the &lt;a href=&quot;http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&quot;&gt;technical notes for the NZIS SURF&lt;/a&gt; is that it represents income after transfers, but prior to tax.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Let’s be clear - I’m not saying my Gini coefficient is better than Statistics New Zealand’s.  If anyone claims I’m criticising the official measure you’re misrepresenting me and please don’t!  In this post, I’m exploring the technical characteristics of estimates of Gini coefficients, and I happen to have weekly, individual gross income rather than annual, household, after taxes-and-transfers income to do it with.&lt;/p&gt;

&lt;h3 id=&quot;weekly-versus-annual-measures&quot;&gt;Weekly versus annual measures?&lt;/h3&gt;
&lt;p&gt;Let’s explore that weekly issue a bit more.  Consider two extremes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;If everyone’s weekly income is unchanging and the week that we’ve sampled is representative of every week for them, the annual inequality will be identical to the weekly ie 0.51&lt;/li&gt;
  &lt;li&gt;If income in one week bears no relation to income in the other weeks, but each week an individual gets a random draw from the pool of possible incomes, the annual inequality will be substantively less - around 0.09&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For those not familiar with the Gini coefficient, 1 means complete inequality (ie one person receives all the income) and 0 means complete inequality (everyone gets exactly the same income).  0.09 is far lower than any observed economic inequalities, and reflects the absurdity of everyone’s weekly income being random - cleaners don’t spend the occasional week as CEO of a large firm.  However, one certainly expects some degree of smoothing.&lt;/p&gt;

&lt;p&gt;Taking all those factors into account, the weekly individual income Gini coefficient of 0.51 does not contradict the official household annual figure of 0.33 (which is a relief, of course).  Here’s how I worked out that 0.09 number, with a little simulation based on resampling the observed data:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;Gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                   &lt;span class=&quot;c1&quot;&gt;# 0.51&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# if completely constant each week&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;Gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;52&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;              &lt;span class=&quot;c1&quot;&gt;# 0.51&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create incomes that simulate each week being a random pull from the pool&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;random_incomes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   income &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;52&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; replace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   person &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;52&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;  
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   group_by&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;person&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   summarise&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;Gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;random_incomes&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# 0.09&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;must-be-positive-non-zero&quot;&gt;“Must be positive non zero”?&lt;/h3&gt;
&lt;p&gt;The literature on Gini coefficients says it can only be fitted to positive, non zero data but I see no practical problem with fitting them to a dataset with zeroes and negative values, even one with a &lt;a href=&quot;http://ellisp.github.io/blog/2015/09/05/creating-a-scale-transformation/&quot;&gt;large number of zeroes like the NZIS&lt;/a&gt;.  Including negative numbers means the Lorenz curve briefly dips below zero, and it becomes possible to have a Gini coefficient greater than 1 (for example, if one person has a positive income and everyone else has negative), but this doesn’t strike me as a reason for not using it.  The result is intuitively ok and there are no computational difficulties so long as at least one number is positive and the sum of the positive numbers is enough to outweigh the sum of the negative numbers.  If anyone can think of a reason for only applying Gini coefficients and Lorenz curves to strictly positive data let me know.&lt;/p&gt;

&lt;h3 id=&quot;sampling-distribution-of-a-gini-coefficient&quot;&gt;Sampling distribution of a Gini coefficient&lt;/h3&gt;
&lt;p&gt;So the question I’m seeking to answer is, how do inequality statistics like the Gini coefficient and the others stand up with small samples of real data?  Putting aside non-sampling error (like people misleading the interviewers), what happens with a smaller survey?  I know from &lt;a href=&quot;http://www.statsdirect.com/help/default.htm#nonparametric_methods/gini.htm&quot;&gt;various sources online&lt;/a&gt; that “The small sample variance properties of G are not known, and large sample approximations to the variance of G are poor”.&lt;/p&gt;

&lt;p&gt;I’m interested in both the shape of the distribution of estimates of these figures, and their standard errors ie how far out from the “true” value we’d expect the estimates to be.  The NZIS has a sample of around 29,000; let’s shrink that down to 30 and see how much the estimated Gini coefficient changes with different randomly selected bunches of 30 people, compared to 1,000, and the original sample of around 30,000.  Note that the horizontal axes on the plots below are on differing scales - I did this to keep a visual sense of the shape of the distribution.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0008-density-gini-n30.svg&quot; alt=&quot;n30&quot; /&gt;
&lt;img src=&quot;http://ellisp.github.io/img/0008-density-gini-n1000.svg&quot; alt=&quot;n1000&quot; /&gt;
&lt;img src=&quot;http://ellisp.github.io/img/0008-density-gini-n30000.svg&quot; alt=&quot;n30000&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This estimator behaves better than I thought it would with real data that has all the weird and wonderful extremes we get with individual economic variables.  Certainly by the time the sample size gets up to 1,000 or so there are no outrageous values and the range of estimated values is reasonably narrow, although wide enough to beware of comparisons of small differences at that sample size.  This is in contrast to the sample size of 30, where clearly in one instance we got a sample with one high earner and many zeros or negatives, resulting in a Gini coefficient of more than 1!  Make a note not to estimate a population’s inequality from such a small sample.  For the actual sample size of the New Zealand Income Survey of nearly 30,000, sampling error is negligible.  Now, if only we could say the same for the non-sampling error - so much harder to quantify, so much harder to control for.  But subject for reflections at a later date.&lt;/p&gt;

&lt;p&gt;The above analysis was done by creating a function to conduct the simulation and draw the plot for a given sample size n:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;sim_gini &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; reps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   results &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;      trial &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;      estimate &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;numeric&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for reproducibility&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;reps&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;      results&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;estimate&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; 
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;         Gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;sample&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; replace &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;      ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; estimate&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;      geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;      geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;      theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Distribution of estimated Gini coefficient, n =&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Standard error: &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sd&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;estimate&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;             gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;95% Confidence interval:\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;                    &lt;span class=&quot;kp&quot;&gt;paste&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;quantile&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;results&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;estimate&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.025&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.975&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; collapse &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;, &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;             gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt; 
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;sim_gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;sim_gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;sim_gini&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;30000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Further exploration of the other inequality measures and their distributions will wait for another post, as this one is long enough already.&lt;/p&gt;
</description>
				<pubDate>Sat, 12 Sep 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/12/inequality-stats-distributions</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/12/inequality-stats-distributions</guid>
			</item>
		
			<item>
				<title>Transforming the breaks to match a scale</title>
					<description>&lt;h2 id=&quot;something-missing&quot;&gt;Something missing&lt;/h2&gt;
&lt;p&gt;In &lt;a href=&quot;http://ellisp.github.io/blog/2015/09/05/creating-a-scale-transformation/&quot;&gt;my last post&lt;/a&gt; I developed a new scale transformation for R using the approach and platform from the {ggplot2} and {scales}. I implemented a method proposed in 1980 by John and Draper that does some of the job of a logarithmic transform in reducing the dominance on the page of the large values, but is also continuous through zero and works for negative numbers.  Here’s the image where I demonstrated that:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0006_income_by_region.png&quot; alt=&quot;regions-plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Tweets about the post highlighted a problem with axis labels - no labels at the points where the bulk of the data lie.  This can be fixed by setting the breaks by hand but there should be a way to automate that.  This post records my efforts in this direction. In the image above, you can see the big gap between $0 and $10,000 on the vertical axis (this is showing income per week, so most people are between those two numbers!) and 0 and 50 hours worked per week on the horizontal axis.&lt;/p&gt;

&lt;h2 id=&quot;simulated-example-application&quot;&gt;Simulated example application&lt;/h2&gt;
&lt;p&gt;To help me address this I simulated some toy data from a realistic situation - a positive, largish log-normal distribution mixed up with an unrelated normal distribution.  Real data often resemble this sort of mixture (and much more complicated of course) of several different probability distributions, and it can make some of the more traditional statistical inference techniques really suffer.&lt;/p&gt;

&lt;p&gt;Here’s the density plot of my simulated data, presented in its original scale, with a logarithm scale, and with the new modulus transform scale.  There’s usually no strict rights or wrongs in this sort of exploratory analysis, but the logarithm transform does throw away all the negative values and gives a wholy erroneous focus on the big, log-normally distributed part of the data.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0007_density_plots.svg&quot; alt=&quot;density-plot&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;eg &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; rnorm&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;eg&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Original scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Logarithm scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;log&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# see previous post for definition of modulus_trans():&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Modulus transform scale&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Like in my example from last week, we can see that there are no axis labels where the bulk of the data is - between 0 and 2,000.  That’s what we want to fix.&lt;/p&gt;

&lt;h2 id=&quot;helper-functions&quot;&gt;Helper functions&lt;/h2&gt;
&lt;p&gt;For inspiration, I drew on the answers to this &lt;a href=&quot;http://stackoverflow.com/questions/14255533/pretty-ticks-for-log-normal-scale-using-ggplot2-dynamic-not-manual&quot;&gt;Stack Overflow question&lt;/a&gt;, particularly Heather Turner’s (it’s the lowest rated answer but the best in my opinion - it just came in a year after the attention had moved on).  Turner was doing a similar task to me, but with the simpler log transform.  I quickly realised that I needed to define some standalone functions that do the transformation and its inverse.  That’s pretty straightforward&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;mod_transform &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;      yt &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(((&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; lambda &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;      yt &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;mod_inverse &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;      y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; lambda &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;      y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;      
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;approach&quot;&gt;Approach&lt;/h2&gt;
&lt;p&gt;My strategy is going to be to&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;transform the data with .mod_transform()&lt;/li&gt;
  &lt;li&gt;use the pretty() function from base R to determine nearly-equally spaced breaks along that transformed range&lt;/li&gt;
  &lt;li&gt;transform those breaks back to the original scale with .mod_inverse()&lt;/li&gt;
  &lt;li&gt;tidy up the numbers by rounding them, rounding more aggressively the larger the number&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The whole thing gets wrapped up in a function that can be used by the breaks = argument from a scale like scale_x_continuous.  Let’s see where we’re heading:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0007_density_plots_breaks.svg&quot; alt=&quot;density-plots-with-breaks&quot; /&gt;&lt;/p&gt;

&lt;p&gt;One tricky catch was the final tidying up / rounding.  At one point I made the mistake of trying to copy what pretty() does and pick the nearest number that is 1, 2 or 5 times a multiple of 10.  This made the gridlines look oddly spaced; it makes sense for a logarithm transform but not for our more complex one.&lt;/p&gt;

&lt;p&gt;So here’s how I did it.  I broke it into two more functions, because I thought prettify() (which does the rounding) might be useful for something else (I’m sure there’s something that does this already in R, maybe even in base R, but it’s easier to write than to find).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;prettify &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# round numbers, more aggressively the larger they are&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   digits &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;floor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   digits&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;breaks &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; digits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; digits&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;mod_breaks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; prettify &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;      breaks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;mod_transform&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;kp&quot;&gt;pretty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;n &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; n&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;         &lt;span class=&quot;m&quot;&gt;.&lt;/span&gt;mod_inverse&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;prettify&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;         breaks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; prettify&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Usage is simple.  Here’s how I drew the two density plots above:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;                      breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mod_breaks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; prettify &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;panel.grid.minor &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Regular breaks&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;p &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; 
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;                      breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mod_breaks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; prettify &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;panel.grid.minor &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; element_blank&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Rounded breaks&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;applying-to-the-new-zealand-income-survey-2011&quot;&gt;Applying to the New Zealand Income Survey 2011&lt;/h2&gt;
&lt;p&gt;OK, now I can apply it to the real data from my previous post (and a post earlier than that shows how to get it into the database I’m using here).  First, here’s the density of individual weekly income from all sources in that 2011 survey:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0007_better_nzis_breaks.svg&quot; alt=&quot;nzis-breaks&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# connect to database&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;inc &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;select * from vw_mainheader&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                      breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mod_breaks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;And now here’s something new (but similar to last week) - weekly income compared hours worked, by occupation:
&lt;img src=&quot;http://ellisp.github.io/img/0007_income_by_occupation.svg&quot; alt=&quot;nzis-breaks&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hours&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;occupation&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ncol &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mod_breaks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; mod_breaks&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Much better, particularly if I’m going to use this transformation a lot, and it looks like the right one to use for data that is mostly positive and right tailed, but has a bunch of negatives thrown in too.&lt;/p&gt;

</description>
				<pubDate>Mon, 07 Sep 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/07/transforming-breaks-in-a-scale</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/07/transforming-breaks-in-a-scale</guid>
			</item>
		
			<item>
				<title>Creating a scale transformation</title>
					<description>&lt;h2 id=&quot;a-better-transformation-than-my-better-transformation&quot;&gt;A better transformation than my better transformation&lt;/h2&gt;
&lt;p&gt;In &lt;a href=&quot;http://ellisp.github.io/blog/2015/08/21/visualising-distributions/&quot;&gt;an earlier post&lt;/a&gt; I put forward the idea of a modulus power transform - basically the square root (or other similar power transformation) of the absolute value of a variable like income, followed by restoring the sign to it.  The idea is to avoid throwing away values of zero or less, which happens with the logarithm transform that is most commonly used for this sort of data.  In a tweet, Hadley Wickham pointed out the 1980 article in the Journal of the Royal Statistical Society &lt;a href=&quot;http://t.co/vC5b8d4OUh&quot;&gt;An Alternative Family of Transformations by J. A. John and N. R. Draper&lt;/a&gt; (behind the paywall but a guest logon is available) in which they proposed a very similar idea:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0006-john-draper-snip.PNG&quot; alt=&quot;journal-excerpt&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I hope I’m not breaching copyright by posting that snippet; I’ll certainly take it down if anyone complains.  I agree with Wickham that this useful piece of work should be much more widely known (and am sheepish myself for not knowing it) so hats off to the JSTOR for having it available at all.&lt;/p&gt;

&lt;p&gt;John and Draper also show that the methods Box and Cox use to determine parameters of the boxcox transformation can be used to get an optimal value of their tuning parameter lambda.  I’m not too worried about that just yet as I’m only using this for visualising the distribution; it might be something I want to investigate though when I move to modelling the data.&lt;/p&gt;

&lt;h2 id=&quot;implementing-a-transformation-for-easy-re-use&quot;&gt;Implementing a transformation for easy re-use&lt;/h2&gt;
&lt;p&gt;John and Draper’s transformation is slightly different from mine, has some nice properties and is definitely much more thoroughly thought through.    It’s more complex though, and deserves a proper defined implementation for re-use.  There’s no better way of doing this than creating a new transformation using the platform provided by Wickham’s {scales} package, very appropriate given where tip came from.  Here’s how I try that:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# John and Draper&amp;#39;s modulus transformation&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;modulus_trans &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   trans_new&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;modulus&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;             transform &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;                   yt &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(((&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; lambda &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;                   yt &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;             inverse &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                   y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; lambda &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; lambda&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;                   y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yt&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                   
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;                &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;             &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It hasn’t been peer reviewed or anything so use at your own risk.  Please let me know if you find anything wrong with it.&lt;/p&gt;

&lt;p&gt;Here’s that function in use, re-creating the density plot of income from my previous post, with the zero and negative values showing up nicely but without the crampedness of showing the income on an unadjusted scale.  I haven’t done polishing necessary to have axis labels at the various modal points, which is what I would do for a serious use.  This code assumes the existence of a database called nzis11, created as described in &lt;a href=&quot;http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf/&quot;&gt;this post&lt;/a&gt;.
&lt;img src=&quot;http://ellisp.github.io/img/0006_better_density_plot.svg&quot; alt=&quot;density-plot&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# comnect to database&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load fonts&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;inc &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;select * from vw_mainheader&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;lambda &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;income-including-negatives-and-hours-worked&quot;&gt;Income (including negatives) and hours worked&lt;/h2&gt;
&lt;p&gt;So the great advantage of a statistical transformation within the {scales} paradigm is that you never need to worry again about the transformation, you just make it an argument to scale_x_continuous (or any continuous scale, including colour and size, if you want).  I’ll finish this latest step in the journey with New Zealand’s Income Survey simulated unit record file from Statistics New Zealand by showing the new transformation in action on two axes at once, with a plot showing the relationship between hours worked and income earned by region, this time with the negative incomes left in.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0006_income_by_region.png&quot; alt=&quot;regions-plot&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hours&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;region&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; modulus_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h3 id=&quot;late-addition---comparison-to-the-untransformed-version&quot;&gt;Late addition - comparison to the untransformed version&lt;/h3&gt;

&lt;p&gt;As requested in the comments, here’s the untransformed version&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0006_income_by_region_no_transform.svg&quot; alt=&quot;untransformed-plot&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hours&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   facet_wrap&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;region&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   geom_point&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   theme_light&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Sat, 05 Sep 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/09/05/creating-a-scale-transformation</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/09/05/creating-a-scale-transformation</guid>
			</item>
		
			<item>
				<title>Getting started in applied statistics / datascience</title>
					<description>&lt;h2 id=&quot;where-to-start-to-start&quot;&gt;Where to start to start?&lt;/h2&gt;
&lt;p&gt;I was recently asked by a colleague manager from another organisation what direction they could give to a staff member interested in building skills in the whole “big data” thing.  A search of the web shows hundreds if not thousands of sites and blog posts aimed at budding data scientists, but most of them seem (to my admittedly very non-rigorous glance) to be collections of resources and techniques; too detailed and specific for my purposes, and aimed at people already a bit into the journey.  So here’s something oriented a bit more to someone who’s still wondering what this thing is you might be going to get into.&lt;/p&gt;

&lt;h2 id=&quot;why-is-data-suddenly-so-sexy&quot;&gt;Why is data suddenly so sexy?&lt;/h2&gt;
&lt;p&gt;First, while a lot of the publicity you hear is about “big data”, the real revolution in recent decades is bigger than big data.  It’s about data creation, storage, access, analytical techniques and tools:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;In the last third of the twentieth century there were big advances in applied statistics, with new methods like robust statistics, bootstrapping, a bigger range of graphics, and mixed effects and additive models to deal with a bunch of situations beyond the crude assumptions needed for the previous generations of techniques (the world of ANOVA, linear regression and t statistics which unfortunately is still the impression many people have from those one or two mandatory stats papers);&lt;/li&gt;
  &lt;li&gt;Roughly overlapping with that and still ongoing, the rise in computing power has made those methods practicable and cheap;&lt;/li&gt;
  &lt;li&gt;Then, the last 10 years has seen an explosion of data capture and storage, as our digital traces are increasingly being logged somewhere and more and more of our lives create those traces.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;A lot of the new data is web-related, but the overall cumulative impact of those three things above is not necessarily just enormous piles of Twitter and Facebook data.  So I’d be careful not to focus on “big data” from the start but instead build a core of statistics and computing skills which can then be applied to larger data.  The techniques actually specific to big data are relatively small compared to the core skillset, and should be fairly easy to learn if they get a solid grounding.&lt;/p&gt;

&lt;h2 id=&quot;whats-it-take-to-learn&quot;&gt;What’s it take to learn?&lt;/h2&gt;
&lt;p&gt;Second, I would emphasise that this stuff is &lt;em&gt;hard&lt;/em&gt; and there’s &lt;em&gt;lots of it to learn&lt;/em&gt;.  It can’t be learnt by a few two day courses and a brief apprenticeship, although both those things can help.  To be successful you need specialist tertiary education or its equivalent, plus a commitment to continuous creative destruction of your knowledge and skills and to life long learning.  My team for example comprises mostly people with quantitative PhDs or Masters degrees, and we have two training sessions per week at which everyone is continually learning new stuff (and teaching it to the others).  We start each weekly team meeting reporting back one thing each of us learnt in the last week; often it’s some tool or technique that didn’t even exist six months ago.&lt;/p&gt;

&lt;p&gt;My thinking is heavily influenced by &lt;a href=&quot;http://www.dataists.com/2010/09/the-data-science-venn-diagram/&quot;&gt;Drew Conway’s data science Venn diagram&lt;/a&gt;, a modified version of which is below (at the bottom of this post is the R code that drew this):
&lt;img src=&quot;http://ellisp.github.io/img/0005_venndiagram.svg&quot; alt=&quot;Datascience Venn diagram&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Basically, a good applied statistician or datascientist (I’m not going to argue about language here) needs to combine computing, statistical and content knowledge skills.  It’s the growth in computing power that’s changing capabilities in the field, but knowing stuff and techniques is important too.&lt;/p&gt;

&lt;p&gt;However, as we’ve only got one lifetime each, developing specialist knowledge in particular domain areas is expensive.  My advice on the &lt;em&gt;content knowledge&lt;/em&gt; circle of the Venn diagram is to get good at quickly understanding issues and questions that others can bring to you, rather than try to be a domain specialist.  This could be controversial; for example, I was once criticised by statisticians and others for recruiting team members on the basis of statistical and data management skills rather than domain knowledge in XXX.  The reality is, we work with others who are the specialists in XXX and its policy problems, but need help in the data area.  I look for people with data skills (or potential skills) who can quickly build up familiarity with the domain, rather than limit the range an already difficult job search.&lt;/p&gt;

&lt;h2 id=&quot;getting-started-on-statistical-computing&quot;&gt;Getting started on statistical computing&lt;/h2&gt;
&lt;p&gt;That leaves &lt;em&gt;hacking&lt;/em&gt; and &lt;em&gt;statistics&lt;/em&gt;.  In my thinking I break this down into four pragmatic areas where skills need to be developed.  I say pragmatic because I don’t have some theory dictating why these four areas, it’s more that when we’re planning training or other skills development, it seems to fall into these categories:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;statistics&lt;/li&gt;
  &lt;li&gt;computer languages and generally getting the computer to do new stuff&lt;/li&gt;
  &lt;li&gt;reproducible research&lt;/li&gt;
  &lt;li&gt;databases and data management&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This series of &lt;a href=&quot;https://www.coursera.org/specialization/jhudatascience/1/courses&quot;&gt;John Hopkins Coursera online courses&lt;/a&gt; online courses has had good recommendations:  and covers the full range of things, using up to date tools.  It’s a commitment, but the fact is there’s a lot to learn.  I’d suggest at some point early in the journy getting enrolled in that or a similar course to see if you’ve got the stomach for it.  If you haven’t written computer code before, for example, there’s probably a particular psychological hurdle to overcome before you decide this is for you (and you can’t handle data properly without doing it in code).&lt;/p&gt;

&lt;p&gt;The “range of things” as I would see them (which is pretty much similar to the curriculum of that course linked above) would be:&lt;/p&gt;

&lt;h3 id=&quot;statistics&quot;&gt;Statistics&lt;/h3&gt;
&lt;p&gt;Learning statistics properly takes effort, and mathematics, and lots of time in front of a computer practicing.  One problem is a lot of the statistics learnt at university in non-statistics degrees teaches techniques rather than principles, and often dated at that.   To get an idea of what you’re getting into:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;As a starter (reflecting my own learning preferences of course ) I advise reading some books. Like &lt;a href=&quot;http://www.amazon.com/Modern-Statistics-Social-Behavioral-Sciences/dp/1439834563&quot;&gt;Wilcox’s Modern Statistics for the Social and Behavioral Sciences&lt;/a&gt;  and &lt;a href=&quot;http://www.amazon.com/Discovering-Statistics-Using-Andy-Field/dp/1446200469&quot;&gt;Andy Field’s Discovering Statistics Using R&lt;/a&gt;, both of which I’ve used successfully with people and learnt stuff myself on the way.  Those are really good, modern introductory texts, particularly Wilcox’s which played a big part in nudging my own statistical approaches into the modern world.&lt;/li&gt;
  &lt;li&gt;Use the amazing &lt;a href=&quot;http://stats.stackexchange.com/&quot;&gt;Cross-Validated Q&amp;amp;A site&lt;/a&gt; to search for answers to statistical questions&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Statistics&quot;&gt;Wikipedia&lt;/a&gt; for excellent technical definitions and descriptions&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;One day I’ll do a more extended post on other books-I-love dealing with topics like modelling strategies, time series, surveys, etc.&lt;/p&gt;

&lt;h3 id=&quot;a-computing-tool-for-statistics&quot;&gt;A computing tool for statistics&lt;/h3&gt;
&lt;p&gt;A choice needs to be made for a computer language in which to start learning.  If you spend more than an hour thinking about R v SAS, R v Python, or R v Julia you’re wasting your time because the reality is if you’re going to get any good at this, you need to be multilingual.   However, you have to start somewhere and my recommendation is for R.  It’s free, easy to get, forms the lingua franca in the academy, and its open source approach means new techniques get operationalised in it quicker than in SAS, as do bindings to other languages like JavaScript (pretty much essential for fancy modern data presentation).   Ideally you learn R and statistics together – R is a computer language written by statisticians for statisticians, so it helps you fall into a statistical way of thinking.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Download R from &lt;a href=&quot;https://cran.r-project.org/&quot;&gt;CRAN&lt;/a&gt;  and RStudio from &lt;a href=&quot;https://www.rstudio.com/products/RStudio/&quot;&gt;RStudio&lt;/a&gt;.&lt;/li&gt;
  &lt;li&gt;Follow this blog aggregation site: &lt;a href=&quot;http://www.r-bloggers.com/&quot;&gt;http://www.r-bloggers.com/&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Use this &lt;a href=&quot;http://stackoverflow.com/&quot;&gt;Stack Overflow Q&amp;amp;A&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Join your local R users group and other analytics groups.  Where I live, that means the &lt;a href=&quot;http://www.meetup.com/Wellington-R-Users-Group-WRUG/&quot;&gt;Wellington R users group&lt;/a&gt;  and the (language-agnostic) &lt;a href=&quot;http://analytics.org.nz/&quot;&gt;New Zealand analytics forum&lt;/a&gt;, both of which have 3 or 4 events a year to hear what others around are up to and make contacts&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Down the track you need to get familiar with other more general languages - like HTML and JavaScript for web dissemination, LaTeX for static reports and presentations, and probably a general purpose language like Python for generally doing Stuff to data.  You also need to get familiar with the basics of the computer’s operating system and using a shell session to get it to do stuff.  But other than the minimum that can wait until you’ve broken the ice (I’m assuming people are starting from non-familiarity with coding) with a statistically-oriented language.&lt;/p&gt;

&lt;h3 id=&quot;reproducible-research-eg-version-control-making-things-reproducible-end-to-end-etc&quot;&gt;Reproducible research eg version control, making things reproducible end to end, etc.&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Download &lt;a href=&quot;http://www.git-scm.com/&quot;&gt;Git&lt;/a&gt; and once you’ve started to get comfortable with writing code, learn to use Git to do version control.  It integrates well with RStudio.&lt;/li&gt;
  &lt;li&gt;Read about &lt;a href=&quot;https://en.wikipedia.org/wiki/Reproducibility#Reproducible_research&quot;&gt;reproducible research&lt;/a&gt; and find ways to set up your code so others can repeat what you’ve done - for peer review, quality control, scalability, and updating stuff.&lt;/li&gt;
  &lt;li&gt;Install LaTeX and learn how to use it.&lt;/li&gt;
  &lt;li&gt;As you get further into larger projects you need to start borrowing techniques from software developers, and read up on &lt;a href=&quot;https://en.wikipedia.org/wiki/Software_development_process&quot;&gt;software development methods&lt;/a&gt; like &lt;a href=&quot;https://en.wikipedia.org/wiki/Extreme_programming&quot;&gt;Extreme Programming&lt;/a&gt;.  When analysts realise they are writing computer programs, not just interacting with a statistical tool, they move up a level in the power of what they can do.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;databases-data-management-sql-tidying-and-cleaning-data&quot;&gt;Databases, data management, SQL, tidying and cleaning data&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Down the track, you need database skills.  This can wait until familiar with stats and R but at some point you need to be able to set up a database.  &lt;a href=&quot;https://www.mysql.com/&quot;&gt;MySQL&lt;/a&gt; is the easiest one to do this on a home system.&lt;/li&gt;
  &lt;li&gt;Within R, {dplyr} and {tidyr} are relatively new but are king for data tidying, reshaping and accessing.  Most recent online courses and blogs will use these.&lt;/li&gt;
  &lt;li&gt;Only after everything else is sorted and are familiar with medium size data (eg traditional relational databases like MySQL), can think about big-data-specific things like Hadoop clusters.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;more&quot;&gt;More&lt;/h3&gt;
&lt;p&gt;So that’s only a beginning.  It’s an exciting area.  Hopefully I’ve given some indicators that might be useful for someone out there, wondering if they (or someone else) should get into this stuff, and what it will take.&lt;/p&gt;

&lt;h3 id=&quot;drawing-that-diagram&quot;&gt;Drawing that diagram&lt;/h3&gt;
&lt;p&gt;Finally, here’s the code that drew my own version of the Drew Conway data science diagram.   I wanted to tweak his original&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;to avoid the argument “that’s just what applied statisticians do”.&lt;/li&gt;
  &lt;li&gt;to make clearer than Conway’s original that computer skills in combination with statistics is still a danger zone&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;grid&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RColorBrewer&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;palette &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; brewer.pal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;radius &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.3&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;strokecol &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;linewidth &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;fs &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;11&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;draw_diagram &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(){&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;grid.newpage&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;grid.circle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.67&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; radius&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;               gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; strokecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;                    fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;                    alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;                    lwd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; linewidth&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;grid.circle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.67&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.67&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; radius&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;            gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; strokecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;                 fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;                 alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                 lwd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; linewidth&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;grid.circle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.33&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; radius&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;               gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; strokecol&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;                    fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;                    alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;                    lwd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; linewidth&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hacking&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.75&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rot &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;             gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;                  fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;                  col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;                  fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bold&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Statistics&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.75&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.75&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rot &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;             gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;                  fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;                  col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;                  fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bold&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Content\nknowledge&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.25&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rot &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;             gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;                  fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;                  col &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; palette&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;                  fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bold&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Danger:\nno context&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.75&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;          gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;                    fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Danger: no\nunderstanding\nof probability&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rot &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;          gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;                    fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Traditional\nresearch&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.66&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.46&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rot &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;          gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;                    fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;grid.text&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Data science /\napplied\nstatistics&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.55&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;          gp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; gpar&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fontfamily &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;                    fontsize &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fs &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;                    fontface &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bold&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;draw_diagram&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Sun, 30 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/30/starting-in-datascience</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/30/starting-in-datascience</guid>
			</item>
		
			<item>
				<title>A better way of visualising income distributions with zeroes and negatives</title>
					<description>&lt;p&gt;I wasn’t happy with &lt;a href=&quot;/blog/2015/08/15/importing-nzis-surf/&quot;&gt;my visualisation of individual incomes from the New Zealand income survey&lt;/a&gt;.  Because it used a logarithmic scale to improve readability, in effect all zero and negative values are excluded from the data.  Whenever I throw out data, my tail goes bushy… there has to be a better way.  Those zero and negative values are an important part of the story, and it’s too easy to forget them.  If you don’t include them in your standard graphic for exploring the distribution of the data, the next thing is you’re excluding them from your model in serious analysis.&lt;/p&gt;

&lt;p&gt;It turns out this is a very common problem, and the routine solutions (at least according to this &lt;a href=&quot;http://blogs.sas.com/content/iml/2011/04/27/log-transformations-how-to-handle-negative-data-values.html&quot;&gt;SAS blog&lt;/a&gt;, and this &lt;a href=&quot;http://andrewgelman.com/2005/11/10/transforming_va/&quot;&gt;Q&amp;amp;A on another blog&lt;/a&gt;) seem to be either adding an arbitrary constant before taking logarithms, excluding those data points and treating them as missing values, or discretizing the data altogether.  If my tail was bushy before, now I’m really nervous - those sound like really dangerous things to do (and yes, I freely admit having done all three myself plenty of times).&lt;/p&gt;

&lt;p&gt;A bit of reflection shows that what’s going on here is a mixture of distributions - one of the most dangerous things for statistics based on traditional assumptions:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;A large bunch of the population, which we sometimes mistake for the whole population, who earn positive incomes that are roughly log-normally distributed, with mean and variance depending on structural variables like education, location, etc.&lt;/li&gt;
  &lt;li&gt;A small subset, probably of enterpreneurs, who are making losses.  The losses have their own distribution of interest.&lt;/li&gt;
  &lt;li&gt;A medium sized subset who are not in work or owning businesses and have zero income&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It’s folly to think that these three groups in the data-generating process will result in a single smooth distribution, as is implied by adding a constant to the income and taking logarithms.  It’s worse to chuck out the inconvenient second and third groups altogether.&lt;/p&gt;

&lt;p&gt;My solution is to use a modified power transform - one that transforms the absolute value of the original data, then restores the sign (negative or positive) to the result.  I started by thinking of square roots, and I needed to handle the fact that the square root of a negative number is imaginary.  By applying the square root to the absolute value and then restoring the sign you get a transformation like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0004_transformation.svg&quot; alt=&quot;plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Produced by (in R):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;power_trans &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; k &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kp&quot;&gt;sign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; k
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;sim &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-5000&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5000&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;plot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sim&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; power_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sim&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; type &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bty &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;l&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;     xlab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Original value&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ylab &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Transformed value&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;grid&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I’ve given myself flexibility to use powers other than 0.5 (square root).  When I apply this approach to the New Zealand Income Survey 2011 simulated unit record file provided by Statistics New Zealand, I get a much more satisfactory representation of the full range of incomes there.  Not only are the two modes at $825 and $325 per week visible that I discussed in my last post, but we can compare them to the spike at $0 per week, and observe a little bump at the mode negative income level of -$200.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0004_better_density_plot.svg&quot; alt=&quot;plot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I haven’t heard of this approach being used before and would welcome comment on it.  As taking logarithms of income data is extremely common - pretty much the standard approach in fact - I would suggest that analysts are routinely losing sight of some important complexity in their data.&lt;/p&gt;

&lt;p&gt;Here’s the final code producing that plot.  It depends on the data being present in a database, as I described in the previous post.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# comnect to database&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# load fonts&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# define the power to use in the transformation&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;k &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.2&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download the data from the database&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;inc &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;select income from f_mainheader&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;inc_trans &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; power_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# define where to put the gridlines and labels on the x axis&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;breaks &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data.frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;-5000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-1500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-200&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;-10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;345&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;825&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;points &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; power_trans&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; k&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;inc &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; inc_trans&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; breaks&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;points&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; labels &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; breaks&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\nWeekly income (transformed scale, $)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;        y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Density\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;        title &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Distribution of individual income in New Zealand 2011&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;showing the full range including zero and negative&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
</description>
				<pubDate>Fri, 21 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/21/visualising-distributions</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/21/visualising-distributions</guid>
			</item>
		
			<item>
				<title>Importing the New Zealand Income Survey SURF</title>
					<description>&lt;h2&gt;The quest for income microdata&lt;/h2&gt;
&lt;p&gt;For a separate project, I&#39;ve been looking for source data on income and wealth inequality.  Not aggregate data like Gini coefficients or the percentage of income earned by the bottom 20% or top 1%, but the sources used to calculate those things.  Because it&#39;s sensitve personal financial data either from surveys or tax data, it&#39;s not easy to get hold of, particularly if you want to do it in the comfort of your own home and don&#39;t have time / motivation to fill in application forms.  So far, what I&#39;ve got is a &lt;a href = &quot;http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&quot;&gt;simulated unit record file (SURF) from the New Zealand Income Survey,&lt;/a&gt; published by Statistics New Zealand for educational and instructional purposes. It&#39;s a simplified, simulated version of the original survey and it lets me make graphics like this one:&lt;/p&gt;

&lt;div class =&quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0003-nzis-ethnicity-density.svg&quot;&gt;&lt;/div&gt;
 &lt;p&gt;
 This plot shows the density of income from all sources for four of the most prominent ethnicity types in New Zealand.  New Zealand official statistics allow people to identify with more than one ethnicity, which means there is some double counting (more on that below).  Three things leap out at me from this chart:
 &lt;ol&gt;
 &lt;li&gt;The density curves of the different ethnic groups are very similar visually
 &lt;li&gt;People of Maori and Pacific Peoples ethnicity have proportionately more $300-$400 per week earners than Europeans and Asians, leading to an overall noticeable lean to the lower numbers
 &lt;li&gt;Weekly income is bimodal, bunching up at $345 per week and $820 per week.  Actually, this image is misleading in that respect; in reality it is trimodal, with a huge bunch of people with zero income (and some negative), who aren&#39;t shown on this plot because of the logarithmic scale.  So you could say that, for New Zealanders getting any income at all, there is a bimodal distribution.
 &lt;/ol&gt;
  &lt;/p&gt;
&lt;p&gt;
Where&#39;s that bimodal distribution coming from?  The obvious candidate is part time workers, and this is seen when we plot income versus hours worked in the next image:
&lt;/p&gt;
&lt;div class =&quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0003-nzis-scatter.svg&quot;&gt;&lt;/div&gt;
&lt;p&gt;(That interesting diagonal line below which there are very few points is the minimum wage per hour)&lt;/p&gt;
  &lt;p&gt;
  Statistics New Zealand warn that while this simulated data is an accurate representation of the actual New Zealand population, it shouldn&#39;t be used for precise statistics, so for now I won&#39;t draw particularly strong conclusions on anything.  A simulated unit record file is a great way of solving confidentiality purposes, but in the end it has been created by a statistical model.  There&#39;s a risk that interesting inferences might be just picking up something implicit in the model that wasn&#39;t taken into account when it was first put together.  That&#39;s not likely to be the case for the basic distribution of the income values, but we&#39;ll note the exploratory finding for now and move on.&lt;/p&gt;
  
  &lt;p&gt;A box plot is better for examining the full range of reported ethnicities but not so good for picking up the bi-modal subtlety.  It should also be noted that both these graphs delete people who made losses (negative income) in a given week - the data show income from all sources:
  &lt;/p&gt;

&lt;div class = &quot;img-container&quot;&gt;&lt;img src = &quot;http://ellisp.github.io/img/0003-nzis-ethnicity-boxplot.svg&quot;&gt;&lt;/div&gt;

&lt;h2&gt;Loading the NZIS SURF into a database&lt;/h2&gt;
Here&#39;s how I drew the graphs, and estimated the two modes.  I think I&#39;ll want to re-use this data quite often, so it&#39;s worth while putting in a database that&#39;s accessible from different projects without having to move a bunch of data files around in Windows Explorer.  The way Statistics New Zealand have released the file, with codings rather than values for dimensions like ethnicity and region, also makes a database a good way to make the data analysis ready.&lt;/p&gt;

&lt;p&gt;After importing the data, the first significant job is to deal with that pesky ethnicity variable.  In the released version of the data respondents with two ethnicities have both code numbers joined together eg 12 means both European (1) and Maori (2).  To get around this I split the data into two fact tables, one with a single row per respondent with most of the data; and a second just for ethnicity with either one or two rows for each respondent.  Here&#39;s how I do that with a combination of {dplyr} and {tidyr}:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tidyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;mbie&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for AskCreds, which is alternatively directly available &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;              &lt;span class=&quot;c1&quot;&gt;# https://github.com/nz-mbie/mbie-r-package/blob/master/pkg/R/Creds.R &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# imports, clean up, and save to database the data from&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# http://www.stats.govt.nz/tools_and_services/microdata-access/nzis-2011-cart-surf.aspx&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;url &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;http://www.stats.govt.nz/~/media/Statistics/services/microdata-access/nzis11-cart-surf/nzis11-cart-surf.csv&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;nzis &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; read.csv&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------fact tables------------------&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# Create a main table with a primary key&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;f_mainheader &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; nzis &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;survey_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# we need to normalise the multiple ethnicities, currently concatenated into a single variable&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;cat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;max number of ethnicities is&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;nzis&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;f_ethnicity &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; f_mainheader &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; survey_id&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;First &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;          Second &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;substring&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   gather&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_type&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ethnicity_id&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;survey_id&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_id &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# drop the original messy ethnicity variable and tidy up names on main header&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;f_mainheader &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; f_mainheader &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   select&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;ethnicity&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;region_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; lgr&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;          sex_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; sex&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;          agegrp_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; agegrp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;          qualification_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; qualification&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;          occupation_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; occupation&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Second step is to re-create the dimension tables that turn the codes (eg 1 and 2) into meaningful values (European and Maori).  Statistics New Zealand provide these, but unfortunately in an Excel workbook that&#39;s easier for humans than computers to link up to the data.  There&#39;s not too many of so it&#39;s easy enough to code them by hand, which the next set of code does:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#-----------------dimension tables------------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# all drawn from the data dictionary available at the first link given above&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;d_sex &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sex_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sex &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;male&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;female&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;d_agegrp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   agegrp_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp_id &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;65+&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;agegrp_id&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;-&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; agegrp_id &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;d_ethnicity &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;                          ethnicity &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;European&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Pacific Peoples&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Asian&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Middle Eastern/Latin American/African&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Other Ethnicity&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;                             &lt;span class=&quot;s&quot;&gt;&amp;quot;Residual Categories&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;d_occupation &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;occupation_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;                       occupation &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Managers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Professionals&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Technicians and Trades Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Community and Personal Service Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Clerical and Adminsitrative Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Sales Workers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Machinery Operators and Drivers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Labourers&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;Residual Categories&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;                          &lt;span class=&quot;s&quot;&gt;&amp;quot;No occupation&amp;quot;&lt;/span&gt;                          
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;                       &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;d_qualification &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;qualification_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;                        qualification &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;None&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;School&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Vocational/Trade&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Bachelor or Higher&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;                           &lt;span class=&quot;s&quot;&gt;&amp;quot;Other&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;                        &lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;d_region &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;region_id &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;                       region &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Northland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Auckland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Waikato&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Bay of Plenty&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Gisborne / Hawke&amp;#39;s Bay&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;s&quot;&gt;&amp;quot;Taranaki&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Manawatu-Wanganui&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Wellington&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;                                  &lt;span class=&quot;s&quot;&gt;&amp;quot;Nelson/Tasman/Marlborough/West Coast&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Canterbury&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Otago&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Southland&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The final step in the data cleaning is to save all of our tables to a database, create some indexes so they work nice and fast, and join them up in an analysis-ready view.  In the below I use an ODBC (open database connectivity) connection to a MySQL server called &quot;PlayPen&quot;.  R plays nicely with databases; set it up and forget about it.&lt;p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------save to database---------------&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;creds &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; AskCreds&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Credentials for someone who can create databases&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;PlayPen &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; odbcConnect&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;PlayPen_prod&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; uid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; creds&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;uid&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; pwd &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; creds&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;pwd&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;create database nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;use nzis11&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# fact tables.  These take a long time to load up with sqlSave (which adds one row at a time)&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# but it&amp;#39;s easier (quick and dirty) than creating a table and doing a bulk upload from a temp &lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# file.  Any bigger than this you&amp;#39;d want to bulk upload though - took 20 minutes or more.&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; f_mainheader&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; f_ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;                                            &lt;span class=&quot;c1&quot;&gt;# add a primary key on the fly in this case.  All other tables&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;                                            &lt;span class=&quot;c1&quot;&gt;# have their own already created by R.&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# dimension tables&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_sex&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_agegrp&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_occupation&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_qualification&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;sqlSave&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; d_region&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; addPK &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; rownames &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;FALSE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#----------------indexing----------------------&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE f_mainheader ADD PRIMARY KEY(survey_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_sex ADD PRIMARY KEY(sex_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_agegrp ADD PRIMARY KEY(agegrp_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_ethnicity ADD PRIMARY KEY(ethnicity_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_occupation ADD PRIMARY KEY(occupation_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_qualification ADD PRIMARY KEY(qualification_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;ALTER TABLE d_region ADD PRIMARY KEY(region_id)&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#---------------create an analysis-ready view-------------------&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# In Oracle we&amp;#39;d use a materialized view, which MySQL can&amp;#39;t do.  But&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the below is fast enough anyway:&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;sql1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;s&quot;&gt;&amp;quot;CREATE VIEW vw_mainheader AS SELECT sex, agegrp, occupation, qualification, region, hours, income FROM&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      f_mainheader a   JOIN&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_sex b          on a.sex_id = b.sex_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_agegrp c       on a.agegrp_id = c.agegrp_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_occupation e   on a.occupation_id = e.occupation_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_qualification f on a.qualification_id = f.qualification_id JOIN&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;      d_region g       on a.region_id = g.region_id&amp;quot;&lt;/span&gt;
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; sql1&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Average weekly income in NZ 2011 by various slices and dices&lt;/h2&gt;
&lt;p&gt;Whew, that&#39;s out of the way.  Next post that I use this data I can go straight to the database.  We&#39;re now in a position to check our data matches the summary totals provided by Statistics New Zealand.  Statistics New Zealand say this SURF can be treated as a simple random sample, which means each point can get an identical individual weight, which we can estimate from the summary tables in their data dictionary.  Each person in the sample represents 1,174 in the population (in the below I have population figures in thousands, to match the Statistics New Zealand summaries.&lt;p&gt;

&lt;p&gt;Statistics New Zealand doesn&#39;t provide region and occupation summary statistics, and the qualification summaries they provide use a more detailed classification than is in the actual SURF.  But for the other categories - sex, age group, and the trick ethnicity - my results match theirs, so I know I haven&#39;t munched the data.&lt;p&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; sex &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; female &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 611 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 15217 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1787.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; male &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 779 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 14254 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1674.00 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              sex,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY sex&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; agegrp &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 15-19 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 198 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2632 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 309.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 20-24 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 567 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2739 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 321.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 25-29 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 715 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 301.10 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 30-34 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 796 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2349 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 275.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 35-39 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 899 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2442 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 286.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 40-44 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 883 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2625 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 308.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 45-49 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 871 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2745 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 322.40 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 50-54 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 911 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2522 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 296.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 55-59 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 844 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2140 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 251.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 60-64 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 816 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1994 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 234.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; 65+ &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 421 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4719 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 554.20 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              agegrp,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY agegrp&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; qualification &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; School &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 7064 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 829.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; None &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 565 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 6891 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 809.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Other &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 725 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1858 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 218.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Vocational/Trade &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 734 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 8435 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 990.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Bachelor or Higher &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 955 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 5223 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 613.40 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# qualification summary in data dictionary uses a different classification to that in data&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab3 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              qualification,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                              ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY qualification&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; occupation &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; No occupation &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 257 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 10617 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1246.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Labourers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 705 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2154 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 253.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Residual Categories &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 726 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  24 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Community and Personal Service Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 745 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1734 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 203.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Sales Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 800 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1688 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 198.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Clerical and Adminsitrative Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 811 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2126 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 249.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Technicians and Trades Workers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 886 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2377 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 279.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Machinery Operators and Drivers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 917 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1049 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 123.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Professionals &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1105 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4540 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 533.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Managers &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1164 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3162 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 371.30 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# occupation summary not given in data dictionary&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab4 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             occupation,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY occupation&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; region &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Bay of Plenty &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 620 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1701 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 199.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Taranaki &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 634 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 728 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 85.50 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Waikato &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 648 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2619 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 307.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Southland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 648 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 637 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 74.80 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Manawatu-Wanganui &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 656 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1564 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 183.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Northland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 667 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1095 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 128.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Nelson/Tasman/Marlborough/West Coast &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 680 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1253 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 147.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Otago &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 686 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1556 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 182.70 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Gisborne / Hawke&#39;s Bay &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 693 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1418 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 166.50 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Canterbury &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 701 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 4373 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 513.60 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Auckland &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 720 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 9063 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1064.40 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Wellington &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 729 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3464 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 406.80 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# region summary not given in data dictionary&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;tab5 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT &lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             region,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(AVG(income))          as Mean, &lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                             ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           FROM vw_mainheader&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           GROUP BY region&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                           ORDER BY Mean &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- html table generated in R 3.1.2 by xtable 1.7-4 package --&gt;
&lt;!-- Sat Aug 15 12:13:30 2015 --&gt;
&lt;table border=1&gt;
&lt;tr&gt; &lt;th&gt; ethnicity &lt;/th&gt; &lt;th&gt; Mean &lt;/th&gt; &lt;th&gt; Sample &lt;/th&gt; &lt;th&gt; Population &lt;/th&gt;  &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Residual Categories &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 555 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt;  85 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 10.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Maori &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 590 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3652 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 428.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Pacific Peoples &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 606 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 1566 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 183.90 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Middle Eastern/Latin American/African &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 658 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 343 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 40.30 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Asian &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 678 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 3110 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 365.20 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; European &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 706 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 22011 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 2585.00 &lt;/td&gt; &lt;/tr&gt;
  &lt;tr&gt; &lt;td&gt; Other Ethnicity &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 756 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 611 &lt;/td&gt; &lt;td align=&quot;right&quot;&gt; 71.80 &lt;/td&gt; &lt;/tr&gt;
   &lt;/table&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;tab6 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ethnicity,&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ROUND(AVG(income))          as Mean,&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     COUNT(1)                    as Sample,&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                     ROUND(COUNT(1) * .11744, 1) as Population&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  FROM f_mainheader m&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  JOIN f_ethnicity e ON m.survey_id = e.survey_id&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  JOIN d_ethnicity d ON e.ethnicity_id = d.ethnicity_id&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  GROUP BY ethnicity&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                  ORDER BY Mean&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;Graphics showing density of income&lt;/h2&gt;
&lt;p&gt;Finally, here&#39;s the code that drew the charts we started with, showing the distribution of the weekly income New Zealanders of different ethnicity.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RODBC&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# download individual level data from database including ethnicity join&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;SELECT&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                   ethnicity,&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                   income&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                FROM f_mainheader m&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                JOIN f_ethnicity e ON m.survey_id = e.survey_id&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;&lt;span class=&quot;s&quot;&gt;                JOIN d_ethnicity d ON e.ethnicity_id = d.ethnicity_id&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# density plot of income by density                &lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   filter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ethnicity &lt;span class=&quot;o&quot;&gt;%in%&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Asian&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;European&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Maori&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Pacific Peoples&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   geom_density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;345&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;825&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;bottom&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;   scale_colour_brewer&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; palette &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set1&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# boxplot of income by ethnicity&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;dtf &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ethnicity&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   geom_boxplot&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;   geom_rug&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   scale_y_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;   labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;   coord_flip&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;   scale_colour_brewer&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;palette &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Set2&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;   theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# scatter plot of joint density of hours and income&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;dtf2 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; sqlQuery&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;PlayPen&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;select hours, income from vw_mainheader&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dtf2&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; hours&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; income&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;   geom_jitter&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;alpha &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.05&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;   scale_x_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Hours worked&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;   scale_y_log10&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Weekly income from all sources&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; dollar&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; breaks &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;345&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;825&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;   
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# how did I choose to mark $345 and $825 on the scale?&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# ripped off (and improved) from http://stackoverflow.com/questions/27418461/calculate-the-modes-in-a-multimodal-distribution-in-r&lt;/span&gt;
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;find_modes&lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   dens &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; density&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   y &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dens&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;y
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   modes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;NULL&lt;/span&gt;
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; y&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;         modes &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;      modes &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;#39;This is a monotonic distribution&amp;#39;&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dens&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;modes&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;x &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; dtf&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;income
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;x&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# not interested in negative income just now&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# where are those modes?&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;find_modes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Edited 18 August 2015 to add the scatter plot of the joint density of hours and income.&lt;/p&gt;</description>
				<pubDate>Sat, 15 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/15/importing-nzis-surf</guid>
			</item>
		
			<item>
				<title>Simulating backgammon players&#39; Elo ratings</title>
					<description>&lt;h2 id=&quot;probabilities-of-winning-with-a-given-rating&quot;&gt;Probabilities of winning with a given rating&lt;/h2&gt;
&lt;p&gt;Backgammon clubs and on-line forums use a modified form of the &lt;a href=&quot;https://en.wikipedia.org/wiki/Elo_rating_system&quot;&gt;Elo rating system&lt;/a&gt; to keep track of how well individuals have played and draw inferences about their underlying strength.  The higher the rating, the stronger the player.  Players with higher ratings are inferred to be stronger than those with lower ratings and hence are expected to win; and the longer the match, the more likely the greater skill level will overcome the random chance of the dice.  The animated plot below shows the expected probabilities of two players in the &lt;a href=&quot;http://www.fibs.com/&quot;&gt;FIBS (First Internet Backgammon Server)&lt;/a&gt; internet forum, where players start at 1500 and the very best reach over 2000.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0002-EloProbs.gif&quot; alt=&quot;Animated heatmap of player probabilities of winning&quot; style=&quot;width: 500px;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When the two players have the same rating, they are expected to have a 50/50 chance of winning, and this causes the constant diagonal line in the animation above.  When one player is better than the other they have a higher chance of winning, represented for Player A by the increasingly blue space in the bottom right of the plot and the numbers (which are estimated probabilities) labelling the contour lines.  The actual formula used on FIBS and illustrated above is &lt;a href=&quot;http://www.fibs.com/ratings.html&quot;&gt;defined by on the FIBS site&lt;/a&gt; as:&lt;/p&gt;

&lt;p&gt;Winning prob. = 1 - (1 / (10 ^ ((YOU - HIM) * SQRT(ML) / 2000) + 1))&lt;/p&gt;

&lt;p&gt;(As an aside, I don’t think there is a strong theoretical reason for the SQRT(ML) in that formula.  With the complications of the doubling cube I very much doubt that the relationship of the probability winning to match length is as simple as that.  But it’s a reasonable empirical approximation; I might blog more about that another time.)&lt;/p&gt;

&lt;p&gt;Now, here’s how I made that animation.  In the R code below, first, I load up some functionality and the Google font I use for this blog.  Then I define a function that estimates the probability of a player winning using the FIBS formula above.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;dplyr&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;showtext&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for fonts&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;RColorBrewer&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;directlabels&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for labels on contour lines&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ggplot2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;scales&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kn&quot;&gt;library&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;forecast&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for auto.arima later on&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;font.add.google&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Poppins&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;showtext.auto&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#==================helper functions=====================&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;fibs_p &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# function to determine the expected probability of player a winning a bachgammon match&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# against player b of length ml, with a and b representing their FIBS Elo ratings&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   tmp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;^&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;tmp&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The strategy to create the animation is simple:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Create all the combinations of two players’ Elo ratings.&lt;/li&gt;
  &lt;li&gt;Loop through 23 possible match lengths, calculating the probabilities of A winning for each combination of Elo ratings at that match length&lt;/li&gt;
  &lt;li&gt;Draw a still image heatmap for each of those 23 match lengths using {ggplot2}&lt;/li&gt;
  &lt;li&gt;Compile the images into a single animated Gif using &lt;a href=&quot;http://studio.imagemagick.org/script/index.php&quot;&gt;ImageMagick&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#================heat maps showing probability of winning&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a matrix of players A and B&amp;#39;s possible Elo ratings&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;mat &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;expand.grid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   rename&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Var1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Var2&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# create a folder to hold the images and navigate to it&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;dir.create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;owd &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# cycle through a range of possible match lengths, drawing a plot for each&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;matchlengths &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;seq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;from &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; to &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; by &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;res &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;150&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;matchlengths&lt;span class=&quot;p&quot;&gt;)){&lt;/span&gt;
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   df1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; mat &lt;span class=&quot;o&quot;&gt;%&amp;gt;%&lt;/span&gt; mutate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;probs &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; fibs_p&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; matchlengths&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   p1 &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;df1&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;  aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; z &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; probs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;      geom_tile&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fill &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; probs&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;      theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      scale_fill_gradientn&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colours &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; brewer.pal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Spectral&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; limits &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      scale_colour_gradientn&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colours &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;black&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;      stat_contour&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;..&lt;/span&gt;level..&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; binwidth &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;.1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# force contours to be same distance each image&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;      labs&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Player A Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;Player B Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      theme&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;legend.position &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;none&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;      coord_equal&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;      ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Probability of Player A winning a match to &amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; matchlengths&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;   png&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;paste0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kc&quot;&gt;letters&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;.png&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; res &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; res&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bg &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;white&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;kp&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;direct.label&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;p1&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# direct labels used to label the contour points&lt;/span&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;   dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# compile the images into a single animated Gif with ImageMagick.  Note that&lt;/span&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# the {animation} package provides R wrappers to do this but they often get&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# confused (eg clashes with Windows&amp;#39; convert) and it&amp;#39;s easier to do it explicitly&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# yourself by sending an instruction to the system:&lt;/span&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;#39;&amp;quot;C:\\Program Files\\ImageMagick-6.9.1-Q16\\convert&amp;quot; -loop 0 -delay 150 *.png &amp;quot;EloProbs.gif&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# move the asset over to where needed for the blog&lt;/span&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;file.copy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;EloProbs.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;../..http://ellisp.github.io/img/0002-EloProbs.gif&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; overwrite &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# clean up&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;setwd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;owd&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;tmp0002&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; recursive &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;TRUE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id=&quot;actual-ratings-varying-true-rating-constant&quot;&gt;Actual ratings varying, “true” rating constant&lt;/h2&gt;
&lt;p&gt;The estimated probability of winning against a certain opponent at a given match length might be of interest to backgammon players (I’m surprised it’s not referred to more often), but its most common use is embedded in the calculation of how much each player’s Elo rating changes after a match is decided.  That formula is well explained by FIBS and a little involved so I won’t spell it out here, but you can see it in action in the function I provide later in this post.  A key point for our purposes is that as the win/loss of a match is a random event, players’ Elo ratings which are based on those events are random variables.  Even if we grant the existence of a “real” value for each player, it is unobservable, and can only be estimated by their actual Elo rating in a tournament or internet forum.&lt;/p&gt;

&lt;p&gt;In fact, my original motivation for this blog post was to see how much Elo ratings fluctuate due to randomness of individual games.  In a later post I’ll have a more complex and realistic simulation, but the chart below shows what happens to a player’s Elo ratings over time in the following situation:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Only two players&lt;/li&gt;
  &lt;li&gt;They only ever play 5 point matches, and they play 10,000 of them&lt;/li&gt;
  &lt;li&gt;Player A’s chance of winning the 5 point match is 0.6, and this does not change over time (ie no player is improving in skill relative to the other)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The results are shown in the chart below, and in this unrealistically simple scenario there’s more variation than I’d realised there would be.  Player A’s actual Elo rating fluctuates fairly wildly around the true value (which can be calculated as 1578.75), hitting 1650 several times and dropping nearly all the way to 1500 at one point.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://ellisp.github.io/img/0002-elo-rating.svg&quot; alt=&quot;Ratings of Player A in 2 player simulation&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Here’s the code for that simulation, including my R function that provides FIBS-style Elo ratings, adjusted for experience as set out by FIBS.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-r&quot; data-lang=&quot;r&quot;&gt;&lt;a name=&quot;True-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#=================determine change of Elo rating ================&lt;/span&gt;
&lt;a name=&quot;True-2&quot;&gt;&lt;/a&gt;fibs_scores &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-3&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# a is Elo rating of player A before match&lt;/span&gt;
&lt;a name=&quot;True-4&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# b is Elo rating of player B before match&lt;/span&gt;
&lt;a name=&quot;True-5&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# ml is match length&lt;/span&gt;
&lt;a name=&quot;True-6&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# axp is total match lengths (experience) of player a until this match&lt;/span&gt;
&lt;a name=&quot;True-7&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# bxp is total match lengths (experience) of player b until this match&lt;/span&gt;
&lt;a name=&quot;True-8&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# see http://www.fibs.com/ratings.html for formulae&lt;/span&gt;
&lt;a name=&quot;True-9&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-10&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# calculate experience-correction multipliers:&lt;/span&gt;
&lt;a name=&quot;True-11&quot;&gt;&lt;/a&gt;   multa &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-12&quot;&gt;&lt;/a&gt;   multb &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;bxp &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-13&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-14&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# probability of A winning, using fibs_p function defined earlier:&lt;/span&gt;
&lt;a name=&quot;True-15&quot;&gt;&lt;/a&gt;   winproba &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; fibs_p&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-16&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-17&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# match value (points to be distributed between the two players):&lt;/span&gt;
&lt;a name=&quot;True-18&quot;&gt;&lt;/a&gt;   matchvalue &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;ml&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-19&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-20&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;c1&quot;&gt;# who gets them?:&lt;/span&gt;
&lt;a name=&quot;True-21&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;winner &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-22&quot;&gt;&lt;/a&gt;      a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; a &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; winproba &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multa
&lt;a name=&quot;True-23&quot;&gt;&lt;/a&gt;      b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; winproba &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multb
&lt;a name=&quot;True-24&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
&lt;a name=&quot;True-25&quot;&gt;&lt;/a&gt;      a &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; a &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; winproba&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multa 
&lt;a name=&quot;True-26&quot;&gt;&lt;/a&gt;      b &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; matchvalue &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; winproba&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; multb
&lt;a name=&quot;True-27&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-28&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-29&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kr&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; b&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; ml&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;a name=&quot;True-30&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-31&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-32&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# test against &amp;quot;baptism by fire&amp;quot; example at http://www.fibs.com/ratings.html&lt;/span&gt;
&lt;a name=&quot;True-33&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# should be 1540.95:&lt;/span&gt;
&lt;a name=&quot;True-34&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;fibs_scores&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1925&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;a&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-35&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-36&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;#================simulations of how long it takes for scores to stablise================&lt;/span&gt;
&lt;a name=&quot;True-37&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# two people playing eachother 5 point games with 0.6 chance of winning&lt;/span&gt;
&lt;a name=&quot;True-38&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-39&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-40&quot;&gt;&lt;/a&gt;A &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; B &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; exp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-41&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-42&quot;&gt;&lt;/a&gt;timeseries &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;data_frame&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;A &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; B &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-43&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-44&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kp&quot;&gt;set.seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;123&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# for reproducibility&lt;/span&gt;
&lt;a name=&quot;True-45&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kr&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;i &lt;span class=&quot;kr&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;
&lt;a name=&quot;True-46&quot;&gt;&lt;/a&gt;   result &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; fibs_scores&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-47&quot;&gt;&lt;/a&gt;               winner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;ifelse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;runif&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;b&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;a name=&quot;True-48&quot;&gt;&lt;/a&gt;               axp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; bxp &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; ml &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-49&quot;&gt;&lt;/a&gt;   timeseries&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;a
&lt;a name=&quot;True-50&quot;&gt;&lt;/a&gt;   timeseries&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt;    B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;rating &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;b
&lt;a name=&quot;True-51&quot;&gt;&lt;/a&gt;   A&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;exp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;axp
&lt;a name=&quot;True-52&quot;&gt;&lt;/a&gt;   B&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;exp &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; result&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;bxp
&lt;a name=&quot;True-53&quot;&gt;&lt;/a&gt;   
&lt;a name=&quot;True-54&quot;&gt;&lt;/a&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;a name=&quot;True-55&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-56&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;A &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;A&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-57&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;B &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; ts&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;B&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-58&quot;&gt;&lt;/a&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;time &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;nrow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-59&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-60&quot;&gt;&lt;/a&gt;&lt;span class=&quot;c1&quot;&gt;# theoretical value:&lt;/span&gt;
&lt;a name=&quot;True-61&quot;&gt;&lt;/a&gt;tv &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0.4&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3000&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
&lt;a name=&quot;True-62&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-63&quot;&gt;&lt;/a&gt;
&lt;a name=&quot;True-64&quot;&gt;&lt;/a&gt;svg&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;..http://ellisp.github.io/img/0002-elo-rating.svg&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-65&quot;&gt;&lt;/a&gt;ggplot&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; aes&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; time&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; A&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-66&quot;&gt;&lt;/a&gt;   geom_line&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;grey50&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-67&quot;&gt;&lt;/a&gt;   theme_minimal&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;base_family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-68&quot;&gt;&lt;/a&gt;   scale_y_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Player A&amp;#39;s Elo rating&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-69&quot;&gt;&lt;/a&gt;   geom_hline&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;yintercept &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tv&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-70&quot;&gt;&lt;/a&gt;   ggtitle&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Elo rating of Player A in two player, constant skill simulation&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-71&quot;&gt;&lt;/a&gt;   scale_x_continuous&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;\nNumber of matches played&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; comma&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;
&lt;a name=&quot;True-72&quot;&gt;&lt;/a&gt;   annotate&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; y &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; tv &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; x &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;timeseries&lt;span class=&quot;o&quot;&gt;$&lt;/span&gt;time&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-73&quot;&gt;&lt;/a&gt;            label &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;quot;Theoretical\nvalue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; colour  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;blue&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
&lt;a name=&quot;True-74&quot;&gt;&lt;/a&gt;            family &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;myfont&amp;quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;a name=&quot;True-75&quot;&gt;&lt;/a&gt;dev.off&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In this situation, the resulting player’s Elo rating bouncing around at random is quite well modelled by an autoregressive AR(1) time series model with an intercept at the “true” level of the player’s skill.  With an autoregression parameter of around 0.98, the rating at any point in time is obviously very closely related to the previous rating; almost but not quite a random walk. Showing how and why would make this post too long, but it’s a useful factoid to note for future work when we come to more realistic and complex simulations of Elo ratings on FIBS.&lt;/p&gt;

</description>
				<pubDate>Fri, 07 Aug 2015 00:00:00 +1200</pubDate>
				<link>http://ellisp.github.io/blog/2015/08/07/fibs-elo-ratings-basics</link>
				<guid isPermaLink="true">http://ellisp.github.io/blog/2015/08/07/fibs-elo-ratings-basics</guid>
			</item>
		
	</channel>
</rss>